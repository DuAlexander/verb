/*! verb 2013-02-18 */
VERB.eval.nurbs.rational_surface_derivs=function(n,e,r,i,t,o,u,s){var a=VERB.eval.nurbs.surface_derivs(n,e,r,i,t,o,u,s),l=VERB.eval.nurbs.separate_homo_derivs_2d(a),v=l[0],_=l[1],c=0,f=0,h=0,b=0,d=[],B=v[0][0].length;for(c=0;o>=c;c++)for(d.push([]),b=0;o-c>=b;b++){var s=v[c][b];for(h=1;b>=h;h++)s=numeric.sub(s,numeric.mul(numeric.mul(binomial.get(b,h),_[0][h]),d[c][b-h]));for(f=1;c>=f;f++){s=numeric.sub(s,numeric.mul(numeric.mul(binomial.get(c,f),_[f][0]),d[c-f][b]));var m=VERB.eval.nurbs.zeros_1d(B);for(h=1;b>=h;h++)m=numeric.add(m,numeric.mul(numeric.mul(binomial.get(b,h),_[f][h]),d[c-f][b-h]));s=numeric.sub(s,numeric.mul(binomial.get(c,f),m))}d[c].push(numeric.mul(1/_[0][0],s))}return d},VERB.eval.nurbs.rational_surface_point=function(n,e,r,i,t,o,u){return VERB.eval.nurbs.dehomogenize(VERB.eval.nurbs.surface_point(n,e,r,i,t,o,u))},VERB.eval.nurbs.rational_curve_derivs=function(n,e,r,i,t){var o=VERB.eval.nurbs.separate_homo_derivs_1d(VERB.eval.nurbs.curve_derivs(n,e,r,i,t)),u=o[0],s=o[1],a=0,l=0,v=[];for(a=0;t>=a;a++){var _=u[a];for(l=1;a>=l;l++)_=numeric.sub(_,numeric.mul(numeric.mul(binomial.get(a,l),s[l]),v[a-l]));v.push(numeric.mul(1/s[0],_))}return v},VERB.eval.nurbs.separate_homo_derivs_1d=function(n){for(var e=n[0].length,r=e-1,i=[],t=[],o=0,u=n.length;u>o;o++)i.push(n[o].slice(0,r)),t.push(n[o][r]);return[i,t]},VERB.eval.nurbs.separate_homo_derivs_2d=function(n){for(var e=[],r=[],i=0,t=n.length;t>i;i++){var o=VERB.eval.nurbs.separate_homo_derivs_1d(n[i]);e.push(o[0]),r.push(o[1])}return[e,r]},VERB.eval.nurbs.rational_curve_point=function(n,e,r,i){return VERB.eval.nurbs.dehomogenize(VERB.eval.nurbs.curve_point(n,e,r,i))},VERB.eval.nurbs.dehomogenize=function(n){for(var e=n.length,r=[],i=n[e-1],t=0;n.length-1>t;t++)r.push(n[t]/i);return r},VERB.eval.nurbs.homogenize_1d=function(n,e){for(var r=n.length,i=n[0].length,t=0,o=[],u=0,s=[],a=0;r>a;a++){var l=[];for(s=n[a],u=e[a],t=0;i>t;t++)l.push(s[t]*u);l.push(u),o.push(l)}return o},VERB.eval.nurbs.homogenize_2d=function(n,e){for(var r=n.length,i=(n[0].length,n[0][0].length,[]),t=0;r>t;t++)i.push(VERB.eval.nurbs.homogenize_1d(n[t],e[t]));return i},VERB.eval.nurbs.surface_derivs=function(n,e,r,i,t,o,u,s){var a=e.length-n-2,l=i.length-r-2;return VERB.eval.nurbs.surface_derivs_given_n_m(a,n,e,l,r,i,t,o,u,s)},VERB.eval.nurbs.surface_derivs_given_n_m=function(n,e,r,i,t,o,u,s,a,l){if(VERB.eval.nurbs.are_valid_relations(e,u.length,r.length)===!1||VERB.eval.nurbs.are_valid_relations(t,u[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var v=u[0][0].length,_=Math.min(s,e),c=Math.min(s,t),f=VERB.eval.nurbs.zeros_3d(_+1,c+1,v),h=VERB.eval.nurbs.knot_span_given_n(n,e,a,r),b=VERB.eval.nurbs.knot_span_given_n(i,t,l,o),d=VERB.eval.nurbs.deriv_basis_functions_given_n_i(h,a,e,n,r),B=VERB.eval.nurbs.deriv_basis_functions_given_n_i(b,l,t,i,o),m=VERB.eval.nurbs.zeros_2d(t+1,v),g=0,R=0,E=0,V=0,p=0;for(g=0;_>=g;g++){for(R=0;t>=R;R++)for(m[R]=VERB.eval.nurbs.zeros_1d(v),E=0;e>=E;E++)m[R]=numeric.add(m[R],numeric.mul(d[g][E],u[h-e+E][b-t+R]));for(p=Math.min(s-g,c),V=0;p>=V;V++)for(f[g][V]=VERB.eval.nurbs.zeros_1d(v),R=0;t>=R;R++)f[g][V]=numeric.add(f[g][V],numeric.mul(B[V][R],m[R]))}return f},VERB.eval.nurbs.surface_point=function(n,e,r,i,t,o,u){var s=e.length-n-2,a=i.length-r-2;return VERB.eval.nurbs.surface_point_given_n_m(s,n,e,a,r,i,t,o,u)},VERB.eval.nurbs.surface_point_given_n_m=function(n,e,r,i,t,o,u,s,a){if(VERB.eval.nurbs.are_valid_relations(e,u.length,r.length)===!1||VERB.eval.nurbs.are_valid_relations(t,u[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var l=(u[0][0].length,VERB.eval.nurbs.knot_span_given_n(n,e,s,r)),v=VERB.eval.nurbs.knot_span_given_n(i,t,a,o),_=VERB.eval.nurbs.basis_functions_given_knot_span_index(l,s,e,r),c=VERB.eval.nurbs.basis_functions_given_knot_span_index(v,a,t,o),f=l-e,h=v,b=VERB.eval.nurbs.zeros_1d(u[0][0].length),d=VERB.eval.nurbs.zeros_1d(u[0][0].length),B=0,m=0;for(B=0;t>=B;B++){for(d=VERB.eval.nurbs.zeros_1d(u[0][0].length),h=v-t+B,m=0;e>=m;m++)d=numeric.add(d,numeric.mul(_[m],u[f+m][h]));b=numeric.add(b,numeric.mul(c[B],d))}return b},VERB.eval.nurbs.curve_derivs=function(n,e,r,i,t){var o=e.length-n-2;return VERB.eval.nurbs.curve_derivs_given_n(o,n,e,r,i,t)},VERB.eval.nurbs.curve_derivs_given_n=function(n,e,r,i,t,o){if(VERB.eval.nurbs.are_valid_relations(e,i.length,r.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var u=i[0].length,s=Math.min(o,e),a=VERB.eval.nurbs.zeros_2d(s+1,u),l=VERB.eval.nurbs.knot_span_given_n(n,e,t,r),v=VERB.eval.nurbs.deriv_basis_functions_given_n_i(l,t,e,s,r),_=0,c=0;for(_=0;s>=_;_++)for(c=0;e>=c;c++)a[_]=numeric.add(a[_],numeric.mul(v[_][c],i[l-e+c]));return a},VERB.eval.nurbs.are_valid_relations=function(n,e,r){return 0===e+n+1-r?!0:!1},VERB.eval.nurbs.curve_point=function(n,e,r,i){var t=e.length-n-2;return VERB.eval.nurbs.curve_point_given_n(t,n,e,r,i)},VERB.eval.nurbs.curve_point_given_n=function(n,e,r,i,t){if(VERB.eval.nurbs.are_valid_relations(e,i.length,r.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;for(var o=VERB.eval.nurbs.knot_span_given_n(n,e,t,r),u=VERB.eval.nurbs.basis_functions_given_knot_span_index(o,t,e,r),s=VERB.eval.nurbs.zeros_1d(i[0].length),a=0;e>=a;a++)s=numeric.add(s,numeric.mul(u[a],i[o-e+a]));return s},VERB.eval.nurbs.zeros_1d=function(n){n=n>0?n:0;for(var e=[];n--;)e.push(0);return e},VERB.eval.nurbs.zeros_2d=function(n,e){e=e>0?e:0,n=n>0?n:0;for(var r=[],i=e,t=n;n--;){for(r.push([]);i--;)r[t-n-1].push(0);i=e}return r},VERB.eval.nurbs.zeros_3d=function(n,e,r){e=e>0?e:0,n=n>0?n:0;for(var i=[],t=e,o=n;n--;){for(i.push([]);t--;)i[o-n-1].push(VERB.eval.nurbs.zeros_1d(r));t=e}return i},VERB.eval.nurbs.deriv_basis_functions=function(n,e,r){var i=VERB.eval.nurbs.knot_span(e,n,r),t=r.length-1,o=t-e-1;return VERB.eval.nurbs.deriv_basis_functions_given_n_i(i,n,e,o,r)},VERB.eval.nurbs.deriv_basis_functions_given_n_i=function(n,e,r,i,t){var o=VERB.eval.nurbs.zeros_2d(r+1,r+1),u=Array(r+1),s=Array(r+1),a=0,l=0,v=1,_=0;for(o[0][0]=1,v=1;r>=v;v++){for(u[v]=e-t[n+1-v],s[v]=t[n+v]-e,a=0,_=0;v>_;_++)o[v][_]=s[_+1]+u[v-_],l=o[_][v-1]/o[v][_],o[_][v]=a+s[_+1]*l,a=u[v-_]*l;o[v][v]=a}var c=VERB.eval.nurbs.zeros_2d(i+1,r+1),f=VERB.eval.nurbs.zeros_2d(2,r+1),h=1,b=0,d=1,B=0,m=0,g=0,R=0,E=0;for(v=0;r>=v;v++)c[0][v]=o[v][r];for(_=0;r>=_;_++)for(b=0,d=1,f[0][0]=1,h=1;i>=h;h++){for(B=0,m=_-h,g=r-h,_>=h&&(f[d][0]=f[b][0]/o[g+1][m],B=f[d][0]*o[m][g]),R=m>=-1?1:-m,E=g>=_-1?h-1:r-_,v=R;E>=v;v++)f[d][v]=(f[b][v]-f[b][v-1])/o[g+1][m+v],B+=f[d][v]*o[m+v][g];g>=_&&(f[d][h]=-f[b][h-1]/o[g+1][_],B+=f[d][h]*o[_][g]),c[h][_]=B,v=b,b=d,d=v}for(_=r,h=1;i>=h;h++){for(v=0;r>=v;v++)c[h][v]*=_;_*=r-h}return c},VERB.eval.nurbs.basis_functions=function(n,e,r){var i=VERB.eval.nurbs.knot_span(n,e,r);return VERB.eval.nurbs.basis_functions_given_knot_span_index(i,n,e,r)},VERB.eval.nurbs.basis_functions_given_knot_span_index=function(n,e,r,i){var t=Array(r+1),o=Array(r+1),u=Array(r+1),s=0,a=0;t[0]=1;for(var l=1;r>=l;l++){o[l]=e-i[n+1-l],u[l]=i[n+l]-e,s=0;for(var v=0;l>v;v++)a=t[v]/(u[v+1]+o[l-v]),t[v]=s+u[v+1]*a,s=o[l-v]*a;t[l]=s}return t},VERB.eval.nurbs.knot_span=function(n,e,r){var i=r.length-1,t=i-n-1;return VERB.eval.nurbs.knot_span_given_n(t,n,e,r)},VERB.eval.nurbs.knot_span_given_n=function(n,e,r,i){if(r>=i[n+1])return n;if(i[e]>r)return e;for(var t=e,o=n+1,u=Math.floor((t+o)/2);i[u]>r||r>=i[u+1];)i[u]>r?o=u:t=u,u=Math.floor((t+o)/2);return u};