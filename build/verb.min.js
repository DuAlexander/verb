/*! verb 2015-01-18 */
if("object"!=typeof exports||void 0===exports)var verb=exports={};else var verb=module.exports={};(function(e){"use strict";function r(e,r){function n(){}n.prototype=e;var o=new n;for(var t in r)o[t]=r[t];return r.toString!==Object.prototype.toString&&(o.toString=r.toString),o}function n(e){return e instanceof Array?function(){return t.iter(e)}:"function"==typeof e.iterator?o(e,e.iterator):e.iterator}function o(e,r){if(null==r)return null;null==r.__id__&&(r.__id__=u++);var n;return null==e.hx__closures__?e.hx__closures__={}:n=e.hx__closures__[r.__id__],null==n&&(n=function(){return n.method.apply(n.scope,arguments)},n.scope=e,n.method=r,e.hx__closures__[r.__id__]=n),n}e.core=e.core||{};var t=function(){};t.iter=function(e){return{cur:0,arr:e,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};var c=function(){};c.fold=function(e,r,o){for(var t=n(e)();t.hasNext();){var c=t.next();o=r(c,o)}return o};var i=function(){},s={};s.ds={},s.ds.IntMap=function(){this.h={}},s.ds.IntMap.__interfaces__=[i],s.ds.IntMap.prototype={set:function(e,r){this.h[e]=r},get:function(e){return this.h[e]},exists:function(e){return this.h.hasOwnProperty(e)}};var a={};a.BoundingBox=e.BoundingBox=function(e){this.max=null,this.min=null,this.dim=3,this.initialized=!1,null!=e&&this.addRange(e)},a.BoundingBox.intervalsOverlap=function(e,r,n,o,t){null==t&&(t=-1);var c;c=0>t?a.BoundingBox.TOLERANCE:t;var i=Math.min(e,r)-c,s=Math.max(e,r)+c,u=Math.min(n,o)-c,l=Math.max(n,o)+c;return i>=u&&l>=i||s>=u&&l>=s||u>=i&&s>=u||l>=i&&s>=l},a.BoundingBox.prototype={fromPoint:function(e){return new a.BoundingBox([e])},add:function(e){if(!this.initialized)return this.dim=e.length,this.min=e.slice(0),this.max=e.slice(0),this.initialized=!0,this;for(var r=0,n=this.dim;n>r;){var o=r++;e[o]>this.max[o]&&(this.max[o]=e[o]),e[o]<this.min[o]&&(this.min[o]=e[o])}return this},addRange:function(e){for(var r=e.length,n=0;r>n;){var o=n++;this.add(e[o])}return this},contains:function(e,r){return null==r&&(r=-1),this.initialized?this.intersects(new a.BoundingBox([e]),r):!1},intersects:function(e,r){if(null==r&&(r=-1),!this.initialized||!e.initialized)return!1;for(var n=this.min,o=this.max,t=e.min,c=e.max,i=0,s=this.dim;s>i;){var u=i++;if(!a.BoundingBox.intervalsOverlap(n[u],o[u],t[u],c[u],r))return!1}return!0},clear:function(){return this.initialized=!1,this},getLongestAxis:function(){for(var e=0,r=0,n=0,o=this.dim;o>n;){var t=n++,c=this.getAxisLength(t);c>e&&(e=c,r=t)}return r},getAxisLength:function(e){return 0>e||e>this.dim-1?0:Math.abs(this.min[e]-this.max[e])},intersect:function(e,r){if(!this.initialized)return null;var n=this.min,o=this.max,t=e.min,c=e.max;if(!this.intersects(e,r))return null;for(var i=[],s=[],u=0,l=this.dim;l>u;){var h=u++;i.push(Math.min(o[h],c[h])),s.push(Math.max(n[h],t[h]))}return new a.BoundingBox([s,i])}},a.Init=function(){},a.Init.main=function(){console.log("verb 0.2.0")},a.core={},a.core.Analyze=e.core.Analyze=function(){},a.core.Analyze.is_rational_surface_closed=function(e,r){null==r&&(r=!0);var n;n=r?e.controlPoints:a.core.Mat.transpose(e.controlPoints);for(var o=0,t=n[0].length;t>o;){var c=o++,i=a.core.Vec.dist(n[0][c],n[n.length-1][c])<a.core.Constants.EPSILON;if(!i)return!1}return!0},a.core.Analyze.rationalSurfaceClosestPoint=function(e,r){for(var n,o,t,c=5,i=0,s=1e-4,u=5e-4,l=e.knotsU[0],h=a.core.ArrayExtensions.last(e.knotsU),v=e.knotsV[0],f=a.core.ArrayExtensions.last(e.knotsV),d=a.core.Analyze.is_rational_surface_closed(e),_=a.core.Analyze.is_rational_surface_closed(e,!1),p=a.core.Tess.rational_surface_adaptive(e,new a.core.types.AdaptiveRefinementOptions),m=Math.POSITIVE_INFINITY,g=0,V=p.points.length;V>g;){var y=g++,b=p.points[y],x=a.core.Vec.normSquared(a.core.Vec.sub(r,b));m>x&&(m=x,t=p.uvs[y])}for(var E=function(r){return a.core.Eval.rational_surface_derivs(e,2,r[0],r[1])},M=function(e,r,n){var o=r[1][0],t=r[0][1],c=r[2][0],i=r[0][2],s=r[1][1],u=r[1][1],l=a.core.Vec.dot(o,n),h=a.core.Vec.dot(t,n),v=[-l,-h],f=a.core.Vec.dot(o,o)+a.core.Vec.dot(c,n),d=a.core.Vec.dot(o,t)+a.core.Vec.dot(s,n),_=a.core.Vec.dot(o,t)+a.core.Vec.dot(u,n),p=a.core.Vec.dot(t,t)+a.core.Vec.dot(i,n),m=[[f,d],[_,p]],g=a.core.Mat.solve(m,v);return a.core.Vec.add(g,e)};c>i;){n=E(t),o=a.core.Vec.sub(n[0][0],r);var k=a.core.Vec.norm(o),I=a.core.Vec.dot(n[1][0],o),B=a.core.Vec.norm(n[1][0])*k,P=a.core.Vec.dot(n[0][1],o),z=a.core.Vec.norm(n[0][1])*k,w=I/B,T=P/z,N=s>k,S=u>w,C=u>T;if(N&&S&&C)return t;var L=M(t,n,o);l>L[0]?L=d?[h-(L[0]-l),L[1]]:[l+a.core.Constants.EPSILON,L[1]]:L[0]>h&&(L=d?[l+(L[0]-h),L[1]]:[h-a.core.Constants.EPSILON,L[1]]),v>L[1]?L=_?[L[0],f-(L[1]-v)]:[L[0],v+a.core.Constants.EPSILON]:L[1]>f&&(L=_?[L[0],v+(L[0]-f)]:[L[0],f-a.core.Constants.EPSILON]);var A=a.core.Vec.norm(a.core.Vec.mul(L[0]-t[0],n[1][0])),D=a.core.Vec.norm(a.core.Vec.mul(L[1]-t[1],n[0][1]));if(s>A+D)return t;t=L,i++}return t},a.core.Analyze.rationalCurveClosestPoint=function(e,r){for(var n=.001,o=Math.POSITIVE_INFINITY,t=0,c=a.core.Tess.rational_curve_adaptive_sample(e,n,!0),i=0,s=c.length-1;s>i;){var u=i++,l=c[u][0],h=c[u+1][0],v=c[u].slice(1),f=c[u+1].slice(1),d=a.core.Trig.closest_point_on_segment(r,v,f,l,h),_=a.core.Vec.norm(a.core.Vec.sub(r,d.pt));o>_&&(o=_,t=d.u)}for(var p,m,g=5,V=0,y=1e-4,b=5e-4,x=e.knots[0],E=a.core.ArrayExtensions.last(e.knots),M=a.core.Vec.normSquared(a.core.Vec.sub(e.controlPoints[0],a.core.ArrayExtensions.last(e.controlPoints)))<a.core.Constants.EPSILON,k=t,I=function(r){return a.core.Eval.rational_curve_derivs(e,r,2)},B=function(e,r,n){var o=a.core.Vec.dot(r[1],n),t=a.core.Vec.dot(r[2],n),c=a.core.Vec.dot(r[1],r[1]),i=t+c;return e-o/i};g>V;){p=I(k),m=a.core.Vec.sub(p[0],r);var P=a.core.Vec.norm(m),z=a.core.Vec.dot(p[1],m),w=a.core.Vec.norm(p[1])*P,T=z/w,N=y>P,S=b>Math.abs(T);if(N&&S)return k;var C=B(k,p,m);x>C?C=M?E-(C-x):x:C>E&&(C=M?x+(C-E):E);var L=a.core.Vec.norm(a.core.Vec.mul(C-k,p[1]));if(y>L)return k;k=C,V++}return k},a.core.Analyze.rationalCurveParamAtArcLength=function(e,r,n,o,t){if(a.core.Constants.EPSILON>r)return e.knots[0];var c;c=null!=o?o:a.core.Modify.curve_bezier_decompose(e);var i=0;c[i];var s,u=-a.core.Constants.EPSILON;for(s=null!=t?t:[];r>u&&c.length>i;){if(s[i]=s.length>i?s[i]:a.core.Analyze.rational_bezier_curve_arc_length(e),u+=s[i],u+a.core.Constants.EPSILON>r)return a.core.Analyze.rationalBezierCurveParamAtArcLength(e,r,n,s[i]);i++}return-1},a.core.Analyze.rationalBezierCurveParamAtArcLength=function(e,r,n,o){if(0>r)return e.knots[0];var t;if(t=null!=o?o:a.core.Analyze.rational_bezier_curve_arc_length(e),r>t)return a.core.ArrayExtensions.last(e.knots);var c,i=e.knots[0],s=0,u=a.core.ArrayExtensions.last(e.knots),l=t,h=0,v=0;for(c=null!=n?n:2*a.core.Constants.TOLERANCE;l-s>c;)h=(i+u)/2,v=a.core.Analyze.rational_bezier_curve_arc_length(e,h),v>r?(u=h,l=v):(i=h,s=v);return(i+u)/2},a.core.Analyze.rationalCurveArcLength=function(e,r,n){null==n&&(n=16),r=null==r?a.core.ArrayExtensions.last(e.knots):r;for(var o=a.core.Modify.curve_bezier_decompose(e),t=0,c=o[0],i=0;o.length>t&&r>c.knots[0]+a.core.Constants.EPSILON;){var s=Math.min(a.core.ArrayExtensions.last(c.knots),r);i+=a.core.Analyze.rational_bezier_curve_arc_length(c,s,n),c=o[++t]}return i},a.core.Analyze.rational_bezier_curve_arc_length=function(e,r,n){null==n&&(n=16);var o;o=null==r?a.core.ArrayExtensions.last(e.knots):r;for(var t,c,i=(o-e.knots[0])/2,s=0,u=e.degree+n,l=0;u>l;){var h=l++;t=i*a.core.Analyze.Tvalues[u][h]+i+e.knots[0],c=a.core.Eval.rational_curve_derivs(e,t,1),s+=a.core.Analyze.Cvalues[u][h]*a.core.Vec.norm(c[1])}return i*s},a.core.ArrayExtensions=function(){},a.core.ArrayExtensions.last=function(e){return e[e.length-1]},a.core.ArrayExtensions.first=function(e){return e[0]},a.core.ArrayExtensions.spliceAndInsert=function(e,r,n,o){e.splice(r,n),e.splice(r,0,o)},a.core.ArrayExtensions.left=function(e){if(0==e.length)return[];var r=Math.ceil(e.length/2);return e.slice(0,r)},a.core.ArrayExtensions.right=function(e){if(0==e.length)return[];var r=Math.ceil(e.length/2);return e.slice(r)},a.core.ArrayExtensions.rightWithPivot=function(e){if(0==e.length)return[];var r=Math.ceil(e.length/2);return e.slice(r-1)},a.core.ArrayExtensions.unique=function(e,r){if(0==e.length)return[];for(var n=[e.pop()];e.length>0;){for(var o=e.pop(),t=!0,c=0;n.length>c;){var i=n[c];if(++c,r(o,i)){t=!1;break}}t&&n.push(o)}return n},a.core.Binomial=function(){},a.core.Binomial.get=function(e,r){if(0==r)return 1;if(0==e||r>e)return 0;if(r>e-r&&(r=e-r),a.core.Binomial.memo_exists(e,r))return a.core.Binomial.get_memo(e,r);for(var n=1,o=e,t=1,c=r+1;c>t;){var i=t++;a.core.Binomial.memo_exists(o,i)?(e--,n=a.core.Binomial.get_memo(o,i)):(n*=e--,n/=i,a.core.Binomial.memoize(o,i,n))}return n},a.core.Binomial.get_no_memo=function(e,r){if(0==r)return 1;if(0==e||r>e)return 0;r>e-r&&(r=e-r);for(var n=1,o=1,t=r+1;t>o;){var c=o++;n*=e--,n/=c}return n},a.core.Binomial.memo_exists=function(e,r){return a.core.Binomial.memo.exists(e)&&a.core.Binomial.memo.get(e).exists(r)},a.core.Binomial.get_memo=function(e,r){return a.core.Binomial.memo.get(e).get(r)},a.core.Binomial.memoize=function(e,r,n){a.core.Binomial.memo.exists(e)||a.core.Binomial.memo.set(e,new s.ds.IntMap),a.core.Binomial.memo.get(e).set(r,n)},a.core.Constants=e.core.Constants=function(){},a.core.Divide=e.core.Divide=function(){},a.core.Divide.rationalCurveEquallyByArcLength=function(e,r){var n=a.core.Analyze.rationalCurveArcLength(e),o=n/r;return a.core.Divide.rationalCurveByArcLength(e,o)},a.core.Divide.rationalCurveByArcLength=function(e,r){var n=a.core.Modify.curve_bezier_decompose(e),o=n.map(function(e){return a.core.Analyze.rational_bezier_curve_arc_length(e)}),t=a.core.Vec.sum(o),c=[new a.core.types.CurveLengthSample(e.knots[0],0)];if(r>t)return c;for(var i,s=r,u=0,l=s,h=0,v=0;n.length>u;){for(h+=o[u];h+a.core.Constants.EPSILON>l;)i=a.core.Analyze.rationalBezierCurveParamAtArcLength(n[u],l-v,a.core.Constants.TOLERANCE,o[u]),c.push(new a.core.types.CurveLengthSample(i,l)),l+=s;v+=o[u],u++}return c},a.core.Eval=e.core.Eval=function(){},a.core.Eval.volume_point=function(e,r,n,o){var t=e.knotsU.length-e.degreeU-2,c=e.knotsV.length-e.degreeV-2,i=e.knotsW.length-e.degreeW-2;return a.core.Eval.volume_point_given_n_m_l(e,t,c,i,r,n,o)},a.core.Eval.volume_point_given_n_m_l=function(e,r,n,o,t,c,i){for(var s=e.controlPoints,u=e.degreeU,l=e.degreeV,h=e.degreeW,v=e.knotsU,f=e.knotsV,d=e.knotsW,_=s[0][0][0].length,p=a.core.Eval.knot_span_given_n(r,u,t,v),m=a.core.Eval.knot_span_given_n(n,l,c,f),g=a.core.Eval.knot_span_given_n(o,h,i,d),V=a.core.Eval.basis_functions_given_knot_span_index(p,t,u,v),y=a.core.Eval.basis_functions_given_knot_span_index(m,c,l,f),b=a.core.Eval.basis_functions_given_knot_span_index(g,i,h,d),x=p-u,E=a.core.Vec.zeros1d(_),M=a.core.Vec.zeros1d(_),k=a.core.Vec.zeros1d(_),I=0,B=h+1;B>I;){var P=I++;k=a.core.Vec.zeros1d(_);for(var z=g-h+P,w=0,T=l+1;T>w;){var N=w++;M=a.core.Vec.zeros1d(_);for(var S=m-l+N,C=0,L=u+1;L>C;){var A=C++;M=a.core.Vec.add(M,a.core.Vec.mul(V[A],s[x+A][S][z]))}k=a.core.Vec.add(k,a.core.Vec.mul(y[N],M))}E=a.core.Vec.add(E,a.core.Vec.mul(b[P],k))}return E},a.core.Eval.rational_surface_derivs=function(e,r,n,o){for(var t=a.core.Eval.surface_derivs(e,r,n,o),c=a.core.Eval.rational_2d(t),i=a.core.Eval.weight_2d(t),s=[],u=c[0][0].length,l=0,h=r+1;h>l;){var v=l++;s.push([]);for(var f=0,d=r-v+1;d>f;){for(var _=f++,p=c[v][_],m=1,g=_+1;g>m;){var V=m++;p=a.core.Vec.sub(p,a.core.Vec.mul(a.core.Binomial.get(_,V)*i[0][V],s[v][_-V]))}for(var y=1,b=v+1;b>y;){var x=y++;p=a.core.Vec.sub(p,a.core.Vec.mul(a.core.Binomial.get(v,x)*i[x][0],s[v-x][_]));for(var E=a.core.Vec.zeros1d(u),M=1,k=_+1;k>M;){var I=M++;E=a.core.Vec.add(E,a.core.Vec.mul(a.core.Binomial.get(_,I)*i[x][I],s[v-x][_-I]))}p=a.core.Vec.sub(p,a.core.Vec.mul(a.core.Binomial.get(v,x),E))}s[v].push(a.core.Vec.mul(1/i[0][0],p))}}return s},a.core.Eval.rational_surface_point=function(e,r,n){return a.core.Eval.dehomogenize(a.core.Eval.surface_point(e,r,n))},a.core.Eval.rational_curve_derivs=function(e,r,n){for(var o=a.core.Eval.curve_derivs(e,r,n),t=a.core.Eval.rational_1d(o),c=a.core.Eval.weight_1d(o),i=[],s=0,u=n+1;u>s;){for(var l=s++,h=t[l],v=1,f=l+1;f>v;){var d=v++;h=a.core.Vec.sub(h,a.core.Vec.mul(a.core.Binomial.get(l,d)*c[d],i[l-d]))}i.push(a.core.Vec.mul(1/c[0],h))}return i},a.core.Eval.rational_curve_point=function(e,r){return a.core.Eval.dehomogenize(a.core.Eval.curve_point(e,r))},a.core.Eval.dehomogenize=function(e){for(var r=e.length,n=[],o=e[r-1],t=e.length-1,c=0;t>c;){var i=c++;n.push(e[i]/o)}return n},a.core.Eval.rational_1d=function(e){var r=e[0].length-1;return e.map(function(e){return e.slice(0,r)})},a.core.Eval.rational_2d=function(e){return e.map(a.core.Eval.rational_1d)},a.core.Eval.weight_1d=function(e){var r=e[0].length-1;return e.map(function(e){return e[r]})},a.core.Eval.weight_2d=function(e){return e.map(a.core.Eval.weight_1d)},a.core.Eval.dehomogenize_1d=function(e){return e.map(a.core.Eval.dehomogenize)},a.core.Eval.dehomogenize_2d=function(e){return e.map(a.core.Eval.dehomogenize_1d)},a.core.Eval.homogenize_1d=function(e,r){for(var n=e.length,o=e[0].length,t=[],c=0,i=[],s=0;n>s;){var a=s++,u=[];i=e[a],c=r[a];for(var l=0;o>l;){var h=l++;u.push(i[h]*c)}u.push(c),t.push(u)}return t},a.core.Eval.homogenize_2d=function(e,r){for(var n=e.length,o=[],t=0;n>t;){var c=t++;o.push(a.core.Eval.homogenize_1d(e[c],r[c]))}return o},a.core.Eval.surface_derivs=function(e,r,n,o){var t=e.knotsU.length-e.degreeU-2,c=e.knotsV.length-e.degreeV-2;return a.core.Eval.surface_derivs_given_n_m(t,c,e,r,n,o)},a.core.Eval.surface_derivs_given_n_m=function(e,r,n,o,t,c){var i=n.degreeU,s=n.degreeV,u=n.controlPoints,l=n.knotsU,h=n.knotsV;if(!a.core.Eval.are_valid_relations(i,u.length,l.length)||!a.core.Eval.are_valid_relations(s,u[0].length,h.length))throw"Invalid relations between control points, knot vector, and n";var v,f=u[0][0].length;v=i>o?o:i;var d;d=s>o?o:s;for(var _=a.core.Vec.zeros3d(v+1,d+1,f),p=a.core.Eval.knot_span_given_n(e,i,t,l),m=a.core.Eval.knot_span_given_n(r,s,c,h),g=a.core.Eval.deriv_basis_functions_given_n_i(p,t,i,e,l),V=a.core.Eval.deriv_basis_functions_given_n_i(m,c,s,r,h),y=a.core.Vec.zeros2d(s+1,f),b=0,x=0,E=v+1;E>x;){for(var M=x++,k=0,I=s+1;I>k;){var B=k++;y[B]=a.core.Vec.zeros1d(f);for(var P=0,z=i+1;z>P;){var w=P++;y[B]=a.core.Vec.add(y[B],a.core.Vec.mul(g[M][w],u[p-i+w][m-s+B]))}}var T=o-M;b=d>T?T:d;for(var N=0,S=b+1;S>N;){var C=N++;_[M][C]=a.core.Vec.zeros1d(f);for(var L=0,A=s+1;A>L;){var D=L++;_[M][C]=a.core.Vec.add(_[M][C],a.core.Vec.mul(V[C][D],y[D]))}}}return _},a.core.Eval.surface_point=function(e,r,n){var o=e.knotsU.length-e.degreeU-2,t=e.knotsV.length-e.degreeV-2;return a.core.Eval.surface_point_given_n_m(o,t,e,r,n)},a.core.Eval.surface_point_given_n_m=function(e,r,n,o,t){var c=n.degreeU,i=n.degreeV,s=n.controlPoints,u=n.knotsU,l=n.knotsV;if(!a.core.Eval.are_valid_relations(c,s.length,u.length)||!a.core.Eval.are_valid_relations(i,s[0].length,l.length))throw"Invalid relations between control points, knot vector, and n";for(var h=s[0][0].length,v=a.core.Eval.knot_span_given_n(e,c,o,u),f=a.core.Eval.knot_span_given_n(r,i,t,l),d=a.core.Eval.basis_functions_given_knot_span_index(v,o,c,u),_=a.core.Eval.basis_functions_given_knot_span_index(f,t,i,l),p=v-c,m=f,g=a.core.Vec.zeros1d(h),V=a.core.Vec.zeros1d(h),y=0,b=i+1;b>y;){var x=y++;V=a.core.Vec.zeros1d(h),m=f-i+x;for(var E=0,M=c+1;M>E;){var k=E++;V=a.core.Vec.add(V,a.core.Vec.mul(d[k],s[p+k][m]))}g=a.core.Vec.add(g,a.core.Vec.mul(_[x],V))}return g},a.core.Eval.curve_derivs=function(e,r,n){var o=e.knots.length-e.degree-2;return a.core.Eval.curve_derivs_given_n(o,e,r,n)},a.core.Eval.curve_derivs_given_n=function(e,r,n,o){var t=r.degree,c=r.controlPoints,i=r.knots;if(!a.core.Eval.are_valid_relations(t,c.length,i.length))throw"Invalid relations between control points, knot vector, and n";var s,u=c[0].length;s=t>o?o:t;for(var l=a.core.Vec.zeros2d(s+1,u),h=a.core.Eval.knot_span_given_n(e,t,n,i),v=a.core.Eval.deriv_basis_functions_given_n_i(h,n,t,s,i),f=0,d=s+1;d>f;)for(var _=f++,p=0,m=t+1;m>p;){var g=p++;l[_]=a.core.Vec.add(l[_],a.core.Vec.mul(v[_][g],c[h-t+g]))}return l},a.core.Eval.curve_point=function(e,r){var n=e.knots.length-e.degree-2;return a.core.Eval.curve_point_given_n(n,e,r)},a.core.Eval.are_valid_relations=function(e,r,n){return 0==r+e+1-n},a.core.Eval.curve_point_given_n=function(e,r,n){var o=r.degree,t=r.controlPoints,c=r.knots;if(!a.core.Eval.are_valid_relations(o,t.length,c.length))throw"Invalid relations between control points, knot Array, and n";for(var i=a.core.Eval.knot_span_given_n(e,o,n,c),s=a.core.Eval.basis_functions_given_knot_span_index(i,n,o,c),u=a.core.Vec.zeros1d(t[0].length),l=0,h=o+1;h>l;){var v=l++;u=a.core.Vec.add(u,a.core.Vec.mul(s[v],t[i-o+v]))}return u},a.core.Eval.deriv_basis_functions=function(e,r,n){var o=a.core.Eval.knot_span(r,e,n),t=n.length-1,c=t-r-1;return a.core.Eval.deriv_basis_functions_given_n_i(o,e,r,c,n)},a.core.Eval.deriv_basis_functions_given_n_i=function(e,r,n,o,t){var c=a.core.Vec.zeros2d(n+1,n+1),i=a.core.Vec.zeros1d(n+1),s=a.core.Vec.zeros1d(n+1),u=0,l=0;c[0][0]=1;for(var h=1,v=n+1;v>h;){var f=h++;i[f]=r-t[e+1-f],s[f]=t[e+f]-r,u=0;for(var d=0;f>d;){var _=d++;c[f][_]=s[_+1]+i[f-_],l=c[_][f-1]/c[f][_],c[_][f]=u+s[_+1]*l,u=i[f-_]*l}c[f][f]=u}for(var p=a.core.Vec.zeros2d(o+1,n+1),m=a.core.Vec.zeros2d(2,n+1),g=0,V=1,y=0,b=0,x=0,E=0,M=0,k=0,I=n+1;I>k;){var B=k++;p[0][B]=c[B][n]}for(var P=0,z=n+1;z>P;){var w=P++;g=0,V=1,m[0][0]=1;for(var T=1,N=o+1;N>T;){var S=T++;y=0,b=w-S,x=n-S,w>=S&&(m[V][0]=m[g][0]/c[x+1][b],y=m[V][0]*c[b][x]),E=b>=-1?1:-b,M=x>=w-1?S-1:n-w;for(var C=E,L=M+1;L>C;){var A=C++;m[V][A]=(m[g][A]-m[g][A-1])/c[x+1][b+A],y+=m[V][A]*c[b+A][x]}x>=w&&(m[V][S]=-m[g][S-1]/c[x+1][w],y+=m[V][S]*c[w][x]),p[S][w]=y;var D=g;g=V,V=D}}for(var U=n,O=1,R=o+1;R>O;){for(var q=O++,F=0,K=n+1;K>F;){var j=F++;p[q][j]*=U}U*=n-q}return p},a.core.Eval.basis_functions=function(e,r,n){var o=a.core.Eval.knot_span(r,e,n);return a.core.Eval.basis_functions_given_knot_span_index(o,e,r,n)},a.core.Eval.basis_functions_given_knot_span_index=function(e,r,n,o){var t=a.core.Vec.zeros1d(n+1),c=a.core.Vec.zeros1d(n+1),i=a.core.Vec.zeros1d(n+1),s=0,u=0;t[0]=1;for(var l=1,h=n+1;h>l;){var v=l++;c[v]=r-o[e+1-v],i[v]=o[e+v]-r,s=0;for(var f=0;v>f;){var d=f++;u=t[d]/(i[d+1]+c[v-d]),t[d]=s+i[d+1]*u,s=c[v-d]*u}t[v]=s}return t},a.core.Eval.knot_span=function(e,r,n){var o=n.length-1,t=o-e-1;return a.core.Eval.knot_span_given_n(t,e,r,n)},a.core.Eval.knot_span_given_n=function(e,r,n,o){if(n>=o[e+1])return e;if(o[r]>n)return r;for(var t=r,c=e+1,i=Math.floor((t+c)/2);o[i]>n||n>=o[i+1];)o[i]>n?c=i:t=i,i=Math.floor((t+c)/2);return i},a.core.Intersect=e.core.Intersect=function(){},a.core.Intersect.surfaces=function(e,r,n){var o=a.core.Tess.rational_surface_adaptive(e),t=a.core.Tess.rational_surface_adaptive(r),c=a.core.Intersect.meshes(o,t),i=c.map(function(o){return o.map(function(o){return a.core.Intersect.surfaces_at_point_with_estimate(e,r,o.uv0,o.uv1,n)})});return i.map(function(e){return a.core.Make.rational_interp_curve(e.map(function(e){return e.point}),3)})},a.core.Intersect.surfaces_at_point_with_estimate=function(e,r,n,o,t){var c,i,s,u,l,h,v,f,d,_,p,m,g,V=10,y=0;do{if(c=a.core.Eval.rational_surface_derivs(e,1,n[0],n[1]),i=c[0][0],u=c[1][0],l=c[0][1],s=a.core.Vec.normalized(a.core.Vec.cross(u,l)),h=a.core.Vec.dot(s,i),v=a.core.Eval.rational_surface_derivs(e,1,o[0],o[1]),f=v[0][0],_=v[1][0],p=v[0][1],d=a.core.Vec.normalized(a.core.Vec.cross(_,p)),m=a.core.Vec.dot(d,f),g=a.core.Vec.norm(a.core.Vec.sub(i,f)),t>g)break;var b=a.core.Vec.normalized(a.core.Vec.cross(s,d)),x=a.core.Vec.dot(b,i),E=a.core.Intersect.three_planes(s,h,d,m,b,x);if(null==E)throw"panic!";var M=a.core.Vec.sub(E,i),k=a.core.Vec.sub(E,f),I=a.core.Vec.cross(u,s),B=a.core.Vec.cross(l,s),P=a.core.Vec.cross(_,d),z=a.core.Vec.cross(p,d),w=a.core.Vec.dot(B,M)/a.core.Vec.dot(B,u),T=a.core.Vec.dot(I,M)/a.core.Vec.dot(I,l),N=a.core.Vec.dot(z,k)/a.core.Vec.dot(z,_),S=a.core.Vec.dot(P,k)/a.core.Vec.dot(P,p);n=a.core.Vec.add([w,T],n),o=a.core.Vec.add([N,S],o),y++}while(V>y);return new a.core.types.SurfaceSurfaceIntersectionPoint(n,o,i,g)},a.core.Intersect.meshes=function(e,r){var n=a.core.Intersect.bounding_box_trees(new a.core.types.LazyMeshBoundingBoxTree(e),new a.core.types.LazyMeshBoundingBoxTree(r),0),o=a.core.ArrayExtensions.unique(n.map(function(n){return a.core.Intersect.triangles(e,n.item0,r,n.item1)}).filter(function(e){return null!=e}).filter(function(e){return a.core.Vec.distSquared(e.min.point,e.max.point)>a.core.Constants.EPSILON}),function(e,r){var n=a.core.Vec.sub(e.min.uv0,r.min.uv0),o=a.core.Vec.dot(n,n),t=a.core.Vec.sub(e.max.uv0,r.max.uv0),c=a.core.Vec.dot(t,t),i=a.core.Vec.sub(e.min.uv0,r.max.uv0),s=a.core.Vec.dot(i,i),u=a.core.Vec.sub(e.max.uv0,r.min.uv0),l=a.core.Vec.dot(u,u);return a.core.Constants.EPSILON>o&&a.core.Constants.EPSILON>c||a.core.Constants.EPSILON>s&&a.core.Constants.EPSILON>l});return 0==o.length?[]:a.core.Intersect.make_mesh_intersection_polylines(o)},a.core.Intersect.make_mesh_intersection_polylines=function(e){for(var r=0;e.length>r;){var n=e[r];++r,n.max.opp=n.min,n.min.opp=n.max}for(var o=a.core.Intersect.kdtree_from_segs(e),t=[],c=0;e.length>c;){var i=e[c];++c,t.push(i.min),t.push(i.max)}for(var s=0;t.length>s;){var u=t[s];if(++s,null==u.adj){var l=a.core.Intersect.lookup_adj_segment(u,o,e.length);null!=l&&null==l.adj&&(u.adj=l,l.adj=u)}}var h=t.filter(function(e){return null==e.adj});0==h.length&&(h=t);for(var v=[],f=0;h.length>f;){var d=h[f];if(++f,!d.visited){for(var _=[],p=d;null!=p;){if(p.visited)throw"Segment end encountered twice!";if(p.visited=!0,p.opp.visited=!0,_.push(p),p=p.opp.adj,p==d)break}_.length>0&&(_.push(_[_.length-1].opp),v.push(_))}}return v},a.core.Intersect.kdtree_from_segs=function(e){for(var r=[],n=0;e.length>n;){var o=e[n];++n,r.push(new a.core.KdPoint(o.min.point,o.min)),r.push(new a.core.KdPoint(o.max.point,o.max))}return new a.core.KdTree(r,a.core.Vec.distSquared)},a.core.Intersect.lookup_adj_segment=function(e,r,n){var o;o=null!=n?3>n?3:n:3;var t=r.nearest(e.point,o,a.core.Constants.EPSILON).filter(function(r){return e!=r.item0.obj}).map(function(e){return e.item0.obj});return 1==t.length?t[0]:null},a.core.Intersect.curve_and_surface=function(e,r,n){null==n&&(n=.001);var o=a.core.Intersect.bounding_box_trees(new a.core.types.LazyCurveBoundingBoxTree(e),new a.core.types.LazySurfaceBoundingBoxTree(r),0);return o.map(function(e){var r=e.item0,o=e.item1,t=r.knots[0],c=a.core.ArrayExtensions.last(r.knots),i=(t+c)/2,s=o.knotsU[0],u=a.core.ArrayExtensions.last(o.knotsU),l=o.knotsV[0],h=a.core.ArrayExtensions.last(o.knotsV),v=[(s+u)/2,(l+h)/2];return a.core.Intersect.curve_and_surface_with_estimate(r,o,[i].concat(v),n)})},a.core.Intersect.curve_and_surface_with_estimate=function(e,r,n,o){null==o&&(o=.001);var t=function(n){var o=a.core.Eval.rational_curve_point(e,n[0]),t=a.core.Eval.rational_surface_point(r,n[1],n[2]),c=a.core.Vec.sub(o,t);return a.core.Vec.dot(c,c)},c=a.core.Numeric.uncmin(t,n,o),i=c.solution;return new a.core.types.CurveSurfaceIntersection(i[0],[i[1],i[2]])},a.core.Intersect.polyline_and_mesh=function(e,r,n){for(var o=a.core.Intersect.bounding_box_trees(new a.core.types.LazyPolylineBoundingBoxTree(e),new a.core.types.LazyMeshBoundingBoxTree(r),n),t=[],c=0;o.length>c;){var i=o[c];++c;var s=i.item0,u=i.item1,l=a.core.Intersect.segment_with_tri(e.points[s],e.points[s+1],r.points,r.faces[u]);if(null!=l){var h=l.point,v=a.core.Vec.lerp(l.p,[e.params[s]],[e.params[s+1]])[0],f=a.core.Mesh.tri_uv_from_point(r,u,h);t.push(new a.core.types.PolylineMeshIntersection(h,v,f,s,u))}}return t},a.core.Intersect.mesh_bounding_boxes=function(e,r,n){return a.core.Intersect.bounding_box_trees(new a.core.types.LazyMeshBoundingBoxTree(e),new a.core.types.LazyMeshBoundingBoxTree(r),n)},a.core.Intersect.bounding_box_trees=function(e,r,n){if(null==n&&(n=1e-9),e.empty()||r.empty())return[];if(!e.boundingBox().intersects(r.boundingBox(),n))return[];if(e.indivisible(n)&&r.indivisible(n))return[new a.core.types.Pair(e.yield(),r.yield())];var o=e.split(),t=r.split();return a.core.Intersect.bounding_box_trees(o.item0,t.item0,n).concat(a.core.Intersect.bounding_box_trees(o.item0,t.item1,n)).concat(a.core.Intersect.bounding_box_trees(o.item1,t.item0,n)).concat(a.core.Intersect.bounding_box_trees(o.item1,t.item1,n))},a.core.Intersect.curves=function(e,r,n){var o=a.core.Intersect.bounding_box_trees(new a.core.types.LazyCurveBoundingBoxTree(e),new a.core.types.LazyCurveBoundingBoxTree(r),0);return o.map(function(o){return a.core.Intersect.curves_with_estimate(e,r,o.item0.knots[0],o.item1.knots[0],n)})},a.core.Intersect.curves_with_estimate=function(e,r,n,o,t){var c=function(n){var o=a.core.Eval.rational_curve_point(e,n[0]),t=a.core.Eval.rational_curve_point(r,n[1]),c=a.core.Vec.sub(o,t);return a.core.Vec.dot(c,c)},i=a.core.Numeric.uncmin(c,[n,o],t),s=i.solution[0],u=i.solution[1],l=a.core.Eval.rational_curve_point(e,s),h=a.core.Eval.rational_curve_point(r,u);return new a.core.types.CurveCurveIntersection(l,h,s,u)},a.core.Intersect.triangles=function(e,r,n,o){var t=e.faces[r],c=n.faces[o],i=a.core.Mesh.get_tri_norm(e.points,t),s=a.core.Mesh.get_tri_norm(n.points,c),u=e.points[t[0]],l=n.points[c[0]],h=a.core.Intersect.planes(u,i,l,s);if(null==h)return null;var v=a.core.Intersect.clip_ray_in_coplanar_tri(h,e,r);if(null==v)return null;var f=a.core.Intersect.clip_ray_in_coplanar_tri(h,n,o);if(null==f)return null;var d=a.core.Intersect.merge_tri_clip_intervals(v,f,e,r,n,o);return null==d?null:new a.core.types.Interval(new a.core.types.MeshIntersectionPoint(d.min.uv0,d.min.uv1,d.min.point,r,o),new a.core.types.MeshIntersectionPoint(d.max.uv0,d.max.uv1,d.max.point,r,o))},a.core.Intersect.clip_ray_in_coplanar_tri=function(e,r,n){for(var o=r.faces[n],t=[r.points[o[0]],r.points[o[1]],r.points[o[2]]],c=[r.uvs[o[0]],r.uvs[o[1]],r.uvs[o[2]]],i=[a.core.Vec.sub(c[1],c[0]),a.core.Vec.sub(c[2],c[1]),a.core.Vec.sub(c[0],c[2])],s=[a.core.Vec.sub(t[1],t[0]),a.core.Vec.sub(t[2],t[1]),a.core.Vec.sub(t[0],t[2])],u=s.map(a.core.Vec.normalized),l=s.map(a.core.Vec.norm),h=null,v=null,f=0;3>f;){var d=f++,_=t[d],p=u[d],m=a.core.Intersect.rays(_,p,e.origin,e.dir);if(null!=m){var g=m.u0,V=m.u1;-a.core.Constants.EPSILON>g||g>l[d]+a.core.Constants.EPSILON||((null==h||h.u>V)&&(h=new a.core.types.CurveTriPoint(V,a.core.Vec.onRay(e.origin,e.dir,V),a.core.Vec.onRay(c[d],i[d],g/l[d]))),(null==v||V>v.u)&&(v=new a.core.types.CurveTriPoint(V,a.core.Vec.onRay(e.origin,e.dir,V),a.core.Vec.onRay(c[d],i[d],g/l[d]))))}}return null==v||null==h?null:new a.core.types.Interval(h,v)},a.core.Intersect.merge_tri_clip_intervals=function(e,r,n,o,t,c){if(r.min.u>e.max.u+a.core.Constants.EPSILON||e.min.u>r.max.u+a.core.Constants.EPSILON)return null;var i;i=e.min.u>r.min.u?new a.core.types.Pair(e.min,0):new a.core.types.Pair(r.min,1);var s;s=e.max.u<r.max.u?new a.core.types.Pair(e.max,0):new a.core.types.Pair(r.max,1);var u=new a.core.types.Interval(new a.core.types.MeshIntersectionPoint(null,null,i.item0.point,o,c),new a.core.types.MeshIntersectionPoint(null,null,s.item0.point,o,c));return 0==i.item1?(u.min.uv0=i.item0.uv,u.min.uv1=a.core.Mesh.tri_uv_from_point(t,c,i.item0.point)):(u.min.uv0=a.core.Mesh.tri_uv_from_point(n,o,i.item0.point),u.min.uv1=i.item0.uv),0==s.item1?(u.max.uv0=s.item0.uv,u.max.uv1=a.core.Mesh.tri_uv_from_point(t,c,s.item0.point)):(u.max.uv0=a.core.Mesh.tri_uv_from_point(n,o,s.item0.point),u.max.uv1=s.item0.uv),u},a.core.Intersect.planes=function(e,r,n,o){var t=a.core.Vec.cross(r,o);if(a.core.Vec.dot(t,t)<a.core.Constants.EPSILON)return null;var c=0,i=Math.abs(t[0]),s=Math.abs(t[1]),u=Math.abs(t[2]);s>i&&(c=1,i=s),u>i&&(c=2,i=u);var l,h,v,f;0==c?(l=r[1],h=r[2],v=o[1],f=o[2]):1==c?(l=r[0],h=r[2],v=o[0],f=o[2]):(l=r[0],h=r[1],v=o[0],f=o[1]);var d,_=-a.core.Vec.dot(e,r),p=-a.core.Vec.dot(n,o),m=l*f-h*v,g=(h*p-_*f)/m,V=(_*v-l*p)/m;return d=0==c?[0,g,V]:1==c?[g,0,V]:[g,V,0],new a.core.types.Ray(d,a.core.Vec.normalized(t))},a.core.Intersect.three_planes=function(e,r,n,o,t,c){var i=a.core.Vec.cross(n,t),s=a.core.Vec.dot(e,i);if(Math.abs(s)<a.core.Constants.EPSILON)return null;var u=a.core.Vec.sub(a.core.Vec.mul(c,n),a.core.Vec.mul(o,t)),l=a.core.Vec.add(a.core.Vec.mul(r,i),a.core.Vec.cross(e,u));return a.core.Vec.mul(1/s,l)},a.core.Intersect.polylines=function(e,r,n){for(var o=a.core.Intersect.bounding_box_trees(new a.core.types.LazyPolylineBoundingBoxTree(e),new a.core.types.LazyPolylineBoundingBoxTree(r),n),t=[],c=0;o.length>c;){var i=o[c];++c;var s=i.item0,u=i.item1,l=a.core.Intersect.segments(e.points[s],e.points[s+1],r.points[u],r.points[u+1],n);null!=l&&(l.u0=a.core.Vec.lerp(l.u0,[e.params[s]],[e.params[s+1]])[0],l.u1=a.core.Vec.lerp(l.u1,[r.params[u]],[r.params[u+1]])[0],t.push(l))}return t},a.core.Intersect.segments=function(e,r,n,o,t){var c=a.core.Vec.sub(r,e),i=Math.sqrt(a.core.Vec.dot(c,c)),s=a.core.Vec.mul(1/i,c),u=a.core.Vec.sub(o,n),l=Math.sqrt(a.core.Vec.dot(u,u)),h=a.core.Vec.mul(1/l,u),v=a.core.Intersect.rays(e,s,n,h);if(null!=v){var f=Math.min(Math.max(0,v.u0/i),1),d=Math.min(Math.max(0,v.u1/l),1),_=a.core.Vec.onRay(e,c,f),p=a.core.Vec.onRay(n,u,d),m=a.core.Vec.distSquared(_,p);if(t*t>m)return new a.core.types.CurveCurveIntersection(_,p,f,d)}return null},a.core.Intersect.rays=function(e,r,n,o){var t=a.core.Vec.dot(r,o),c=a.core.Vec.dot(r,n),i=a.core.Vec.dot(r,e),s=a.core.Vec.dot(o,n),u=a.core.Vec.dot(o,e),l=a.core.Vec.dot(r,r),h=a.core.Vec.dot(o,o),v=l*h-t*t;if(Math.abs(v)<a.core.Constants.EPSILON)return null;var f=t*(c-i)-l*(s-u),d=f/v,_=(c-i+d*t)/l,p=a.core.Vec.onRay(e,r,_),m=a.core.Vec.onRay(n,o,d);return new a.core.types.CurveCurveIntersection(p,m,_,d)},a.core.Intersect.segment_with_tri=function(e,r,n,o){var t=n[o[0]],c=n[o[1]],i=n[o[2]],s=a.core.Vec.sub(c,t),u=a.core.Vec.sub(i,t),l=a.core.Vec.cross(s,u),h=a.core.Vec.sub(r,e),v=a.core.Vec.sub(e,t),f=-a.core.Vec.dot(l,v),d=a.core.Vec.dot(l,h);if(Math.abs(d)<a.core.Constants.EPSILON)return null;var _=f/d;if(0>_||_>1)return null;var p=a.core.Vec.add(e,a.core.Vec.mul(_,h)),m=a.core.Vec.dot(s,u),g=a.core.Vec.dot(s,s),V=a.core.Vec.dot(u,u),y=a.core.Vec.sub(p,t),b=a.core.Vec.dot(y,s),x=a.core.Vec.dot(y,u),E=m*m-g*V;if(Math.abs(E)<a.core.Constants.EPSILON)return null;var M=(m*x-V*b)/E,k=(m*b-g*x)/E;return M>1+a.core.Constants.EPSILON||k>1+a.core.Constants.EPSILON||-a.core.Constants.EPSILON>k||-a.core.Constants.EPSILON>M||M+k>1+a.core.Constants.EPSILON?null:new a.core.types.TriSegmentIntersection(p,M,k,_)},a.core.Intersect.segment_with_plane=function(e,r,n,o){var t=a.core.Vec.dot(o,a.core.Vec.sub(e,r));if(Math.abs(t)<a.core.Constants.EPSILON)return null;var c=a.core.Vec.dot(o,a.core.Vec.sub(n,e));return{p:c/t}},a.core.KdPoint=e.core.KdPoint=function(e,r){this.point=e,this.obj=r},a.core.KdNode=e.core.KdNode=function(e,r,n){this.kdPoint=e,this.left=null,this.right=null,this.parent=n,this.dimension=r},a.core.KdTree=e.core.KdTree=function(e,r){this.dim=3,this.points=e,this.distanceFunction=r,this.dim=e[0].point.length,this.root=this.buildTree(e,0,null)},a.core.KdTree.prototype={buildTree:function(e,r,n){var o,t,c=r%this.dim;return 0==e.length?null:1==e.length?new a.core.KdNode(e[0],c,n):(e.sort(function(e,r){var n=e.point[c]-r.point[c];return 0==n?0:n>0?1:-1}),o=Math.floor(e.length/2),t=new a.core.KdNode(e[o],c,n),t.left=this.buildTree(e.slice(0,o),r+1,t),t.right=this.buildTree(e.slice(o+1),r+1,t),t)},nearest:function(e,r,n){var o,t=this,c=new a.core.BinaryHeap(function(e){return-e.item1}),i=null;if(i=function(n){for(var o,s,u=n.dimension,l=t.distanceFunction(e,n.kdPoint.point),h=[],v=0,f=t.dim;f>v;)v++,h.push(0);s=h;for(var d,_,p=function(e,n){c.push(new a.core.types.Pair(e,n)),c.size()>r&&c.pop()},m=0,g=t.dim;g>m;){var V=m++;s[V]=V==n.dimension?e[V]:n.kdPoint.point[V]}return d=t.distanceFunction(s,n.kdPoint.point),null==n.right&&null==n.left?((r>c.size()||c.peek().item1>l)&&p(n,l),void 0):(o=null==n.right?n.left:null==n.left?n.right:e[u]<n.kdPoint.point[u]?n.left:n.right,i(o),(r>c.size()||c.peek().item1>l)&&p(n,l),(r>c.size()||Math.abs(d)<c.peek().item1)&&(_=o==n.left?n.right:n.left,null!=_&&i(_)),void 0)
},o=i,null!=n)for(var s=0;r>s;)s++,c.push(new a.core.types.Pair(null,n));o(this.root);for(var u=[],l=0;r>l;){var h=l++;null!=c.content[h].item0&&u.push(new a.core.types.Pair(c.content[h].item0.kdPoint,c.content[h].item1))}return u}},a.core.BinaryHeap=function(e){this.content=[],this.scoreFunction=e},a.core.BinaryHeap.prototype={push:function(e){this.content.push(e),this.bubbleUp(this.content.length-1)},pop:function(){var e=this.content[0],r=this.content.pop();return this.content.length>0&&(this.content[0]=r,this.sinkDown(0)),e},peek:function(){return this.content[0]},remove:function(e){for(var r=this.content.length,n=0;r>n;){var o=n++;if(this.content[o]==e){var t=this.content.pop();return o!=r-1&&(this.content[o]=t,this.scoreFunction(t)<this.scoreFunction(e)?this.bubbleUp(o):this.sinkDown(o)),void 0}}throw"Node not found."},size:function(){return this.content.length},bubbleUp:function(e){for(var r=this.content[e];e>0;){var n=Math.floor((e+1)/2)-1,o=this.content[n];if(!(this.scoreFunction(r)<this.scoreFunction(o)))break;this.content[n]=r,this.content[e]=o,e=n}},sinkDown:function(e){for(var r=this.content.length,n=this.content[e],o=this.scoreFunction(n);;){var t=2*(e+1),c=t-1,i=null,s=0;if(r>c){var a=this.content[c];s=this.scoreFunction(a),o>s&&(i=c)}if(r>t){var u=this.content[t],l=this.scoreFunction(u);(null==i?o:s)>l&&(i=t)}if(null==i)break;this.content[e]=this.content[i],this.content[i]=n,e=i}}},a.core.Make=e.core.Make=function(){},a.core.Make.four_point_surface=function(e,r,n,o,t){null==t&&(t=3);for(var c=t,i=[],s=0,u=t+1;u>s;){for(var l=s++,h=[],v=0,f=t+1;f>v;){var d=v++,_=1-l/c,p=a.core.Vec.lerp(_,e,r),m=a.core.Vec.lerp(_,o,n),g=a.core.Vec.lerp(1-d/c,p,m);g.push(1),h.push(g)}i.push(h)}var V=a.core.Vec.rep(t+1,0),y=a.core.Vec.rep(t+1,1);return new a.core.types.SurfaceData(t,t,V.concat(y),V.concat(y),i)},a.core.Make.sweep1_surface=function(e,r){for(var n=a.core.Eval.rational_curve_point(r,0),o=1/r.controlPoints.length,t=[],c=[],i=a.core.Eval.weight_1d(r.controlPoints),s=a.core.Eval.weight_1d(e.controlPoints),u=a.core.Eval.dehomogenize_1d(e.controlPoints),l=0,h=r.controlPoints.length;h>l;){for(var v=l++,f=a.core.Eval.rational_curve_point(r,v*o),d=a.core.Vec.sub(f,n),_=[],p=[],m=0,g=e.controlPoints.length;g>m;){var V=m++;_.push(a.core.Vec.add(d,u[V])),p.push(s[V]*i[v])}t.push(_),c.push(p)}return new a.core.types.SurfaceData(r.degree,e.degree,r.knots,e.knots,a.core.Eval.homogenize_2d(t,c))},a.core.Make.ellipse_arc=function(e,r,n,o,t,c,i){c>i&&(i=2*Math.PI+c);var s=i-c,u=0;u=Math.PI/2>=s?1:Math.PI>=s?2:3*Math.PI/2>=s?3:4;var l=s/u,h=Math.cos(l/2),v=a.core.Vec.add(e,a.core.Vec.add(a.core.Vec.mul(o*Math.cos(c),r),a.core.Vec.mul(t*Math.sin(c),n))),f=a.core.Vec.sub(a.core.Vec.mul(Math.cos(c),n),a.core.Vec.mul(Math.sin(c),r)),d=[],_=a.core.Vec.zeros1d(2*u+3),p=0,m=c,g=a.core.Vec.zeros1d(2*u);d[0]=v,g[0]=1;for(var V=1,y=u+1;y>V;){var b=V++;m+=l;var x=a.core.Vec.add(e,a.core.Vec.add(a.core.Vec.mul(o*Math.cos(m),r),a.core.Vec.mul(t*Math.sin(m),n)));g[p+2]=1,d[p+2]=x;var E=a.core.Vec.sub(a.core.Vec.mul(Math.cos(m),n),a.core.Vec.mul(Math.sin(m),r)),M=a.core.Intersect.rays(v,a.core.Vec.mul(1/a.core.Vec.norm(f),f),x,a.core.Vec.mul(1/a.core.Vec.norm(E),E)),k=a.core.Vec.add(v,a.core.Vec.mul(M.u0,f));g[p+1]=h,d[p+1]=k,p+=2,u>b&&(v=x,f=E)}for(var I=2*u+1,B=0;3>B;){var P=B++;_[P]=0,_[P+I]=1}switch(u){case 2:_[3]=_[4]=.5;break;case 3:_[3]=_[4]=.3333333333333333,_[5]=_[6]=.6666666666666666;break;case 4:_[3]=_[4]=.25,_[5]=_[6]=.5,_[7]=_[8]=.75}return new a.core.types.CurveData(2,_,a.core.Eval.homogenize_1d(d,g))},a.core.Make.arc=function(e,r,n,o,t,c){return a.core.Make.ellipse_arc(e,r,n,o,o,t,c)},a.core.Make.polyline_curve=function(e){for(var r=[0,0],n=0,o=0,t=e.length-1;t>o;){var c=o++;n+=a.core.Vec.dist(e[c],e[c+1]),r.push(n)}r.push(n),r=a.core.Vec.mul(1/n,r);for(var i,s=[],u=0,l=e.length;l>u;)u++,s.push(1);return i=s,new a.core.types.CurveData(1,r,a.core.Eval.homogenize_1d(e.slice(0),i))},a.core.Make.extruded_surface=function(e,r,n){for(var o=[[],[],[]],t=[[],[],[]],c=a.core.Eval.dehomogenize_1d(n.controlPoints),i=a.core.Eval.weight_1d(n.controlPoints),s=a.core.Vec.mul(r,e),u=a.core.Vec.mul(.5*r,e),l=0,h=c.length;h>l;){var v=l++;o[2][v]=c[v],o[1][v]=a.core.Vec.add(u,c[v]),o[0][v]=a.core.Vec.add(s,c[v]),t[0][v]=i[v],t[1][v]=i[v],t[2][v]=i[v]}return new a.core.types.SurfaceData(2,n.degree,[0,0,0,1,1,1],n.knots,a.core.Eval.homogenize_2d(o,t))},a.core.Make.cylinder_surface=function(e,r,n,o,t){var c=a.core.Vec.cross(e,r);2*Math.PI;var i=a.core.Make.arc(n,r,c,t,0,2*Math.PI);return a.core.Make.extruded_surface(e,o,i)},a.core.Make.revolved_surface=function(e,r,n,o){var t,c,i=a.core.Eval.dehomogenize_1d(o.controlPoints),s=a.core.Eval.weight_1d(o.controlPoints);Math.PI/2>=n?(t=1,c=a.core.Vec.zeros1d(6+2*(t-1))):Math.PI>=n?(t=2,c=a.core.Vec.zeros1d(6+2*(t-1)),c[3]=c[4]=.5):3*Math.PI/2>=n?(t=3,c=a.core.Vec.zeros1d(6+2*(t-1)),c[3]=c[4]=.3333333333333333,c[5]=c[6]=.6666666666666666):(t=4,c=a.core.Vec.zeros1d(6+2*(t-1)),c[3]=c[4]=.25,c[5]=c[6]=.5,c[7]=c[8]=.75);for(var u=n/t,l=3+2*(t-1),h=0;3>h;){var v=h++;c[v]=0,c[l+v]=1}for(var f=Math.cos(u/2),d=0,_=a.core.Vec.zeros1d(t+1),p=a.core.Vec.zeros1d(t+1),m=a.core.Vec.zeros3d(2*t+1,i.length,3),g=a.core.Vec.zeros2d(2*t+1,i.length),V=1,y=t+1;y>V;){var b=V++;d+=u,p[b]=Math.cos(d),_[b]=Math.sin(d)}for(var x=0,E=i.length;E>x;){var M=x++,k=a.core.Trig.closest_point_on_ray(i[M],e,r),I=a.core.Vec.sub(i[M],k),B=a.core.Vec.norm(I),P=a.core.Vec.cross(r,I);B>a.core.Constants.EPSILON&&(I=a.core.Vec.mul(1/B,I),P=a.core.Vec.mul(1/B,P)),m[0][M]=i[M];var z=i[M];g[0][M]=s[M];for(var w=P,T=0,N=1,S=t+1;S>N;){var C,L=N++;C=0==B?k:a.core.Vec.add(k,a.core.Vec.add(a.core.Vec.mul(B*p[L],I),a.core.Vec.mul(B*_[L],P))),m[T+2][M]=C,g[T+2][M]=s[M];var A=a.core.Vec.sub(a.core.Vec.mul(p[L],P),a.core.Vec.mul(_[L],I));if(0==B)m[T+1][M]=k;else{var D=a.core.Intersect.rays(z,a.core.Vec.mul(1/a.core.Vec.norm(w),w),C,a.core.Vec.mul(1/a.core.Vec.norm(A),A)),U=a.core.Vec.add(z,a.core.Vec.mul(D.u0,w));m[T+1][M]=U}g[T+1][M]=f*s[M],T+=2,t>L&&(z=C,w=A)}}return new a.core.types.SurfaceData(2,o.degree,c,o.knots,a.core.Eval.homogenize_2d(m,g))},a.core.Make.sphere_surface=function(e,r,n,o){var t=a.core.Make.arc(e,a.core.Vec.mul(-1,r),n,o,0,Math.PI);return a.core.Make.revolved_surface(e,r,2*Math.PI,t)},a.core.Make.cone_surface=function(e,r,n,o,t){var c=2*Math.PI,i=1,s=[a.core.Vec.add(n,a.core.Vec.mul(o,e)),a.core.Vec.add(n,a.core.Vec.mul(t,r))],u=[0,0,1,1],l=[1,1],h=new a.core.types.CurveData(i,u,a.core.Eval.homogenize_1d(s,l));return a.core.Make.revolved_surface(n,e,c,h)},a.core.Make.rational_interp_curve=function(e,r,n,o){if(null==r&&(r=3),r+1>e.length)throw"You need to supply at least degree + 1 points!";for(var t=[0],c=1,i=e.length;i>c;){var s=c++,u=a.core.Vec.norm(a.core.Vec.sub(e[s],e[s-1])),l=t[t.length-1];t.push(l+u)}for(var h=t[t.length-1],v=0,f=t.length;f>v;){var d=v++;t[d]=t[d]/h}var _,p=a.core.Vec.rep(r+1,0),m=null!=n&&null!=o;_=m?0:1;var g;g=m?t.length-r+1:t.length-r;for(var V=_;g>V;){for(var y=V++,b=0,x=0;r>x;){var E=x++;b+=t[y+E]}p.push(1/r*b)}var M,k=p.concat(a.core.Vec.rep(r+1,1)),I=[];M=m?e.length+1:e.length-1;var B;B=m?1:0;var P;P=m?e.length-(r-1):e.length-(r+1);for(var z=0;t.length>z;){var w=t[z];++z;var T=a.core.Eval.knot_span_given_n(M,r,w,k),N=a.core.Eval.basis_functions_given_knot_span_index(T,w,r,k),S=T-r,C=a.core.Vec.zeros1d(S),L=a.core.Vec.zeros1d(P-S);I.push(C.concat(N).concat(L))}if(m){var A=I[0].length-2,D=[-1,1].concat(a.core.Vec.zeros1d(A)),U=a.core.Vec.zeros1d(A).concat([-1,1]);a.core.ArrayExtensions.spliceAndInsert(I,1,0,D),a.core.ArrayExtensions.spliceAndInsert(I,I.length-1,0,U)}for(var O=e[0].length,R=[],q=(1-k[k.length-r-2])/r,F=k[r+1]/r,K=0;O>K;){var j,Y=[K++];if(m){j=[e[0][Y[0]]],j.push(F*n[Y[0]]);for(var H=1,W=e.length-1;W>H;){var G=H++;j.push(e[G][Y[0]])}j.push(q*o[Y[0]]),j.push(e[e.length-1][Y[0]])}else j=e.map(function(e){return function(r){return r[e[0]]}}(Y));var Z=a.core.Mat.solve(I,j);R.push(Z)}var J=a.core.Mat.transpose(R),Q=a.core.Vec.rep(J.length,1);return new a.core.types.CurveData(r,k,a.core.Eval.homogenize_1d(J,Q))},a.core.LUDecomp=function(e,r){this.LU=e,this.P=r},a.core.Mat=e.core.Mat=function(){},a.core.Mat.mul=function(e,r){for(var n=[],o=0,t=r.length;t>o;){var c=o++;n.push(a.core.Vec.mul(e,r[c]))}return n},a.core.Mat.add=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(a.core.Vec.add(e[c],r[c]))}return n},a.core.Mat.div=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(a.core.Vec.div(e[c],r))}return n},a.core.Mat.sub=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(a.core.Vec.sub(e[c],r[c]))}return n},a.core.Mat.dot=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(a.core.Vec.dot(e[c],r))}return n},a.core.Mat.identity=function(e){for(var r=a.core.Vec.zeros2d(e,e),n=0;e>n;){var o=n++;r[o][o]=1}return r},a.core.Mat.transpose=function(e){if(0==e.length)return[];for(var r=[],n=0,o=e[0].length;o>n;){var t=n++;r.push(function(){for(var r,n=[],o=0,c=e.length;c>o;){var i=o++;n.push(e[i][t])}return r=n}(this))}return r},a.core.Mat.solve=function(e,r){return a.core.Mat.LUsolve(a.core.Mat.LU(e),r)},a.core.Mat.LUsolve=function(e,r){var n,o,t,c,i,s=e.LU,a=s.length,u=r.slice(),l=e.P;for(n=a-1;-1!=n;)u[n]=r[n],--n;for(n=0;a>n;){for(t=l[n],l[n]!=n&&(i=u[n],u[n]=u[t],u[t]=i),c=s[n],o=0;n>o;)u[n]-=u[o]*c[o],++o;++n}for(n=a-1;n>=0;){for(c=s[n],o=n+1;a>o;)u[n]-=u[o]*c[o],++o;u[n]/=c[n],--n}return u},a.core.Mat.LU=function(e){Math.abs;for(var r,n,o,t,c,i,s,u,l,h=[],v=0,f=e.length;f>v;){var d=v++;h.push(e[d].slice())}e=h;var _=e.length,p=_-1,m=[];for(o=0;_>o;){for(s=o,i=e[o],l=Math.abs(i[o]),n=o+1;_>n;)t=Math.abs(e[n][o]),t>l&&(l=t,s=n),++n;for(m[o]=s,s!=o&&(e[o]=e[s],e[s]=i,i=e[o]),c=i[o],r=o+1;_>r;)e[r][o]/=c,++r;for(r=o+1;_>r;){for(u=e[r],n=o+1;p>n;)u[n]-=u[o]*i[n],++n,u[n]-=u[o]*i[n],++n;n==p&&(u[n]-=u[o]*i[n]),++r}++o}return new a.core.LUDecomp(e,m)},a.core.Mesh=e.core.Mesh=function(){},a.core.Mesh.get_tri_norm=function(e,r){var n=e[r[0]],o=e[r[1]],t=e[r[2]],c=a.core.Vec.sub(o,n),i=a.core.Vec.sub(t,n),s=a.core.Vec.cross(c,i);return a.core.Vec.mul(1/a.core.Vec.norm(s),s)},a.core.Mesh.make_mesh_aabb=function(e,r){for(var n=new a.BoundingBox,o=0;r.length>o;){var t=r[o];++o,n.add(e.points[e.faces[t][0]]),n.add(e.points[e.faces[t][1]]),n.add(e.points[e.faces[t][2]])}return n},a.core.Mesh.make_mesh_aabb_tree=function(e,r){var n=a.core.Mesh.make_mesh_aabb(e,r);if(1==r.length)return new a.core.types.BoundingBoxLeaf(n,r[0]);var o=a.core.Mesh.sort_tris_on_longest_axis(n,e,r),t=a.core.ArrayExtensions.left(o),c=a.core.ArrayExtensions.right(o);return new a.core.types.BoundingBoxInnerNode(n,[a.core.Mesh.make_mesh_aabb_tree(e,t),a.core.Mesh.make_mesh_aabb_tree(e,c)])},a.core.Mesh.sort_tris_on_longest_axis=function(e,r,n){for(var o=e.getLongestAxis(),t=[],c=0;n.length>c;){var i=n[c];++c;var s=a.core.Mesh.get_min_coordinate_on_axis(r.points,r.faces[i],o);t.push(new a.core.types.Pair(s,i))}t.sort(function(e,r){var n=e.item0,o=r.item0;return n==o?0:n>o?1:-1});for(var u=[],l=0,h=t.length;h>l;){var v=l++;u.push(t[v].item1)}return u},a.core.Mesh.get_min_coordinate_on_axis=function(e,r,n){for(var o=Math.POSITIVE_INFINITY,t=0;3>t;){var c=t++,i=e[r[c]][n];o>i&&(o=i)}return o},a.core.Mesh.get_tri_centroid=function(e,r){for(var n=[0,0,0],o=0;3>o;)for(var t=o++,c=0;3>c;){var i=c++;n[i]+=e[r[t]][i]}for(var s=0;3>s;){var a=s++;n[a]/=3}return n},a.core.Mesh.tri_uv_from_point=function(e,r,n){var o=e.faces[r],t=e.points[o[0]],c=e.points[o[1]],i=e.points[o[2]],s=e.uvs[o[0]],u=e.uvs[o[1]],l=e.uvs[o[2]],h=a.core.Vec.sub(t,n),v=a.core.Vec.sub(c,n),f=a.core.Vec.sub(i,n),d=a.core.Vec.norm(a.core.Vec.cross(a.core.Vec.sub(t,c),a.core.Vec.sub(t,i))),_=a.core.Vec.norm(a.core.Vec.cross(v,f))/d,p=a.core.Vec.norm(a.core.Vec.cross(f,h))/d,m=a.core.Vec.norm(a.core.Vec.cross(h,v))/d;return a.core.Vec.add(a.core.Vec.mul(_,s),a.core.Vec.add(a.core.Vec.mul(p,u),a.core.Vec.mul(m,l)))},a.core.KnotMultiplicity=e.core.KnotMultiplicity=function(e,r){this.knot=e,this.mult=r},a.core.KnotMultiplicity.prototype={inc:function(){this.mult++}},a.core.Modify=e.core.Modify=function(){},a.core.Modify.surface_knot_refine=function(e,r,n){var o,t,c,i=[];n?(c=e.controlPoints,o=e.knotsV,t=e.degreeV):(c=a.core.Mat.transpose(e.controlPoints),o=e.knotsU,t=e.degreeU);for(var s=null,u=0;c.length>u;){var l=c[u];++u,s=a.core.Modify.curve_knot_refine(new a.core.types.CurveData(t,o,l),r),i.push(s.controlPoints)}var h=s.knots;return n?new a.core.types.SurfaceData(e.degreeU,e.degreeV,e.knotsU.slice(),h,i):(i=a.core.Mat.transpose(i),new a.core.types.SurfaceData(e.degreeU,e.degreeV,h,e.knotsV.slice(),i))},a.core.Modify.surface_split=function(e,r,n){null==n&&(n=!1);var o,t,c;n?(c=e.controlPoints,o=e.knotsV,t=e.degreeV):(c=a.core.Mat.transpose(e.controlPoints),o=e.knotsU,t=e.degreeU);for(var i,s=[],u=0,l=t+1;l>u;)u++,s.push(r);i=s;for(var h=[],v=[],f=a.core.Eval.knot_span(t,r,o),d=null,_=0;c.length>_;){var p=c[_];++_,d=a.core.Modify.curve_knot_refine(new a.core.types.CurveData(t,o,p),i),h.push(d.controlPoints.slice(0,f+1)),v.push(d.controlPoints.slice(f+1))}var m=d.knots.slice(0,f+t+2),g=d.knots.slice(f+1);return n?[new a.core.types.SurfaceData(e.degreeU,t,e.knotsU.slice(),m,h),new a.core.types.SurfaceData(e.degreeU,t,e.knotsU.slice(),g,v)]:(h=a.core.Mat.transpose(h),v=a.core.Mat.transpose(v),[new a.core.types.SurfaceData(t,e.degreeV,m,e.knotsV.slice(),h),new a.core.types.SurfaceData(t,e.degreeV,g,e.knotsV.slice(),v)])},a.core.Modify.curve_bezier_decompose=function(e){for(var r=e.degree,n=e.controlPoints,o=e.knots,t=a.core.Modify.knot_multiplicities(o),c=r+1,i=0;t.length>i;){var s=t[i];if(++i,c>s.mult){var u=a.core.Vec.rep(c-s.mult,s.knot),l=a.core.Modify.curve_knot_refine(new a.core.types.CurveData(r,o,n),u);o=l.knots,n=l.controlPoints}}o.length/c-1;for(var h=2*c,v=[],f=0;n.length>f;){var d=o.slice(f,f+h),_=n.slice(f,f+c);v.push(new a.core.types.CurveData(r,d,_)),f+=c}return v},a.core.Modify.knot_multiplicities=function(e){for(var r=[new a.core.KnotMultiplicity(e[0],0)],n=r[0],o=0;e.length>o;){var t=e[o];++o,Math.abs(t-n.knot)>a.core.Constants.EPSILON&&(n=new a.core.KnotMultiplicity(t,0),r.push(n)),n.inc()}return r},a.core.Modify.curve_split=function(e,r){var n=e.degree;e.controlPoints;for(var o,t=e.knots,c=[],i=0,s=n+1;s>i;)i++,c.push(r);o=c;var u=a.core.Modify.curve_knot_refine(e,o),l=a.core.Eval.knot_span(n,r,t),h=u.knots.slice(0,l+n+2),v=u.knots.slice(l+1),f=u.controlPoints.slice(0,l+1),d=u.controlPoints.slice(l+1);return[new a.core.types.CurveData(n,h,f),new a.core.types.CurveData(n,v,d)]},a.core.Modify.curve_knot_refine=function(e,r){for(var n=e.degree,o=e.controlPoints,t=e.knots,c=o.length-1,i=c+n+1,s=r.length-1,u=a.core.Eval.knot_span(n,r[0],t),l=a.core.Eval.knot_span(n,r[s],t),h=[],v=[],f=0,d=u-n+1;d>f;){var _=f++;h[_]=o[_]}for(var p=l-1,m=c+1;m>p;){var g=p++;h[g+s+1]=o[g]}for(var V=0,y=u+1;y>V;){var b=V++;v[b]=t[b]}for(var x=l+n,E=i+1;E>x;){var M=x++;v[M+s+1]=t[M]}for(var k=l+n-1,I=l+n+s,B=s;B>=0;){for(;r[B]<=t[k]&&k>u;)h[I-n-1]=o[k-n-1],v[I]=t[k],I-=1,k-=1;h[I-n-1]=h[I-n];for(var P=1,z=n+1;z>P;){var w=P++,T=I-n+w,N=v[I+w]-r[B];Math.abs(N)<a.core.Constants.EPSILON?h[T-1]=h[T]:(N/=v[I+w]-t[k-n+w],h[T-1]=a.core.Vec.add(a.core.Vec.mul(N,h[T-1]),a.core.Vec.mul(1-N,h[T])))}v[I]=r[B],I-=1,B--}return new a.core.types.CurveData(n,v,h)},a.core.Modify.curve_knot_insert=function(e,r,n){for(var o=e.degree,t=e.controlPoints,c=e.knots,i=0,s=t.length,u=a.core.Eval.knot_span(o,r,c),l=[],h=[],v=[],f=1,d=u+1;d>f;){var _=f++;h[_]=c[_]}for(var p=1,m=n+1;m>p;){var g=p++;h[u+g]=r}for(var V=u+1,y=c.length;y>V;){var b=V++;h[b+n]=c[b]}for(var x=0,E=u-o+1;E>x;){var M=x++;v[M]=t[M]}for(var k=u-i;s>k;){var I=k++;v[I+n]=t[I]}for(var B=0,P=o-i+1;P>B;){var z=B++;l[z]=t[u-o+z]}for(var w=0,T=0,N=1,S=n+1;S>N;){var C=N++;w=u-o+C;for(var L=0,A=o-C-i+1;A>L;){var D=L++;T=(r-c[w+D])/(c[D+u+1]-c[w+D]),l[D]=a.core.Vec.add(a.core.Vec.mul(T,l[D+1]),a.core.Vec.mul(1-T,l[D]))}v[w]=l[0],v[u+n-C-i]=l[o-C-i]}for(var U=w+1,O=u-i;O>U;){var R=U++;v[R]=l[R-w]}return new a.core.types.CurveData(o,h,v)},a.core.MinimizationResult=function(e,r,n,o,t,c){this.solution=e,this.value=r,this.gradient=n,this.invHessian=o,this.iterations=t,this.message=c},a.core.Numeric=function(){},a.core.Numeric.numericalGradient=function(e,r){var n=r.length,o=e(r);if(o==Math.NaN)throw"gradient: f(x) is a NaN!";for(var t,c,i,s,u,l,h,v,f,d=r.slice(0),_=[],p=.001,m=0,g=0;n>g;)for(var V=g++,y=Math.max(1e-6*o,1e-8);;){if(++m,m>20)throw"Numerical gradient fails";if(d[V]=r[V]+y,t=e(d),d[V]=r[V]-y,c=e(d),d[V]=r[V],Math.isNaN(t)||Math.isNaN(c))y/=16;else{if(_[V]=(t-c)/(2*y),s=r[V]-y,u=r[V],l=r[V]+y,h=(t-o)/y,v=(o-c)/y,f=a.core.Vec.max([Math.abs(_[V]),Math.abs(o),Math.abs(t),Math.abs(c),Math.abs(s),Math.abs(u),Math.abs(l),1e-8]),i=Math.min(a.core.Vec.max([Math.abs(h-_[V]),Math.abs(v-_[V]),Math.abs(h-v)])/f,y/f),!(i>p))break;y/=16}}return _},a.core.Numeric.uncmin=function(e,r,n,o,t){null==n&&(n=1e-8),null==o&&(o=function(r){return a.core.Numeric.numericalGradient(e,r)}),null==t&&(t=1e3),r=r.slice(0);var c,i=r.length,s=e(r),u=s;if(Math.isNaN(s))throw"uncmin: f(x0) is a NaN!";n=Math.max(n,a.core.Constants.EPSILON);var l,h,v,f,d,_,p,m,g,V=a.core.Mat.identity(i),y=0,b=[],x="";for(h=o(r);t>y;){if(!a.core.Vec.all(a.core.Vec.finite(h))){x="Gradient has Infinity or NaN";break}if(l=a.core.Vec.neg(a.core.Mat.dot(V,h)),!a.core.Vec.all(a.core.Vec.finite(l))){x="Search direction has Infinity or NaN";break}if(g=a.core.Vec.norm(l),n>g){x="Newton step smaller than tol";break}for(m=1,c=a.core.Vec.dot(h,l),f=r;t>y&&!(n>m*g)&&(b=a.core.Vec.mul(m,l),f=a.core.Vec.add(r,b),u=e(f),u-s>=.1*m*c||Math.isNaN(u));)m*=.5,++y;if(n>m*g){x="Line search step size smaller than tol";break}if(y==t){x="maxit reached during line search";break}v=o(f),d=a.core.Vec.sub(v,h),p=a.core.Vec.dot(d,b),_=a.core.Mat.dot(V,d),V=a.core.Mat.sub(a.core.Mat.add(V,a.core.Mat.mul((p+a.core.Vec.dot(d,_))/(p*p),a.core.Numeric.tensor(b,b))),a.core.Mat.div(a.core.Mat.add(a.core.Numeric.tensor(_,b),a.core.Numeric.tensor(b,_)),p)),r=f,s=u,h=v,++y}return new a.core.MinimizationResult(r,s,h,V,y,x)},a.core.Numeric.tensor=function(e,r){for(var n,o,t=e.length,c=r.length,i=[],s=t-1;s>=0;){n=[],o=e[s];for(var a=c-1;a>=3;)n[a]=o*r[a],--a,n[a]=o*r[a],--a,n[a]=o*r[a],--a,n[a]=o*r[a],--a;for(;a>=0;)n[a]=o*r[a],--a;i[s]=n,s--}return i},a.core.Tess=e.core.Tess=function(){},a.core.Tess.rational_curve_regular_sample=function(e,r,n){return a.core.Tess.rational_curve_regular_sample_range(e,e.knots[0],a.core.ArrayExtensions.last(e.knots),r,n)},a.core.Tess.rational_curve_regular_sample_range=function(e,r,n,o,t){1>o&&(o=2);for(var c=[],i=(n-r)/(o-1),s=0,u=0;o>u;){var l=u++;s=r+i*l,t?c.push([s].concat(a.core.Eval.rational_curve_point(e,s))):c.push(a.core.Eval.rational_curve_point(e,s))}return c},a.core.Tess.rational_curve_adaptive_sample=function(e,r,n){if(1==e.degree){if(n){for(var o=[],t=0,c=e.controlPoints.length;c>t;){var i=t++;o.push([e.knots[i+1]].concat(a.core.Eval.dehomogenize(e.controlPoints[i])))}return o}return e.controlPoints.map(a.core.Eval.dehomogenize)}return a.core.Tess.rational_curve_adaptive_sample_range(e,e.knots[0],a.core.ArrayExtensions.last(e.knots),r,n)},a.core.Tess.rational_curve_adaptive_sample_range=function(e,r,n,o,t){var c=a.core.Eval.rational_curve_point(e,r),i=a.core.Eval.rational_curve_point(e,n),s=.5+.2*Math.random(),u=r+(n-r)*s,l=a.core.Eval.rational_curve_point(e,u),h=a.core.Vec.sub(c,i),v=a.core.Vec.sub(c,l);if(o>a.core.Vec.dot(h,h)&&a.core.Vec.dot(v,v)>o||!a.core.Trig.three_points_are_flat(c,l,i,o)){var f=r+.5*(n-r),d=a.core.Tess.rational_curve_adaptive_sample_range(e,r,f,o,t),_=a.core.Tess.rational_curve_adaptive_sample_range(e,f,n,o,t);return d.slice(0,-1).concat(_)}return t?[[r].concat(c),[n].concat(i)]:[c,i]},a.core.Tess.rational_surface_naive=function(e,r,n){1>r&&(r=1),1>n&&(n=1),e.degreeU,e.degreeV,e.controlPoints;for(var o=e.knotsU,t=e.knotsV,c=o[o.length-1]-o[0],i=t[t.length-1]-t[0],s=c/r,u=i/n,l=[],h=[],v=[],f=0,d=r+1;d>f;)for(var _=f++,p=0,m=n+1;m>p;){var g=p++,V=_*s,y=g*u;h.push([V,y]);var b=a.core.Eval.rational_surface_derivs(e,1,V,y),x=b[0][0];l.push(x);var E=a.core.Vec.normalized(a.core.Vec.cross(b[1][0],b[0][1]));v.push(E)}for(var M=[],k=0;r>k;)for(var I=k++,B=0;n>B;){var P=B++,z=I*(n+1)+P,w=(I+1)*(n+1)+P,T=w+1,N=z+1,S=[z,w,T],C=[z,T,N];M.push(S),M.push(C)}return new a.core.types.MeshData(M,l,v,h)},a.core.Tess.divide_rational_surface_adaptive=function(e,r){null==r&&(r=new a.core.types.AdaptiveRefinementOptions),r.minDivsU=null!=r.minDivsU?r.minDivsU:1,r.minDivsU=null!=r.minDivsV?r.minDivsV:1,r.refine=null!=r.refine?r.refine:!0;var n,o=3*(e.controlPoints.length-1),t=3*(e.controlPoints[0].length-1);n=r.minDivsU=r.minDivsU>o?r.minDivsU:o;var c;c=r.minDivsV=r.minDivsV>t?r.minDivsV:t;for(var i=a.core.ArrayExtensions.last(e.knotsU),s=e.knotsU[0],u=a.core.ArrayExtensions.last(e.knotsV),l=e.knotsV[0],h=(i-s)/n,v=(u-l)/c,f=[],d=[],_=0,p=c+1;p>_;){for(var m=_++,g=[],V=0,y=n+1;y>V;){var b=V++,x=s+h*b,E=l+v*m,M=a.core.Eval.rational_surface_derivs(e,1,x,E),k=a.core.Vec.normalized(a.core.Vec.cross(M[0][1],M[1][0]));g.push(new a.core.types.SurfacePoint(M[0][0],k,[x,E],-1,a.core.Vec.isZero(k)))}d.push(g)}for(var I=0;c>I;)for(var B=I++,P=0;n>P;){var z=P++,w=[d[c-B-1][z],d[c-B-1][z+1],d[c-B][z+1],d[c-B][z]];f.push(new a.core.types.AdaptiveRefinementNode(e,w))}if(!r.refine)return f;for(var T=0;c>T;)for(var N=T++,S=0;n>S;){var C=S++,L=N*n+C,A=a.core.Tess.north(L,N,C,n,c,f),D=a.core.Tess.east(L,N,C,n,c,f),U=a.core.Tess.south(L,N,C,n,c,f),O=a.core.Tess.west(L,N,C,n,c,f);f[L].neighbors=[U,D,A,O],f[L].divide(r)}return f},a.core.Tess.north=function(e,r,n,o,t,c){return 0==r?null:c[e-o]},a.core.Tess.south=function(e,r,n,o,t,c){return r==t-1?null:c[e+o]},a.core.Tess.east=function(e,r,n,o,t,c){return n==o-1?null:c[e+1]},a.core.Tess.west=function(e,r,n,o,t,c){return 0==n?null:c[e-1]},a.core.Tess.triangulate_adaptive_refinement_node_tree=function(e){for(var r=a.core.types.MeshData.empty(),n=0;e.length>n;){var o=e[n];++n,o.triangulate(r)}return r},a.core.Tess.rational_surface_adaptive=function(e,r){r=null!=r?r:new a.core.types.AdaptiveRefinementOptions;var n=a.core.Tess.divide_rational_surface_adaptive(e,r);return a.core.Tess.triangulate_adaptive_refinement_node_tree(n)},a.core.Trig=e.core.Trig=function(){},a.core.Trig.dist_to_seg=function(e,r,n){var o=a.core.Vec.sub(n,e),t=a.core.Vec.norm(o),c=a.core.Vec.sub(r,e);if(a.core.Constants.TOLERANCE>t)return a.core.Vec.norm(c);var i=a.core.Vec.mul(1/t,o),s=a.core.Vec.dot(c,i),u=a.core.Vec.add(e,a.core.Vec.mul(s,i));return a.core.Vec.dist(u,r)},a.core.Trig.closest_point_on_ray=function(e,r,n){var o=a.core.Vec.sub(e,r),t=a.core.Vec.dot(o,n),c=a.core.Vec.add(r,a.core.Vec.mul(t,n));return c},a.core.Trig.dist_to_ray=function(e,r,n){var o=a.core.Trig.closest_point_on_ray(e,r,n),t=a.core.Vec.sub(o,e);return a.core.Vec.norm(t)},a.core.Trig.three_points_are_flat=function(e,r,n,o){var t=a.core.Vec.sub(r,e),c=a.core.Vec.sub(n,e),i=a.core.Vec.cross(t,c),s=a.core.Vec.dot(i,i);return o>s},a.core.Trig.closest_point_on_segment=function(e,r,n,o,t){var c=a.core.Vec.sub(n,r),i=a.core.Vec.norm(c);if(a.core.Constants.EPSILON>i)return{u:o,pt:r};var s=r,u=a.core.Vec.mul(1/i,c),l=a.core.Vec.sub(e,s),h=a.core.Vec.dot(l,u);return 0>h?{u:o,pt:r}:h>i?{u:t,pt:n}:{u:o+(t-o)*h/i,pt:a.core.Vec.add(s,a.core.Vec.mul(h,u))}},a.core.Vec=e.core.Vec=function(){},a.core.Vec.range=function(e){for(var r=[],n=0,o=0;e>o;)o++,r.push(n),n+=1;return r},a.core.Vec.neg=function(e){return e.map(function(e){return-e})},a.core.Vec.min=function(e){return c.fold(e,function(e,r){return Math.min(e,r)},Math.POSITIVE_INFINITY)},a.core.Vec.max=function(e){return c.fold(e,function(e,r){return Math.max(e,r)},Math.NEGATIVE_INFINITY)},a.core.Vec.all=function(e){return c.fold(e,function(e,r){return r&&e},!0)},a.core.Vec.finite=function(e){return e.map(function(e){return Math.isFinite(e)})},a.core.Vec.onRay=function(e,r,n){return a.core.Vec.add(e,a.core.Vec.mul(n,r))},a.core.Vec.lerp=function(e,r,n){return a.core.Vec.add(a.core.Vec.mul(e,r),a.core.Vec.mul(1-e,n))},a.core.Vec.normalized=function(e){return a.core.Vec.div(e,a.core.Vec.norm(e))},a.core.Vec.cross=function(e,r){return[e[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]},a.core.Vec.dist=function(e,r){return a.core.Vec.norm(a.core.Vec.sub(e,r))},a.core.Vec.distSquared=function(e,r){return a.core.Vec.normSquared(a.core.Vec.sub(e,r))},a.core.Vec.sum=function(e){return c.fold(e,function(e,r){return r+e},0)},a.core.Vec.norm=function(e){return Math.sqrt(a.core.Vec.normSquared(e))},a.core.Vec.normSquared=function(e){return c.fold(e,function(e,r){return r+e*e},0)},a.core.Vec.rep=function(e,r){for(var n=[],o=0;e>o;)o++,n.push(r);return n},a.core.Vec.zeros1d=function(e){for(var r=[],n=0;e>n;)n++,r.push(0);return r},a.core.Vec.zeros2d=function(e,r){for(var n=[],o=0;e>o;)o++,n.push(a.core.Vec.zeros1d(r));return n},a.core.Vec.zeros3d=function(e,r,n){for(var o=[],t=0;e>t;)t++,o.push(a.core.Vec.zeros2d(r,n));return o},a.core.Vec.dot=function(e,r){for(var n=0,o=0,t=e.length;t>o;){var c=o++;n+=e[c]*r[c]}return n},a.core.Vec.add=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(e[c]+r[c])}return n},a.core.Vec.mul=function(e,r){for(var n=[],o=0,t=r.length;t>o;){var c=o++;n.push(e*r[c])}return n},a.core.Vec.div=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(e[c]/r)}return n},a.core.Vec.sub=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(e[c]-r[c])}return n},a.core.Vec.isZero=function(e){for(var r=0,n=e.length;n>r;){var o=r++;if(Math.abs(e[o])>a.core.Constants.TOLERANCE)return!1}return!0},a.core.types={},a.core.types.AdaptiveRefinementOptions=function(){this.minDivsV=1,this.minDivsU=1,this.refine=!0,this.maxDepth=10,this.minDepth=0,this.normTol=.085},a.core.types.AdaptiveRefinementNode=e.core.AdaptiveRefinementNode=function(e,r,n){if(this.srf=e,this.neighbors=null==n?[null,null,null,null]:n,this.corners=r,null==this.corners){var o=e.knotsU[0],t=a.core.ArrayExtensions.last(e.knotsU),c=e.knotsV[0],i=a.core.ArrayExtensions.last(e.knotsV);this.corners=[a.core.types.SurfacePoint.fromUv(o,c),a.core.types.SurfacePoint.fromUv(t,c),a.core.types.SurfacePoint.fromUv(t,i),a.core.types.SurfacePoint.fromUv(o,i)]}},a.core.types.AdaptiveRefinementNode.prototype={isLeaf:function(){return null==this.children},center:function(){return null!=this.centerPoint?this.centerPoint:this.evalSrf(this.u05,this.v05)},evalCorners:function(){this.u05=(this.corners[0].uv[0]+this.corners[2].uv[0])/2,this.v05=(this.corners[0].uv[1]+this.corners[2].uv[1])/2;for(var e=0;4>e;){var r=e++;if(null==this.corners[r].point){var n=this.corners[r];this.evalSrf(n.uv[0],n.uv[1],n)}}},evalSrf:function(e,r,n){var o=a.core.Eval.rational_surface_derivs(this.srf,1,e,r),t=o[0][0],c=a.core.Vec.cross(o[0][1],o[1][0]),i=a.core.Vec.isZero(c);return i||(c=a.core.Vec.normalized(c)),null!=n?(n.degen=i,n.point=t,n.normal=c,n):new a.core.types.SurfacePoint(t,c,[e,r],-1,i)},getEdgeCorners:function(e){if(this.isLeaf())return[this.corners[e]];if(this.horizontal)switch(e){case 0:return this.children[0].getEdgeCorners(0);case 1:return this.children[0].getEdgeCorners(1).concat(this.children[1].getEdgeCorners(1));case 2:return this.children[1].getEdgeCorners(2);case 3:return this.children[1].getEdgeCorners(3).concat(this.children[0].getEdgeCorners(3))}switch(e){case 0:return this.children[0].getEdgeCorners(0).concat(this.children[1].getEdgeCorners(0));case 1:return this.children[1].getEdgeCorners(1);case 2:return this.children[1].getEdgeCorners(2).concat(this.children[0].getEdgeCorners(2));case 3:return this.children[0].getEdgeCorners(3)}return null},getAllCorners:function(e){var r=[this.corners[e]];if(null==this.neighbors[e])return r;var n=this.neighbors[e].getEdgeCorners((e+2)%4),o=e%2,t=a.core.Constants.EPSILON,c=this,i=[function(e){return e.uv[0]>c.corners[0].uv[0]+t&&e.uv[0]<c.corners[2].uv[0]-t},function(e){return e.uv[1]>c.corners[0].uv[1]+t&&e.uv[1]<c.corners[2].uv[1]-t}],s=n.filter(i[o]);return s.reverse(),r.concat(s)},midpoint:function(e){if(null==this.midPoints&&(this.midPoints=[null,null,null,null]),null!=this.midPoints[e])return this.midPoints[e];switch(e){case 0:this.midPoints[0]=this.evalSrf(this.u05,this.corners[0].uv[1]);break;case 1:this.midPoints[1]=this.evalSrf(this.corners[1].uv[0],this.v05);break;case 2:this.midPoints[2]=this.evalSrf(this.u05,this.corners[2].uv[1]);break;case 3:this.midPoints[3]=this.evalSrf(this.corners[0].uv[0],this.v05)}return this.midPoints[e]},hasBadNormals:function(){return this.corners[0].degen||this.corners[1].degen||this.corners[2].degen||this.corners[3].degen},fixNormals:function(){for(var e=this.corners.length,r=0;e>r;){var n=r++;if(this.corners[n],this.corners[n].degen){var o=this.corners[(n+1)%e],t=this.corners[(n+3)%e];this.corners[n].normal=o.degen?t.normal:o.normal}}},shouldDivide:function(e,r){if(e.minDepth>r)return!0;if(r>=e.maxDepth)return!1;if(this.hasBadNormals())return this.fixNormals(),!1;if(this.splitVert=a.core.Vec.normSquared(a.core.Vec.sub(this.corners[0].normal,this.corners[1].normal))>e.normTol||a.core.Vec.normSquared(a.core.Vec.sub(this.corners[2].normal,this.corners[3].normal))>e.normTol,this.splitHoriz=a.core.Vec.normSquared(a.core.Vec.sub(this.corners[1].normal,this.corners[2].normal))>e.normTol||a.core.Vec.normSquared(a.core.Vec.sub(this.corners[3].normal,this.corners[0].normal))>e.normTol,this.splitVert||this.splitHoriz)return!0;var n=this.center();return a.core.Vec.normSquared(a.core.Vec.sub(n.normal,this.corners[0].normal))>e.normTol||a.core.Vec.normSquared(a.core.Vec.sub(n.normal,this.corners[1].normal))>e.normTol||a.core.Vec.normSquared(a.core.Vec.sub(n.normal,this.corners[2].normal))>e.normTol||a.core.Vec.normSquared(a.core.Vec.sub(n.normal,this.corners[3].normal))>e.normTol},divide:function(e){null==e&&(e=new a.core.types.AdaptiveRefinementOptions),null==e.normTol&&(e.normTol=.085),null==e.minDepth&&(e.minDepth=0),null==e.maxDepth&&(e.maxDepth=10),this._divide(e,0,!0)},_divide:function(e,r,n){if(this.evalCorners(),this.shouldDivide(e,r)){if(r++,this.splitVert&&!this.splitHoriz?n=!1:!this.splitVert&&this.splitHoriz&&(n=!0),this.horizontal=n,this.horizontal){var o=[this.corners[0],this.corners[1],this.midpoint(1),this.midpoint(3)],t=[this.midpoint(3),this.midpoint(1),this.corners[2],this.corners[3]];this.children=[new a.core.types.AdaptiveRefinementNode(this.srf,o),new a.core.types.AdaptiveRefinementNode(this.srf,t)],this.children[0].neighbors=[this.neighbors[0],this.neighbors[1],this.children[1],this.neighbors[3]],this.children[1].neighbors=[this.children[0],this.neighbors[1],this.neighbors[2],this.neighbors[3]]}else{var c=[this.corners[0],this.midpoint(0),this.midpoint(2),this.corners[3]],i=[this.midpoint(0),this.corners[1],this.corners[2],this.midpoint(2)];this.children=[new a.core.types.AdaptiveRefinementNode(this.srf,c),new a.core.types.AdaptiveRefinementNode(this.srf,i)],this.children[0].neighbors=[this.neighbors[0],this.children[1],this.neighbors[2],this.neighbors[3]],this.children[1].neighbors=[this.neighbors[0],this.neighbors[1],this.neighbors[2],this.children[0]]}for(var s=0,u=this.children;u.length>s;){var l=u[s];++s,l._divide(e,r,!n)}}},triangulate:function(e){if(null==e&&(e=a.core.types.MeshData.empty()),this.isLeaf())return this.triangulateLeaf(e);for(var r=0,n=this.children;n.length>r;){var o=n[r];if(++r,null==o)break;o.triangulate(e)}return e},triangulateLeaf:function(e){for(var r=e.points.length,n=[],o=[],t=0,c=0;4>c;){var i=c++,s=this.getAllCorners(i);2==s.length&&(t=i+1);for(var a=0,u=s.length;u>a;){var l=a++;n.push(s[l])}}for(var h=0;n.length>h;){var v=n[h];++h,-1==v.id?(e.uvs.push(v.uv),e.points.push(v.point),e.normals.push(v.normal),v.id=r,o.push(r),r++):o.push(v.id)}if(4==n.length)return e.faces.push([o[0],o[3],o[1]]),e.faces.push([o[3],o[2],o[1]]),e;if(5==n.length){var f=o.length;return e.faces.push([o[t],o[(t+1)%f],o[(t+2)%f]]),e.faces.push([o[(t+4)%f],o[(t+3)%f],o[t]]),e.faces.push([o[t],o[(t+2)%f],o[(t+3)%f]]),e}var d=this.center();
e.uvs.push(d.uv),e.points.push(d.point),e.normals.push(d.normal);for(var _=e.points.length-1,p=0,m=n.length-1;n.length>p;)e.faces.push([_,o[m],o[p]]),m=p++;return e}},a.core.types.BoundingBoxNode=e.core.BoundingBoxNode=function(e){this.boundingBox=e},a.core.types.BoundingBoxInnerNode=e.core.BoundingBoxInnerNode=function(e,r){a.core.types.BoundingBoxNode.call(this,e),this.children=r},a.core.types.BoundingBoxInnerNode.__super__=a.core.types.BoundingBoxNode,a.core.types.BoundingBoxInnerNode.prototype=r(a.core.types.BoundingBoxNode.prototype,{}),a.core.types.BoundingBoxLeaf=e.core.BoundingBoxLeaf=function(e,r){a.core.types.BoundingBoxNode.call(this,e),this.item=r},a.core.types.BoundingBoxLeaf.__super__=a.core.types.BoundingBoxNode,a.core.types.BoundingBoxLeaf.prototype=r(a.core.types.BoundingBoxNode.prototype,{}),a.core.types.CurveCurveIntersection=e.core.CurveCurveIntersection=function(e,r,n,o){this.point0=e,this.point1=r,this.u0=n,this.u1=o},a.core.types.CurveData=e.core.CurveData=function(e,r,n){this.degree=e,this.controlPoints=n,this.knots=r},a.core.types.CurveLengthSample=e.core.CurveLengthSample=function(e,r){this.u=e,this.len=r},a.core.types.CurveSurfaceIntersection=e.core.CurveSurfaceIntersection=function(e,r){this.u=e,this.uv=r},a.core.types.CurveTriPoint=e.core.CurveTriPoint=function(e,r,n){this.u=e,this.point=r,this.uv=n},a.core.types.IBoundingBoxTree=function(){},a.core.types.Interval=e.core.Interval=function(e,r){this.min=e,this.max=r},a.core.types.LazyCurveBoundingBoxTree=function(e,r){this._boundingBox=null,this._curve=e,null==r&&(r=a.core.ArrayExtensions.last(this._curve.knots)-this._curve.knots[0]/1e3),this._knotTol=r},a.core.types.LazyCurveBoundingBoxTree.__interfaces__=[a.core.types.IBoundingBoxTree],a.core.types.LazyCurveBoundingBoxTree.prototype={split:function(){var e=this._curve.knots[0],r=a.core.ArrayExtensions.last(this._curve.knots),n=r-e,o=a.core.Modify.curve_split(this._curve,(r+e)/2+.01*n*Math.random());return new a.core.types.Pair(new a.core.types.LazyCurveBoundingBoxTree(o[0],this._knotTol),new a.core.types.LazyCurveBoundingBoxTree(o[1],this._knotTol))},boundingBox:function(){return null==this._boundingBox&&(this._boundingBox=new a.BoundingBox(a.core.Eval.dehomogenize_1d(this._curve.controlPoints))),this._boundingBox},yield:function(){return this._curve},indivisible:function(){return a.core.ArrayExtensions.last(this._curve.knots)-this._curve.knots[0]<this._knotTol},empty:function(){return!1}},a.core.types.LazyMeshBoundingBoxTree=function(e,r){if(this._boundingBox=null,this._mesh=e,null==r){for(var n=[],o=0,t=e.faces.length;t>o;){var c=o++;n.push(c)}r=n}this._faceIndices=r},a.core.types.LazyMeshBoundingBoxTree.__interfaces__=[a.core.types.IBoundingBoxTree],a.core.types.LazyMeshBoundingBoxTree.prototype={split:function(){var e=a.core.Mesh.sort_tris_on_longest_axis(this._boundingBox,this._mesh,this._faceIndices),r=a.core.ArrayExtensions.left(e),n=a.core.ArrayExtensions.right(e);return new a.core.types.Pair(new a.core.types.LazyMeshBoundingBoxTree(this._mesh,r),new a.core.types.LazyMeshBoundingBoxTree(this._mesh,n))},boundingBox:function(){return null==this._boundingBox&&(this._boundingBox=a.core.Mesh.make_mesh_aabb(this._mesh,this._faceIndices)),this._boundingBox},yield:function(){return this._faceIndices[0]},indivisible:function(){return 1==this._faceIndices.length},empty:function(){return 0==this._faceIndices.length}},a.core.types.LazyPolylineBoundingBoxTree=function(e,r){this._boundingBox=null,this._polyline=e,null==r&&(r=new a.core.types.Interval(0,0!=e.points.length?e.points.length-1:0)),this._interval=r},a.core.types.LazyPolylineBoundingBoxTree.__interfaces__=[a.core.types.IBoundingBoxTree],a.core.types.LazyPolylineBoundingBoxTree.prototype={split:function(){var e=this._interval.min,r=this._interval.max,n=e+Math.ceil((r-e)/2),o=new a.core.types.Interval(e,n),t=new a.core.types.Interval(n,r);return new a.core.types.Pair(new a.core.types.LazyPolylineBoundingBoxTree(this._polyline,o),new a.core.types.LazyPolylineBoundingBoxTree(this._polyline,t))},boundingBox:function(){return null==this._boundingBox&&(this._boundingBox=new a.BoundingBox(this._polyline.points)),this._boundingBox},yield:function(){return this._interval.min},indivisible:function(){return 1==this._interval.max-this._interval.min},empty:function(){return 0==this._interval.max-this._interval.min}},a.core.types.LazySurfaceBoundingBoxTree=function(e,r,n,o){null==r&&(r=!1),this._boundingBox=null,this._surface=e,this._splitV=r,null==n&&(n=(a.core.ArrayExtensions.last(e.knotsU)-e.knotsU[0])/1e3),null==o&&(o=(a.core.ArrayExtensions.last(e.knotsV)-e.knotsV[0])/1e3),this._knotTolU=n,this._knotTolV=o},a.core.types.LazySurfaceBoundingBoxTree.__interfaces__=[a.core.types.IBoundingBoxTree],a.core.types.LazySurfaceBoundingBoxTree.prototype={split:function(){var e,r;this._splitV?(e=this._surface.knotsV[0],r=a.core.ArrayExtensions.last(this._surface.knotsV)):(e=this._surface.knotsU[0],r=a.core.ArrayExtensions.last(this._surface.knotsU));var n=r-e,o=(e+r)/2+.01*n*Math.random(),t=a.core.Modify.surface_split(this._surface,o,this._splitV);return new a.core.types.Pair(new a.core.types.LazySurfaceBoundingBoxTree(t[0],!this._splitV,this._knotTolU,this._knotTolV),new a.core.types.LazySurfaceBoundingBoxTree(t[1],!this._splitV,this._knotTolU,this._knotTolV))},boundingBox:function(){if(null==this._boundingBox){this._boundingBox=new a.BoundingBox;for(var e=0,r=this._surface.controlPoints;r.length>e;){var n=r[e];++e,this._boundingBox.addRange(a.core.Eval.dehomogenize_1d(n))}}return this._boundingBox},yield:function(){return this._surface},indivisible:function(){return this._splitV?a.core.ArrayExtensions.last(this._surface.knotsV)-this._surface.knotsV[0]<this._knotTolV:a.core.ArrayExtensions.last(this._surface.knotsU)-this._surface.knotsU[0]<this._knotTolU},empty:function(){return!1}},a.core.types.MeshData=e.core.MeshData=function(e,r,n,o){this.faces=e,this.points=r,this.normals=n,this.uvs=o},a.core.types.MeshData.empty=function(){return new a.core.types.MeshData([],[],[],[])},a.core.types.MeshIntersectionPoint=e.core.MeshIntersectionPoint=function(e,r,n){this.visited=!1,this.adj=null,this.opp=null,this.uv0=e,this.uv1=r,this.point=n,this.faceIndex0,this.faceIndex1},a.core.types.Pair=e.core.Pair=function(e,r){this.item0=e,this.item1=r},a.core.types.PolylineData=e.core.PolylineData=function(e,r){this.points=e,this.params=r},a.core.types.PolylineMeshIntersection=e.core.PolylineMeshIntersection=function(e,r,n,o,t){this.point=e,this.u=r,this.uv=n,this.polylineIndex=o,this.faceIndex=t},a.core.types.Ray=e.core.Ray=function(e,r){this.origin=e,this.dir=r},a.core.types.SurfaceData=e.core.SurfaceData=function(e,r,n,o,t){this.degreeU=e,this.degreeV=r,this.knotsU=n,this.knotsV=o,this.controlPoints=t},a.core.types.SurfacePoint=function(e,r,n,o,t){null==t&&(t=!1),null==o&&(o=-1),this.uv=n,this.point=e,this.normal=r,this.id=o,this.degen=t},a.core.types.SurfacePoint.fromUv=function(e,r){return new a.core.types.SurfacePoint(null,null,[e,r])},a.core.types.SurfaceSurfaceIntersectionPoint=e.core.SurfaceSurfaceIntersectionPoint=function(e,r,n,o){this.uv0=e,this.uv1=r,this.point=n,this.dist=o},a.core.types.TriSegmentIntersection=e.core.TriSegmentIntersection=function(e,r,n,o){this.point=e,this.s=r,this.t=n,this.p=o},a.core.types.VolumeData=e.core.VolumeData=function(e,r,n,o,t,c,i){this.degreeU=e,this.degreeV=r,this.degreeW=n,this.knotsU=o,this.knotsV=t,this.knotsW=c,this.controlPoints=i};var u=0;Math.NaN=Number.NaN,Math.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY,Math.POSITIVE_INFINITY=Number.POSITIVE_INFINITY,Math.isFinite=function(e){return isFinite(e)},Math.isNaN=function(e){return isNaN(e)},null==Array.prototype.map&&(Array.prototype.map=function(e){for(var r=[],n=0,o=this.length;o>n;){var t=n++;r[t]=e(this[t])}return r}),null==Array.prototype.filter&&(Array.prototype.filter=function(e){for(var r=[],n=0,o=this.length;o>n;){var t=n++,c=this[t];e(c)&&r.push(c)}return r}),a.BoundingBox.TOLERANCE=1e-4,a.core.Analyze.Tvalues=[[],[],[-.5773502691896257,.5773502691896257],[0,-.7745966692414834,.7745966692414834],[-.33998104358485626,.33998104358485626,-.8611363115940526,.8611363115940526],[0,-.5384693101056831,.5384693101056831,-.906179845938664,.906179845938664],[.6612093864662645,-.6612093864662645,-.2386191860831969,.2386191860831969,-.932469514203152,.932469514203152],[0,.4058451513773972,-.4058451513773972,-.7415311855993945,.7415311855993945,-.9491079123427585,.9491079123427585],[-.1834346424956498,.1834346424956498,-.525532409916329,.525532409916329,-.7966664774136267,.7966664774136267,-.9602898564975363,.9602898564975363],[0,-.8360311073266358,.8360311073266358,-.9681602395076261,.9681602395076261,-.3242534234038089,.3242534234038089,-.6133714327005904,.6133714327005904],[-.14887433898163122,.14887433898163122,-.4333953941292472,.4333953941292472,-.6794095682990244,.6794095682990244,-.8650633666889845,.8650633666889845,-.9739065285171717,.9739065285171717],[0,-.26954315595234496,.26954315595234496,-.5190961292068118,.5190961292068118,-.7301520055740494,.7301520055740494,-.8870625997680953,.8870625997680953,-.978228658146057,.978228658146057],[-.1252334085114689,.1252334085114689,-.3678314989981802,.3678314989981802,-.5873179542866175,.5873179542866175,-.7699026741943047,.7699026741943047,-.9041172563704749,.9041172563704749,-.9815606342467192,.9815606342467192],[0,-.2304583159551348,.2304583159551348,-.44849275103644687,.44849275103644687,-.6423493394403402,.6423493394403402,-.8015780907333099,.8015780907333099,-.9175983992229779,.9175983992229779,-.9841830547185881,.9841830547185881],[-.10805494870734367,.10805494870734367,-.31911236892788974,.31911236892788974,-.5152486363581541,.5152486363581541,-.6872929048116855,.6872929048116855,-.827201315069765,.827201315069765,-.9284348836635735,.9284348836635735,-.9862838086968123,.9862838086968123],[0,-.20119409399743451,.20119409399743451,-.3941513470775634,.3941513470775634,-.5709721726085388,.5709721726085388,-.7244177313601701,.7244177313601701,-.8482065834104272,.8482065834104272,-.937273392400706,.937273392400706,-.9879925180204854,.9879925180204854],[-.09501250983763744,.09501250983763744,-.2816035507792589,.2816035507792589,-.45801677765722737,.45801677765722737,-.6178762444026438,.6178762444026438,-.755404408355003,.755404408355003,-.8656312023878318,.8656312023878318,-.9445750230732326,.9445750230732326,-.9894009349916499,.9894009349916499],[0,-.17848418149584785,.17848418149584785,-.3512317634538763,.3512317634538763,-.5126905370864769,.5126905370864769,-.6576711592166907,.6576711592166907,-.7815140038968014,.7815140038968014,-.8802391537269859,.8802391537269859,-.9506755217687678,.9506755217687678,-.9905754753144174,.9905754753144174],[-.0847750130417353,.0847750130417353,-.2518862256915055,.2518862256915055,-.41175116146284263,.41175116146284263,-.5597708310739475,.5597708310739475,-.6916870430603532,.6916870430603532,-.8037049589725231,.8037049589725231,-.8926024664975557,.8926024664975557,-.9558239495713977,.9558239495713977,-.9915651684209309,.9915651684209309],[0,-.16035864564022537,.16035864564022537,-.31656409996362983,.31656409996362983,-.46457074137596094,.46457074137596094,-.600545304661681,.600545304661681,-.7209661773352294,.7209661773352294,-.8227146565371428,.8227146565371428,-.9031559036148179,.9031559036148179,-.96020815213483,.96020815213483,-.9924068438435844,.9924068438435844],[-.07652652113349734,.07652652113349734,-.22778585114164507,.22778585114164507,-.37370608871541955,.37370608871541955,-.5108670019508271,.5108670019508271,-.636053680726515,.636053680726515,-.7463319064601508,.7463319064601508,-.8391169718222188,.8391169718222188,-.912234428251326,.912234428251326,-.9639719272779138,.9639719272779138,-.9931285991850949,.9931285991850949],[0,-.1455618541608951,.1455618541608951,-.2880213168024011,.2880213168024011,-.4243421202074388,.4243421202074388,-.5516188358872198,.5516188358872198,-.6671388041974123,.6671388041974123,-.7684399634756779,.7684399634756779,-.8533633645833173,.8533633645833173,-.9200993341504008,.9200993341504008,-.9672268385663063,.9672268385663063,-.9937521706203895,.9937521706203895],[-.06973927331972223,.06973927331972223,-.20786042668822127,.20786042668822127,-.34193582089208424,.34193582089208424,-.469355837986757,.469355837986757,-.5876404035069116,.5876404035069116,-.6944872631866827,.6944872631866827,-.7878168059792081,.7878168059792081,-.8658125777203002,.8658125777203002,-.926956772187174,.926956772187174,-.9700604978354287,.9700604978354287,-.9942945854823992,.9942945854823992],[0,-.1332568242984661,.1332568242984661,-.26413568097034495,.26413568097034495,-.3903010380302908,.3903010380302908,-.5095014778460075,.5095014778460075,-.6196098757636461,.6196098757636461,-.7186613631319502,.7186613631319502,-.8048884016188399,.8048884016188399,-.8767523582704416,.8767523582704416,-.9329710868260161,.9329710868260161,-.9725424712181152,.9725424712181152,-.9947693349975522,.9947693349975522],[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213]],a.core.Analyze.Cvalues=[[],[],[1,1],[.8888888888888888,.5555555555555556,.5555555555555556],[.6521451548625461,.6521451548625461,.34785484513745385,.34785484513745385],[.5688888888888889,.47862867049936647,.47862867049936647,.23692688505618908,.23692688505618908],[.3607615730481386,.3607615730481386,.46791393457269104,.46791393457269104,.17132449237917036,.17132449237917036],[.4179591836734694,.3818300505051189,.3818300505051189,.27970539148927664,.27970539148927664,.1294849661688697,.1294849661688697],[.362683783378362,.362683783378362,.31370664587788727,.31370664587788727,.22238103445337448,.22238103445337448,.10122853629037626,.10122853629037626],[.3302393550012598,.1806481606948574,.1806481606948574,.08127438836157441,.08127438836157441,.31234707704000286,.31234707704000286,.26061069640293544,.26061069640293544],[.29552422471475287,.29552422471475287,.26926671930999635,.26926671930999635,.21908636251598204,.21908636251598204,.1494513491505806,.1494513491505806,.06667134430868814,.06667134430868814],[.2729250867779006,.26280454451024665,.26280454451024665,.23319376459199048,.23319376459199048,.18629021092773426,.18629021092773426,.1255803694649046,.1255803694649046,.05566856711617366,.05566856711617366],[.24914704581340277,.24914704581340277,.2334925365383548,.2334925365383548,.20316742672306592,.20316742672306592,.16007832854334622,.16007832854334622,.10693932599531843,.10693932599531843,.04717533638651183,.04717533638651183],[.2325515532308739,.22628318026289723,.22628318026289723,.2078160475368885,.2078160475368885,.17814598076194574,.17814598076194574,.13887351021978725,.13887351021978725,.09212149983772845,.09212149983772845,.04048400476531588,.04048400476531588],[.2152638534631578,.2152638534631578,.2051984637212956,.2051984637212956,.18553839747793782,.18553839747793782,.15720316715819355,.15720316715819355,.12151857068790319,.12151857068790319,.08015808715976021,.08015808715976021,.03511946033175186,.03511946033175186],[.2025782419255613,.19843148532711158,.19843148532711158,.1861610000155622,.1861610000155622,.16626920581699392,.16626920581699392,.13957067792615432,.13957067792615432,.10715922046717194,.10715922046717194,.07036604748810812,.07036604748810812,.03075324199611727,.03075324199611727],[.1894506104550685,.1894506104550685,.18260341504492358,.18260341504492358,.16915651939500254,.16915651939500254,.14959598881657674,.14959598881657674,.12462897125553388,.12462897125553388,.09515851168249279,.09515851168249279,.062253523938647894,.062253523938647894,.027152459411754096,.027152459411754096],[.17944647035620653,.17656270536699264,.17656270536699264,.16800410215645004,.16800410215645004,.15404576107681028,.15404576107681028,.13513636846852548,.13513636846852548,.11188384719340397,.11188384719340397,.08503614831717918,.08503614831717918,.0554595293739872,.0554595293739872,.02414830286854793,.02414830286854793],[.1691423829631436,.1691423829631436,.16427648374583273,.16427648374583273,.15468467512626524,.15468467512626524,.14064291467065065,.14064291467065065,.12255520671147846,.12255520671147846,.10094204410628717,.10094204410628717,.07642573025488905,.07642573025488905,.0497145488949698,.0497145488949698,.02161601352648331,.02161601352648331],[.1610544498487837,.15896884339395434,.15896884339395434,.15276604206585967,.15276604206585967,.1426067021736066,.1426067021736066,.12875396253933621,.12875396253933621,.11156664554733399,.11156664554733399,.09149002162245,.09149002162245,.06904454273764123,.06904454273764123,.0448142267656996,.0448142267656996,.019461788229726478,.019461788229726478],[.15275338713072584,.15275338713072584,.14917298647260374,.14917298647260374,.14209610931838204,.14209610931838204,.13168863844917664,.13168863844917664,.11819453196151841,.11819453196151841,.10193011981724044,.10193011981724044,.08327674157670475,.08327674157670475,.06267204833410907,.06267204833410907,.04060142980038694,.04060142980038694,.017614007139152118,.017614007139152118],[.14608113364969041,.14452440398997005,.14452440398997005,.13988739479107315,.13988739479107315,.13226893863333747,.13226893863333747,.12183141605372853,.12183141605372853,.10879729916714838,.10879729916714838,.09344442345603386,.09344442345603386,.0761001136283793,.0761001136283793,.057134425426857205,.057134425426857205,.036953789770852494,.036953789770852494,.016017228257774335,.016017228257774335],[.13925187285563198,.13925187285563198,.13654149834601517,.13654149834601517,.13117350478706238,.13117350478706238,.12325237681051242,.12325237681051242,.11293229608053922,.11293229608053922,.10041414444288096,.10041414444288096,.08594160621706773,.08594160621706773,.06979646842452049,.06979646842452049,.052293335152683286,.052293335152683286,.03377490158481415,.03377490158481415,.0146279952982722,.0146279952982722],[.13365457218610619,.1324620394046966,.1324620394046966,.12890572218808216,.12890572218808216,.12304908430672953,.12304908430672953,.11499664022241136,.11499664022241136,.10489209146454141,.10489209146454141,.09291576606003515,.09291576606003515,.07928141177671895,.07928141177671895,.06423242140852585,.06423242140852585,.04803767173108467,.04803767173108467,.030988005856979445,.030988005856979445,.013411859487141771,.013411859487141771],[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872]],a.core.Binomial.memo=new s.ds.IntMap,a.core.Constants.TOLERANCE=1e-6,a.core.Constants.EPSILON=1e-10,a.Init.main()})("undefined"!=typeof window?window:exports);