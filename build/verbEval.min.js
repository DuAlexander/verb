/*! verb 2014-01-11 */
function crossprod(e,r){return[e[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]}if("object"!=typeof exports||void 0===exports)importScripts("labor.js"),importScripts("binomial.js"),importScripts("numeric-1.2.6.min.js");else var labor=require("labor");var verb=verb||{};verb.eval=verb.eval||{},verb.eval.nurbs=verb.eval.nurbs||{},verb.eval.mesh=verb.eval.mesh||{},verb.eval.geom=verb.eval.geom||{},verb.geom=verb.geom||{},verb.EPSILON=1e-8,verb.TOLERANCE=.001;var router=new labor.Router(verb.eval.nurbs);numeric.normalized=function(e){return numeric.div(e,numeric.norm2(e))},numeric.cross=function(e,r){return[e[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]},verb.eval.nurbs.get_sweep1_surface=function(e,r,n,t,i,a,s,u){for(var o=verb.eval.nurbs.homogenize_1d(s,u),v=verb.eval.nurbs.rational_curve_point(a,i,o,0),l=1/s.length,c=[],b=[],_=0;s.length>_;_++){for(var h=verb.eval.nurbs.rational_curve_point(a,i,o,_*l),m=numeric.sub(h,v),g=[],d=[],f=0;n.length>f;f++)g.push(numeric.add(m,n[f])),d.push(t[f]*u[_]);c.push(g),b.push(d)}return{knots_u:i,knots_v:e,control_points:c,degree_u:a,degree_v:r,weights:b}},verb.eval.nurbs.get_ellipse_arc=function(e,r,n,t,i,a,s){a>s&&(s=2*Math.PI+a);var u=s-a,o=0;o=Math.PI/2>=u?1:Math.PI>=u?2:3*Math.PI/2>=u?3:4;var v=u/o,l=Math.cos(v/2),c=numeric.add(e,numeric.mul(t,Math.cos(a),r),numeric.mul(i,Math.sin(a),n)),b=numeric.sub(numeric.mul(Math.cos(a),n),numeric.mul(Math.sin(a),r)),_=verb.eval.nurbs.zeros_1d(2*o),h=verb.eval.nurbs.zeros_1d(2*o+3),m=0,g=a,d=verb.eval.nurbs.zeros_1d(2*o);_[0]=c,d[0]=1;for(var f=1;o>=f;f++){g+=v;var p=numeric.add(e,numeric.mul(t,Math.cos(g),r),numeric.mul(i,Math.sin(g),n));d[m+2]=1,_[m+2]=p;var y=numeric.sub(numeric.mul(Math.cos(g),n),numeric.mul(Math.sin(g),r)),x=verb.eval.geom.intersect_rays(c,numeric.mul(1/numeric.norm2(b),b),p,numeric.mul(1/numeric.norm2(y),y)),k=numeric.add(c,numeric.mul(b,x[0]));d[m+1]=l,_[m+1]=k,m+=2,o>f&&(c=p,b=y)}for(var w=2*o+1,f=0;3>f;f++)h[f]=0,h[f+w]=1;switch(o){case 1:break;case 2:h[3]=h[4]=.5;break;case 3:h[3]=h[4]=1/3,h[5]=h[6]=2/3;break;case 4:h[3]=h[4]=.25,h[5]=h[6]=.5,h[7]=h[8]=.75}return{knots:h,control_points:_,degree:2,weights:d}},verb.eval.nurbs.get_sphere_surface=function(e,r,n,t){var i=verb.eval.nurbs.get_arc(e,numeric.mul(r,-1),n,t,0,Math.PI);return verb.eval.nurbs.get_revolved_surface(e,r,2*Math.PI,i.knots,i.degree,i.control_points,i.weights)},verb.eval.nurbs.get_polyline_curve=function(e){for(var r=e.length-1,n=1/r,t=[0,0],i=1;r>i;i++)t.push(i*n);t.push(1),t.push(1);for(var a=[],i=0;e.length>i;i++)a.push(1);return{knots:t,control_points:e.slice(0),degree:1,weights:a}},verb.eval.nurbs.get_4pt_surface=function(e,r,n,t){return{knots_u:[0,0,1,1],knots_v:[0,0,1,1],control_points:[[e,t],[r,n]],degree_u:1,degree_v:1,weights:[[1,1],[1,1]]}},verb.eval.nurbs.get_cylinder_surface=function(e,r,n,t,i){var a=crossprod(e,r),s=(2*Math.PI,verb.eval.nurbs.get_arc(n,r,a,i,0,2*Math.PI));return verb.eval.nurbs.get_extruded_surface(e,t,s.knots,s.degree,s.control_points,s.weights)},verb.eval.nurbs.get_cone_surface=function(e,r,n,t,i){var a=2*Math.PI,s=1,u=[numeric.add(n,numeric.mul(t,e)),numeric.add(n,numeric.mul(i,r))],o=[0,0,1,1],v=[1,1];return verb.eval.nurbs.get_revolved_surface(n,e,a,o,s,u,v)},verb.eval.nurbs.get_extruded_surface=function(e,r,n,t,i,a){for(var s=verb.eval.nurbs.zeros_2d(2,i.length),u=verb.eval.nurbs.zeros_2d(2,i.length),o=0;i.length>o;o++)s[0][o]=i[o],u[0][o]=a[o];for(var v=numeric.mul(e,r),o=0;i.length>o;o++)s[1][o]=numeric.add(v,i[o]),u[1][o]=a[o];return{knots_u:[0,0,1,1],knots_v:n,control_points:s,degree_u:1,degree_v:t,weights:u}},verb.eval.nurbs.get_revolved_surface=function(e,r,n,t,i,a,s){var u,o,v,l;Math.PI/2>=n?(u=1,o=verb.eval.nurbs.zeros_1d(6+2*(u-1))):Math.PI>=n?(u=2,o=verb.eval.nurbs.zeros_1d(6+2*(u-1)),o[3]=o[4]=.5):3*Math.PI/2>=n?(u=3,o=verb.eval.nurbs.zeros_1d(6+2*(u-1)),o[3]=o[4]=1/3,o[5]=o[6]=2/3):(u=4,o=verb.eval.nurbs.zeros_1d(6+2*(u-1)),o[3]=o[4]=.25,o[5]=o[6]=.5,o[7]=o[8]=.75);for(var c=n/u,b=3+2*(u-1),_=0;3>_;b++,_++)o[_]=0,o[b]=1;for(var h=Math.cos(c/2),m=0,g=verb.eval.nurbs.zeros_1d(u+1),d=verb.eval.nurbs.zeros_1d(u+1),v=verb.eval.nurbs.zeros_2d(2*u+1,a.length),l=verb.eval.nurbs.zeros_2d(2*u+1,a.length),_=1;u>=_;_++)m+=c,d[_]=Math.cos(m),g[_]=Math.sin(m);for(b=0;a.length>b;b++){var f=verb.eval.geom.closest_point_on_ray(a[b],e,r),p=numeric.sub(a[b],f),y=numeric.norm2(p),x=crossprod(r,p);y>verb.EPSILON&&(p=numeric.mul(1/y,p),x=numeric.mul(1/y,x)),v[0][b]=a[b];var k=a[b];l[0][b]=s[b];for(var w=x,M=0,m=0,_=1;u>=_;_++){var z=0==y?f:numeric.add(f,numeric.mul(y,d[_],p),numeric.mul(y,g[_],x));v[M+2][b]=z,l[M+2][b]=s[b];var N=numeric.sub(numeric.mul(d[_],x),numeric.mul(g[_],p));if(0==y)v[M+1][b]=f;else{var P=verb.eval.geom.intersect_rays(k,numeric.mul(1/numeric.norm2(w),w),z,numeric.mul(1/numeric.norm2(N),N)),A=numeric.add(k,numeric.mul(w,P[0]));v[M+1][b]=A}l[M+1][b]=h*s[b],M+=2,u>_&&(k=z,w=N)}}return{knots_u:o,knots_v:t,control_points:v,degree_u:2,degree_v:i,weights:l}},verb.eval.nurbs.get_arc=function(e,r,n,t,i,a){return verb.eval.nurbs.get_ellipse_arc(e,r,n,t,t,i,a)},verb.eval.nurbs.intersect_rational_surfaces=function(){},verb.eval.mesh.intersect_meshes=function(){},verb.eval.mesh.intersect_meshes_by_aabb=function(e,r,n,t,i){var a=_.range(r.length),s=_.range(i.length),u=verb.eval.mesh.make_mesh_aabb_tree(e,r,a),o=verb.eval.mesh.make_mesh_aabb_tree(t,i,s);verb.eval.mesh.intersect_aabb_tree(e,r,t,i,u,o)},verb.eval.geom.intersect_tris=function(e,r,n,t,i){for(var a=[e[tr1[0]],e[tr1[1]]],s=[e[tr1[1]],e[tr1[2]]],u=[e[tr1[2]],e[tr1[0]]],o=[t[tr2[0]],t[tr2[1]]],v=[t[tr2[1]],t[tr2[2]]],l=[t[tr2[2]],t[tr2[0]]],c=[a,s,u],b=[o,v,l],_=[],h=verb.eval.geom.get_tri_norm(t,i),m=t[tr2[0]],g=0;3>g;g++){var d=verb.eval.geom.intersect_segment_with_plane(c[g][0],b[g][1],m,h);d.intersects&&_.push(d)}if(2!==_.length)return null;for(var f=[_[0].point,_[1].point],p=[],g=0;3>g;g++){var y=verb.eval.geom.intersect_segments(f[0],f[1],f,b1,tol);y&&p.push(y)}0===p.length||1===p.length||2===p.length},verb.eval.geom.intersect_segment_with_tri=function(e,r,n,t){var i=n[t[0]],a=n[t[1]],s=n[t[2]],u=numeric.sub(a,i),o=numeric.sub(s,i),v=numeric.dot(u,o),l=numeric.dot(u,u),c=numeric.dot(o,o),b=v*v-l*c,_=(v*numeric.dot(u,o)-c*numeric.dot(w,u))/b,h=(v*numeric.dot(w,u)-l*numeric.dot(w,o))/b;if(_>1+EPSILON||h>1+EPSILON||-EPSILON>h||-EPSILON>_||_+h>1+EPSILON)return null;var m=numeric.add(i,numeric.add(numeric.mul(_,u),numeric.mul(h,o))),g=numeric.sub(e,r),d=numeric.dot(g,g),f=numeric.sub(m,r),p=numeric.dot(f,f),y=p/d;return{point:m,s:_,t:h,param:y}},verb.eval.geom.intersect_segment_with_plane=function(e,r,n,t){var i=numeric.dot(t,numeric.sub(e,r));if(EPSILON>abs(i))return null;var a=numeric.dot(t,numeric.sub(n,e));return{param:a/i}},verb.eval.geom.intersect_aabb_trees=function(e,r,n,t,i,a){var s=i.bounding_box.intersects(a.bounding_box);return s?0===i.children.length&&0===a.children.length?[[i.triangle,a.triangle]]:0===i.children.length&&0!=a.children.length?verb.eval.geom.intersect_aabb_trees(e,r,n,t,i,a.children[0]).concat(verb.eval.geom.intersect_aabb_trees(e,r,n,t,i,a.children[1])):0!=i.children.length&&0===a.children.length?verb.eval.geom.intersect_aabb_trees(e,r,n,t,i.children[0],a).concat(verb.eval.geom.intersect_aabb_trees(e,r,n,t,i.children[1],a)):0!=i.children.length&&0!=a.children.length?verb.eval.geom.intersect_aabb_trees(e,r,n,t,i.children[0],a.children[0]).concat(verb.eval.geom.intersect_aabb_trees(e,r,n,t,i.children[0],a.children[1])).concat(verb.eval.geom.intersect_aabb_trees(e,r,n,t,i.children[1],a.children[0])).concat(verb.eval.geom.intersect_aabb_trees(e,r,n,t,i.children[1],a.children[1])):void 0:[]},verb.eval.mesh.make_mesh_aabb_tree=function(e,r,n){var t={bounding_box:verb.eval.mesh.make_mesh_aabb(e,r,n),children:[]};if(1===n.length)return t.triangle=n[0],t;var i=verb.eval.mesh.sort_tris_on_longest_axis(t.bounding_box,e,r,n),a=i.slice(0,Math.floor(i.length/2)),s=i.slice(Math.floor(i.length/2),i.length);return t.children=[verb.eval.mesh.make_mesh_aabb_tree(e,r,a),verb.eval.mesh.make_mesh_aabb_tree(e,r,s)],t},verb.eval.mesh.make_mesh_aabb=function(e,r,n){for(var t=new verb.geom.BoundingBox,i=n.length-1;i>=0;i--){var a=n[i];t.add(e[r[a][0]]),t.add(e[r[a][1]]),t.add(e[r[a][2]])}return t},verb.eval.mesh.sort_tris_on_longest_axis=function(e,r,n,t){for(var i=e.get_longest_axis(),a=[],s=t.length-1;s>=0;s--){var u=t[s],o=verb.eval.mesh.get_min_coordinate_on_axis(r,n[u],i);a.push([o,u])}a.sort(function(e,r){return e[0]>r[0]});for(var v=[],s=0,l=a.length;l>s;s++)v.push(a[s][1]);return v},verb.eval.mesh.get_min_coordinate_on_axis=function(e,r,n){for(var t=[],i=0;3>i;i++)t.push(e[r[i]][n]);return Math.min.apply(Math,t)},verb.eval.geom.get_tri_centroid=function(e,r){for(var n=[0,0,0],t=0;3>t;t++)for(var i=0;3>i;i++)n[i]+=e[r[t]][i];for(var t=0;3>t;t++)n[t]/=3;return n},verb.eval.geom.get_tri_norm=function(e,r){var n=e[r[0]],t=e[r[1]],i=e[r[2]],a=numeric.sub(t,n),s=numeric.sub(i,n),u=numeric.cross(a,s);return numeric.mul(1/numeric.norm2(u),u)},verb.eval.nurbs.tesselate_rational_surface_naive=function(e,r,n,t,i,a,s){1>a&&(a=1),1>s&&(s=1);for(var u=1/a,o=1/s,v=[],l=[],c=[],b=0;a+1>b;b++)for(var _=0;s+1>_;_++){var h=b*u,m=_*o;l.push([h,m]);var g=verb.eval.nurbs.rational_surface_derivs(e,r,n,t,i,1,h,m),d=g[0][0];v.push(d);var f=numeric.cross(g[0][1],g[1][0]);c.push(f)}for(var p=[],b=0;a>b;b++)for(var _=0;s>_;_++){var y=b*(s+1)+_,x=(b+1)*(s+1)+_,k=x+1,w=y+1,M=[y,x,k],z=[y,k,w];p.push(M),p.push(z)}return{points:v,faces:p,uvs:l,normals:c}},verb.eval.nurbs.intersect_rational_curves_by_aabb_refine=function(e,r,n,t,i,a,s,u){var o=verb.eval.nurbs.intersect_rational_curves_by_aabb(e,r,n,t,i,a,s,u);return o.map(function(s){return verb.eval.nurbs.refine_rational_curve_intersection(e,r,n,t,i,a,s)})},verb.eval.nurbs.refine_rational_curve_intersection=function(e,r,n,t,i,a,s){var u=function(s){var u=verb.eval.nurbs.rational_curve_point(e,r,n,s[0]),o=verb.eval.nurbs.rational_curve_point(t,i,a,s[1]),v=numeric.sub(u,o);return numeric.dot(v,v)},o=numeric.uncmin(u,s);return o.solution.concat(o.f)},verb.eval.nurbs.intersect_rational_curves_by_aabb=function(e,r,n,t,i,a,s,u){var o=verb.eval.nurbs.rational_curve_adaptive_sample(e,r,n,s,!0),v=verb.eval.nurbs.rational_curve_adaptive_sample(t,i,a,s,!0),l=o.map(function(e){return e[0]}),c=v.map(function(e){return e[0]}),b=o.map(function(e){return e.slice(1)}),_=v.map(function(e){return e.slice(1)});return verb.eval.nurbs.intersect_parametric_polylines_by_aabb(b,_,l,c,u)},verb.eval.nurbs.intersect_parametric_polylines_by_aabb=function(e,r,n,t,i){var a=new verb.geom.BoundingBox(e),s=new verb.geom.BoundingBox(r);if(!a.intersects(s,i))return[];if(2!==e.length||2!==r.length){if(2===e.length){var u=Math.ceil(r.length/2),o=r.slice(0,u),v=r.slice(u-1),l=t.slice(0,u),c=t.slice(u-1);return verb.eval.nurbs.intersect_parametric_polylines_by_aabb(e,o,n,l,i).concat(verb.eval.nurbs.intersect_parametric_polylines_by_aabb(e,v,n,c,i))}if(2===r.length){var b=Math.ceil(e.length/2),_=e.slice(0,b),h=e.slice(b-1),m=n.slice(0,b),g=n.slice(b-1);return verb.eval.nurbs.intersect_parametric_polylines_by_aabb(_,r,m,t,i).concat(verb.eval.nurbs.intersect_parametric_polylines_by_aabb(h,r,g,t,i))}var b=Math.ceil(e.length/2),_=e.slice(0,b),h=e.slice(b-1),m=n.slice(0,b),g=n.slice(b-1),u=Math.ceil(r.length/2),o=r.slice(0,u),v=r.slice(u-1),l=t.slice(0,u),c=t.slice(u-1);return verb.eval.nurbs.intersect_parametric_polylines_by_aabb(_,o,m,l,i).concat(verb.eval.nurbs.intersect_parametric_polylines_by_aabb(_,v,m,c,i)).concat(verb.eval.nurbs.intersect_parametric_polylines_by_aabb(h,o,g,l,i)).concat(verb.eval.nurbs.intersect_parametric_polylines_by_aabb(h,v,g,c,i))}var d=verb.eval.geom.intersect_segments(e[0],e[1],r[0],r[1],i);return null!=d?(d[0][0]=d[0][0]*(n[1]-n[0])+n[0],d[1][0]=d[1][0]*(t[1]-t[0])+t[0],[[d[0][0],d[1][0]]]):[]},verb.eval.geom.intersect_segments=function(e,r,n,t,i){var a=numeric.sub(r,e),s=Math.sqrt(numeric.dot(a,a)),u=numeric.mul(1/s,a),o=numeric.sub(t,n),v=Math.sqrt(numeric.dot(o,o)),l=numeric.mul(1/v,o),c=verb.eval.geom.intersect_rays(e,u,n,l);if(null!=c){var b=Math.min(Math.max(0,c[0]/s),1),_=Math.min(Math.max(0,c[1]/v),1),h=numeric.add(numeric.mul(b,a),e),m=numeric.add(numeric.mul(_,o),n),g=numeric.norm2Squared(numeric.sub(h,m));if(i*i>g)return[[b].concat(h),[_].concat(m)]}return null},verb.eval.geom.closest_point_on_ray=function(e,r,n){var t=numeric.sub(e,r),i=numeric.dot(t,n),a=numeric.add(r,numeric.mul(i,n));return a},verb.eval.geom.intersect_rays=function(e,r,n,t){var i=numeric.dot(r,t),a=numeric.dot(r,n),s=numeric.dot(r,e),u=numeric.dot(t,n),o=numeric.dot(t,e),v=numeric.dot(r,r),l=numeric.dot(t,t),c=v*l-i*i;if(Math.abs(c)<verb.EPSILON)return null;var b=i*(a-s)-v*(u-o),_=b/c,h=(a-s+_*i)/v;return[h,_]},verb.eval.nurbs.rational_curve_regular_sample=function(e,r,n,t,i){return verb.eval.nurbs.rational_curve_regular_sample_range(e,r,n,0,1,t,i)},verb.eval.nurbs.rational_curve_regular_sample_range=function(e,r,n,t,i,a,s){1>a&&(a=2);for(var u=[],o=(i-t)/(a-1),v=0,l=0;a>l;l++)v=t+o*l,s?u.push([v].concat(verb.eval.nurbs.rational_curve_point(e,r,n,v))):u.push(verb.eval.nurbs.rational_curve_point(e,r,n,v));return u},verb.eval.nurbs.rational_curve_adaptive_sample=function(e,r,n,t,i){return 1===e?i?n.map(function(e,n){return[r[n+1]].concat(verb.eval.nurbs.dehomogenize(e))}):n.map(verb.eval.nurbs.dehomogenize):verb.eval.nurbs.rational_curve_adaptive_sample_range(e,r,n,0,1,t,i)},verb.eval.nurbs.rational_curve_adaptive_sample_range=function(e,r,n,t,i,a,s){var u=verb.eval.nurbs.rational_curve_point(e,r,n,t),o=verb.eval.nurbs.rational_curve_point(e,r,n,i),v=.5+.2*Math.random(),l=t+(i-t)*v,c=verb.eval.nurbs.rational_curve_point(e,r,n,l),b=numeric.sub(u,o),_=numeric.sub(u,c);if(a>numeric.dot(b,b)&&numeric.dot(_,_)>a||!verb.eval.nurbs.three_points_are_flat(u,c,o,a)){var h=verb.eval.nurbs.rational_curve_adaptive_sample_range(e,r,n,t,l,a,s),m=verb.eval.nurbs.rational_curve_adaptive_sample_range(e,r,n,l,i,a,s);return h.slice(0,-1).concat(m)}return s?[[t].concat(u),[i].concat(o)]:[u,o]},verb.eval.nurbs.three_points_are_flat=function(e,r,n,t){var i=numeric.sub(r,e),a=numeric.sub(n,e),s=crossprod(i,a),u=numeric.dot(s,s);return t>u},verb.eval.nurbs.curve_knot_insert=function(e,r,n,t,i,a){var s=(n[0].length,r.length-e-2),u=n.length,o=verb.eval.nurbs.knot_span(e,t,r),v=s+e+1,l=u+a,c=Array(e+1),b=Array(r.length+a),_=Array(l),h=0;for(h=0;o>=h;h++)b[h]=r[h];for(h=1;a>=h;h++)b[o+h]=t;for(h=o+1;v>=h;h++)b[h+a]=r[h];for(h=0;o-e>=h;h++)_[h]=n[h];for(h=o-i;s>=h;h++)_[h+a]=n[h];for(h=0;e-i>=h;h++)c[h]=n[o-e+1];for(var m=0,g=0,d=1;a>=d;d++){for(m=o-e+d,h=0;e-d-i>=h;h++)g=(t-r[m+h])/(r[h+o+1]-r[m+h]),c[h]=numeric.add(numeric.mul(g,c[h+1]),numeric.mul(1-g,c[h]));_[m]=c[0],_[o+a-d-i]=c[e-d-i]}for(h=m+1;o-i>h;h++)_[h]=c[h-m];return[b,_]},verb.eval.nurbs.rational_surface_derivs=function(e,r,n,t,i,a,s,u){var o=verb.eval.nurbs.surface_derivs(e,r,n,t,i,a,s,u),v=verb.eval.nurbs.separate_homo_derivs_2d(o),l=v[0],c=v[1],b=0,_=0,h=0,m=0,g=[],d=l[0][0].length;for(b=0;a>=b;b++)for(g.push([]),m=0;a-b>=m;m++){var u=l[b][m];for(h=1;m>=h;h++)u=numeric.sub(u,numeric.mul(numeric.mul(binomial.get(m,h),c[0][h]),g[b][m-h]));for(_=1;b>=_;_++){u=numeric.sub(u,numeric.mul(numeric.mul(binomial.get(b,_),c[_][0]),g[b-_][m]));var f=verb.eval.nurbs.zeros_1d(d);for(h=1;m>=h;h++)f=numeric.add(f,numeric.mul(numeric.mul(binomial.get(m,h),c[_][h]),g[b-_][m-h]));u=numeric.sub(u,numeric.mul(binomial.get(b,_),f))}g[b].push(numeric.mul(1/c[0][0],u))}return g},verb.eval.nurbs.rational_surface_point=function(e,r,n,t,i,a,s){return verb.eval.nurbs.dehomogenize(verb.eval.nurbs.surface_point(e,r,n,t,i,a,s))},verb.eval.nurbs.rational_curve_derivs=function(e,r,n,t,i){var a=verb.eval.nurbs.separate_homo_derivs_1d(verb.eval.nurbs.curve_derivs(e,r,n,t,i)),s=a[0],u=a[1],o=0,v=0,l=[];for(o=0;i>=o;o++){var c=s[o];for(v=1;o>=v;v++)c=numeric.sub(c,numeric.mul(numeric.mul(binomial.get(o,v),u[v]),l[o-v]));l.push(numeric.mul(1/u[0],c))}return l},verb.eval.nurbs.separate_homo_derivs_1d=function(e){for(var r=e[0].length,n=r-1,t=[],i=[],a=0,s=e.length;s>a;a++)t.push(e[a].slice(0,n)),i.push(e[a][n]);return[t,i]},verb.eval.nurbs.separate_homo_derivs_2d=function(e){for(var r=[],n=[],t=0,i=e.length;i>t;t++){var a=verb.eval.nurbs.separate_homo_derivs_1d(e[t]);r.push(a[0]),n.push(a[1])}return[r,n]},verb.eval.nurbs.rational_curve_point=function(e,r,n,t){return verb.eval.nurbs.dehomogenize(verb.eval.nurbs.curve_point(e,r,n,t))},verb.eval.nurbs.dehomogenize=function(e){for(var r=e.length,n=[],t=e[r-1],i=0;e.length-1>i;i++)n.push(e[i]/t);return n},verb.eval.nurbs.homogenize_1d=function(e,r){for(var n=e.length,t=e[0].length,i=0,a=[],s=0,u=[],o=0;n>o;o++){var v=[];for(u=e[o],s=r[o],i=0;t>i;i++)v.push(u[i]*s);v.push(s),a.push(v)}return a},verb.eval.nurbs.homogenize_2d=function(e,r){for(var n=e.length,t=(e[0].length,e[0][0].length,[]),i=0;n>i;i++)t.push(verb.eval.nurbs.homogenize_1d(e[i],r[i]));return t},verb.eval.nurbs.surface_derivs=function(e,r,n,t,i,a,s,u){var o=r.length-e-2,v=t.length-n-2;return verb.eval.nurbs.surface_derivs_given_n_m(o,e,r,v,n,t,i,a,s,u)},verb.eval.nurbs.surface_derivs_given_n_m=function(e,r,n,t,i,a,s,u,o,v){if(verb.eval.nurbs.are_valid_relations(r,s.length,n.length)===!1||verb.eval.nurbs.are_valid_relations(i,s[0].length,a.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var l=s[0][0].length,c=Math.min(u,r),b=Math.min(u,i),_=verb.eval.nurbs.zeros_3d(c+1,b+1,l),h=verb.eval.nurbs.knot_span_given_n(e,r,o,n),m=verb.eval.nurbs.knot_span_given_n(t,i,v,a),g=verb.eval.nurbs.deriv_basis_functions_given_n_i(h,o,r,e,n),d=verb.eval.nurbs.deriv_basis_functions_given_n_i(m,v,i,t,a),f=verb.eval.nurbs.zeros_2d(i+1,l),p=0,y=0,x=0,k=0,w=0;for(p=0;c>=p;p++){for(y=0;i>=y;y++)for(f[y]=verb.eval.nurbs.zeros_1d(l),x=0;r>=x;x++)f[y]=numeric.add(f[y],numeric.mul(g[p][x],s[h-r+x][m-i+y]));for(w=Math.min(u-p,b),k=0;w>=k;k++)for(_[p][k]=verb.eval.nurbs.zeros_1d(l),y=0;i>=y;y++)_[p][k]=numeric.add(_[p][k],numeric.mul(d[k][y],f[y]))}return _},verb.eval.nurbs.surface_point=function(e,r,n,t,i,a,s){var u=r.length-e-2,o=t.length-n-2;return verb.eval.nurbs.surface_point_given_n_m(u,e,r,o,n,t,i,a,s)},verb.eval.nurbs.surface_point_given_n_m=function(e,r,n,t,i,a,s,u,o){if(verb.eval.nurbs.are_valid_relations(r,s.length,n.length)===!1||verb.eval.nurbs.are_valid_relations(i,s[0].length,a.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var v=s[0][0].length,l=verb.eval.nurbs.knot_span_given_n(e,r,u,n),c=verb.eval.nurbs.knot_span_given_n(t,i,o,a),b=verb.eval.nurbs.basis_functions_given_knot_span_index(l,u,r,n),_=verb.eval.nurbs.basis_functions_given_knot_span_index(c,o,i,a),h=l-r,m=c,g=verb.eval.nurbs.zeros_1d(v),d=verb.eval.nurbs.zeros_1d(v),f=0,p=0;for(f=0;i>=f;f++){for(d=verb.eval.nurbs.zeros_1d(v),m=c-i+f,p=0;r>=p;p++)d=numeric.add(d,numeric.mul(b[p],s[h+p][m]));g=numeric.add(g,numeric.mul(_[f],d))}return g},verb.eval.nurbs.curve_derivs=function(e,r,n,t,i){var a=r.length-e-2;return verb.eval.nurbs.curve_derivs_given_n(a,e,r,n,t,i)},verb.eval.nurbs.curve_derivs_given_n=function(e,r,n,t,i,a){if(verb.eval.nurbs.are_valid_relations(r,t.length,n.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var s=t[0].length,u=Math.min(a,r),o=verb.eval.nurbs.zeros_2d(u+1,s),v=verb.eval.nurbs.knot_span_given_n(e,r,i,n),l=verb.eval.nurbs.deriv_basis_functions_given_n_i(v,i,r,u,n),c=0,b=0;for(c=0;u>=c;c++)for(b=0;r>=b;b++)o[c]=numeric.add(o[c],numeric.mul(l[c][b],t[v-r+b]));return o},verb.eval.nurbs.are_valid_relations=function(e,r,n){return 0===r+e+1-n?!0:!1},verb.eval.nurbs.curve_point=function(e,r,n,t){var i=r.length-e-2;return verb.eval.nurbs.curve_point_given_n(i,e,r,n,t)},verb.eval.nurbs.curve_point_given_n=function(e,r,n,t,i){if(verb.eval.nurbs.are_valid_relations(r,t.length,n.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;for(var a=verb.eval.nurbs.knot_span_given_n(e,r,i,n),s=verb.eval.nurbs.basis_functions_given_knot_span_index(a,i,r,n),u=verb.eval.nurbs.zeros_1d(t[0].length),o=0;r>=o;o++)u=numeric.add(u,numeric.mul(s[o],t[a-r+o]));return u},verb.eval.nurbs.zeros_1d=function(e){e=e>0?e:0;for(var r=[];e--;)r.push(0);return r},verb.eval.nurbs.zeros_2d=function(e,r){r=r>0?r:0,e=e>0?e:0;for(var n=[],t=r,i=e;e--;){for(n.push([]);t--;)n[i-e-1].push(0);t=r}return n},verb.eval.nurbs.zeros_3d=function(e,r,n){r=r>0?r:0,e=e>0?e:0;for(var t=[],i=r,a=e;e--;){for(t.push([]);i--;)t[a-e-1].push(verb.eval.nurbs.zeros_1d(n));i=r}return t},verb.eval.nurbs.deriv_basis_functions=function(e,r,n){var t=verb.eval.nurbs.knot_span(r,e,n),i=n.length-1,a=i-r-1;return verb.eval.nurbs.deriv_basis_functions_given_n_i(t,e,r,a,n)},verb.eval.nurbs.deriv_basis_functions_given_n_i=function(e,r,n,t,i){var a=verb.eval.nurbs.zeros_2d(n+1,n+1),s=Array(n+1),u=Array(n+1),o=0,v=0,l=1,c=0;for(a[0][0]=1,l=1;n>=l;l++){for(s[l]=r-i[e+1-l],u[l]=i[e+l]-r,o=0,c=0;l>c;c++)a[l][c]=u[c+1]+s[l-c],v=a[c][l-1]/a[l][c],a[c][l]=o+u[c+1]*v,o=s[l-c]*v;a[l][l]=o}var b=verb.eval.nurbs.zeros_2d(t+1,n+1),_=verb.eval.nurbs.zeros_2d(2,n+1),h=1,m=0,g=1,d=0,f=0,p=0,y=0,x=0;for(l=0;n>=l;l++)b[0][l]=a[l][n];for(c=0;n>=c;c++)for(m=0,g=1,_[0][0]=1,h=1;t>=h;h++){for(d=0,f=c-h,p=n-h,c>=h&&(_[g][0]=_[m][0]/a[p+1][f],d=_[g][0]*a[f][p]),y=f>=-1?1:-f,x=p>=c-1?h-1:n-c,l=y;x>=l;l++)_[g][l]=(_[m][l]-_[m][l-1])/a[p+1][f+l],d+=_[g][l]*a[f+l][p];p>=c&&(_[g][h]=-_[m][h-1]/a[p+1][c],d+=_[g][h]*a[c][p]),b[h][c]=d,l=m,m=g,g=l}for(c=n,h=1;t>=h;h++){for(l=0;n>=l;l++)b[h][l]*=c;c*=n-h}return b},verb.eval.nurbs.basis_functions=function(e,r,n){var t=verb.eval.nurbs.knot_span(e,r,n);return verb.eval.nurbs.basis_functions_given_knot_span_index(t,e,r,n)},verb.eval.nurbs.basis_functions_given_knot_span_index=function(e,r,n,t){var i=Array(n+1),a=Array(n+1),s=Array(n+1),u=0,o=0;i[0]=1;for(var v=1;n>=v;v++){a[v]=r-t[e+1-v],s[v]=t[e+v]-r,u=0;for(var l=0;v>l;l++)o=i[l]/(s[l+1]+a[v-l]),i[l]=u+s[l+1]*o,u=a[v-l]*o;i[v]=u}return i},verb.eval.nurbs.knot_span=function(e,r,n){var t=n.length-1,i=t-e-1;return verb.eval.nurbs.knot_span_given_n(i,e,r,n)},verb.eval.nurbs.knot_span_given_n=function(e,r,n,t){if(n>=t[e+1])return e;if(t[r]>n)return r;for(var i=r,a=e+1,s=Math.floor((i+a)/2);t[s]>n||n>=t[s+1];)t[s]>n?a=s:i=s,s=Math.floor((i+a)/2);return s};