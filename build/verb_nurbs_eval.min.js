/*! verb 2013-09-01 */
if("object"!=typeof exports||void 0===exports)importScripts("labor.js");else var labor=require("labor");var verb=verb||{};verb.eval=verb.eval||{},verb.eval.nurbs=verb.eval.nurbs||{},verb.eval.mesh=verb.eval.mesh||{},verb.EPSILON=1e-8;var router=new labor.Router(verb.eval.nurbs);verb.eval.nurbs.rational_surface_surface_intersect=function(){},verb.eval.mesh.mesh_mesh_intersect=function(){},verb.eval.mesh.mesh_mesh_intersect_aabb=function(){},verb.eval.mesh.make_mesh_aabb=function(){},verb.eval.mesh.make_mesh_aabb=function(n,e,r){for(var t={bounding_box:new verb.geom.BoundingBox,children:[]},i=r.length-1;i>=0;i--){var o=r[i];t.bounding_box.add(n[e[o][0]]),t.bounding_box.add(n[e[o][1]]),t.bounding_box.add(n[e[o][2]])}return 1===r.length?(t.elements=r,t):(t.children=[verb.eval.mesh.make_mesh_aabb(n,e,tri_indices_a),verb.eval.mesh.make_mesh_aabb(n,e,tri_indices_b)],t)},verb.eval.mesh.make_mesh_aabb=function(){},verb.eval.mesh.rational_surface_tesselate_naive=function(n,e,r,t,i,o,a){1>o&&(o=1),1>a&&(a=1);for(var u=1/o,s=1/a,l=[],_=[],c=0;o+1>c;c++)for(var v=0;a+1>v;v++){var h=c*u,b=v*s;_.push([h,b]),l.push(verb.eval.nurbs.rational_surface_point(n,e,r,t,i,h,b))}for(var m=[],c=0;o>c;c++)for(var v=0;a>v;v++){var f=c*(a+1)+v,B=(c+1)*(a+1)+v,p=B+1,d=f+1,g=[f,B,p],V=[f,p,d];m.push(g),m.push(V)}return{points:l,faces:m,uvs:_}},verb.eval.nurbs.rational_curve_curve_bb_intersect_refine=function(n,e,r,t,i,o,a){var u=function(a){var u=verb.eval.nurbs.rational_curve_point(n,e,r,a[0]),s=verb.eval.nurbs.rational_curve_point(t,i,o,a[1]);return numeric.sub(u,s),numeric.dot(p1_p2norm,p1_p2norm)},s=numeric.uncmin(u,a);return[s.f].concat(s.solution)},verb.eval.nurbs.rational_curve_curve_bb_intersect=function(n,e,r,t,i,o,a,u){var s=verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(n,e,r,a),l=verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(n,e,r,a),c=_.map(s,function(n){return n[0]}),v=_.map(l,function(n){return n[0]}),h=_.map(s,function(n){return n.slice(1)}),b=_.map(l,function(n){return n.slice(1)});return verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(h,b,c,v,u)},verb.eval.nurbs.parametric_polyline_polyline_bb_intersect=function(n,e,r,t,i){var o=new verb.geom.BoundingBox(n),a=new verb.geom.BoundingBox(e);if(o.intersects(a)){if(2!==n.length||2!==e.length){if(2===n.length){var u=Math.ceil(e.length/2),s=e.slice(0,u),l=t.slice(0,u),_=e.slice(u-1);return f=e.slice(u-1),verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(n,s,r,l,i).concat(verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(n,_,r,f,i))}if(2===e.length){var c=Math.ceil(n.length/2),v=n.slice(0,c),h=r.slice(0,c),b=n.slice(c-1);return m=n.slice(c-1),verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(e,v,t,v,i).concat(verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(e,b,t,m,i))}var c=Math.ceil(n.length/2),v=n.slice(0,c),h=r.slice(0,c),b=n.slice(c-1),m=n.slice(c-1),u=Math.ceil(e.length/2),s=e.slice(0,u),l=t.slice(0,u),_=e.slice(u-1),f=e.slice(u-1);return verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(v,s,h,s,i).concat(verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(v,_,h,f,i)).concat(verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(b,s,m,l,i)).concat(verb.eval.nurbs.parametric_polyline_polyline_bb_intersect(b,_,m,f,i))}var B=verb.eval.geom.segment_segment_intersect(n[0],n[1],e[0],e[1],i);return null!=B?(B[0][0]=B[0][0]*(r[1]-r[0])+r[0],B[1][0]=B[1][0]*(t[1]-t[0])+t[0],B):[]}},verb.eval.geom.segment_segment_intersect=function(n,e,r,t){var i=numeric.sub(e,n),o=Math.sqrt(numeric.dot(i,i)),a=numeric.mul(1/o,i);if(b1mb0=numeric.sub(t,r),bN=Math.sqrt(numeric.dot(b1mb0,b1mb0)),a=numeric.mul(1/bN,i),int_params=ray_ray_intersect(n,a,r,b),null!=int_params){var u=Math.min(Math.max(0,int_params[0]/a),1),s=Math.min(Math.max(0,int_params[1]/b),1),l=numeric.add(numeric.mul(u,i),n),_=numeric.add(numeric.mul(s,b1mb0),r),c=numeric.norm2Squared(numeric.sub(l,_));if(tolerance*tolerance>c)return[[u].concat(l),[s].concat(_)]}return null},verb.eval.geom.ray_ray_intersect=function(n,e,r,t){var i=numeric.dot(e,t),o=numeric.dot(e,r),a=numeric.dot(e,n),u=numeric.dot(t,r),s=numeric.dot(t,n),l=numeric.dot(e,e),_=numeric.dot(t,t),c=l*_-i*i;if(EPSILON>abs(c))return null;var v=i*(o-a)-l*(u-s),h=v/c,b=(o-a+h*i)/l;return[b,h]},verb.eval.nurbs.rational_curve_regular_sample=function(n,e,r,t){return verb.eval.nurbs.rational_curve_regular_sample_range(n,e,r,0,1,t)},verb.eval.nurbs.rational_curve_regular_sample_range=function(n,e,r,t,i,o){1>o&&(o=2);for(var a=[],u=(i-t)/(o-1),s=0,l=0;o>l;l++)s=t+u*l,a.push([s].concat(verb.eval.nurbs.rational_curve_point(n,e,r,s)));return a},verb.eval.nurbs.rational_curve_adaptive_sample=function(n,e,r,t){return verb.eval.nurbs.rational_curve_adaptive_sample_range(n,e,r,0,1,t)},verb.eval.nurbs.rational_curve_adaptive_sample_range=function(n,e,r,t,i,o){var a=verb.eval.nurbs.rational_curve_point(n,e,r,t),u=verb.eval.nurbs.rational_curve_point(n,e,r,i),s=.45+.1*Math.random(),l=t+(i-t)*s,_=verb.eval.nurbs.rational_curve_point(n,e,r,l);if(verb.eval.nurbs.three_points_are_flat(a,_,u,o))return[[t,a[0],a[1],a[2]],[i,u[0],u[1],u[2]]];var c=verb.eval.nurbs.rational_curve_adaptive_sample_range(n,e,r,t,l,o),v=verb.eval.nurbs.rational_curve_adaptive_sample_range(n,e,r,l,i,o);return c.slice(0,-1).concat(v)},verb.eval.nurbs.three_points_are_flat=function(n,e,r,t){var i=new verb.geom.Vector(n),o=new verb.geom.Vector(e),a=new verb.geom.Vector(r),u=o.minus(i).cross(a.minus(i)),s=u.dot(u);return t>s},verb.eval.nurbs.curve_knot_insert=function(n,e,r,t,i,o){var a=(r[0].length,e.length-n-2),u=r.length,s=verb.eval.nurbs.knot_span(n,t,e),l=a+n+1,_=u+o,c=Array(n+1),v=Array(e.length+o),h=Array(_),b=0;for(b=0;s>=b;b++)v[b]=e[b];for(b=1;o>=b;b++)v[s+b]=t;for(b=s+1;l>=b;b++)v[b+o]=e[b];for(b=0;s-n>=b;b++)h[b]=r[b];for(b=s-i;a>=b;b++)h[b+o]=r[b];for(b=0;n-i>=b;b++)c[b]=r[s-n+1];for(var m=0,f=0,B=1;o>=B;B++){for(m=s-n+B,b=0;n-B-i>=b;b++)f=(t-e[m+b])/(e[b+s+1]-e[m+b]),c[b]=numeric.add(numeric.mul(f,c[b+1]),numeric.mul(1-f,c[b]));h[m]=c[0],h[s+o-B-i]=c[n-B-i]}for(b=m+1;s-i>b;b++)h[b]=c[b-m];return[v,h]},verb.eval.nurbs.rational_surface_derivs=function(n,e,r,t,i,o,a,u){var s=verb.eval.nurbs.surface_derivs(n,e,r,t,i,o,a,u),l=verb.eval.nurbs.separate_homo_derivs_2d(s),_=l[0],c=l[1],v=0,h=0,b=0,m=0,f=[],B=_[0][0].length;for(v=0;o>=v;v++)for(f.push([]),m=0;o-v>=m;m++){var u=_[v][m];for(b=1;m>=b;b++)u=numeric.sub(u,numeric.mul(numeric.mul(binomial.get(m,b),c[0][b]),f[v][m-b]));for(h=1;v>=h;h++){u=numeric.sub(u,numeric.mul(numeric.mul(binomial.get(v,h),c[h][0]),f[v-h][m]));var p=verb.eval.nurbs.zeros_1d(B);for(b=1;m>=b;b++)p=numeric.add(p,numeric.mul(numeric.mul(binomial.get(m,b),c[h][b]),f[v-h][m-b]));u=numeric.sub(u,numeric.mul(binomial.get(v,h),p))}f[v].push(numeric.mul(1/c[0][0],u))}return f},verb.eval.nurbs.rational_surface_point=function(n,e,r,t,i,o,a){return verb.eval.nurbs.dehomogenize(verb.eval.nurbs.surface_point(n,e,r,t,i,o,a))},verb.eval.nurbs.rational_curve_derivs=function(n,e,r,t,i){var o=verb.eval.nurbs.separate_homo_derivs_1d(verb.eval.nurbs.curve_derivs(n,e,r,t,i)),a=o[0],u=o[1],s=0,l=0,_=[];for(s=0;i>=s;s++){var c=a[s];for(l=1;s>=l;l++)c=numeric.sub(c,numeric.mul(numeric.mul(binomial.get(s,l),u[l]),_[s-l]));_.push(numeric.mul(1/u[0],c))}return _},verb.eval.nurbs.separate_homo_derivs_1d=function(n){for(var e=n[0].length,r=e-1,t=[],i=[],o=0,a=n.length;a>o;o++)t.push(n[o].slice(0,r)),i.push(n[o][r]);return[t,i]},verb.eval.nurbs.separate_homo_derivs_2d=function(n){for(var e=[],r=[],t=0,i=n.length;i>t;t++){var o=verb.eval.nurbs.separate_homo_derivs_1d(n[t]);e.push(o[0]),r.push(o[1])}return[e,r]},verb.eval.nurbs.rational_curve_point=function(n,e,r,t){return verb.eval.nurbs.dehomogenize(verb.eval.nurbs.curve_point(n,e,r,t))},verb.eval.nurbs.dehomogenize=function(n){for(var e=n.length,r=[],t=n[e-1],i=0;n.length-1>i;i++)r.push(n[i]/t);return r},verb.eval.nurbs.homogenize_1d=function(n,e){for(var r=n.length,t=n[0].length,i=0,o=[],a=0,u=[],s=0;r>s;s++){var l=[];for(u=n[s],a=e[s],i=0;t>i;i++)l.push(u[i]*a);l.push(a),o.push(l)}return o},verb.eval.nurbs.homogenize_2d=function(n,e){for(var r=n.length,t=(n[0].length,n[0][0].length,[]),i=0;r>i;i++)t.push(verb.eval.nurbs.homogenize_1d(n[i],e[i]));return t},verb.eval.nurbs.surface_derivs=function(n,e,r,t,i,o,a,u){var s=e.length-n-2,l=t.length-r-2;return verb.eval.nurbs.surface_derivs_given_n_m(s,n,e,l,r,t,i,o,a,u)},verb.eval.nurbs.surface_derivs_given_n_m=function(n,e,r,t,i,o,a,u,s,l){if(verb.eval.nurbs.are_valid_relations(e,a.length,r.length)===!1||verb.eval.nurbs.are_valid_relations(i,a[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var _=a[0][0].length,c=Math.min(u,e),v=Math.min(u,i),h=verb.eval.nurbs.zeros_3d(c+1,v+1,_),b=verb.eval.nurbs.knot_span_given_n(n,e,s,r),m=verb.eval.nurbs.knot_span_given_n(t,i,l,o),f=verb.eval.nurbs.deriv_basis_functions_given_n_i(b,s,e,n,r),B=verb.eval.nurbs.deriv_basis_functions_given_n_i(m,l,i,t,o),p=verb.eval.nurbs.zeros_2d(i+1,_),d=0,g=0,V=0,E=0,R=0;for(d=0;c>=d;d++){for(g=0;i>=g;g++)for(p[g]=verb.eval.nurbs.zeros_1d(_),V=0;e>=V;V++)p[g]=numeric.add(p[g],numeric.mul(f[d][V],a[b-e+V][m-i+g]));for(R=Math.min(u-d,v),E=0;R>=E;E++)for(h[d][E]=verb.eval.nurbs.zeros_1d(_),g=0;i>=g;g++)h[d][E]=numeric.add(h[d][E],numeric.mul(B[E][g],p[g]))}return h},verb.eval.nurbs.surface_point=function(n,e,r,t,i,o,a){var u=e.length-n-2,s=t.length-r-2;return verb.eval.nurbs.surface_point_given_n_m(u,n,e,s,r,t,i,o,a)},verb.eval.nurbs.surface_point_given_n_m=function(n,e,r,t,i,o,a,u,s){if(verb.eval.nurbs.are_valid_relations(e,a.length,r.length)===!1||verb.eval.nurbs.are_valid_relations(i,a[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var l=(a[0][0].length,verb.eval.nurbs.knot_span_given_n(n,e,u,r)),_=verb.eval.nurbs.knot_span_given_n(t,i,s,o),c=verb.eval.nurbs.basis_functions_given_knot_span_index(l,u,e,r),v=verb.eval.nurbs.basis_functions_given_knot_span_index(_,s,i,o),h=l-e,b=_,m=verb.eval.nurbs.zeros_1d(a[0][0].length),f=verb.eval.nurbs.zeros_1d(a[0][0].length),B=0,p=0;for(B=0;i>=B;B++){for(f=verb.eval.nurbs.zeros_1d(a[0][0].length),b=_-i+B,p=0;e>=p;p++)f=numeric.add(f,numeric.mul(c[p],a[h+p][b]));m=numeric.add(m,numeric.mul(v[B],f))}return m},verb.eval.nurbs.curve_derivs=function(n,e,r,t,i){var o=e.length-n-2;return verb.eval.nurbs.curve_derivs_given_n(o,n,e,r,t,i)},verb.eval.nurbs.curve_derivs_given_n=function(n,e,r,t,i,o){if(verb.eval.nurbs.are_valid_relations(e,t.length,r.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var a=t[0].length,u=Math.min(o,e),s=verb.eval.nurbs.zeros_2d(u+1,a),l=verb.eval.nurbs.knot_span_given_n(n,e,i,r),_=verb.eval.nurbs.deriv_basis_functions_given_n_i(l,i,e,u,r),c=0,v=0;for(c=0;u>=c;c++)for(v=0;e>=v;v++)s[c]=numeric.add(s[c],numeric.mul(_[c][v],t[l-e+v]));return s},verb.eval.nurbs.are_valid_relations=function(n,e,r){return 0===e+n+1-r?!0:!1},verb.eval.nurbs.curve_point=function(n,e,r,t){var i=e.length-n-2;return verb.eval.nurbs.curve_point_given_n(i,n,e,r,t)},verb.eval.nurbs.curve_point_given_n=function(n,e,r,t,i){if(verb.eval.nurbs.are_valid_relations(e,t.length,r.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;for(var o=verb.eval.nurbs.knot_span_given_n(n,e,i,r),a=verb.eval.nurbs.basis_functions_given_knot_span_index(o,i,e,r),u=verb.eval.nurbs.zeros_1d(t[0].length),s=0;e>=s;s++)u=numeric.add(u,numeric.mul(a[s],t[o-e+s]));return u},verb.eval.nurbs.zeros_1d=function(n){n=n>0?n:0;for(var e=[];n--;)e.push(0);return e},verb.eval.nurbs.zeros_2d=function(n,e){e=e>0?e:0,n=n>0?n:0;for(var r=[],t=e,i=n;n--;){for(r.push([]);t--;)r[i-n-1].push(0);t=e}return r},verb.eval.nurbs.zeros_3d=function(n,e,r){e=e>0?e:0,n=n>0?n:0;for(var t=[],i=e,o=n;n--;){for(t.push([]);i--;)t[o-n-1].push(verb.eval.nurbs.zeros_1d(r));i=e}return t},verb.eval.nurbs.deriv_basis_functions=function(n,e,r){var t=verb.eval.nurbs.knot_span(e,n,r),i=r.length-1,o=i-e-1;return verb.eval.nurbs.deriv_basis_functions_given_n_i(t,n,e,o,r)},verb.eval.nurbs.deriv_basis_functions_given_n_i=function(n,e,r,t,i){var o=verb.eval.nurbs.zeros_2d(r+1,r+1),a=Array(r+1),u=Array(r+1),s=0,l=0,_=1,c=0;for(o[0][0]=1,_=1;r>=_;_++){for(a[_]=e-i[n+1-_],u[_]=i[n+_]-e,s=0,c=0;_>c;c++)o[_][c]=u[c+1]+a[_-c],l=o[c][_-1]/o[_][c],o[c][_]=s+u[c+1]*l,s=a[_-c]*l;o[_][_]=s}var v=verb.eval.nurbs.zeros_2d(t+1,r+1),h=verb.eval.nurbs.zeros_2d(2,r+1),b=1,m=0,f=1,B=0,p=0,d=0,g=0,V=0;for(_=0;r>=_;_++)v[0][_]=o[_][r];for(c=0;r>=c;c++)for(m=0,f=1,h[0][0]=1,b=1;t>=b;b++){for(B=0,p=c-b,d=r-b,c>=b&&(h[f][0]=h[m][0]/o[d+1][p],B=h[f][0]*o[p][d]),g=p>=-1?1:-p,V=d>=c-1?b-1:r-c,_=g;V>=_;_++)h[f][_]=(h[m][_]-h[m][_-1])/o[d+1][p+_],B+=h[f][_]*o[p+_][d];d>=c&&(h[f][b]=-h[m][b-1]/o[d+1][c],B+=h[f][b]*o[c][d]),v[b][c]=B,_=m,m=f,f=_}for(c=r,b=1;t>=b;b++){for(_=0;r>=_;_++)v[b][_]*=c;c*=r-b}return v},verb.eval.nurbs.basis_functions=function(n,e,r){var t=verb.eval.nurbs.knot_span(n,e,r);return verb.eval.nurbs.basis_functions_given_knot_span_index(t,n,e,r)},verb.eval.nurbs.basis_functions_given_knot_span_index=function(n,e,r,t){var i=Array(r+1),o=Array(r+1),a=Array(r+1),u=0,s=0;i[0]=1;for(var l=1;r>=l;l++){o[l]=e-t[n+1-l],a[l]=t[n+l]-e,u=0;for(var _=0;l>_;_++)s=i[_]/(a[_+1]+o[l-_]),i[_]=u+a[_+1]*s,u=o[l-_]*s;i[l]=u}return i},verb.eval.nurbs.knot_span=function(n,e,r){var t=r.length-1,i=t-n-1;return verb.eval.nurbs.knot_span_given_n(i,n,e,r)},verb.eval.nurbs.knot_span_given_n=function(n,e,r,t){if(r>=t[n+1])return n;if(t[e]>r)return e;for(var i=e,o=n+1,a=Math.floor((i+o)/2);t[a]>r||r>=t[a+1];)t[a]>r?o=a:i=a,a=Math.floor((i+o)/2);return a};