/*! verb 2015-01-19 */
if("object"!=typeof exports||void 0===exports)var verb=exports={};else var verb=module.exports={};(function(e){"use strict";function r(e,r){function n(){}n.prototype=e;var o=new n;for(var t in r)o[t]=r[t];return r.toString!==Object.prototype.toString&&(o.toString=r.toString),o}function n(e){return e instanceof Array?function(){return t.iter(e)}:"function"==typeof e.iterator?o(e,e.iterator):e.iterator}function o(e,r){if(null==r)return null;null==r.__id__&&(r.__id__=u++);var n;return null==e.hx__closures__?e.hx__closures__={}:n=e.hx__closures__[r.__id__],null==n&&(n=function(){return n.method.apply(n.scope,arguments)},n.scope=e,n.method=r,e.hx__closures__[r.__id__]=n),n}e.core=e.core||{};var t=function(){};t.iter=function(e){return{cur:0,arr:e,hasNext:function(){return this.cur<this.arr.length},next:function(){return this.arr[this.cur++]}}};var c=function(){};c.fold=function(e,r,o){for(var t=n(e)();t.hasNext();){var c=t.next();o=r(c,o)}return o};var i=function(){},s={};s.ds={},s.ds.IntMap=function(){this.h={}},s.ds.IntMap.__interfaces__=[i],s.ds.IntMap.prototype={set:function(e,r){this.h[e]=r},get:function(e){return this.h[e]},exists:function(e){return this.h.hasOwnProperty(e)},remove:function(e){return this.h.hasOwnProperty(e)?(delete this.h[e],!0):!1}};var a={};a.BoundingBox=e.BoundingBox=function(e){this.max=null,this.min=null,this.dim=3,this.initialized=!1,null!=e&&this.addRange(e)},a.BoundingBox.intervalsOverlap=function(e,r,n,o,t){null==t&&(t=-1);var c;c=0>t?a.BoundingBox.TOLERANCE:t;var i=Math.min(e,r)-c,s=Math.max(e,r)+c,u=Math.min(n,o)-c,l=Math.max(n,o)+c;return i>=u&&l>=i||s>=u&&l>=s||u>=i&&s>=u||l>=i&&s>=l},a.BoundingBox.prototype={fromPoint:function(e){return new a.BoundingBox([e])},add:function(e){if(!this.initialized)return this.dim=e.length,this.min=e.slice(0),this.max=e.slice(0),this.initialized=!0,this;for(var r=0,n=this.dim;n>r;){var o=r++;e[o]>this.max[o]&&(this.max[o]=e[o]),e[o]<this.min[o]&&(this.min[o]=e[o])}return this},addRange:function(e){for(var r=e.length,n=0;r>n;){var o=n++;this.add(e[o])}return this},contains:function(e,r){return null==r&&(r=-1),this.initialized?this.intersects(new a.BoundingBox([e]),r):!1},intersects:function(e,r){if(null==r&&(r=-1),!this.initialized||!e.initialized)return!1;for(var n=this.min,o=this.max,t=e.min,c=e.max,i=0,s=this.dim;s>i;){var u=i++;if(!a.BoundingBox.intervalsOverlap(n[u],o[u],t[u],c[u],r))return!1}return!0},clear:function(){return this.initialized=!1,this},getLongestAxis:function(){for(var e=0,r=0,n=0,o=this.dim;o>n;){var t=n++,c=this.getAxisLength(t);c>e&&(e=c,r=t)}return r},getAxisLength:function(e){return 0>e||e>this.dim-1?0:Math.abs(this.min[e]-this.max[e])},intersect:function(e,r){if(!this.initialized)return null;var n=this.min,o=this.max,t=e.min,c=e.max;if(!this.intersects(e,r))return null;for(var i=[],s=[],u=0,l=this.dim;l>u;){var h=u++;i.push(Math.min(o[h],c[h])),s.push(Math.max(n[h],t[h]))}return new a.BoundingBox([s,i])}},a.Init=function(){},a.Init.main=function(){console.log("verb 0.2.0")},a.NurbsCurve=e.NurbsCurve=function(e,r,n,o){this._data=new a.core.types.CurveData(e,r.slice(0),a.core.Eval.homogenize1d(n.slice(0),o.slice(0)))},a.NurbsCurve.byData=function(e){return new a.NurbsCurve(e.degree,e.knots,a.core.Eval.dehomogenize1d(e.controlPoints),a.core.Eval.weight1d(e.controlPoints))},a.NurbsCurve.prototype={data:function(){return new a.core.types.CurveData(this.degree(),this.knots(),a.core.Eval.homogenize1d(this.controlPoints(),this.weights()))},degree:function(){return this._data.degree},knots:function(){return this._data.knots.slice(0)},controlPoints:function(){return a.core.Eval.dehomogenize1d(this._data.controlPoints)},weights:function(){return a.core.Eval.weight1d(this._data.controlPoints)},point:function(e){return a.core.Eval.rationalCurvePoint(this._data,e)},pointAsync:function(e,r){return a.exe.Dispatcher.instance().eval("Eval","rationalCurvePoint",[this._data,e],r)},derivatives:function(e,r){return null==r&&(r=1),a.core.Eval.rationalCurveDerivatives(this._data,e,r)},closestPoint:function(e){return this.point(this.closestParam(e))},closestParam:function(e){return a.core.Analyze.rationalCurveClosestPoint(this._data,e)},length:function(){return a.core.Analyze.rationalCurveArcLength(this._data)},lengthAtParam:function(e){return a.core.Analyze.rationalCurveArcLength(this._data,e)},paramAtLength:function(e,r){return a.core.Analyze.rationalCurveParamAtArcLength(this._data,e,r)},divideByEqualArcLength:function(e){return a.core.Divide.rationalCurveEquallyByArcLength(this._data,e)},divideByArcLength:function(e){return a.core.Divide.rationalCurveByArcLength(this._data,e)},tessellate:function(e){return a.core.Tess.rationalCurveAdaptiveSample(this._data,e,!1)},split:function(e){var r=this.domain();if(r.min>=e||e>=r.max)throw"Cannot split outside of the domain of the curve!";return a.core.Modify.curveSplit(this._data,e).map(a.NurbsCurve.byData)},domain:function(){return new a.core.types.Interval(this._data.knots[0],a.core.ArrayExtensions.last(this._data.knots))},transform:function(e){for(var r=this.controlPoints(),n=0,o=r.length;o>n;){var t=n++,c=r[t];c.push(1),r[t]=a.core.Mat.dot(e,c).slice(0,c.length-2)}return new a.NurbsCurve(this.degree(),this.knots(),r,this.weights())},clone:function(){return a.NurbsCurve.byData(this._data)}},a.core={},a.core.Analyze=e.core.Analyze=function(){},a.core.Analyze.isRationalSurfaceClosed=function(e,r){null==r&&(r=!0);var n;n=r?e.controlPoints:a.core.Mat.transpose(e.controlPoints);for(var o=0,t=n[0].length;t>o;){var c=o++,i=a.core.Vec.dist(n[0][c],n[n.length-1][c])<a.core.Constants.EPSILON;if(!i)return!1}return!0},a.core.Analyze.rationalSurfaceClosestPoint=function(e,r){for(var n,o,t,c=5,i=0,s=1e-4,u=5e-4,l=e.knotsU[0],h=a.core.ArrayExtensions.last(e.knotsU),v=e.knotsV[0],f=a.core.ArrayExtensions.last(e.knotsV),d=a.core.Analyze.isRationalSurfaceClosed(e),p=a.core.Analyze.isRationalSurfaceClosed(e,!1),m=a.core.Tess.rationalSurfaceAdaptive(e,new a.core.types.AdaptiveRefinementOptions),g=Math.POSITIVE_INFINITY,V=0,y=m.points.length;y>V;){var x=V++,E=m.points[x],b=a.core.Vec.normSquared(a.core.Vec.sub(r,E));g>b&&(g=b,t=m.uvs[x])}for(var _=function(r){return a.core.Eval.rationalSurfaceDerivatives(e,2,r[0],r[1])},M=function(e,r,n){var o=r[1][0],t=r[0][1],c=r[2][0],i=r[0][2],s=r[1][1],u=r[1][1],l=a.core.Vec.dot(o,n),h=a.core.Vec.dot(t,n),v=[-l,-h],f=a.core.Vec.dot(o,o)+a.core.Vec.dot(c,n),d=a.core.Vec.dot(o,t)+a.core.Vec.dot(s,n),p=a.core.Vec.dot(o,t)+a.core.Vec.dot(u,n),m=a.core.Vec.dot(t,t)+a.core.Vec.dot(i,n),g=[[f,d],[p,m]],V=a.core.Mat.solve(g,v);return a.core.Vec.add(V,e)};c>i;){n=_(t),o=a.core.Vec.sub(n[0][0],r);var P=a.core.Vec.norm(o),I=a.core.Vec.dot(n[1][0],o),k=a.core.Vec.norm(n[1][0])*P,B=a.core.Vec.dot(n[0][1],o),C=a.core.Vec.norm(n[0][1])*P,S=I/k,w=B/C,N=s>P,z=u>S,A=u>w;if(N&&z&&A)return t;var T=M(t,n,o);l>T[0]?T=d?[h-(T[0]-l),T[1]]:[l+a.core.Constants.EPSILON,T[1]]:T[0]>h&&(T=d?[l+(T[0]-h),T[1]]:[h-a.core.Constants.EPSILON,T[1]]),v>T[1]?T=p?[T[0],f-(T[1]-v)]:[T[0],v+a.core.Constants.EPSILON]:T[1]>f&&(T=p?[T[0],v+(T[0]-f)]:[T[0],f-a.core.Constants.EPSILON]);var L=a.core.Vec.norm(a.core.Vec.mul(T[0]-t[0],n[1][0])),D=a.core.Vec.norm(a.core.Vec.mul(T[1]-t[1],n[0][1]));if(s>L+D)return t;t=T,i++}return t},a.core.Analyze.rationalCurveClosestPoint=function(e,r){for(var n=.001,o=Math.POSITIVE_INFINITY,t=0,c=a.core.Tess.rationalCurveAdaptiveSample(e,n,!0),i=0,s=c.length-1;s>i;){var u=i++,l=c[u][0],h=c[u+1][0],v=c[u].slice(1),f=c[u+1].slice(1),d=a.core.Trig.segmentClosestPoint(r,v,f,l,h),p=a.core.Vec.norm(a.core.Vec.sub(r,d.pt));o>p&&(o=p,t=d.u)}for(var m,g,V=5,y=0,x=1e-4,E=5e-4,b=e.knots[0],_=a.core.ArrayExtensions.last(e.knots),M=a.core.Vec.normSquared(a.core.Vec.sub(e.controlPoints[0],a.core.ArrayExtensions.last(e.controlPoints)))<a.core.Constants.EPSILON,P=t,I=function(r){return a.core.Eval.rationalCurveDerivatives(e,r,2)},k=function(e,r,n){var o=a.core.Vec.dot(r[1],n),t=a.core.Vec.dot(r[2],n),c=a.core.Vec.dot(r[1],r[1]),i=t+c;return e-o/i};V>y;){m=I(P),g=a.core.Vec.sub(m[0],r);var B=a.core.Vec.norm(g),C=a.core.Vec.dot(m[1],g),S=a.core.Vec.norm(m[1])*B,w=C/S,N=x>B,z=E>Math.abs(w);if(N&&z)return P;var A=k(P,m,g);b>A?A=M?_-(A-b):b:A>_&&(A=M?b+(A-_):_);var T=a.core.Vec.norm(a.core.Vec.mul(A-P,m[1]));if(x>T)return P;P=A,y++}return P},a.core.Analyze.rationalCurveParamAtArcLength=function(e,r,n,o,t){if(null==n&&(n=.001),a.core.Constants.EPSILON>r)return e.knots[0];var c;c=null!=o?o:a.core.Modify.decomposeCurveIntoBeziers(e);var i=0;c[i];var s,u=-a.core.Constants.EPSILON;for(s=null!=t?t:[];r>u&&c.length>i;){if(s[i]=s.length>i?s[i]:a.core.Analyze.rationalBezierCurveArcLength(e),u+=s[i],u+a.core.Constants.EPSILON>r)return a.core.Analyze.rationalBezierCurveParamAtArcLength(e,r,n,s[i]);i++}return-1},a.core.Analyze.rationalBezierCurveParamAtArcLength=function(e,r,n,o){if(0>r)return e.knots[0];var t;if(t=null!=o?o:a.core.Analyze.rationalBezierCurveArcLength(e),r>t)return a.core.ArrayExtensions.last(e.knots);var c,i=e.knots[0],s=0,u=a.core.ArrayExtensions.last(e.knots),l=t,h=0,v=0;for(c=null!=n?n:2*a.core.Constants.TOLERANCE;l-s>c;)h=(i+u)/2,v=a.core.Analyze.rationalBezierCurveArcLength(e,h),v>r?(u=h,l=v):(i=h,s=v);return(i+u)/2},a.core.Analyze.rationalCurveArcLength=function(e,r,n){null==n&&(n=16),r=null==r?a.core.ArrayExtensions.last(e.knots):r;for(var o=a.core.Modify.decomposeCurveIntoBeziers(e),t=0,c=o[0],i=0;o.length>t&&r>c.knots[0]+a.core.Constants.EPSILON;){var s=Math.min(a.core.ArrayExtensions.last(c.knots),r);i+=a.core.Analyze.rationalBezierCurveArcLength(c,s,n),c=o[++t]}return i},a.core.Analyze.rationalBezierCurveArcLength=function(e,r,n){null==n&&(n=16);var o;o=null==r?a.core.ArrayExtensions.last(e.knots):r;for(var t,c,i=(o-e.knots[0])/2,s=0,u=e.degree+n,l=0;u>l;){var h=l++;t=i*a.core.Analyze.Tvalues[u][h]+i+e.knots[0],c=a.core.Eval.rationalCurveDerivatives(e,t,1),s+=a.core.Analyze.Cvalues[u][h]*a.core.Vec.norm(c[1])}return i*s},a.core.ArrayExtensions=function(){},a.core.ArrayExtensions.last=function(e){return e[e.length-1]},a.core.ArrayExtensions.first=function(e){return e[0]},a.core.ArrayExtensions.spliceAndInsert=function(e,r,n,o){e.splice(r,n),e.splice(r,0,o)},a.core.ArrayExtensions.left=function(e){if(0==e.length)return[];var r=Math.ceil(e.length/2);return e.slice(0,r)},a.core.ArrayExtensions.right=function(e){if(0==e.length)return[];var r=Math.ceil(e.length/2);return e.slice(r)},a.core.ArrayExtensions.rightWithPivot=function(e){if(0==e.length)return[];var r=Math.ceil(e.length/2);return e.slice(r-1)},a.core.ArrayExtensions.unique=function(e,r){if(0==e.length)return[];for(var n=[e.pop()];e.length>0;){for(var o=e.pop(),t=!0,c=0;n.length>c;){var i=n[c];if(++c,r(o,i)){t=!1;break}}t&&n.push(o)}return n},a.core.Binomial=function(){},a.core.Binomial.get=function(e,r){if(0==r)return 1;if(0==e||r>e)return 0;if(r>e-r&&(r=e-r),a.core.Binomial.memo_exists(e,r))return a.core.Binomial.get_memo(e,r);for(var n=1,o=e,t=1,c=r+1;c>t;){var i=t++;a.core.Binomial.memo_exists(o,i)?(e--,n=a.core.Binomial.get_memo(o,i)):(n*=e--,n/=i,a.core.Binomial.memoize(o,i,n))}return n},a.core.Binomial.get_no_memo=function(e,r){if(0==r)return 1;if(0==e||r>e)return 0;r>e-r&&(r=e-r);for(var n=1,o=1,t=r+1;t>o;){var c=o++;n*=e--,n/=c}return n},a.core.Binomial.memo_exists=function(e,r){return a.core.Binomial.memo.exists(e)&&a.core.Binomial.memo.get(e).exists(r)},a.core.Binomial.get_memo=function(e,r){return a.core.Binomial.memo.get(e).get(r)},a.core.Binomial.memoize=function(e,r,n){a.core.Binomial.memo.exists(e)||a.core.Binomial.memo.set(e,new s.ds.IntMap),a.core.Binomial.memo.get(e).set(r,n)},a.core.Constants=e.core.Constants=function(){},a.core.Divide=e.core.Divide=function(){},a.core.Divide.rationalCurveEquallyByArcLength=function(e,r){var n=a.core.Analyze.rationalCurveArcLength(e),o=n/r;return a.core.Divide.rationalCurveByArcLength(e,o)},a.core.Divide.rationalCurveByArcLength=function(e,r){var n=a.core.Modify.decomposeCurveIntoBeziers(e),o=n.map(function(e){return a.core.Analyze.rationalBezierCurveArcLength(e)}),t=a.core.Vec.sum(o),c=[new a.core.types.CurveLengthSample(e.knots[0],0)];if(r>t)return c;for(var i,s=r,u=0,l=s,h=0,v=0;n.length>u;){for(h+=o[u];h+a.core.Constants.EPSILON>l;)i=a.core.Analyze.rationalBezierCurveParamAtArcLength(n[u],l-v,a.core.Constants.TOLERANCE,o[u]),c.push(new a.core.types.CurveLengthSample(i,l)),l+=s;v+=o[u],u++}return c},a.core.Eval=e.core.Eval=function(){},a.core.Eval.volumePoint=function(e,r,n,o){var t=e.knotsU.length-e.degreeU-2,c=e.knotsV.length-e.degreeV-2,i=e.knotsW.length-e.degreeW-2;return a.core.Eval.volumePointGivenNML(e,t,c,i,r,n,o)},a.core.Eval.volumePointGivenNML=function(e,r,n,o,t,c,i){if(!a.core.Eval.areValidRelations(e.degreeU,e.controlPoints.length,e.knotsU.length)||!a.core.Eval.areValidRelations(e.degreeV,e.controlPoints[0].length,e.knotsV.length)||!a.core.Eval.areValidRelations(e.degreeW,e.controlPoints[0][0].length,e.knotsW.length))throw"Invalid relations between control points and knot vector";for(var s=e.controlPoints,u=e.degreeU,l=e.degreeV,h=e.degreeW,v=e.knotsU,f=e.knotsV,d=e.knotsW,p=s[0][0][0].length,m=a.core.Eval.knotSpanGivenN(r,u,t,v),g=a.core.Eval.knotSpanGivenN(n,l,c,f),V=a.core.Eval.knotSpanGivenN(o,h,i,d),y=a.core.Eval.basisFunctionsGivenKnotSpanIndex(m,t,u,v),x=a.core.Eval.basisFunctionsGivenKnotSpanIndex(g,c,l,f),E=a.core.Eval.basisFunctionsGivenKnotSpanIndex(V,i,h,d),b=m-u,_=a.core.Vec.zeros1d(p),M=a.core.Vec.zeros1d(p),P=a.core.Vec.zeros1d(p),I=0,k=h+1;k>I;){var B=I++;P=a.core.Vec.zeros1d(p);for(var C=V-h+B,S=0,w=l+1;w>S;){var N=S++;M=a.core.Vec.zeros1d(p);for(var z=g-l+N,A=0,T=u+1;T>A;){var L=A++;M=a.core.Vec.add(M,a.core.Vec.mul(y[L],s[b+L][z][C]))}P=a.core.Vec.add(P,a.core.Vec.mul(x[N],M))}_=a.core.Vec.add(_,a.core.Vec.mul(E[B],P))}return _},a.core.Eval.rationalSurfaceDerivatives=function(e,r,n,o){for(var t=a.core.Eval.surfaceDerivatives(e,r,n,o),c=a.core.Eval.rational2d(t),i=a.core.Eval.weight2d(t),s=[],u=c[0][0].length,l=0,h=r+1;h>l;){var v=l++;s.push([]);for(var f=0,d=r-v+1;d>f;){for(var p=f++,m=c[v][p],g=1,V=p+1;V>g;){var y=g++;m=a.core.Vec.sub(m,a.core.Vec.mul(a.core.Binomial.get(p,y)*i[0][y],s[v][p-y]))}for(var x=1,E=v+1;E>x;){var b=x++;m=a.core.Vec.sub(m,a.core.Vec.mul(a.core.Binomial.get(v,b)*i[b][0],s[v-b][p]));for(var _=a.core.Vec.zeros1d(u),M=1,P=p+1;P>M;){var I=M++;_=a.core.Vec.add(_,a.core.Vec.mul(a.core.Binomial.get(p,I)*i[b][I],s[v-b][p-I]))}m=a.core.Vec.sub(m,a.core.Vec.mul(a.core.Binomial.get(v,b),_))}s[v].push(a.core.Vec.mul(1/i[0][0],m))}}return s},a.core.Eval.rationalSurfacePoint=function(e,r,n){return a.core.Eval.dehomogenize(a.core.Eval.surfacePoint(e,r,n))},a.core.Eval.rationalCurveDerivatives=function(e,r,n){for(var o=a.core.Eval.curveDerivatives(e,r,n),t=a.core.Eval.rational1d(o),c=a.core.Eval.weight1d(o),i=[],s=0,u=n+1;u>s;){for(var l=s++,h=t[l],v=1,f=l+1;f>v;){var d=v++;h=a.core.Vec.sub(h,a.core.Vec.mul(a.core.Binomial.get(l,d)*c[d],i[l-d]))}i.push(a.core.Vec.mul(1/c[0],h))}return i},a.core.Eval.rationalCurvePoint=function(e,r){return a.core.Eval.dehomogenize(a.core.Eval.curvePoint(e,r))},a.core.Eval.dehomogenize=function(e){for(var r=e.length,n=[],o=e[r-1],t=e.length-1,c=0;t>c;){var i=c++;n.push(e[i]/o)}return n},a.core.Eval.rational1d=function(e){var r=e[0].length-1;return e.map(function(e){return e.slice(0,r)})},a.core.Eval.rational2d=function(e){return e.map(a.core.Eval.rational1d)},a.core.Eval.weight1d=function(e){var r=e[0].length-1;return e.map(function(e){return e[r]})},a.core.Eval.weight2d=function(e){return e.map(a.core.Eval.weight1d)},a.core.Eval.dehomogenize1d=function(e){return e.map(a.core.Eval.dehomogenize)},a.core.Eval.dehomogenize2d=function(e){return e.map(a.core.Eval.dehomogenize1d)},a.core.Eval.homogenize1d=function(e,r){for(var n=e.length,o=e[0].length,t=[],c=0,i=[],s=0;n>s;){var a=s++,u=[];i=e[a],c=r[a];for(var l=0;o>l;){var h=l++;u.push(i[h]*c)}u.push(c),t.push(u)}return t},a.core.Eval.homogenize2d=function(e,r){for(var n=e.length,o=[],t=0;n>t;){var c=t++;o.push(a.core.Eval.homogenize1d(e[c],r[c]))}return o},a.core.Eval.surfaceDerivatives=function(e,r,n,o){var t=e.knotsU.length-e.degreeU-2,c=e.knotsV.length-e.degreeV-2;return a.core.Eval.surfaceDerivativesGivenNM(t,c,e,r,n,o)},a.core.Eval.surfaceDerivativesGivenNM=function(e,r,n,o,t,c){var i=n.degreeU,s=n.degreeV,u=n.controlPoints,l=n.knotsU,h=n.knotsV;if(!a.core.Eval.areValidRelations(i,u.length,l.length)||!a.core.Eval.areValidRelations(s,u[0].length,h.length))throw"Invalid relations between control points, knot vector, and n";var v,f=u[0][0].length;v=i>o?o:i;var d;d=s>o?o:s;for(var p=a.core.Vec.zeros3d(v+1,d+1,f),m=a.core.Eval.knotSpanGivenN(e,i,t,l),g=a.core.Eval.knotSpanGivenN(r,s,c,h),V=a.core.Eval.derivativeBasisFunctionsGivenNI(m,t,i,e,l),y=a.core.Eval.derivativeBasisFunctionsGivenNI(g,c,s,r,h),x=a.core.Vec.zeros2d(s+1,f),E=0,b=0,_=v+1;_>b;){for(var M=b++,P=0,I=s+1;I>P;){var k=P++;x[k]=a.core.Vec.zeros1d(f);for(var B=0,C=i+1;C>B;){var S=B++;x[k]=a.core.Vec.add(x[k],a.core.Vec.mul(V[M][S],u[m-i+S][g-s+k]))}}var w=o-M;E=d>w?w:d;for(var N=0,z=E+1;z>N;){var A=N++;p[M][A]=a.core.Vec.zeros1d(f);for(var T=0,L=s+1;L>T;){var D=T++;p[M][A]=a.core.Vec.add(p[M][A],a.core.Vec.mul(y[A][D],x[D]))}}}return p},a.core.Eval.surfacePoint=function(e,r,n){var o=e.knotsU.length-e.degreeU-2,t=e.knotsV.length-e.degreeV-2;return a.core.Eval.surfacePointGivenNM(o,t,e,r,n)},a.core.Eval.surfacePointGivenNM=function(e,r,n,o,t){var c=n.degreeU,i=n.degreeV,s=n.controlPoints,u=n.knotsU,l=n.knotsV;if(!a.core.Eval.areValidRelations(c,s.length,u.length)||!a.core.Eval.areValidRelations(i,s[0].length,l.length))throw"Invalid relations between control points, knot vector, and n";for(var h=s[0][0].length,v=a.core.Eval.knotSpanGivenN(e,c,o,u),f=a.core.Eval.knotSpanGivenN(r,i,t,l),d=a.core.Eval.basisFunctionsGivenKnotSpanIndex(v,o,c,u),p=a.core.Eval.basisFunctionsGivenKnotSpanIndex(f,t,i,l),m=v-c,g=f,V=a.core.Vec.zeros1d(h),y=a.core.Vec.zeros1d(h),x=0,E=i+1;E>x;){var b=x++;y=a.core.Vec.zeros1d(h),g=f-i+b;for(var _=0,M=c+1;M>_;){var P=_++;y=a.core.Vec.add(y,a.core.Vec.mul(d[P],s[m+P][g]))}V=a.core.Vec.add(V,a.core.Vec.mul(p[b],y))}return V},a.core.Eval.curveDerivatives=function(e,r,n){var o=e.knots.length-e.degree-2;return a.core.Eval.curveDerivativesGivenN(o,e,r,n)},a.core.Eval.curveDerivativesGivenN=function(e,r,n,o){var t=r.degree,c=r.controlPoints,i=r.knots;if(!a.core.Eval.areValidRelations(t,c.length,i.length))throw"Invalid relations between control points, knot vector, and n";var s,u=c[0].length;s=t>o?o:t;for(var l=a.core.Vec.zeros2d(s+1,u),h=a.core.Eval.knotSpanGivenN(e,t,n,i),v=a.core.Eval.derivativeBasisFunctionsGivenNI(h,n,t,s,i),f=0,d=s+1;d>f;)for(var p=f++,m=0,g=t+1;g>m;){var V=m++;l[p]=a.core.Vec.add(l[p],a.core.Vec.mul(v[p][V],c[h-t+V]))}return l},a.core.Eval.curvePoint=function(e,r){var n=e.knots.length-e.degree-2;return a.core.Eval.curvePoint_given_n(n,e,r)},a.core.Eval.areValidRelations=function(e,r,n){return 0==r+e+1-n},a.core.Eval.curvePoint_given_n=function(e,r,n){var o=r.degree,t=r.controlPoints,c=r.knots;if(!a.core.Eval.areValidRelations(o,t.length,c.length))throw"Invalid relations between control points, knot Array, and n";for(var i=a.core.Eval.knotSpanGivenN(e,o,n,c),s=a.core.Eval.basisFunctionsGivenKnotSpanIndex(i,n,o,c),u=a.core.Vec.zeros1d(t[0].length),l=0,h=o+1;h>l;){var v=l++;u=a.core.Vec.add(u,a.core.Vec.mul(s[v],t[i-o+v]))}return u},a.core.Eval.deriv_basisFunctions=function(e,r,n){var o=a.core.Eval.knotSpan(r,e,n),t=n.length-1,c=t-r-1;return a.core.Eval.derivativeBasisFunctionsGivenNI(o,e,r,c,n)},a.core.Eval.derivativeBasisFunctionsGivenNI=function(e,r,n,o,t){var c=a.core.Vec.zeros2d(n+1,n+1),i=a.core.Vec.zeros1d(n+1),s=a.core.Vec.zeros1d(n+1),u=0,l=0;c[0][0]=1;for(var h=1,v=n+1;v>h;){var f=h++;i[f]=r-t[e+1-f],s[f]=t[e+f]-r,u=0;for(var d=0;f>d;){var p=d++;c[f][p]=s[p+1]+i[f-p],l=c[p][f-1]/c[f][p],c[p][f]=u+s[p+1]*l,u=i[f-p]*l}c[f][f]=u}for(var m=a.core.Vec.zeros2d(o+1,n+1),g=a.core.Vec.zeros2d(2,n+1),V=0,y=1,x=0,E=0,b=0,_=0,M=0,P=0,I=n+1;I>P;){var k=P++;m[0][k]=c[k][n]}for(var B=0,C=n+1;C>B;){var S=B++;V=0,y=1,g[0][0]=1;for(var w=1,N=o+1;N>w;){var z=w++;x=0,E=S-z,b=n-z,S>=z&&(g[y][0]=g[V][0]/c[b+1][E],x=g[y][0]*c[E][b]),_=E>=-1?1:-E,M=b>=S-1?z-1:n-S;for(var A=_,T=M+1;T>A;){var L=A++;g[y][L]=(g[V][L]-g[V][L-1])/c[b+1][E+L],x+=g[y][L]*c[E+L][b]}b>=S&&(g[y][z]=-g[V][z-1]/c[b+1][S],x+=g[y][z]*c[S][b]),m[z][S]=x;var D=V;V=y,y=D}}for(var U=n,R=1,O=o+1;O>R;){for(var F=R++,G=0,K=n+1;K>G;){var q=G++;m[F][q]*=U}U*=n-F}return m},a.core.Eval.basisFunctions=function(e,r,n){var o=a.core.Eval.knotSpan(r,e,n);return a.core.Eval.basisFunctionsGivenKnotSpanIndex(o,e,r,n)},a.core.Eval.basisFunctionsGivenKnotSpanIndex=function(e,r,n,o){var t=a.core.Vec.zeros1d(n+1),c=a.core.Vec.zeros1d(n+1),i=a.core.Vec.zeros1d(n+1),s=0,u=0;t[0]=1;for(var l=1,h=n+1;h>l;){var v=l++;c[v]=r-o[e+1-v],i[v]=o[e+v]-r,s=0;for(var f=0;v>f;){var d=f++;u=t[d]/(i[d+1]+c[v-d]),t[d]=s+i[d+1]*u,s=c[v-d]*u}t[v]=s}return t},a.core.Eval.knotSpan=function(e,r,n){var o=n.length-1,t=o-e-1;return a.core.Eval.knotSpanGivenN(t,e,r,n)},a.core.Eval.knotSpanGivenN=function(e,r,n,o){if(n>=o[e+1])return e;if(o[r]>n)return r;for(var t=r,c=e+1,i=Math.floor((t+c)/2);o[i]>n||n>=o[i+1];)o[i]>n?c=i:t=i,i=Math.floor((t+c)/2);return i},a.core.Intersect=e.core.Intersect=function(){},a.core.Intersect.surfaces=function(e,r,n){var o=a.core.Tess.rationalSurfaceAdaptive(e),t=a.core.Tess.rationalSurfaceAdaptive(r),c=a.core.Intersect.meshes(o,t),i=c.map(function(o){return o.map(function(o){return a.core.Intersect.surfaces_at_point_with_estimate(e,r,o.uv0,o.uv1,n)})});return i.map(function(e){return a.core.Make.rationalInterpCurve(e.map(function(e){return e.point}),3)})},a.core.Intersect.surfaces_at_point_with_estimate=function(e,r,n,o,t){var c,i,s,u,l,h,v,f,d,p,m,g,V,y=10,x=0;do{if(c=a.core.Eval.rationalSurfaceDerivatives(e,1,n[0],n[1]),i=c[0][0],u=c[1][0],l=c[0][1],s=a.core.Vec.normalized(a.core.Vec.cross(u,l)),h=a.core.Vec.dot(s,i),v=a.core.Eval.rationalSurfaceDerivatives(e,1,o[0],o[1]),f=v[0][0],p=v[1][0],m=v[0][1],d=a.core.Vec.normalized(a.core.Vec.cross(p,m)),g=a.core.Vec.dot(d,f),V=a.core.Vec.norm(a.core.Vec.sub(i,f)),t>V)break;var E=a.core.Vec.normalized(a.core.Vec.cross(s,d)),b=a.core.Vec.dot(E,i),_=a.core.Intersect.threePlanes(s,h,d,g,E,b);if(null==_)throw"panic!";var M=a.core.Vec.sub(_,i),P=a.core.Vec.sub(_,f),I=a.core.Vec.cross(u,s),k=a.core.Vec.cross(l,s),B=a.core.Vec.cross(p,d),C=a.core.Vec.cross(m,d),S=a.core.Vec.dot(k,M)/a.core.Vec.dot(k,u),w=a.core.Vec.dot(I,M)/a.core.Vec.dot(I,l),N=a.core.Vec.dot(C,P)/a.core.Vec.dot(C,p),z=a.core.Vec.dot(B,P)/a.core.Vec.dot(B,m);n=a.core.Vec.add([S,w],n),o=a.core.Vec.add([N,z],o),x++}while(y>x);return new a.core.types.SurfaceSurfaceIntersectionPoint(n,o,i,V)},a.core.Intersect.meshes=function(e,r){var n=a.core.Intersect.bounding_box_trees(new a.core.types.LazyMeshBoundingBoxTree(e),new a.core.types.LazyMeshBoundingBoxTree(r),0),o=a.core.ArrayExtensions.unique(n.map(function(n){return a.core.Intersect.triangles(e,n.item0,r,n.item1)}).filter(function(e){return null!=e}).filter(function(e){return a.core.Vec.distSquared(e.min.point,e.max.point)>a.core.Constants.EPSILON}),function(e,r){var n=a.core.Vec.sub(e.min.uv0,r.min.uv0),o=a.core.Vec.dot(n,n),t=a.core.Vec.sub(e.max.uv0,r.max.uv0),c=a.core.Vec.dot(t,t),i=a.core.Vec.sub(e.min.uv0,r.max.uv0),s=a.core.Vec.dot(i,i),u=a.core.Vec.sub(e.max.uv0,r.min.uv0),l=a.core.Vec.dot(u,u);return a.core.Constants.EPSILON>o&&a.core.Constants.EPSILON>c||a.core.Constants.EPSILON>s&&a.core.Constants.EPSILON>l});return 0==o.length?[]:a.core.Intersect.makeMeshIntersectionPolylines(o)},a.core.Intersect.makeMeshIntersectionPolylines=function(e){for(var r=0;e.length>r;){var n=e[r];++r,n.max.opp=n.min,n.min.opp=n.max}for(var o=a.core.Intersect.kdTreeFromSegments(e),t=[],c=0;e.length>c;){var i=e[c];++c,t.push(i.min),t.push(i.max)}for(var s=0;t.length>s;){var u=t[s];if(++s,null==u.adj){var l=a.core.Intersect.lookupAdjacentSegment(u,o,e.length);null!=l&&null==l.adj&&(u.adj=l,l.adj=u)}}var h=t.filter(function(e){return null==e.adj});0==h.length&&(h=t);for(var v=[],f=0;h.length>f;){var d=h[f];if(++f,!d.visited){for(var p=[],m=d;null!=m;){if(m.visited)throw"Segment end encountered twice!";if(m.visited=!0,m.opp.visited=!0,p.push(m),m=m.opp.adj,m==d)break}p.length>0&&(p.push(p[p.length-1].opp),v.push(p))}}return v},a.core.Intersect.kdTreeFromSegments=function(e){for(var r=[],n=0;e.length>n;){var o=e[n];++n,r.push(new a.core.KdPoint(o.min.point,o.min)),r.push(new a.core.KdPoint(o.max.point,o.max))}return new a.core.KdTree(r,a.core.Vec.distSquared)},a.core.Intersect.lookupAdjacentSegment=function(e,r,n){var o;o=null!=n?3>n?3:n:3;var t=r.nearest(e.point,o,a.core.Constants.EPSILON).filter(function(r){return e!=r.item0.obj}).map(function(e){return e.item0.obj});return 1==t.length?t[0]:null},a.core.Intersect.curveAndSurface=function(e,r,n){null==n&&(n=.001);var o=a.core.Intersect.bounding_box_trees(new a.core.types.LazyCurveBoundingBoxTree(e),new a.core.types.LazySurfaceBoundingBoxTree(r),0);return o.map(function(e){var r=e.item0,o=e.item1,t=r.knots[0],c=a.core.ArrayExtensions.last(r.knots),i=(t+c)/2,s=o.knotsU[0],u=a.core.ArrayExtensions.last(o.knotsU),l=o.knotsV[0],h=a.core.ArrayExtensions.last(o.knotsV),v=[(s+u)/2,(l+h)/2];return a.core.Intersect.curveAndSurfaceWithEstimate(r,o,[i].concat(v),n)})},a.core.Intersect.curveAndSurfaceWithEstimate=function(e,r,n,o){null==o&&(o=.001);var t=function(n){var o=a.core.Eval.rationalCurvePoint(e,n[0]),t=a.core.Eval.rationalSurfacePoint(r,n[1],n[2]),c=a.core.Vec.sub(o,t);return a.core.Vec.dot(c,c)},c=a.core.Numeric.uncmin(t,n,o),i=c.solution;return new a.core.types.CurveSurfaceIntersection(i[0],[i[1],i[2]])},a.core.Intersect.polyline_and_mesh=function(e,r,n){for(var o=a.core.Intersect.bounding_box_trees(new a.core.types.LazyPolylineBoundingBoxTree(e),new a.core.types.LazyMeshBoundingBoxTree(r),n),t=[],c=0;o.length>c;){var i=o[c];++c;var s=i.item0,u=i.item1,l=a.core.Intersect.segmentWithTriangle(e.points[s],e.points[s+1],r.points,r.faces[u]);if(null!=l){var h=l.point,v=a.core.Vec.lerp(l.p,[e.params[s]],[e.params[s+1]])[0],f=a.core.Mesh.triangleUVFromPoint(r,u,h);t.push(new a.core.types.PolylineMeshIntersection(h,v,f,s,u))}}return t},a.core.Intersect.mesh_bounding_boxes=function(e,r,n){return a.core.Intersect.bounding_box_trees(new a.core.types.LazyMeshBoundingBoxTree(e),new a.core.types.LazyMeshBoundingBoxTree(r),n)},a.core.Intersect.bounding_box_trees=function(e,r,n){if(null==n&&(n=1e-9),e.empty()||r.empty())return[];if(!e.boundingBox().intersects(r.boundingBox(),n))return[];if(e.indivisible(n)&&r.indivisible(n))return[new a.core.types.Pair(e.yield(),r.yield())];var o=e.split(),t=r.split();return a.core.Intersect.bounding_box_trees(o.item0,t.item0,n).concat(a.core.Intersect.bounding_box_trees(o.item0,t.item1,n)).concat(a.core.Intersect.bounding_box_trees(o.item1,t.item0,n)).concat(a.core.Intersect.bounding_box_trees(o.item1,t.item1,n))},a.core.Intersect.curves=function(e,r,n){var o=a.core.Intersect.bounding_box_trees(new a.core.types.LazyCurveBoundingBoxTree(e),new a.core.types.LazyCurveBoundingBoxTree(r),0);return o.map(function(o){return a.core.Intersect.curves_with_estimate(e,r,o.item0.knots[0],o.item1.knots[0],n)})},a.core.Intersect.curves_with_estimate=function(e,r,n,o,t){var c=function(n){var o=a.core.Eval.rationalCurvePoint(e,n[0]),t=a.core.Eval.rationalCurvePoint(r,n[1]),c=a.core.Vec.sub(o,t);return a.core.Vec.dot(c,c)},i=a.core.Numeric.uncmin(c,[n,o],t),s=i.solution[0],u=i.solution[1],l=a.core.Eval.rationalCurvePoint(e,s),h=a.core.Eval.rationalCurvePoint(r,u);return new a.core.types.CurveCurveIntersection(l,h,s,u)},a.core.Intersect.triangles=function(e,r,n,o){var t=e.faces[r],c=n.faces[o],i=a.core.Mesh.getTriangleNorm(e.points,t),s=a.core.Mesh.getTriangleNorm(n.points,c),u=e.points[t[0]],l=n.points[c[0]],h=a.core.Intersect.planes(u,i,l,s);if(null==h)return null;var v=a.core.Intersect.clipRayInCoplanarTriangle(h,e,r);if(null==v)return null;var f=a.core.Intersect.clipRayInCoplanarTriangle(h,n,o);if(null==f)return null;var d=a.core.Intersect.mergeTriangleClipIntervals(v,f,e,r,n,o);return null==d?null:new a.core.types.Interval(new a.core.types.MeshIntersectionPoint(d.min.uv0,d.min.uv1,d.min.point,r,o),new a.core.types.MeshIntersectionPoint(d.max.uv0,d.max.uv1,d.max.point,r,o))},a.core.Intersect.clipRayInCoplanarTriangle=function(e,r,n){for(var o=r.faces[n],t=[r.points[o[0]],r.points[o[1]],r.points[o[2]]],c=[r.uvs[o[0]],r.uvs[o[1]],r.uvs[o[2]]],i=[a.core.Vec.sub(c[1],c[0]),a.core.Vec.sub(c[2],c[1]),a.core.Vec.sub(c[0],c[2])],s=[a.core.Vec.sub(t[1],t[0]),a.core.Vec.sub(t[2],t[1]),a.core.Vec.sub(t[0],t[2])],u=s.map(a.core.Vec.normalized),l=s.map(a.core.Vec.norm),h=null,v=null,f=0;3>f;){var d=f++,p=t[d],m=u[d],g=a.core.Intersect.rays(p,m,e.origin,e.dir);if(null!=g){var V=g.u0,y=g.u1;-a.core.Constants.EPSILON>V||V>l[d]+a.core.Constants.EPSILON||((null==h||h.u>y)&&(h=new a.core.types.CurveTriPoint(y,a.core.Vec.onRay(e.origin,e.dir,y),a.core.Vec.onRay(c[d],i[d],V/l[d]))),(null==v||y>v.u)&&(v=new a.core.types.CurveTriPoint(y,a.core.Vec.onRay(e.origin,e.dir,y),a.core.Vec.onRay(c[d],i[d],V/l[d]))))}}return null==v||null==h?null:new a.core.types.Interval(h,v)},a.core.Intersect.mergeTriangleClipIntervals=function(e,r,n,o,t,c){if(r.min.u>e.max.u+a.core.Constants.EPSILON||e.min.u>r.max.u+a.core.Constants.EPSILON)return null;var i;i=e.min.u>r.min.u?new a.core.types.Pair(e.min,0):new a.core.types.Pair(r.min,1);var s;s=e.max.u<r.max.u?new a.core.types.Pair(e.max,0):new a.core.types.Pair(r.max,1);var u=new a.core.types.Interval(new a.core.types.MeshIntersectionPoint(null,null,i.item0.point,o,c),new a.core.types.MeshIntersectionPoint(null,null,s.item0.point,o,c));return 0==i.item1?(u.min.uv0=i.item0.uv,u.min.uv1=a.core.Mesh.triangleUVFromPoint(t,c,i.item0.point)):(u.min.uv0=a.core.Mesh.triangleUVFromPoint(n,o,i.item0.point),u.min.uv1=i.item0.uv),0==s.item1?(u.max.uv0=s.item0.uv,u.max.uv1=a.core.Mesh.triangleUVFromPoint(t,c,s.item0.point)):(u.max.uv0=a.core.Mesh.triangleUVFromPoint(n,o,s.item0.point),u.max.uv1=s.item0.uv),u},a.core.Intersect.planes=function(e,r,n,o){var t=a.core.Vec.cross(r,o);if(a.core.Vec.dot(t,t)<a.core.Constants.EPSILON)return null;var c=0,i=Math.abs(t[0]),s=Math.abs(t[1]),u=Math.abs(t[2]);s>i&&(c=1,i=s),u>i&&(c=2,i=u);var l,h,v,f;0==c?(l=r[1],h=r[2],v=o[1],f=o[2]):1==c?(l=r[0],h=r[2],v=o[0],f=o[2]):(l=r[0],h=r[1],v=o[0],f=o[1]);var d,p=-a.core.Vec.dot(e,r),m=-a.core.Vec.dot(n,o),g=l*f-h*v,V=(h*m-p*f)/g,y=(p*v-l*m)/g;return d=0==c?[0,V,y]:1==c?[V,0,y]:[V,y,0],new a.core.types.Ray(d,a.core.Vec.normalized(t))},a.core.Intersect.threePlanes=function(e,r,n,o,t,c){var i=a.core.Vec.cross(n,t),s=a.core.Vec.dot(e,i);if(Math.abs(s)<a.core.Constants.EPSILON)return null;var u=a.core.Vec.sub(a.core.Vec.mul(c,n),a.core.Vec.mul(o,t)),l=a.core.Vec.add(a.core.Vec.mul(r,i),a.core.Vec.cross(e,u));return a.core.Vec.mul(1/s,l)},a.core.Intersect.polylines=function(e,r,n){for(var o=a.core.Intersect.bounding_box_trees(new a.core.types.LazyPolylineBoundingBoxTree(e),new a.core.types.LazyPolylineBoundingBoxTree(r),n),t=[],c=0;o.length>c;){var i=o[c];++c;var s=i.item0,u=i.item1,l=a.core.Intersect.segments(e.points[s],e.points[s+1],r.points[u],r.points[u+1],n);null!=l&&(l.u0=a.core.Vec.lerp(l.u0,[e.params[s]],[e.params[s+1]])[0],l.u1=a.core.Vec.lerp(l.u1,[r.params[u]],[r.params[u+1]])[0],t.push(l))}return t},a.core.Intersect.segments=function(e,r,n,o,t){var c=a.core.Vec.sub(r,e),i=Math.sqrt(a.core.Vec.dot(c,c)),s=a.core.Vec.mul(1/i,c),u=a.core.Vec.sub(o,n),l=Math.sqrt(a.core.Vec.dot(u,u)),h=a.core.Vec.mul(1/l,u),v=a.core.Intersect.rays(e,s,n,h);if(null!=v){var f=Math.min(Math.max(0,v.u0/i),1),d=Math.min(Math.max(0,v.u1/l),1),p=a.core.Vec.onRay(e,c,f),m=a.core.Vec.onRay(n,u,d),g=a.core.Vec.distSquared(p,m);if(t*t>g)return new a.core.types.CurveCurveIntersection(p,m,f,d)}return null},a.core.Intersect.rays=function(e,r,n,o){var t=a.core.Vec.dot(r,o),c=a.core.Vec.dot(r,n),i=a.core.Vec.dot(r,e),s=a.core.Vec.dot(o,n),u=a.core.Vec.dot(o,e),l=a.core.Vec.dot(r,r),h=a.core.Vec.dot(o,o),v=l*h-t*t;
if(Math.abs(v)<a.core.Constants.EPSILON)return null;var f=t*(c-i)-l*(s-u),d=f/v,p=(c-i+d*t)/l,m=a.core.Vec.onRay(e,r,p),g=a.core.Vec.onRay(n,o,d);return new a.core.types.CurveCurveIntersection(m,g,p,d)},a.core.Intersect.segmentWithTriangle=function(e,r,n,o){var t=n[o[0]],c=n[o[1]],i=n[o[2]],s=a.core.Vec.sub(c,t),u=a.core.Vec.sub(i,t),l=a.core.Vec.cross(s,u),h=a.core.Vec.sub(r,e),v=a.core.Vec.sub(e,t),f=-a.core.Vec.dot(l,v),d=a.core.Vec.dot(l,h);if(Math.abs(d)<a.core.Constants.EPSILON)return null;var p=f/d;if(0>p||p>1)return null;var m=a.core.Vec.add(e,a.core.Vec.mul(p,h)),g=a.core.Vec.dot(s,u),V=a.core.Vec.dot(s,s),y=a.core.Vec.dot(u,u),x=a.core.Vec.sub(m,t),E=a.core.Vec.dot(x,s),b=a.core.Vec.dot(x,u),_=g*g-V*y;if(Math.abs(_)<a.core.Constants.EPSILON)return null;var M=(g*b-y*E)/_,P=(g*E-V*b)/_;return M>1+a.core.Constants.EPSILON||P>1+a.core.Constants.EPSILON||-a.core.Constants.EPSILON>P||-a.core.Constants.EPSILON>M||M+P>1+a.core.Constants.EPSILON?null:new a.core.types.TriSegmentIntersection(m,M,P,p)},a.core.Intersect.segment_with_plane=function(e,r,n,o){var t=a.core.Vec.dot(o,a.core.Vec.sub(e,r));if(Math.abs(t)<a.core.Constants.EPSILON)return null;var c=a.core.Vec.dot(o,a.core.Vec.sub(n,e));return{p:c/t}},a.core.KdPoint=e.core.KdPoint=function(e,r){this.point=e,this.obj=r},a.core.KdNode=e.core.KdNode=function(e,r,n){this.kdPoint=e,this.left=null,this.right=null,this.parent=n,this.dimension=r},a.core.KdTree=e.core.KdTree=function(e,r){this.dim=3,this.points=e,this.distanceFunction=r,this.dim=e[0].point.length,this.root=this.buildTree(e,0,null)},a.core.KdTree.prototype={buildTree:function(e,r,n){var o,t,c=r%this.dim;return 0==e.length?null:1==e.length?new a.core.KdNode(e[0],c,n):(e.sort(function(e,r){var n=e.point[c]-r.point[c];return 0==n?0:n>0?1:-1}),o=Math.floor(e.length/2),t=new a.core.KdNode(e[o],c,n),t.left=this.buildTree(e.slice(0,o),r+1,t),t.right=this.buildTree(e.slice(o+1),r+1,t),t)},nearest:function(e,r,n){var o,t=this,c=new a.core.BinaryHeap(function(e){return-e.item1}),i=null;if(i=function(n){for(var o,s,u=n.dimension,l=t.distanceFunction(e,n.kdPoint.point),h=[],v=0,f=t.dim;f>v;)v++,h.push(0);s=h;for(var d,p,m=function(e,n){c.push(new a.core.types.Pair(e,n)),c.size()>r&&c.pop()},g=0,V=t.dim;V>g;){var y=g++;s[y]=y==n.dimension?e[y]:n.kdPoint.point[y]}return d=t.distanceFunction(s,n.kdPoint.point),null==n.right&&null==n.left?((r>c.size()||c.peek().item1>l)&&m(n,l),void 0):(o=null==n.right?n.left:null==n.left?n.right:e[u]<n.kdPoint.point[u]?n.left:n.right,i(o),(r>c.size()||c.peek().item1>l)&&m(n,l),(r>c.size()||Math.abs(d)<c.peek().item1)&&(p=o==n.left?n.right:n.left,null!=p&&i(p)),void 0)},o=i,null!=n)for(var s=0;r>s;)s++,c.push(new a.core.types.Pair(null,n));o(this.root);for(var u=[],l=0;r>l;){var h=l++;null!=c.content[h].item0&&u.push(new a.core.types.Pair(c.content[h].item0.kdPoint,c.content[h].item1))}return u}},a.core.BinaryHeap=function(e){this.content=[],this.scoreFunction=e},a.core.BinaryHeap.prototype={push:function(e){this.content.push(e),this.bubbleUp(this.content.length-1)},pop:function(){var e=this.content[0],r=this.content.pop();return this.content.length>0&&(this.content[0]=r,this.sinkDown(0)),e},peek:function(){return this.content[0]},remove:function(e){for(var r=this.content.length,n=0;r>n;){var o=n++;if(this.content[o]==e){var t=this.content.pop();return o!=r-1&&(this.content[o]=t,this.scoreFunction(t)<this.scoreFunction(e)?this.bubbleUp(o):this.sinkDown(o)),void 0}}throw"Node not found."},size:function(){return this.content.length},bubbleUp:function(e){for(var r=this.content[e];e>0;){var n=Math.floor((e+1)/2)-1,o=this.content[n];if(!(this.scoreFunction(r)<this.scoreFunction(o)))break;this.content[n]=r,this.content[e]=o,e=n}},sinkDown:function(e){for(var r=this.content.length,n=this.content[e],o=this.scoreFunction(n);;){var t=2*(e+1),c=t-1,i=null,s=0;if(r>c){var a=this.content[c];s=this.scoreFunction(a),o>s&&(i=c)}if(r>t){var u=this.content[t],l=this.scoreFunction(u);(null==i?o:s)>l&&(i=t)}if(null==i)break;this.content[e]=this.content[i],this.content[i]=n,e=i}}},a.core.Make=e.core.Make=function(){},a.core.Make.fourPointSurface=function(e,r,n,o,t){null==t&&(t=3);for(var c=t,i=[],s=0,u=t+1;u>s;){for(var l=s++,h=[],v=0,f=t+1;f>v;){var d=v++,p=1-l/c,m=a.core.Vec.lerp(p,e,r),g=a.core.Vec.lerp(p,o,n),V=a.core.Vec.lerp(1-d/c,m,g);V.push(1),h.push(V)}i.push(h)}var y=a.core.Vec.rep(t+1,0),x=a.core.Vec.rep(t+1,1);return new a.core.types.SurfaceData(t,t,y.concat(x),y.concat(x),i)},a.core.Make.sweep1_surface=function(e,r){for(var n=a.core.Eval.rationalCurvePoint(r,0),o=1/r.controlPoints.length,t=[],c=[],i=a.core.Eval.weight1d(r.controlPoints),s=a.core.Eval.weight1d(e.controlPoints),u=a.core.Eval.dehomogenize1d(e.controlPoints),l=0,h=r.controlPoints.length;h>l;){for(var v=l++,f=a.core.Eval.rationalCurvePoint(r,v*o),d=a.core.Vec.sub(f,n),p=[],m=[],g=0,V=e.controlPoints.length;V>g;){var y=g++;p.push(a.core.Vec.add(d,u[y])),m.push(s[y]*i[v])}t.push(p),c.push(m)}return new a.core.types.SurfaceData(r.degree,e.degree,r.knots,e.knots,a.core.Eval.homogenize2d(t,c))},a.core.Make.ellipseArc=function(e,r,n,o,t,c,i){c>i&&(i=2*Math.PI+c);var s=i-c,u=0;u=Math.PI/2>=s?1:Math.PI>=s?2:3*Math.PI/2>=s?3:4;var l=s/u,h=Math.cos(l/2),v=a.core.Vec.add(e,a.core.Vec.add(a.core.Vec.mul(o*Math.cos(c),r),a.core.Vec.mul(t*Math.sin(c),n))),f=a.core.Vec.sub(a.core.Vec.mul(Math.cos(c),n),a.core.Vec.mul(Math.sin(c),r)),d=[],p=a.core.Vec.zeros1d(2*u+3),m=0,g=c,V=a.core.Vec.zeros1d(2*u);d[0]=v,V[0]=1;for(var y=1,x=u+1;x>y;){var E=y++;g+=l;var b=a.core.Vec.add(e,a.core.Vec.add(a.core.Vec.mul(o*Math.cos(g),r),a.core.Vec.mul(t*Math.sin(g),n)));V[m+2]=1,d[m+2]=b;var _=a.core.Vec.sub(a.core.Vec.mul(Math.cos(g),n),a.core.Vec.mul(Math.sin(g),r)),M=a.core.Intersect.rays(v,a.core.Vec.mul(1/a.core.Vec.norm(f),f),b,a.core.Vec.mul(1/a.core.Vec.norm(_),_)),P=a.core.Vec.add(v,a.core.Vec.mul(M.u0,f));V[m+1]=h,d[m+1]=P,m+=2,u>E&&(v=b,f=_)}for(var I=2*u+1,k=0;3>k;){var B=k++;p[B]=0,p[B+I]=1}switch(u){case 2:p[3]=p[4]=.5;break;case 3:p[3]=p[4]=.3333333333333333,p[5]=p[6]=.6666666666666666;break;case 4:p[3]=p[4]=.25,p[5]=p[6]=.5,p[7]=p[8]=.75}return new a.core.types.CurveData(2,p,a.core.Eval.homogenize1d(d,V))},a.core.Make.arc=function(e,r,n,o,t,c){return a.core.Make.ellipseArc(e,r,n,o,o,t,c)},a.core.Make.polylineCurve=function(e){for(var r=[0,0],n=0,o=0,t=e.length-1;t>o;){var c=o++;n+=a.core.Vec.dist(e[c],e[c+1]),r.push(n)}r.push(n),r=a.core.Vec.mul(1/n,r);for(var i,s=[],u=0,l=e.length;l>u;)u++,s.push(1);return i=s,new a.core.types.CurveData(1,r,a.core.Eval.homogenize1d(e.slice(0),i))},a.core.Make.extrudedSurface=function(e,r,n){for(var o=[[],[],[]],t=[[],[],[]],c=a.core.Eval.dehomogenize1d(n.controlPoints),i=a.core.Eval.weight1d(n.controlPoints),s=a.core.Vec.mul(r,e),u=a.core.Vec.mul(.5*r,e),l=0,h=c.length;h>l;){var v=l++;o[2][v]=c[v],o[1][v]=a.core.Vec.add(u,c[v]),o[0][v]=a.core.Vec.add(s,c[v]),t[0][v]=i[v],t[1][v]=i[v],t[2][v]=i[v]}return new a.core.types.SurfaceData(2,n.degree,[0,0,0,1,1,1],n.knots,a.core.Eval.homogenize2d(o,t))},a.core.Make.cylinderSurface=function(e,r,n,o,t){var c=a.core.Vec.cross(e,r);2*Math.PI;var i=a.core.Make.arc(n,r,c,t,0,2*Math.PI);return a.core.Make.extrudedSurface(e,o,i)},a.core.Make.revolvedSurface=function(e,r,n,o){var t,c,i=a.core.Eval.dehomogenize1d(o.controlPoints),s=a.core.Eval.weight1d(o.controlPoints);Math.PI/2>=n?(t=1,c=a.core.Vec.zeros1d(6+2*(t-1))):Math.PI>=n?(t=2,c=a.core.Vec.zeros1d(6+2*(t-1)),c[3]=c[4]=.5):3*Math.PI/2>=n?(t=3,c=a.core.Vec.zeros1d(6+2*(t-1)),c[3]=c[4]=.3333333333333333,c[5]=c[6]=.6666666666666666):(t=4,c=a.core.Vec.zeros1d(6+2*(t-1)),c[3]=c[4]=.25,c[5]=c[6]=.5,c[7]=c[8]=.75);for(var u=n/t,l=3+2*(t-1),h=0;3>h;){var v=h++;c[v]=0,c[l+v]=1}for(var f=Math.cos(u/2),d=0,p=a.core.Vec.zeros1d(t+1),m=a.core.Vec.zeros1d(t+1),g=a.core.Vec.zeros3d(2*t+1,i.length,3),V=a.core.Vec.zeros2d(2*t+1,i.length),y=1,x=t+1;x>y;){var E=y++;d+=u,m[E]=Math.cos(d),p[E]=Math.sin(d)}for(var b=0,_=i.length;_>b;){var M=b++,P=a.core.Trig.rayClosestPoint(i[M],e,r),I=a.core.Vec.sub(i[M],P),k=a.core.Vec.norm(I),B=a.core.Vec.cross(r,I);k>a.core.Constants.EPSILON&&(I=a.core.Vec.mul(1/k,I),B=a.core.Vec.mul(1/k,B)),g[0][M]=i[M];var C=i[M];V[0][M]=s[M];for(var S=B,w=0,N=1,z=t+1;z>N;){var A,T=N++;A=0==k?P:a.core.Vec.add(P,a.core.Vec.add(a.core.Vec.mul(k*m[T],I),a.core.Vec.mul(k*p[T],B))),g[w+2][M]=A,V[w+2][M]=s[M];var L=a.core.Vec.sub(a.core.Vec.mul(m[T],B),a.core.Vec.mul(p[T],I));if(0==k)g[w+1][M]=P;else{var D=a.core.Intersect.rays(C,a.core.Vec.mul(1/a.core.Vec.norm(S),S),A,a.core.Vec.mul(1/a.core.Vec.norm(L),L)),U=a.core.Vec.add(C,a.core.Vec.mul(D.u0,S));g[w+1][M]=U}V[w+1][M]=f*s[M],w+=2,t>T&&(C=A,S=L)}}return new a.core.types.SurfaceData(2,o.degree,c,o.knots,a.core.Eval.homogenize2d(g,V))},a.core.Make.sphereSurface=function(e,r,n,o){var t=a.core.Make.arc(e,a.core.Vec.mul(-1,r),n,o,0,Math.PI);return a.core.Make.revolvedSurface(e,r,2*Math.PI,t)},a.core.Make.coneSurface=function(e,r,n,o,t){var c=2*Math.PI,i=1,s=[a.core.Vec.add(n,a.core.Vec.mul(o,e)),a.core.Vec.add(n,a.core.Vec.mul(t,r))],u=[0,0,1,1],l=[1,1],h=new a.core.types.CurveData(i,u,a.core.Eval.homogenize1d(s,l));return a.core.Make.revolvedSurface(n,e,c,h)},a.core.Make.rationalInterpCurve=function(e,r,n,o){if(null==r&&(r=3),r+1>e.length)throw"You need to supply at least degree + 1 points!";for(var t=[0],c=1,i=e.length;i>c;){var s=c++,u=a.core.Vec.norm(a.core.Vec.sub(e[s],e[s-1])),l=t[t.length-1];t.push(l+u)}for(var h=t[t.length-1],v=0,f=t.length;f>v;){var d=v++;t[d]=t[d]/h}var p,m=a.core.Vec.rep(r+1,0),g=null!=n&&null!=o;p=g?0:1;var V;V=g?t.length-r+1:t.length-r;for(var y=p;V>y;){for(var x=y++,E=0,b=0;r>b;){var _=b++;E+=t[x+_]}m.push(1/r*E)}var M,P=m.concat(a.core.Vec.rep(r+1,1)),I=[];M=g?e.length+1:e.length-1;var k;k=g?1:0;var B;B=g?e.length-(r-1):e.length-(r+1);for(var C=0;t.length>C;){var S=t[C];++C;var w=a.core.Eval.knotSpanGivenN(M,r,S,P),N=a.core.Eval.basisFunctionsGivenKnotSpanIndex(w,S,r,P),z=w-r,A=a.core.Vec.zeros1d(z),T=a.core.Vec.zeros1d(B-z);I.push(A.concat(N).concat(T))}if(g){var L=I[0].length-2,D=[-1,1].concat(a.core.Vec.zeros1d(L)),U=a.core.Vec.zeros1d(L).concat([-1,1]);a.core.ArrayExtensions.spliceAndInsert(I,1,0,D),a.core.ArrayExtensions.spliceAndInsert(I,I.length-1,0,U)}for(var R=e[0].length,O=[],F=(1-P[P.length-r-2])/r,G=P[r+1]/r,K=0;R>K;){var q,W=[K++];if(g){q=[e[0][W[0]]],q.push(G*n[W[0]]);for(var j=1,H=e.length-1;H>j;){var Y=j++;q.push(e[Y][W[0]])}q.push(F*o[W[0]]),q.push(e[e.length-1][W[0]])}else q=e.map(function(e){return function(r){return r[e[0]]}}(W));var Q=a.core.Mat.solve(I,q);O.push(Q)}var Z=a.core.Mat.transpose(O),J=a.core.Vec.rep(Z.length,1);return new a.core.types.CurveData(r,P,a.core.Eval.homogenize1d(Z,J))},a.core.LUDecomp=function(e,r){this.LU=e,this.P=r},a.core.Mat=e.core.Mat=function(){},a.core.Mat.mul=function(e,r){for(var n=[],o=0,t=r.length;t>o;){var c=o++;n.push(a.core.Vec.mul(e,r[c]))}return n},a.core.Mat.add=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(a.core.Vec.add(e[c],r[c]))}return n},a.core.Mat.div=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(a.core.Vec.div(e[c],r))}return n},a.core.Mat.sub=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(a.core.Vec.sub(e[c],r[c]))}return n},a.core.Mat.dot=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(a.core.Vec.dot(e[c],r))}return n},a.core.Mat.identity=function(e){for(var r=a.core.Vec.zeros2d(e,e),n=0;e>n;){var o=n++;r[o][o]=1}return r},a.core.Mat.transpose=function(e){if(0==e.length)return[];for(var r=[],n=0,o=e[0].length;o>n;){var t=n++;r.push(function(){for(var r,n=[],o=0,c=e.length;c>o;){var i=o++;n.push(e[i][t])}return r=n}(this))}return r},a.core.Mat.solve=function(e,r){return a.core.Mat.LUsolve(a.core.Mat.LU(e),r)},a.core.Mat.LUsolve=function(e,r){var n,o,t,c,i,s=e.LU,a=s.length,u=r.slice(),l=e.P;for(n=a-1;-1!=n;)u[n]=r[n],--n;for(n=0;a>n;){for(t=l[n],l[n]!=n&&(i=u[n],u[n]=u[t],u[t]=i),c=s[n],o=0;n>o;)u[n]-=u[o]*c[o],++o;++n}for(n=a-1;n>=0;){for(c=s[n],o=n+1;a>o;)u[n]-=u[o]*c[o],++o;u[n]/=c[n],--n}return u},a.core.Mat.LU=function(e){Math.abs;for(var r,n,o,t,c,i,s,u,l,h=[],v=0,f=e.length;f>v;){var d=v++;h.push(e[d].slice())}e=h;var p=e.length,m=p-1,g=[];for(o=0;p>o;){for(s=o,i=e[o],l=Math.abs(i[o]),n=o+1;p>n;)t=Math.abs(e[n][o]),t>l&&(l=t,s=n),++n;for(g[o]=s,s!=o&&(e[o]=e[s],e[s]=i,i=e[o]),c=i[o],r=o+1;p>r;)e[r][o]/=c,++r;for(r=o+1;p>r;){for(u=e[r],n=o+1;m>n;)u[n]-=u[o]*i[n],++n,u[n]-=u[o]*i[n],++n;n==m&&(u[n]-=u[o]*i[n]),++r}++o}return new a.core.LUDecomp(e,g)},a.core.Mesh=e.core.Mesh=function(){},a.core.Mesh.getTriangleNorm=function(e,r){var n=e[r[0]],o=e[r[1]],t=e[r[2]],c=a.core.Vec.sub(o,n),i=a.core.Vec.sub(t,n),s=a.core.Vec.cross(c,i);return a.core.Vec.mul(1/a.core.Vec.norm(s),s)},a.core.Mesh.makeMeshAabb=function(e,r){for(var n=new a.BoundingBox,o=0;r.length>o;){var t=r[o];++o,n.add(e.points[e.faces[t][0]]),n.add(e.points[e.faces[t][1]]),n.add(e.points[e.faces[t][2]])}return n},a.core.Mesh.makeMeshAabbTree=function(e,r){var n=a.core.Mesh.makeMeshAabb(e,r);if(1==r.length)return new a.core.types.BoundingBoxLeaf(n,r[0]);var o=a.core.Mesh.sortTrianglesOnLongestAxis(n,e,r),t=a.core.ArrayExtensions.left(o),c=a.core.ArrayExtensions.right(o);return new a.core.types.BoundingBoxInnerNode(n,[a.core.Mesh.makeMeshAabbTree(e,t),a.core.Mesh.makeMeshAabbTree(e,c)])},a.core.Mesh.sortTrianglesOnLongestAxis=function(e,r,n){for(var o=e.getLongestAxis(),t=[],c=0;n.length>c;){var i=n[c];++c;var s=a.core.Mesh.getMinCoordOnAxis(r.points,r.faces[i],o);t.push(new a.core.types.Pair(s,i))}t.sort(function(e,r){var n=e.item0,o=r.item0;return n==o?0:n>o?1:-1});for(var u=[],l=0,h=t.length;h>l;){var v=l++;u.push(t[v].item1)}return u},a.core.Mesh.getMinCoordOnAxis=function(e,r,n){for(var o=Math.POSITIVE_INFINITY,t=0;3>t;){var c=t++,i=e[r[c]][n];o>i&&(o=i)}return o},a.core.Mesh.getTriangleCentroid=function(e,r){for(var n=[0,0,0],o=0;3>o;)for(var t=o++,c=0;3>c;){var i=c++;n[i]+=e[r[t]][i]}for(var s=0;3>s;){var a=s++;n[a]/=3}return n},a.core.Mesh.triangleUVFromPoint=function(e,r,n){var o=e.faces[r],t=e.points[o[0]],c=e.points[o[1]],i=e.points[o[2]],s=e.uvs[o[0]],u=e.uvs[o[1]],l=e.uvs[o[2]],h=a.core.Vec.sub(t,n),v=a.core.Vec.sub(c,n),f=a.core.Vec.sub(i,n),d=a.core.Vec.norm(a.core.Vec.cross(a.core.Vec.sub(t,c),a.core.Vec.sub(t,i))),p=a.core.Vec.norm(a.core.Vec.cross(v,f))/d,m=a.core.Vec.norm(a.core.Vec.cross(f,h))/d,g=a.core.Vec.norm(a.core.Vec.cross(h,v))/d;return a.core.Vec.add(a.core.Vec.mul(p,s),a.core.Vec.add(a.core.Vec.mul(m,u),a.core.Vec.mul(g,l)))},a.core.KnotMultiplicity=e.core.KnotMultiplicity=function(e,r){this.knot=e,this.mult=r},a.core.KnotMultiplicity.prototype={inc:function(){this.mult++}},a.core.Modify=e.core.Modify=function(){},a.core.Modify.surfaceKnotRefine=function(e,r,n){var o,t,c,i=[];n?(c=e.controlPoints,o=e.knotsV,t=e.degreeV):(c=a.core.Mat.transpose(e.controlPoints),o=e.knotsU,t=e.degreeU);for(var s=null,u=0;c.length>u;){var l=c[u];++u,s=a.core.Modify.curveKnotRefine(new a.core.types.CurveData(t,o,l),r),i.push(s.controlPoints)}var h=s.knots;return n?new a.core.types.SurfaceData(e.degreeU,e.degreeV,e.knotsU.slice(),h,i):(i=a.core.Mat.transpose(i),new a.core.types.SurfaceData(e.degreeU,e.degreeV,h,e.knotsV.slice(),i))},a.core.Modify.surfaceSplit=function(e,r,n){null==n&&(n=!1);var o,t,c;n?(c=e.controlPoints,o=e.knotsV,t=e.degreeV):(c=a.core.Mat.transpose(e.controlPoints),o=e.knotsU,t=e.degreeU);for(var i,s=[],u=0,l=t+1;l>u;)u++,s.push(r);i=s;for(var h=[],v=[],f=a.core.Eval.knotSpan(t,r,o),d=null,p=0;c.length>p;){var m=c[p];++p,d=a.core.Modify.curveKnotRefine(new a.core.types.CurveData(t,o,m),i),h.push(d.controlPoints.slice(0,f+1)),v.push(d.controlPoints.slice(f+1))}var g=d.knots.slice(0,f+t+2),V=d.knots.slice(f+1);return n?[new a.core.types.SurfaceData(e.degreeU,t,e.knotsU.slice(),g,h),new a.core.types.SurfaceData(e.degreeU,t,e.knotsU.slice(),V,v)]:(h=a.core.Mat.transpose(h),v=a.core.Mat.transpose(v),[new a.core.types.SurfaceData(t,e.degreeV,g,e.knotsV.slice(),h),new a.core.types.SurfaceData(t,e.degreeV,V,e.knotsV.slice(),v)])},a.core.Modify.decomposeCurveIntoBeziers=function(e){for(var r=e.degree,n=e.controlPoints,o=e.knots,t=a.core.Modify.knotMultiplicities(o),c=r+1,i=0;t.length>i;){var s=t[i];if(++i,c>s.mult){var u=a.core.Vec.rep(c-s.mult,s.knot),l=a.core.Modify.curveKnotRefine(new a.core.types.CurveData(r,o,n),u);o=l.knots,n=l.controlPoints}}o.length/c-1;for(var h=2*c,v=[],f=0;n.length>f;){var d=o.slice(f,f+h),p=n.slice(f,f+c);v.push(new a.core.types.CurveData(r,d,p)),f+=c}return v},a.core.Modify.knotMultiplicities=function(e){for(var r=[new a.core.KnotMultiplicity(e[0],0)],n=r[0],o=0;e.length>o;){var t=e[o];++o,Math.abs(t-n.knot)>a.core.Constants.EPSILON&&(n=new a.core.KnotMultiplicity(t,0),r.push(n)),n.inc()}return r},a.core.Modify.curveSplit=function(e,r){var n=e.degree;e.controlPoints;for(var o,t=e.knots,c=[],i=0,s=n+1;s>i;)i++,c.push(r);o=c;var u=a.core.Modify.curveKnotRefine(e,o),l=a.core.Eval.knotSpan(n,r,t),h=u.knots.slice(0,l+n+2),v=u.knots.slice(l+1),f=u.controlPoints.slice(0,l+1),d=u.controlPoints.slice(l+1);return[new a.core.types.CurveData(n,h,f),new a.core.types.CurveData(n,v,d)]},a.core.Modify.curveKnotRefine=function(e,r){for(var n=e.degree,o=e.controlPoints,t=e.knots,c=o.length-1,i=c+n+1,s=r.length-1,u=a.core.Eval.knotSpan(n,r[0],t),l=a.core.Eval.knotSpan(n,r[s],t),h=[],v=[],f=0,d=u-n+1;d>f;){var p=f++;h[p]=o[p]}for(var m=l-1,g=c+1;g>m;){var V=m++;h[V+s+1]=o[V]}for(var y=0,x=u+1;x>y;){var E=y++;v[E]=t[E]}for(var b=l+n,_=i+1;_>b;){var M=b++;v[M+s+1]=t[M]}for(var P=l+n-1,I=l+n+s,k=s;k>=0;){for(;r[k]<=t[P]&&P>u;)h[I-n-1]=o[P-n-1],v[I]=t[P],I-=1,P-=1;h[I-n-1]=h[I-n];for(var B=1,C=n+1;C>B;){var S=B++,w=I-n+S,N=v[I+S]-r[k];Math.abs(N)<a.core.Constants.EPSILON?h[w-1]=h[w]:(N/=v[I+S]-t[P-n+S],h[w-1]=a.core.Vec.add(a.core.Vec.mul(N,h[w-1]),a.core.Vec.mul(1-N,h[w])))}v[I]=r[k],I-=1,k--}return new a.core.types.CurveData(n,v,h)},a.core.Modify.curveKnotInsert=function(e,r,n){for(var o=e.degree,t=e.controlPoints,c=e.knots,i=0,s=t.length,u=a.core.Eval.knotSpan(o,r,c),l=[],h=[],v=[],f=1,d=u+1;d>f;){var p=f++;h[p]=c[p]}for(var m=1,g=n+1;g>m;){var V=m++;h[u+V]=r}for(var y=u+1,x=c.length;x>y;){var E=y++;h[E+n]=c[E]}for(var b=0,_=u-o+1;_>b;){var M=b++;v[M]=t[M]}for(var P=u-i;s>P;){var I=P++;v[I+n]=t[I]}for(var k=0,B=o-i+1;B>k;){var C=k++;l[C]=t[u-o+C]}for(var S=0,w=0,N=1,z=n+1;z>N;){var A=N++;S=u-o+A;for(var T=0,L=o-A-i+1;L>T;){var D=T++;w=(r-c[S+D])/(c[D+u+1]-c[S+D]),l[D]=a.core.Vec.add(a.core.Vec.mul(w,l[D+1]),a.core.Vec.mul(1-w,l[D]))}v[S]=l[0],v[u+n-A-i]=l[o-A-i]}for(var U=S+1,R=u-i;R>U;){var O=U++;v[O]=l[O-S]}return new a.core.types.CurveData(o,h,v)},a.core.MinimizationResult=function(e,r,n,o,t,c){this.solution=e,this.value=r,this.gradient=n,this.invHessian=o,this.iterations=t,this.message=c},a.core.Numeric=function(){},a.core.Numeric.numericalGradient=function(e,r){var n=r.length,o=e(r);if(o==Math.NaN)throw"gradient: f(x) is a NaN!";for(var t,c,i,s,u,l,h,v,f,d=r.slice(0),p=[],m=.001,g=0,V=0;n>V;)for(var y=V++,x=Math.max(1e-6*o,1e-8);;){if(++g,g>20)throw"Numerical gradient fails";if(d[y]=r[y]+x,t=e(d),d[y]=r[y]-x,c=e(d),d[y]=r[y],Math.isNaN(t)||Math.isNaN(c))x/=16;else{if(p[y]=(t-c)/(2*x),s=r[y]-x,u=r[y],l=r[y]+x,h=(t-o)/x,v=(o-c)/x,f=a.core.Vec.max([Math.abs(p[y]),Math.abs(o),Math.abs(t),Math.abs(c),Math.abs(s),Math.abs(u),Math.abs(l),1e-8]),i=Math.min(a.core.Vec.max([Math.abs(h-p[y]),Math.abs(v-p[y]),Math.abs(h-v)])/f,x/f),!(i>m))break;x/=16}}return p},a.core.Numeric.uncmin=function(e,r,n,o,t){null==n&&(n=1e-8),null==o&&(o=function(r){return a.core.Numeric.numericalGradient(e,r)}),null==t&&(t=1e3),r=r.slice(0);var c,i=r.length,s=e(r),u=s;if(Math.isNaN(s))throw"uncmin: f(x0) is a NaN!";n=Math.max(n,a.core.Constants.EPSILON);var l,h,v,f,d,p,m,g,V,y=a.core.Mat.identity(i),x=0,E=[],b="";for(h=o(r);t>x;){if(!a.core.Vec.all(a.core.Vec.finite(h))){b="Gradient has Infinity or NaN";break}if(l=a.core.Vec.neg(a.core.Mat.dot(y,h)),!a.core.Vec.all(a.core.Vec.finite(l))){b="Search direction has Infinity or NaN";break}if(V=a.core.Vec.norm(l),n>V){b="Newton step smaller than tol";break}for(g=1,c=a.core.Vec.dot(h,l),f=r;t>x&&!(n>g*V)&&(E=a.core.Vec.mul(g,l),f=a.core.Vec.add(r,E),u=e(f),u-s>=.1*g*c||Math.isNaN(u));)g*=.5,++x;if(n>g*V){b="Line search step size smaller than tol";break}if(x==t){b="maxit reached during line search";break}v=o(f),d=a.core.Vec.sub(v,h),m=a.core.Vec.dot(d,E),p=a.core.Mat.dot(y,d),y=a.core.Mat.sub(a.core.Mat.add(y,a.core.Mat.mul((m+a.core.Vec.dot(d,p))/(m*m),a.core.Numeric.tensor(E,E))),a.core.Mat.div(a.core.Mat.add(a.core.Numeric.tensor(p,E),a.core.Numeric.tensor(E,p)),m)),r=f,s=u,h=v,++x}return new a.core.MinimizationResult(r,s,h,y,x,b)},a.core.Numeric.tensor=function(e,r){for(var n,o,t=e.length,c=r.length,i=[],s=t-1;s>=0;){n=[],o=e[s];for(var a=c-1;a>=3;)n[a]=o*r[a],--a,n[a]=o*r[a],--a,n[a]=o*r[a],--a,n[a]=o*r[a],--a;for(;a>=0;)n[a]=o*r[a],--a;i[s]=n,s--}return i},a.core.Tess=e.core.Tess=function(){},a.core.Tess.rationalCurveRegularSample=function(e,r,n){return a.core.Tess.rationalCurveRegularSampleRange(e,e.knots[0],a.core.ArrayExtensions.last(e.knots),r,n)},a.core.Tess.rationalCurveRegularSampleRange=function(e,r,n,o,t){1>o&&(o=2);for(var c=[],i=(n-r)/(o-1),s=0,u=0;o>u;){var l=u++;s=r+i*l,t?c.push([s].concat(a.core.Eval.rationalCurvePoint(e,s))):c.push(a.core.Eval.rationalCurvePoint(e,s))}return c},a.core.Tess.rationalCurveAdaptiveSample=function(e,r,n){if(null==n&&(n=!1),null==r&&(r=1e-6),1==e.degree){if(n){for(var o=[],t=0,c=e.controlPoints.length;c>t;){var i=t++;o.push([e.knots[i+1]].concat(a.core.Eval.dehomogenize(e.controlPoints[i])))}return o}return e.controlPoints.map(a.core.Eval.dehomogenize)}return a.core.Tess.rationalCurveAdaptiveSample_range(e,e.knots[0],a.core.ArrayExtensions.last(e.knots),r,n)},a.core.Tess.rationalCurveAdaptiveSample_range=function(e,r,n,o,t){var c=a.core.Eval.rationalCurvePoint(e,r),i=a.core.Eval.rationalCurvePoint(e,n),s=.5+.2*Math.random(),u=r+(n-r)*s,l=a.core.Eval.rationalCurvePoint(e,u),h=a.core.Vec.sub(c,i),v=a.core.Vec.sub(c,l);if(o>a.core.Vec.dot(h,h)&&a.core.Vec.dot(v,v)>o||!a.core.Trig.threePointsAreFlat(c,l,i,o)){var f=r+.5*(n-r),d=a.core.Tess.rationalCurveAdaptiveSample_range(e,r,f,o,t),p=a.core.Tess.rationalCurveAdaptiveSample_range(e,f,n,o,t);return d.slice(0,-1).concat(p)}return t?[[r].concat(c),[n].concat(i)]:[c,i]},a.core.Tess.rationalSurfaceNaive=function(e,r,n){1>r&&(r=1),1>n&&(n=1),e.degreeU,e.degreeV,e.controlPoints;for(var o=e.knotsU,t=e.knotsV,c=o[o.length-1]-o[0],i=t[t.length-1]-t[0],s=c/r,u=i/n,l=[],h=[],v=[],f=0,d=r+1;d>f;)for(var p=f++,m=0,g=n+1;g>m;){var V=m++,y=p*s,x=V*u;h.push([y,x]);var E=a.core.Eval.rationalSurfaceDerivatives(e,1,y,x),b=E[0][0];l.push(b);var _=a.core.Vec.normalized(a.core.Vec.cross(E[1][0],E[0][1]));v.push(_)}for(var M=[],P=0;r>P;)for(var I=P++,k=0;n>k;){var B=k++,C=I*(n+1)+B,S=(I+1)*(n+1)+B,w=S+1,N=C+1,z=[C,S,w],A=[C,w,N];M.push(z),M.push(A)}return new a.core.types.MeshData(M,l,v,h)},a.core.Tess.divideRationalSurfaceAdaptive=function(e,r){null==r&&(r=new a.core.types.AdaptiveRefinementOptions),r.minDivsU=null!=r.minDivsU?r.minDivsU:1,r.minDivsU=null!=r.minDivsV?r.minDivsV:1,r.refine=null!=r.refine?r.refine:!0;var n,o=3*(e.controlPoints.length-1),t=3*(e.controlPoints[0].length-1);n=r.minDivsU=r.minDivsU>o?r.minDivsU:o;var c;c=r.minDivsV=r.minDivsV>t?r.minDivsV:t;for(var i=a.core.ArrayExtensions.last(e.knotsU),s=e.knotsU[0],u=a.core.ArrayExtensions.last(e.knotsV),l=e.knotsV[0],h=(i-s)/n,v=(u-l)/c,f=[],d=[],p=0,m=c+1;m>p;){for(var g=p++,V=[],y=0,x=n+1;x>y;){var E=y++,b=s+h*E,_=l+v*g,M=a.core.Eval.rationalSurfaceDerivatives(e,1,b,_),P=a.core.Vec.normalized(a.core.Vec.cross(M[0][1],M[1][0]));V.push(new a.core.types.SurfacePoint(M[0][0],P,[b,_],-1,a.core.Vec.isZero(P)))}d.push(V)}for(var I=0;c>I;)for(var k=I++,B=0;n>B;){var C=B++,S=[d[c-k-1][C],d[c-k-1][C+1],d[c-k][C+1],d[c-k][C]];f.push(new a.core.types.AdaptiveRefinementNode(e,S))}if(!r.refine)return f;for(var w=0;c>w;)for(var N=w++,z=0;n>z;){var A=z++,T=N*n+A,L=a.core.Tess.north(T,N,A,n,c,f),D=a.core.Tess.east(T,N,A,n,c,f),U=a.core.Tess.south(T,N,A,n,c,f),R=a.core.Tess.west(T,N,A,n,c,f);f[T].neighbors=[U,D,L,R],f[T].divide(r)}return f},a.core.Tess.north=function(e,r,n,o,t,c){return 0==r?null:c[e-o]},a.core.Tess.south=function(e,r,n,o,t,c){return r==t-1?null:c[e+o]},a.core.Tess.east=function(e,r,n,o,t,c){return n==o-1?null:c[e+1]},a.core.Tess.west=function(e,r,n,o,t,c){return 0==n?null:c[e-1]},a.core.Tess.triangulateAdaptiveRefinementNodeTree=function(e){for(var r=a.core.types.MeshData.empty(),n=0;e.length>n;){var o=e[n];++n,o.triangulate(r)}return r},a.core.Tess.rationalSurfaceAdaptive=function(e,r){r=null!=r?r:new a.core.types.AdaptiveRefinementOptions;var n=a.core.Tess.divideRationalSurfaceAdaptive(e,r);return a.core.Tess.triangulateAdaptiveRefinementNodeTree(n)},a.core.Trig=e.core.Trig=function(){},a.core.Trig.distToSegment=function(e,r,n){var o=a.core.Vec.sub(n,e),t=a.core.Vec.norm(o),c=a.core.Vec.sub(r,e);if(a.core.Constants.TOLERANCE>t)return a.core.Vec.norm(c);var i=a.core.Vec.mul(1/t,o),s=a.core.Vec.dot(c,i),u=a.core.Vec.add(e,a.core.Vec.mul(s,i));return a.core.Vec.dist(u,r)},a.core.Trig.rayClosestPoint=function(e,r,n){var o=a.core.Vec.sub(e,r),t=a.core.Vec.dot(o,n),c=a.core.Vec.add(r,a.core.Vec.mul(t,n));return c},a.core.Trig.distToRay=function(e,r,n){var o=a.core.Trig.rayClosestPoint(e,r,n),t=a.core.Vec.sub(o,e);return a.core.Vec.norm(t)},a.core.Trig.threePointsAreFlat=function(e,r,n,o){var t=a.core.Vec.sub(r,e),c=a.core.Vec.sub(n,e),i=a.core.Vec.cross(t,c),s=a.core.Vec.dot(i,i);return o>s},a.core.Trig.segmentClosestPoint=function(e,r,n,o,t){var c=a.core.Vec.sub(n,r),i=a.core.Vec.norm(c);if(a.core.Constants.EPSILON>i)return{u:o,pt:r};var s=r,u=a.core.Vec.mul(1/i,c),l=a.core.Vec.sub(e,s),h=a.core.Vec.dot(l,u);return 0>h?{u:o,pt:r}:h>i?{u:t,pt:n}:{u:o+(t-o)*h/i,pt:a.core.Vec.add(s,a.core.Vec.mul(h,u))}},a.core.Vec=e.core.Vec=function(){},a.core.Vec.range=function(e){for(var r=[],n=0,o=0;e>o;)o++,r.push(n),n+=1;return r},a.core.Vec.neg=function(e){return e.map(function(e){return-e})},a.core.Vec.min=function(e){return c.fold(e,function(e,r){return Math.min(e,r)},Math.POSITIVE_INFINITY)},a.core.Vec.max=function(e){return c.fold(e,function(e,r){return Math.max(e,r)},Math.NEGATIVE_INFINITY)},a.core.Vec.all=function(e){return c.fold(e,function(e,r){return r&&e},!0)},a.core.Vec.finite=function(e){return e.map(function(e){return Math.isFinite(e)})},a.core.Vec.onRay=function(e,r,n){return a.core.Vec.add(e,a.core.Vec.mul(n,r))},a.core.Vec.lerp=function(e,r,n){return a.core.Vec.add(a.core.Vec.mul(e,r),a.core.Vec.mul(1-e,n))},a.core.Vec.normalized=function(e){return a.core.Vec.div(e,a.core.Vec.norm(e))},a.core.Vec.cross=function(e,r){return[e[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]},a.core.Vec.dist=function(e,r){return a.core.Vec.norm(a.core.Vec.sub(e,r))},a.core.Vec.distSquared=function(e,r){return a.core.Vec.normSquared(a.core.Vec.sub(e,r))},a.core.Vec.sum=function(e){return c.fold(e,function(e,r){return r+e},0)},a.core.Vec.norm=function(e){return Math.sqrt(a.core.Vec.normSquared(e))},a.core.Vec.normSquared=function(e){return c.fold(e,function(e,r){return r+e*e},0)},a.core.Vec.rep=function(e,r){for(var n=[],o=0;e>o;)o++,n.push(r);return n},a.core.Vec.zeros1d=function(e){for(var r=[],n=0;e>n;)n++,r.push(0);return r},a.core.Vec.zeros2d=function(e,r){for(var n=[],o=0;e>o;)o++,n.push(a.core.Vec.zeros1d(r));return n},a.core.Vec.zeros3d=function(e,r,n){for(var o=[],t=0;e>t;)t++,o.push(a.core.Vec.zeros2d(r,n));return o},a.core.Vec.dot=function(e,r){for(var n=0,o=0,t=e.length;t>o;){var c=o++;n+=e[c]*r[c]}return n},a.core.Vec.add=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(e[c]+r[c])}return n},a.core.Vec.mul=function(e,r){for(var n=[],o=0,t=r.length;t>o;){var c=o++;n.push(e*r[c])}return n},a.core.Vec.div=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(e[c]/r)}return n},a.core.Vec.sub=function(e,r){for(var n=[],o=0,t=e.length;t>o;){var c=o++;n.push(e[c]-r[c])}return n},a.core.Vec.isZero=function(e){for(var r=0,n=e.length;n>r;){var o=r++;if(Math.abs(e[o])>a.core.Constants.TOLERANCE)return!1}return!0},a.core.types={},a.core.types.AdaptiveRefinementOptions=function(){this.minDivsV=1,this.minDivsU=1,this.refine=!0,this.maxDepth=10,this.minDepth=0,this.normTol=.085},a.core.types.AdaptiveRefinementNode=e.core.AdaptiveRefinementNode=function(e,r,n){if(this.srf=e,this.neighbors=null==n?[null,null,null,null]:n,this.corners=r,null==this.corners){var o=e.knotsU[0],t=a.core.ArrayExtensions.last(e.knotsU),c=e.knotsV[0],i=a.core.ArrayExtensions.last(e.knotsV);this.corners=[a.core.types.SurfacePoint.fromUv(o,c),a.core.types.SurfacePoint.fromUv(t,c),a.core.types.SurfacePoint.fromUv(t,i),a.core.types.SurfacePoint.fromUv(o,i)]}},a.core.types.AdaptiveRefinementNode.prototype={isLeaf:function(){return null==this.children},center:function(){return null!=this.centerPoint?this.centerPoint:this.evalSrf(this.u05,this.v05)},evalCorners:function(){this.u05=(this.corners[0].uv[0]+this.corners[2].uv[0])/2,this.v05=(this.corners[0].uv[1]+this.corners[2].uv[1])/2;for(var e=0;4>e;){var r=e++;if(null==this.corners[r].point){var n=this.corners[r];this.evalSrf(n.uv[0],n.uv[1],n)}}},evalSrf:function(e,r,n){var o=a.core.Eval.rationalSurfaceDerivatives(this.srf,1,e,r),t=o[0][0],c=a.core.Vec.cross(o[0][1],o[1][0]),i=a.core.Vec.isZero(c);return i||(c=a.core.Vec.normalized(c)),null!=n?(n.degen=i,n.point=t,n.normal=c,n):new a.core.types.SurfacePoint(t,c,[e,r],-1,i)},getEdgeCorners:function(e){if(this.isLeaf())return[this.corners[e]];if(this.horizontal)switch(e){case 0:return this.children[0].getEdgeCorners(0);case 1:return this.children[0].getEdgeCorners(1).concat(this.children[1].getEdgeCorners(1));case 2:return this.children[1].getEdgeCorners(2);case 3:return this.children[1].getEdgeCorners(3).concat(this.children[0].getEdgeCorners(3))}switch(e){case 0:return this.children[0].getEdgeCorners(0).concat(this.children[1].getEdgeCorners(0));case 1:return this.children[1].getEdgeCorners(1);case 2:return this.children[1].getEdgeCorners(2).concat(this.children[0].getEdgeCorners(2));case 3:return this.children[0].getEdgeCorners(3)}return null},getAllCorners:function(e){var r=[this.corners[e]];if(null==this.neighbors[e])return r;var n=this.neighbors[e].getEdgeCorners((e+2)%4),o=e%2,t=a.core.Constants.EPSILON,c=this,i=[function(e){return e.uv[0]>c.corners[0].uv[0]+t&&e.uv[0]<c.corners[2].uv[0]-t},function(e){return e.uv[1]>c.corners[0].uv[1]+t&&e.uv[1]<c.corners[2].uv[1]-t}],s=n.filter(i[o]);return s.reverse(),r.concat(s)},midpoint:function(e){if(null==this.midPoints&&(this.midPoints=[null,null,null,null]),null!=this.midPoints[e])return this.midPoints[e];switch(e){case 0:this.midPoints[0]=this.evalSrf(this.u05,this.corners[0].uv[1]);break;case 1:this.midPoints[1]=this.evalSrf(this.corners[1].uv[0],this.v05);break;case 2:this.midPoints[2]=this.evalSrf(this.u05,this.corners[2].uv[1]);break;case 3:this.midPoints[3]=this.evalSrf(this.corners[0].uv[0],this.v05)}return this.midPoints[e]},hasBadNormals:function(){return this.corners[0].degen||this.corners[1].degen||this.corners[2].degen||this.corners[3].degen},fixNormals:function(){for(var e=this.corners.length,r=0;e>r;){var n=r++;if(this.corners[n],this.corners[n].degen){var o=this.corners[(n+1)%e],t=this.corners[(n+3)%e];this.corners[n].normal=o.degen?t.normal:o.normal}}},shouldDivide:function(e,r){if(e.minDepth>r)return!0;if(r>=e.maxDepth)return!1;if(this.hasBadNormals())return this.fixNormals(),!1;if(this.splitVert=a.core.Vec.normSquared(a.core.Vec.sub(this.corners[0].normal,this.corners[1].normal))>e.normTol||a.core.Vec.normSquared(a.core.Vec.sub(this.corners[2].normal,this.corners[3].normal))>e.normTol,this.splitHoriz=a.core.Vec.normSquared(a.core.Vec.sub(this.corners[1].normal,this.corners[2].normal))>e.normTol||a.core.Vec.normSquared(a.core.Vec.sub(this.corners[3].normal,this.corners[0].normal))>e.normTol,this.splitVert||this.splitHoriz)return!0;var n=this.center();return a.core.Vec.normSquared(a.core.Vec.sub(n.normal,this.corners[0].normal))>e.normTol||a.core.Vec.normSquared(a.core.Vec.sub(n.normal,this.corners[1].normal))>e.normTol||a.core.Vec.normSquared(a.core.Vec.sub(n.normal,this.corners[2].normal))>e.normTol||a.core.Vec.normSquared(a.core.Vec.sub(n.normal,this.corners[3].normal))>e.normTol
},divide:function(e){null==e&&(e=new a.core.types.AdaptiveRefinementOptions),null==e.normTol&&(e.normTol=.085),null==e.minDepth&&(e.minDepth=0),null==e.maxDepth&&(e.maxDepth=10),this._divide(e,0,!0)},_divide:function(e,r,n){if(this.evalCorners(),this.shouldDivide(e,r)){if(r++,this.splitVert&&!this.splitHoriz?n=!1:!this.splitVert&&this.splitHoriz&&(n=!0),this.horizontal=n,this.horizontal){var o=[this.corners[0],this.corners[1],this.midpoint(1),this.midpoint(3)],t=[this.midpoint(3),this.midpoint(1),this.corners[2],this.corners[3]];this.children=[new a.core.types.AdaptiveRefinementNode(this.srf,o),new a.core.types.AdaptiveRefinementNode(this.srf,t)],this.children[0].neighbors=[this.neighbors[0],this.neighbors[1],this.children[1],this.neighbors[3]],this.children[1].neighbors=[this.children[0],this.neighbors[1],this.neighbors[2],this.neighbors[3]]}else{var c=[this.corners[0],this.midpoint(0),this.midpoint(2),this.corners[3]],i=[this.midpoint(0),this.corners[1],this.corners[2],this.midpoint(2)];this.children=[new a.core.types.AdaptiveRefinementNode(this.srf,c),new a.core.types.AdaptiveRefinementNode(this.srf,i)],this.children[0].neighbors=[this.neighbors[0],this.children[1],this.neighbors[2],this.neighbors[3]],this.children[1].neighbors=[this.neighbors[0],this.neighbors[1],this.neighbors[2],this.children[0]]}for(var s=0,u=this.children;u.length>s;){var l=u[s];++s,l._divide(e,r,!n)}}},triangulate:function(e){if(null==e&&(e=a.core.types.MeshData.empty()),this.isLeaf())return this.triangulateLeaf(e);for(var r=0,n=this.children;n.length>r;){var o=n[r];if(++r,null==o)break;o.triangulate(e)}return e},triangulateLeaf:function(e){for(var r=e.points.length,n=[],o=[],t=0,c=0;4>c;){var i=c++,s=this.getAllCorners(i);2==s.length&&(t=i+1);for(var a=0,u=s.length;u>a;){var l=a++;n.push(s[l])}}for(var h=0;n.length>h;){var v=n[h];++h,-1==v.id?(e.uvs.push(v.uv),e.points.push(v.point),e.normals.push(v.normal),v.id=r,o.push(r),r++):o.push(v.id)}if(4==n.length)return e.faces.push([o[0],o[3],o[1]]),e.faces.push([o[3],o[2],o[1]]),e;if(5==n.length){var f=o.length;return e.faces.push([o[t],o[(t+1)%f],o[(t+2)%f]]),e.faces.push([o[(t+4)%f],o[(t+3)%f],o[t]]),e.faces.push([o[t],o[(t+2)%f],o[(t+3)%f]]),e}var d=this.center();e.uvs.push(d.uv),e.points.push(d.point),e.normals.push(d.normal);for(var p=e.points.length-1,m=0,g=n.length-1;n.length>m;)e.faces.push([p,o[g],o[m]]),g=m++;return e}},a.core.types.BoundingBoxNode=e.core.BoundingBoxNode=function(e){this.boundingBox=e},a.core.types.BoundingBoxInnerNode=e.core.BoundingBoxInnerNode=function(e,r){a.core.types.BoundingBoxNode.call(this,e),this.children=r},a.core.types.BoundingBoxInnerNode.__super__=a.core.types.BoundingBoxNode,a.core.types.BoundingBoxInnerNode.prototype=r(a.core.types.BoundingBoxNode.prototype,{}),a.core.types.BoundingBoxLeaf=e.core.BoundingBoxLeaf=function(e,r){a.core.types.BoundingBoxNode.call(this,e),this.item=r},a.core.types.BoundingBoxLeaf.__super__=a.core.types.BoundingBoxNode,a.core.types.BoundingBoxLeaf.prototype=r(a.core.types.BoundingBoxNode.prototype,{}),a.core.types.CurveCurveIntersection=e.core.CurveCurveIntersection=function(e,r,n,o){this.point0=e,this.point1=r,this.u0=n,this.u1=o},a.core.types.CurveData=e.core.CurveData=function(e,r,n){this.degree=e,this.controlPoints=n,this.knots=r},a.core.types.CurveLengthSample=e.core.CurveLengthSample=function(e,r){this.u=e,this.len=r},a.core.types.CurveSurfaceIntersection=e.core.CurveSurfaceIntersection=function(e,r){this.u=e,this.uv=r},a.core.types.CurveTriPoint=e.core.CurveTriPoint=function(e,r,n){this.u=e,this.point=r,this.uv=n},a.core.types.IBoundingBoxTree=function(){},a.core.types.Interval=e.core.Interval=function(e,r){this.min=e,this.max=r},a.core.types.LazyCurveBoundingBoxTree=function(e,r){this._boundingBox=null,this._curve=e,null==r&&(r=a.core.ArrayExtensions.last(this._curve.knots)-this._curve.knots[0]/1e3),this._knotTol=r},a.core.types.LazyCurveBoundingBoxTree.__interfaces__=[a.core.types.IBoundingBoxTree],a.core.types.LazyCurveBoundingBoxTree.prototype={split:function(){var e=this._curve.knots[0],r=a.core.ArrayExtensions.last(this._curve.knots),n=r-e,o=a.core.Modify.curveSplit(this._curve,(r+e)/2+.01*n*Math.random());return new a.core.types.Pair(new a.core.types.LazyCurveBoundingBoxTree(o[0],this._knotTol),new a.core.types.LazyCurveBoundingBoxTree(o[1],this._knotTol))},boundingBox:function(){return null==this._boundingBox&&(this._boundingBox=new a.BoundingBox(a.core.Eval.dehomogenize1d(this._curve.controlPoints))),this._boundingBox},yield:function(){return this._curve},indivisible:function(){return a.core.ArrayExtensions.last(this._curve.knots)-this._curve.knots[0]<this._knotTol},empty:function(){return!1}},a.core.types.LazyMeshBoundingBoxTree=function(e,r){if(this._boundingBox=null,this._mesh=e,null==r){for(var n=[],o=0,t=e.faces.length;t>o;){var c=o++;n.push(c)}r=n}this._faceIndices=r},a.core.types.LazyMeshBoundingBoxTree.__interfaces__=[a.core.types.IBoundingBoxTree],a.core.types.LazyMeshBoundingBoxTree.prototype={split:function(){var e=a.core.Mesh.sortTrianglesOnLongestAxis(this._boundingBox,this._mesh,this._faceIndices),r=a.core.ArrayExtensions.left(e),n=a.core.ArrayExtensions.right(e);return new a.core.types.Pair(new a.core.types.LazyMeshBoundingBoxTree(this._mesh,r),new a.core.types.LazyMeshBoundingBoxTree(this._mesh,n))},boundingBox:function(){return null==this._boundingBox&&(this._boundingBox=a.core.Mesh.makeMeshAabb(this._mesh,this._faceIndices)),this._boundingBox},yield:function(){return this._faceIndices[0]},indivisible:function(){return 1==this._faceIndices.length},empty:function(){return 0==this._faceIndices.length}},a.core.types.LazyPolylineBoundingBoxTree=function(e,r){this._boundingBox=null,this._polyline=e,null==r&&(r=new a.core.types.Interval(0,0!=e.points.length?e.points.length-1:0)),this._interval=r},a.core.types.LazyPolylineBoundingBoxTree.__interfaces__=[a.core.types.IBoundingBoxTree],a.core.types.LazyPolylineBoundingBoxTree.prototype={split:function(){var e=this._interval.min,r=this._interval.max,n=e+Math.ceil((r-e)/2),o=new a.core.types.Interval(e,n),t=new a.core.types.Interval(n,r);return new a.core.types.Pair(new a.core.types.LazyPolylineBoundingBoxTree(this._polyline,o),new a.core.types.LazyPolylineBoundingBoxTree(this._polyline,t))},boundingBox:function(){return null==this._boundingBox&&(this._boundingBox=new a.BoundingBox(this._polyline.points)),this._boundingBox},yield:function(){return this._interval.min},indivisible:function(){return 1==this._interval.max-this._interval.min},empty:function(){return 0==this._interval.max-this._interval.min}},a.core.types.LazySurfaceBoundingBoxTree=function(e,r,n,o){null==r&&(r=!1),this._boundingBox=null,this._surface=e,this._splitV=r,null==n&&(n=(a.core.ArrayExtensions.last(e.knotsU)-e.knotsU[0])/1e3),null==o&&(o=(a.core.ArrayExtensions.last(e.knotsV)-e.knotsV[0])/1e3),this._knotTolU=n,this._knotTolV=o},a.core.types.LazySurfaceBoundingBoxTree.__interfaces__=[a.core.types.IBoundingBoxTree],a.core.types.LazySurfaceBoundingBoxTree.prototype={split:function(){var e,r;this._splitV?(e=this._surface.knotsV[0],r=a.core.ArrayExtensions.last(this._surface.knotsV)):(e=this._surface.knotsU[0],r=a.core.ArrayExtensions.last(this._surface.knotsU));var n=r-e,o=(e+r)/2+.01*n*Math.random(),t=a.core.Modify.surfaceSplit(this._surface,o,this._splitV);return new a.core.types.Pair(new a.core.types.LazySurfaceBoundingBoxTree(t[0],!this._splitV,this._knotTolU,this._knotTolV),new a.core.types.LazySurfaceBoundingBoxTree(t[1],!this._splitV,this._knotTolU,this._knotTolV))},boundingBox:function(){if(null==this._boundingBox){this._boundingBox=new a.BoundingBox;for(var e=0,r=this._surface.controlPoints;r.length>e;){var n=r[e];++e,this._boundingBox.addRange(a.core.Eval.dehomogenize1d(n))}}return this._boundingBox},yield:function(){return this._surface},indivisible:function(){return this._splitV?a.core.ArrayExtensions.last(this._surface.knotsV)-this._surface.knotsV[0]<this._knotTolV:a.core.ArrayExtensions.last(this._surface.knotsU)-this._surface.knotsU[0]<this._knotTolU},empty:function(){return!1}},a.core.types.MeshData=e.core.MeshData=function(e,r,n,o){this.faces=e,this.points=r,this.normals=n,this.uvs=o},a.core.types.MeshData.empty=function(){return new a.core.types.MeshData([],[],[],[])},a.core.types.MeshIntersectionPoint=e.core.MeshIntersectionPoint=function(e,r,n){this.visited=!1,this.adj=null,this.opp=null,this.uv0=e,this.uv1=r,this.point=n,this.faceIndex0,this.faceIndex1},a.core.types.Pair=e.core.Pair=function(e,r){this.item0=e,this.item1=r},a.core.types.PolylineData=e.core.PolylineData=function(e,r){this.points=e,this.params=r},a.core.types.PolylineMeshIntersection=e.core.PolylineMeshIntersection=function(e,r,n,o,t){this.point=e,this.u=r,this.uv=n,this.polylineIndex=o,this.faceIndex=t},a.core.types.Ray=e.core.Ray=function(e,r){this.origin=e,this.dir=r},a.core.types.SurfaceData=e.core.SurfaceData=function(e,r,n,o,t){this.degreeU=e,this.degreeV=r,this.knotsU=n,this.knotsV=o,this.controlPoints=t},a.core.types.SurfaceData.prototype={get_foo:function(){return this.foo}},a.core.types.SurfacePoint=function(e,r,n,o,t){null==t&&(t=!1),null==o&&(o=-1),this.uv=n,this.point=e,this.normal=r,this.id=o,this.degen=t},a.core.types.SurfacePoint.fromUv=function(e,r){return new a.core.types.SurfacePoint(null,null,[e,r])},a.core.types.SurfaceSurfaceIntersectionPoint=e.core.SurfaceSurfaceIntersectionPoint=function(e,r,n,o){this.uv0=e,this.uv1=r,this.point=n,this.dist=o},a.core.types.TriSegmentIntersection=e.core.TriSegmentIntersection=function(e,r,n,o){this.point=e,this.s=r,this.t=n,this.p=o},a.core.types.VolumeData=e.core.VolumeData=function(e,r,n,o,t,c,i){this.degreeU=e,this.degreeV=r,this.degreeW=n,this.knotsU=o,this.knotsV=t,this.knotsW=c,this.controlPoints=i},a.exe={},a.exe.Dispatcher=function(){this._workerPool=new a.exe.WorkerPool(a.exe.Dispatcher.THREADS)},a.exe.Dispatcher.instance=function(){return null==a.exe.Dispatcher._instance&&(a.exe.Dispatcher._instance=new a.exe.Dispatcher),a.exe.Dispatcher._instance},a.exe.Dispatcher.prototype={eval:function(){}},a.exe.Work=function(e,r,n){this.className=e,this.methodName=r,this.args=n,this.id=a.exe.Work.uuid++},a.exe.WorkerPool=function(e,r){null==r&&(r="verb.js"),this._callbacks=new s.ds.IntMap,this._working=new s.ds.IntMap,this._pool=[],this._queue=[];for(var n=0;e>n;)n++,this._pool.push(new Worker("verb.js"))},a.exe.WorkerPool.prototype={addWork:function(e,r,n,o){var t=new a.exe.Work(e,r,n);this._callbacks.set(t.id,o),this._queue.push(t),this.processQueue()},processQueue:function(){for(var e=this;this._queue.length>0&&this._pool.length>0;){var r=this._queue.shift(),n=[r.id],o=[this._pool.shift()];this._working.set(n[0],o[0]),o[0].onmessage=function(r,n){return function(o){e._working.remove(n[0]),e._pool.push(r[0]);try{e._callbacks.exists(n[0])&&(e._callbacks.get(n[0])(o.data.result),e._callbacks.remove(n[0]))}catch(t){console.log(t)}e.processQueue()}}(o,n),o[0].postMessage(r)}}};var u=0;Math.NaN=Number.NaN,Math.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY,Math.POSITIVE_INFINITY=Number.POSITIVE_INFINITY,Math.isFinite=function(e){return isFinite(e)},Math.isNaN=function(e){return isNaN(e)},null==Array.prototype.map&&(Array.prototype.map=function(e){for(var r=[],n=0,o=this.length;o>n;){var t=n++;r[t]=e(this[t])}return r}),null==Array.prototype.filter&&(Array.prototype.filter=function(e){for(var r=[],n=0,o=this.length;o>n;){var t=n++,c=this[t];e(c)&&r.push(c)}return r}),a.BoundingBox.TOLERANCE=1e-4,a.core.Analyze.Tvalues=[[],[],[-.5773502691896257,.5773502691896257],[0,-.7745966692414834,.7745966692414834],[-.33998104358485626,.33998104358485626,-.8611363115940526,.8611363115940526],[0,-.5384693101056831,.5384693101056831,-.906179845938664,.906179845938664],[.6612093864662645,-.6612093864662645,-.2386191860831969,.2386191860831969,-.932469514203152,.932469514203152],[0,.4058451513773972,-.4058451513773972,-.7415311855993945,.7415311855993945,-.9491079123427585,.9491079123427585],[-.1834346424956498,.1834346424956498,-.525532409916329,.525532409916329,-.7966664774136267,.7966664774136267,-.9602898564975363,.9602898564975363],[0,-.8360311073266358,.8360311073266358,-.9681602395076261,.9681602395076261,-.3242534234038089,.3242534234038089,-.6133714327005904,.6133714327005904],[-.14887433898163122,.14887433898163122,-.4333953941292472,.4333953941292472,-.6794095682990244,.6794095682990244,-.8650633666889845,.8650633666889845,-.9739065285171717,.9739065285171717],[0,-.26954315595234496,.26954315595234496,-.5190961292068118,.5190961292068118,-.7301520055740494,.7301520055740494,-.8870625997680953,.8870625997680953,-.978228658146057,.978228658146057],[-.1252334085114689,.1252334085114689,-.3678314989981802,.3678314989981802,-.5873179542866175,.5873179542866175,-.7699026741943047,.7699026741943047,-.9041172563704749,.9041172563704749,-.9815606342467192,.9815606342467192],[0,-.2304583159551348,.2304583159551348,-.44849275103644687,.44849275103644687,-.6423493394403402,.6423493394403402,-.8015780907333099,.8015780907333099,-.9175983992229779,.9175983992229779,-.9841830547185881,.9841830547185881],[-.10805494870734367,.10805494870734367,-.31911236892788974,.31911236892788974,-.5152486363581541,.5152486363581541,-.6872929048116855,.6872929048116855,-.827201315069765,.827201315069765,-.9284348836635735,.9284348836635735,-.9862838086968123,.9862838086968123],[0,-.20119409399743451,.20119409399743451,-.3941513470775634,.3941513470775634,-.5709721726085388,.5709721726085388,-.7244177313601701,.7244177313601701,-.8482065834104272,.8482065834104272,-.937273392400706,.937273392400706,-.9879925180204854,.9879925180204854],[-.09501250983763744,.09501250983763744,-.2816035507792589,.2816035507792589,-.45801677765722737,.45801677765722737,-.6178762444026438,.6178762444026438,-.755404408355003,.755404408355003,-.8656312023878318,.8656312023878318,-.9445750230732326,.9445750230732326,-.9894009349916499,.9894009349916499],[0,-.17848418149584785,.17848418149584785,-.3512317634538763,.3512317634538763,-.5126905370864769,.5126905370864769,-.6576711592166907,.6576711592166907,-.7815140038968014,.7815140038968014,-.8802391537269859,.8802391537269859,-.9506755217687678,.9506755217687678,-.9905754753144174,.9905754753144174],[-.0847750130417353,.0847750130417353,-.2518862256915055,.2518862256915055,-.41175116146284263,.41175116146284263,-.5597708310739475,.5597708310739475,-.6916870430603532,.6916870430603532,-.8037049589725231,.8037049589725231,-.8926024664975557,.8926024664975557,-.9558239495713977,.9558239495713977,-.9915651684209309,.9915651684209309],[0,-.16035864564022537,.16035864564022537,-.31656409996362983,.31656409996362983,-.46457074137596094,.46457074137596094,-.600545304661681,.600545304661681,-.7209661773352294,.7209661773352294,-.8227146565371428,.8227146565371428,-.9031559036148179,.9031559036148179,-.96020815213483,.96020815213483,-.9924068438435844,.9924068438435844],[-.07652652113349734,.07652652113349734,-.22778585114164507,.22778585114164507,-.37370608871541955,.37370608871541955,-.5108670019508271,.5108670019508271,-.636053680726515,.636053680726515,-.7463319064601508,.7463319064601508,-.8391169718222188,.8391169718222188,-.912234428251326,.912234428251326,-.9639719272779138,.9639719272779138,-.9931285991850949,.9931285991850949],[0,-.1455618541608951,.1455618541608951,-.2880213168024011,.2880213168024011,-.4243421202074388,.4243421202074388,-.5516188358872198,.5516188358872198,-.6671388041974123,.6671388041974123,-.7684399634756779,.7684399634756779,-.8533633645833173,.8533633645833173,-.9200993341504008,.9200993341504008,-.9672268385663063,.9672268385663063,-.9937521706203895,.9937521706203895],[-.06973927331972223,.06973927331972223,-.20786042668822127,.20786042668822127,-.34193582089208424,.34193582089208424,-.469355837986757,.469355837986757,-.5876404035069116,.5876404035069116,-.6944872631866827,.6944872631866827,-.7878168059792081,.7878168059792081,-.8658125777203002,.8658125777203002,-.926956772187174,.926956772187174,-.9700604978354287,.9700604978354287,-.9942945854823992,.9942945854823992],[0,-.1332568242984661,.1332568242984661,-.26413568097034495,.26413568097034495,-.3903010380302908,.3903010380302908,-.5095014778460075,.5095014778460075,-.6196098757636461,.6196098757636461,-.7186613631319502,.7186613631319502,-.8048884016188399,.8048884016188399,-.8767523582704416,.8767523582704416,-.9329710868260161,.9329710868260161,-.9725424712181152,.9725424712181152,-.9947693349975522,.9947693349975522],[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213]],a.core.Analyze.Cvalues=[[],[],[1,1],[.8888888888888888,.5555555555555556,.5555555555555556],[.6521451548625461,.6521451548625461,.34785484513745385,.34785484513745385],[.5688888888888889,.47862867049936647,.47862867049936647,.23692688505618908,.23692688505618908],[.3607615730481386,.3607615730481386,.46791393457269104,.46791393457269104,.17132449237917036,.17132449237917036],[.4179591836734694,.3818300505051189,.3818300505051189,.27970539148927664,.27970539148927664,.1294849661688697,.1294849661688697],[.362683783378362,.362683783378362,.31370664587788727,.31370664587788727,.22238103445337448,.22238103445337448,.10122853629037626,.10122853629037626],[.3302393550012598,.1806481606948574,.1806481606948574,.08127438836157441,.08127438836157441,.31234707704000286,.31234707704000286,.26061069640293544,.26061069640293544],[.29552422471475287,.29552422471475287,.26926671930999635,.26926671930999635,.21908636251598204,.21908636251598204,.1494513491505806,.1494513491505806,.06667134430868814,.06667134430868814],[.2729250867779006,.26280454451024665,.26280454451024665,.23319376459199048,.23319376459199048,.18629021092773426,.18629021092773426,.1255803694649046,.1255803694649046,.05566856711617366,.05566856711617366],[.24914704581340277,.24914704581340277,.2334925365383548,.2334925365383548,.20316742672306592,.20316742672306592,.16007832854334622,.16007832854334622,.10693932599531843,.10693932599531843,.04717533638651183,.04717533638651183],[.2325515532308739,.22628318026289723,.22628318026289723,.2078160475368885,.2078160475368885,.17814598076194574,.17814598076194574,.13887351021978725,.13887351021978725,.09212149983772845,.09212149983772845,.04048400476531588,.04048400476531588],[.2152638534631578,.2152638534631578,.2051984637212956,.2051984637212956,.18553839747793782,.18553839747793782,.15720316715819355,.15720316715819355,.12151857068790319,.12151857068790319,.08015808715976021,.08015808715976021,.03511946033175186,.03511946033175186],[.2025782419255613,.19843148532711158,.19843148532711158,.1861610000155622,.1861610000155622,.16626920581699392,.16626920581699392,.13957067792615432,.13957067792615432,.10715922046717194,.10715922046717194,.07036604748810812,.07036604748810812,.03075324199611727,.03075324199611727],[.1894506104550685,.1894506104550685,.18260341504492358,.18260341504492358,.16915651939500254,.16915651939500254,.14959598881657674,.14959598881657674,.12462897125553388,.12462897125553388,.09515851168249279,.09515851168249279,.062253523938647894,.062253523938647894,.027152459411754096,.027152459411754096],[.17944647035620653,.17656270536699264,.17656270536699264,.16800410215645004,.16800410215645004,.15404576107681028,.15404576107681028,.13513636846852548,.13513636846852548,.11188384719340397,.11188384719340397,.08503614831717918,.08503614831717918,.0554595293739872,.0554595293739872,.02414830286854793,.02414830286854793],[.1691423829631436,.1691423829631436,.16427648374583273,.16427648374583273,.15468467512626524,.15468467512626524,.14064291467065065,.14064291467065065,.12255520671147846,.12255520671147846,.10094204410628717,.10094204410628717,.07642573025488905,.07642573025488905,.0497145488949698,.0497145488949698,.02161601352648331,.02161601352648331],[.1610544498487837,.15896884339395434,.15896884339395434,.15276604206585967,.15276604206585967,.1426067021736066,.1426067021736066,.12875396253933621,.12875396253933621,.11156664554733399,.11156664554733399,.09149002162245,.09149002162245,.06904454273764123,.06904454273764123,.0448142267656996,.0448142267656996,.019461788229726478,.019461788229726478],[.15275338713072584,.15275338713072584,.14917298647260374,.14917298647260374,.14209610931838204,.14209610931838204,.13168863844917664,.13168863844917664,.11819453196151841,.11819453196151841,.10193011981724044,.10193011981724044,.08327674157670475,.08327674157670475,.06267204833410907,.06267204833410907,.04060142980038694,.04060142980038694,.017614007139152118,.017614007139152118],[.14608113364969041,.14452440398997005,.14452440398997005,.13988739479107315,.13988739479107315,.13226893863333747,.13226893863333747,.12183141605372853,.12183141605372853,.10879729916714838,.10879729916714838,.09344442345603386,.09344442345603386,.0761001136283793,.0761001136283793,.057134425426857205,.057134425426857205,.036953789770852494,.036953789770852494,.016017228257774335,.016017228257774335],[.13925187285563198,.13925187285563198,.13654149834601517,.13654149834601517,.13117350478706238,.13117350478706238,.12325237681051242,.12325237681051242,.11293229608053922,.11293229608053922,.10041414444288096,.10041414444288096,.08594160621706773,.08594160621706773,.06979646842452049,.06979646842452049,.052293335152683286,.052293335152683286,.03377490158481415,.03377490158481415,.0146279952982722,.0146279952982722],[.13365457218610619,.1324620394046966,.1324620394046966,.12890572218808216,.12890572218808216,.12304908430672953,.12304908430672953,.11499664022241136,.11499664022241136,.10489209146454141,.10489209146454141,.09291576606003515,.09291576606003515,.07928141177671895,.07928141177671895,.06423242140852585,.06423242140852585,.04803767173108467,.04803767173108467,.030988005856979445,.030988005856979445,.013411859487141771,.013411859487141771],[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872]],a.core.Binomial.memo=new s.ds.IntMap,a.core.Constants.TOLERANCE=1e-6,a.core.Constants.EPSILON=1e-10,a.exe.Dispatcher.THREADS=8,a.exe.Work.uuid=0,a.Init.main()})("undefined"!=typeof window?window:exports);