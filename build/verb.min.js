/*! verb 2013-02-18 */
if("object"!=typeof exports||void 0===exports)var VERB={},numeric=window.numeric,binomial=window.binomial,labor=window.labor;else var VERB=module.exports={},numeric=require("numeric"),binomial=require("binomial"),labor=require("labor");VERB.geom={},VERB.core={},VERB.eval={},VERB.init=function(){VERB.nurbs_engine=new VERB.core.Engine(VERB.eval.nurbs),VERB.geom.NURBSGeometry.prototype.nurbs_engine=VERB.nurbs_engine},VERB.core.Engine=function(n){var e="function"==typeof Worker&&(n.use_pool||void 0===n.use_pool),r=n.num_workers||2,i=n.tolerance||1e-4,t=n.url||"verb_nurbs_eval.js";n.library||VERB.eval.nurbs;var o=n.error_handler||function(n){console.warn(n)},s=void 0,u=function(){try{s=new labor.Pool(t,r),s.start()}catch(n){return o("Failed to initialize labor.Pool."),!1}return!0};this.start=function(){e&&u()},this.eval=function(n,r,i){if(e&&(s||void 0===s&&u()))s.addWork(n,r,i);else{var t=this;_.defer(function(){i(t.eval_sync(n,r))})}},this.eval_sync=function(n,e){return _library[n].apply(null,e)},this.set_tolerance=function(n){i=n},this.set_use_pool=function(n){return n&&void 0===s&&u()?(e=n,!0):n?!1:(s=null,delete s,!0)},this.set_error_handler=function(n){o=n},this.set_num_threads=function(n){r=n}},VERB.core.uid=function(){var n=0;return function(){return n++}}(),VERB.geom.BoundingBox=function(){this.initialized=!1,this.min=[0,0,0],this.max=[0,0,0];var n=Array.prototype.slice.call(arguments,0);this.add_points_sync(n)},VERB.geom.BoundingBox.prototype.add_points=function(n,e){var r=this;_.defer(function(){_.each(n,function(n){r.add(n)}),e(r)})},VERB.geom.BoundingBox.prototype.add_points_sync=function(n){var e=this;return _.each(n,function(n){e.add(n)}),this},VERB.geom.BoundingBox.prototype.add=function(n){return this.initialized?(n[0]>this.max[0]&&(this.max[0]=n[0]),n[1]>this.max[1]&&(this.max[1]=n[1]),n[2]>this.max[2]&&(this.max[2]=n[2]),n[0]<this.min[0]&&(this.min[0]=n[0]),n[1]<this.min[1]&&(this.min[1]=n[1]),n[2]<this.min[2]&&(this.min[2]=n[2]),this):(this.min=n.slice(0),this.max=n.slice(0),this.initialized=!0,this)},VERB.geom.BoundingBox.prototype.contains=function(n){return this.initialized?this.intersects(new VERB.geom.BoundingBox(n)):!1},VERB.geom.BoundingBox.prototype.TOLERANCE=1e-4,VERB.geom.BoundingBox.prototype.intervals_overlap=function(n,e,r,i){var t=VERB.geom.BoundingBox.prototype.TOLERANCE,o=Math.min(n,e)-t,s=Math.max(n,e)+t,u=Math.min(r,i)-t,a=Math.max(r,i)+t;return o>=u&&a>=o||s>=u&&a>=s||u>=o&&s>=u||a>=o&&s>=a?!0:!1},VERB.geom.BoundingBox.prototype.intersects=function(n){if(!this.initialized||!n.initialized)return!1;var e=this.min,r=this.max,i=n.min,t=n.max;return this.intervals_overlap(e[0],r[0],i[0],t[0])&&this.intervals_overlap(e[1],r[1],i[1],t[1])&&this.intervals_overlap(e[2],r[2],i[2],t[2])?!0:!1},VERB.geom.BoundingBox.prototype.clear=function(){return this.initialized=!1,this},VERB.geom.BoundingBox.prototype.intersect=function(n){if(!this.initialized)return null;var e=this.min,r=this.max,i=n.min,t=n.max;if(!this.intersects(n))return null;var o=Math.min(r[0],t[0]),s=Math.max(e[0],i[0]),u=Math.min(r[1],t[1]),a=Math.max(e[1],i[1]),l=Math.min(r[2],t[2]),_=Math.max(e[2],i[2]),v=[o,u,l],c=[s,a,_];return new VERB.geom.BoundingBox(c,v)},VERB.geom.Geometry=function(){var n=VERB.core.uid();this.uid=function(){return n}},VERB.geom.NurbsCurve=function(n,e,r,i){if(VERB.geom.NURBSGeometry.call(this),VERB.eval.nurbs.are_valid_relations(n,e.length,i.length))var t=e.slice(0),o=VERB.eval.nurbs.homogenize_1d(e,r),s=i.slice(0),u=r.slice(0),a=n;else{console.warn("Invalid relations were used to instantiate a NurbsCurve - using defaults.");var t=[],o=[],s=[],u=[],a=2}this.set_control_point=function(n,e){return t[n]=e,o[n]=e*u[n],this},this.set_weight=function(n,e){return u[n]=e,set_control_point(n,t[n]),this},this.set_knot=function(n,e){return s[n]=e,this},this.point_sync=function(n){return this.nurbs_engine.eval_sync("rational_curve_point",[a,_knot_vector,o,n])},this.derivs_sync=function(n,e){return this.nurbs_engine.eval_sync("rational_curve_derivs",[a,_knot_vector,o,n,e])},this.point=function(n,e){nurbs_engine.eval("rational_curve_point",[a,_knot_vector,o,n],e)},this.derivs=function(n,e,r){this.nurbs_engine.eval("rational_curve_derivs",[a,_knot_vector,o,n,e],r)}},VERB.geom.NURBSGeometry=function(){VERB.geom.Geometry.call(this)}.inherits(VERB.geom.Geometry),VERB.geom.NurbsSurface=function(n,e,r,i){VERB.geom.NURBSGeometry.call(this),e.slice(0),i.slice(0),r.slice(0),this.set_control_point=function(){},this.set_weight=function(){},this.set_control_point=function(){},this.point=function(){},this.derivs=function(){}}.inherits(VERB.geom.NURBSGeometry),VERB.eval.nurbs.rational_surface_derivs=function(n,e,r,i,t,o,s,u){var a=VERB.eval.nurbs.surface_derivs(n,e,r,i,t,o,s,u),l=VERB.eval.nurbs.separate_homo_derivs_2d(a),_=l[0],v=l[1],c=0,h=0,f=0,m=0,B=[],d=_[0][0].length;for(c=0;o>=c;c++)for(B.push([]),m=0;o-c>=m;m++){var u=_[c][m];for(f=1;m>=f;f++)u=numeric.sub(u,numeric.mul(numeric.mul(binomial.get(m,f),v[0][f]),B[c][m-f]));for(h=1;c>=h;h++){u=numeric.sub(u,numeric.mul(numeric.mul(binomial.get(c,h),v[h][0]),B[c-h][m]));var b=VERB.eval.nurbs.zeros_1d(d);for(f=1;m>=f;f++)b=numeric.add(b,numeric.mul(numeric.mul(binomial.get(m,f),v[h][f]),B[c-h][m-f]));u=numeric.sub(u,numeric.mul(binomial.get(c,h),b))}B[c].push(numeric.mul(1/v[0][0],u))}return B},VERB.eval.nurbs.rational_surface_point=function(n,e,r,i,t,o,s){return VERB.eval.nurbs.dehomogenize(VERB.eval.nurbs.surface_point(n,e,r,i,t,o,s))},VERB.eval.nurbs.rational_curve_derivs=function(n,e,r,i,t){var o=VERB.eval.nurbs.separate_homo_derivs_1d(VERB.eval.nurbs.curve_derivs(n,e,r,i,t)),s=o[0],u=o[1],a=0,l=0,_=[];for(a=0;t>=a;a++){var v=s[a];for(l=1;a>=l;l++)v=numeric.sub(v,numeric.mul(numeric.mul(binomial.get(a,l),u[l]),_[a-l]));_.push(numeric.mul(1/u[0],v))}return _},VERB.eval.nurbs.separate_homo_derivs_1d=function(n){for(var e=n[0].length,r=e-1,i=[],t=[],o=0,s=n.length;s>o;o++)i.push(n[o].slice(0,r)),t.push(n[o][r]);return[i,t]},VERB.eval.nurbs.separate_homo_derivs_2d=function(n){for(var e=[],r=[],i=0,t=n.length;t>i;i++){var o=VERB.eval.nurbs.separate_homo_derivs_1d(n[i]);e.push(o[0]),r.push(o[1])}return[e,r]},VERB.eval.nurbs.rational_curve_point=function(n,e,r,i){return VERB.eval.nurbs.dehomogenize(VERB.eval.nurbs.curve_point(n,e,r,i))},VERB.eval.nurbs.dehomogenize=function(n){for(var e=n.length,r=[],i=n[e-1],t=0;n.length-1>t;t++)r.push(n[t]/i);return r},VERB.eval.nurbs.homogenize_1d=function(n,e){for(var r=n.length,i=n[0].length,t=0,o=[],s=0,u=[],a=0;r>a;a++){var l=[];for(u=n[a],s=e[a],t=0;i>t;t++)l.push(u[t]*s);l.push(s),o.push(l)}return o},VERB.eval.nurbs.homogenize_2d=function(n,e){for(var r=n.length,i=(n[0].length,n[0][0].length,[]),t=0;r>t;t++)i.push(VERB.eval.nurbs.homogenize_1d(n[t],e[t]));return i},VERB.eval.nurbs.surface_derivs=function(n,e,r,i,t,o,s,u){var a=e.length-n-2,l=i.length-r-2;return VERB.eval.nurbs.surface_derivs_given_n_m(a,n,e,l,r,i,t,o,s,u)},VERB.eval.nurbs.surface_derivs_given_n_m=function(n,e,r,i,t,o,s,u,a,l){if(VERB.eval.nurbs.are_valid_relations(e,s.length,r.length)===!1||VERB.eval.nurbs.are_valid_relations(t,s[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var _=s[0][0].length,v=Math.min(u,e),c=Math.min(u,t),h=VERB.eval.nurbs.zeros_3d(v+1,c+1,_),f=VERB.eval.nurbs.knot_span_given_n(n,e,a,r),m=VERB.eval.nurbs.knot_span_given_n(i,t,l,o),B=VERB.eval.nurbs.deriv_basis_functions_given_n_i(f,a,e,n,r),d=VERB.eval.nurbs.deriv_basis_functions_given_n_i(m,l,t,i,o),b=VERB.eval.nurbs.zeros_2d(t+1,_),g=0,R=0,E=0,V=0,p=0;for(g=0;v>=g;g++){for(R=0;t>=R;R++)for(b[R]=VERB.eval.nurbs.zeros_1d(_),E=0;e>=E;E++)b[R]=numeric.add(b[R],numeric.mul(B[g][E],s[f-e+E][m-t+R]));for(p=Math.min(u-g,c),V=0;p>=V;V++)for(h[g][V]=VERB.eval.nurbs.zeros_1d(_),R=0;t>=R;R++)h[g][V]=numeric.add(h[g][V],numeric.mul(d[V][R],b[R]))}return h},VERB.eval.nurbs.surface_point=function(n,e,r,i,t,o,s){var u=e.length-n-2,a=i.length-r-2;return VERB.eval.nurbs.surface_point_given_n_m(u,n,e,a,r,i,t,o,s)},VERB.eval.nurbs.surface_point_given_n_m=function(n,e,r,i,t,o,s,u,a){if(VERB.eval.nurbs.are_valid_relations(e,s.length,r.length)===!1||VERB.eval.nurbs.are_valid_relations(t,s[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var l=(s[0][0].length,VERB.eval.nurbs.knot_span_given_n(n,e,u,r)),_=VERB.eval.nurbs.knot_span_given_n(i,t,a,o),v=VERB.eval.nurbs.basis_functions_given_knot_span_index(l,u,e,r),c=VERB.eval.nurbs.basis_functions_given_knot_span_index(_,a,t,o),h=l-e,f=_,m=VERB.eval.nurbs.zeros_1d(s[0][0].length),B=VERB.eval.nurbs.zeros_1d(s[0][0].length),d=0,b=0;for(d=0;t>=d;d++){for(B=VERB.eval.nurbs.zeros_1d(s[0][0].length),f=_-t+d,b=0;e>=b;b++)B=numeric.add(B,numeric.mul(v[b],s[h+b][f]));m=numeric.add(m,numeric.mul(c[d],B))}return m},VERB.eval.nurbs.curve_derivs=function(n,e,r,i,t){var o=e.length-n-2;return VERB.eval.nurbs.curve_derivs_given_n(o,n,e,r,i,t)},VERB.eval.nurbs.curve_derivs_given_n=function(n,e,r,i,t,o){if(VERB.eval.nurbs.are_valid_relations(e,i.length,r.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var s=i[0].length,u=Math.min(o,e),a=VERB.eval.nurbs.zeros_2d(u+1,s),l=VERB.eval.nurbs.knot_span_given_n(n,e,t,r),_=VERB.eval.nurbs.deriv_basis_functions_given_n_i(l,t,e,u,r),v=0,c=0;for(v=0;u>=v;v++)for(c=0;e>=c;c++)a[v]=numeric.add(a[v],numeric.mul(_[v][c],i[l-e+c]));return a},VERB.eval.nurbs.are_valid_relations=function(n,e,r){return 0===e+n+1-r?!0:!1},VERB.eval.nurbs.curve_point=function(n,e,r,i){var t=e.length-n-2;return VERB.eval.nurbs.curve_point_given_n(t,n,e,r,i)},VERB.eval.nurbs.curve_point_given_n=function(n,e,r,i,t){if(VERB.eval.nurbs.are_valid_relations(e,i.length,r.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;for(var o=VERB.eval.nurbs.knot_span_given_n(n,e,t,r),s=VERB.eval.nurbs.basis_functions_given_knot_span_index(o,t,e,r),u=VERB.eval.nurbs.zeros_1d(i[0].length),a=0;e>=a;a++)u=numeric.add(u,numeric.mul(s[a],i[o-e+a]));return u},VERB.eval.nurbs.zeros_1d=function(n){n=n>0?n:0;for(var e=[];n--;)e.push(0);return e},VERB.eval.nurbs.zeros_2d=function(n,e){e=e>0?e:0,n=n>0?n:0;for(var r=[],i=e,t=n;n--;){for(r.push([]);i--;)r[t-n-1].push(0);i=e}return r},VERB.eval.nurbs.zeros_3d=function(n,e,r){e=e>0?e:0,n=n>0?n:0;for(var i=[],t=e,o=n;n--;){for(i.push([]);t--;)i[o-n-1].push(VERB.eval.nurbs.zeros_1d(r));t=e}return i},VERB.eval.nurbs.deriv_basis_functions=function(n,e,r){var i=VERB.eval.nurbs.knot_span(e,n,r),t=r.length-1,o=t-e-1;return VERB.eval.nurbs.deriv_basis_functions_given_n_i(i,n,e,o,r)},VERB.eval.nurbs.deriv_basis_functions_given_n_i=function(n,e,r,i,t){var o=VERB.eval.nurbs.zeros_2d(r+1,r+1),s=Array(r+1),u=Array(r+1),a=0,l=0,_=1,v=0;for(o[0][0]=1,_=1;r>=_;_++){for(s[_]=e-t[n+1-_],u[_]=t[n+_]-e,a=0,v=0;_>v;v++)o[_][v]=u[v+1]+s[_-v],l=o[v][_-1]/o[_][v],o[v][_]=a+u[v+1]*l,a=s[_-v]*l;o[_][_]=a}var c=VERB.eval.nurbs.zeros_2d(i+1,r+1),h=VERB.eval.nurbs.zeros_2d(2,r+1),f=1,m=0,B=1,d=0,b=0,g=0,R=0,E=0;for(_=0;r>=_;_++)c[0][_]=o[_][r];for(v=0;r>=v;v++)for(m=0,B=1,h[0][0]=1,f=1;i>=f;f++){for(d=0,b=v-f,g=r-f,v>=f&&(h[B][0]=h[m][0]/o[g+1][b],d=h[B][0]*o[b][g]),R=b>=-1?1:-b,E=g>=v-1?f-1:r-v,_=R;E>=_;_++)h[B][_]=(h[m][_]-h[m][_-1])/o[g+1][b+_],d+=h[B][_]*o[b+_][g];g>=v&&(h[B][f]=-h[m][f-1]/o[g+1][v],d+=h[B][f]*o[v][g]),c[f][v]=d,_=m,m=B,B=_}for(v=r,f=1;i>=f;f++){for(_=0;r>=_;_++)c[f][_]*=v;v*=r-f}return c},VERB.eval.nurbs.basis_functions=function(n,e,r){var i=VERB.eval.nurbs.knot_span(n,e,r);return VERB.eval.nurbs.basis_functions_given_knot_span_index(i,n,e,r)},VERB.eval.nurbs.basis_functions_given_knot_span_index=function(n,e,r,i){var t=Array(r+1),o=Array(r+1),s=Array(r+1),u=0,a=0;t[0]=1;for(var l=1;r>=l;l++){o[l]=e-i[n+1-l],s[l]=i[n+l]-e,u=0;for(var _=0;l>_;_++)a=t[_]/(s[_+1]+o[l-_]),t[_]=u+s[_+1]*a,u=o[l-_]*a;t[l]=u}return t},VERB.eval.nurbs.knot_span=function(n,e,r){var i=r.length-1,t=i-n-1;return VERB.eval.nurbs.knot_span_given_n(t,n,e,r)},VERB.eval.nurbs.knot_span_given_n=function(n,e,r,i){if(r>=i[n+1])return n;if(i[e]>r)return e;for(var t=e,o=n+1,s=Math.floor((t+o)/2);i[s]>r||r>=i[s+1];)i[s]>r?o=s:t=s,s=Math.floor((t+o)/2);return s};