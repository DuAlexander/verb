/*! verb 2014-12-22 */
"use strict";function Node(e,r,t){this.obj=e,this.left=null,this.right=null,this.parent=t,this.dimension=r}function KdTree(e,r,t){function n(e,r,i){var o,s,a=r%t.length;return 0===e.length?null:1===e.length?new Node(e[0],a,i):(e.sort(function(e,r){return e[t[a]]-r[t[a]]}),o=Math.floor(e.length/2),s=new Node(e[o],a,i),s.left=n(e.slice(0,o),r+1,s),s.right=n(e.slice(o+1),r+1,s),s)}var i=this;this.root=n(e,0,null),this.insert=function(e){function r(n,i){if(null===n)return i;var o=t[n.dimension];return e[o]<n.obj[o]?r(n.left,n):r(n.right,n)}var n,i,o=r(this.root,null);return null===o?(this.root=new Node(e,0,null),void 0):(n=new Node(e,(o.dimension+1)%t.length,o),i=t[o.dimension],e[i]<o.obj[i]?o.left=n:o.right=n,void 0)},this.remove=function(e){function r(n){if(null===n)return null;if(n.obj===e)return n;var i=t[n.dimension];return e[i]<n.obj[i]?r(n.left,n):r(n.right,n)}function n(e){function r(e,n){var i,o,s,a,u;return null===e?null:(i=t[n],e.dimension===n?null!==e.right?r(e.right,n):e:(o=e.obj[i],s=r(e.left,n),a=r(e.right,n),u=e,null!==s&&s.obj[i]>o&&(u=s),null!==a&&a.obj[i]>u.obj[i]&&(u=a),u))}function o(e,r){var n,i,s,a,u;return null===e?null:(n=t[r],e.dimension===r?null!==e.left?o(e.left,r):e:(i=e.obj[n],s=o(e.left,r),a=o(e.right,r),u=e,null!==s&&i>s.obj[n]&&(u=s),null!==a&&a.obj[n]<u.obj[n]&&(u=a),u))}var s,a,u;return null===e.left&&null===e.right?null===e.parent?(i.root=null,void 0):(u=t[e.parent.dimension],e.obj[u]<e.parent.obj[u]?e.parent.left=null:e.parent.right=null,void 0):(s=null!==e.left?r(e.left,e.dimension):o(e.right,e.dimension),a=s.obj,n(s),e.obj=a,void 0)}var o;o=r(i.root),null!==o&&n(o)},this.nearest=function(e,n,o){function s(i){function o(e,r){v.push([e,r]),v.size()>n&&v.pop()}var a,u,l,c,h=t[i.dimension],b=r(e,i.obj),_={};for(c=0;t.length>c;c+=1)_[t[c]]=c===i.dimension?e[t[c]]:i.obj[t[c]];return u=r(_,i.obj),null===i.right&&null===i.left?((n>v.size()||v.peek()[1]>b)&&o(i,b),void 0):(a=null===i.right?i.left:null===i.left?i.right:e[h]<i.obj[h]?i.left:i.right,s(a),(n>v.size()||v.peek()[1]>b)&&o(i,b),(n>v.size()||Math.abs(u)<v.peek()[1])&&(l=a===i.left?i.right:i.left,null!==l&&s(l)),void 0)}var a,u,v;if(v=new BinaryHeap(function(e){return-e[1]}),o)for(a=0;n>a;a+=1)v.push([null,o]);for(s(i.root),u=[],a=0;n>a;a+=1)v.content[a][0]&&u.push([v.content[a][0].obj,v.content[a][1]]);return u},this.balanceFactor=function(){function e(r){return null===r?0:Math.max(e(r.left),e(r.right))+1}function r(e){return null===e?0:r(e.left)+r(e.right)+1}return e(i.root)/(Math.log(r(i.root))/Math.log(2))}}function BinaryHeap(e){this.content=[],this.scoreFunction=e}function CurvePoint(e,r){this.u=e,this.len=r}function crossprod(e,r){return[e[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]}if("object"!=typeof exports||void 0===exports)var verb={},numeric=window.numeric,binomial=window.binomial,labor=window.labor;else var verb=module.exports={},numeric=require("numeric"),binomial=require("binomial"),labor=require("labor");verb=verb||{},verb=verb||{},verb.eval=verb.eval||{},verb.EPSILON=1e-10,verb.TOLERANCE=1e-6,verb.init=function(){verb.nurbsEngine=new verb.Engine(verb.eval),verb.NurbsGeometry.prototype.nurbsEngine=verb.nurbsEngine},Function.prototype.method=function(e,r){return this.prototype[e]=r,this},Function.method("inherits",function(e){return this.prototype=new e,this.prototype,this.prototype.constructor=e,this}),Array.prototype.flatten=function(){if(0==this.length)return[];for(var e=[],r=0;this.length>r;r++)e=this[r]instanceof Array?e.concat(this[r].flatten()):e.concat(this[r]);return e},numeric.normalized=function(e){return numeric.div(e,numeric.norm2(e))},numeric.cross=function(e,r){return[e[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]},verb.left=function(e){if(0===e.length)return[];var r=Math.ceil(e.length/2);return e.slice(0,r)},verb.right=function(e){if(0===e.length)return[];var r=Math.ceil(e.length/2);return e.slice(r)},verb.last=function(e){return e.length?e[e.length-1]:void 0},verb.rightWithPivot=function(e){if(0===e.length)return[];var r=Math.ceil(e.length/2);return e.slice(r-1)},verb.unique=function(e,r){if(0===e.length)return[];for(var t=[e.pop()];e.length>0;){for(var n=e.pop(),i=!0,o=0;t.length>o;o++)if(r(n,t[o])){i=!1;break}i&&t.push(n)}return t},verb.isZero=function(e){for(var r=0,t=e.length;t>r;r++)if(Math.abs(e[r])>verb.TOLERANCE)return!1;return!0},verb.range=function(e,r,t){1>=arguments.length&&(r=e||0,e=0),t=arguments[2]||1;for(var n=Math.max(Math.ceil((r-e)/t),0),i=0,o=Array(n);n>i;)o[i++]=e,e+=t;return o},BinaryHeap.prototype={push:function(e){this.content.push(e),this.bubbleUp(this.content.length-1)},pop:function(){var e=this.content[0],r=this.content.pop();return this.content.length>0&&(this.content[0]=r,this.sinkDown(0)),e},peek:function(){return this.content[0]},remove:function(e){for(var r=this.content.length,t=0;r>t;t++)if(this.content[t]==e){var n=this.content.pop();return t!=r-1&&(this.content[t]=n,this.scoreFunction(n)<this.scoreFunction(e)?this.bubbleUp(t):this.sinkDown(t)),void 0}throw Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(e){for(var r=this.content[e];e>0;){var t=Math.floor((e+1)/2)-1,n=this.content[t];if(!(this.scoreFunction(r)<this.scoreFunction(n)))break;this.content[t]=r,this.content[e]=n,e=t}},sinkDown:function(e){for(var r=this.content.length,t=this.content[e],n=this.scoreFunction(t);;){var i=2*(e+1),o=i-1,s=null;if(r>o){var a=this.content[o],u=this.scoreFunction(a);n>u&&(s=o)}if(r>i){var v=this.content[i],l=this.scoreFunction(v);(null==s?n:u)>l&&(s=i)}if(null==s)break;this.content[e]=this.content[s],this.content[s]=t,e=s}}},verb.core.Engine=function(e){var r="function"==typeof Worker&&(e.use_pool||void 0===e.use_pool),t=e.num_workers||2,n=e.tolerance||1e-4,i=e.url||"js/verbEval.js",o=e.library||verb.eval,s=e.error_handler||function(e){console.warn(e)},a=void 0,u=function(){try{a=new labor.Pool(i,t),a.start()}catch(e){return s("Failed to initialize labor.Pool: "+e),!1}return!0},v=function(e,r){return o[e].apply(null,r)};this.start=function(){r&&u()},this.eval=function(e,t,n){return n?(r&&(a||void 0===a&&u())?a.addWork(e,t,n):setTimeout(function(){n(v(e,t))},0),void 0):v(e,t)},this.setTolerance=function(e){n=e},this.setUsePool=function(e){return e&&void 0===a&&u()?(r=e,!0):e?!1:(a=null,!0)},this.setErrorHandler=function(e){s=e},this.setNumThreads=function(e){t=e}},verb.core.WatchObject=function(){var e={change:{}},r={},t=0,n=this,i=function(r,t){if("string"==typeof r){for(var n in e[r])e[r][n](t);for(var n in e.change)e.change[n](t)}else for(var o in r)i(o,t)};this.get=function(e){return r[e]},this.set=function(t,o){var s=r[t];r[t]=o,e[t]=e[t]||{},i(t,{name:t,old:s,"new":o,target:n,type:"full"})},this.setAll=function(t){var o={};for(var s in t)o[s]=r[s],r[s]=t[s],e[s]=e[s]||{};i(t,{old:o,"new":t,target:n,type:"multi"})},this.setAt=function(e,t,o){var s=r[e];if(!(void 0===s||s.length>=t||0>t)){var a=r[e][t];r[e][t]=o,i(e,{name:e,index:t,old:a,"new":o,target:n,type:"index"})}},this.watch=function(n,i){return void 0!==r[n]&&i?(t++,e[n][t]=i,t++):void 0},this.watchAll=function(e,r){for(var t=[],n=0;e.length>n;n++)t.push(this.watch(e[n],r));return t},this.ignore=function(r,t){void 0!==e[r]&&void 0!==e[r][t]&&(e[r][t]=void 0)}},verb.core.uid=function(){var e=0;return function(){return e++}}(),verb.Geometry=function(){verb.core.WatchObject.call(this);var e=verb.core.uid();this.uniqueId=function(){return e}}.inherits(verb.core.WatchObject),verb.NurbsGeometry=function(){verb.Geometry.call(this)}.inherits(verb.Geometry),verb.NurbsCurve=function(e,r,t,n){verb.NurbsGeometry.call(this),this.setAll({controlPoints:r,weights:t,knots:n?n.slice(0):[],degree:e})}.inherits(verb.NurbsGeometry),verb.NurbsCurve.prototype.point=function(e,r){return this.nurbsEngine.eval("rational_curve_point",[this.get("degree"),this.get("knots"),this.homogenize(),e],r)},verb.NurbsCurve.prototype.derivatives=function(e,r,t){return this.nurbsEngine.eval("rational_curve_derivs",[this.get("degree"),this.get("knots"),this.homogenize(),e,r||1],t)},verb.NurbsCurve.prototype.closestPoint=function(e,r){return this.nurbsEngine.eval("rational_curve_closest_point",[this.get("degree"),this.get("knots"),this.homogenize(),e],r)},verb.NurbsCurve.prototype.length=function(e){return this.nurbsEngine.eval("rational_curve_arc_length",[this.get("degree"),this.get("knots"),this.homogenize()],e)},verb.NurbsCurve.prototype.lengthAtParam=function(e,r){return this.nurbsEngine.eval("rational_curve_arc_length",[this.get("degree"),this.get("knots"),this.homogenize(),e],r)},verb.NurbsCurve.prototype.paramAtLength=function(e,r){return this.nurbsEngine.eval("rational_curve_param_at_arc_length",[this.get("degree"),this.get("knots"),this.homogenize(),e],r)},verb.NurbsCurve.prototype.divideByEqualArcLength=function(e,r){return this.nurbsEngine.eval("rational_curve_divide_curve_equally_by_arc_length",[this.get("degree"),this.get("knots"),this.homogenize(),e],r)},verb.NurbsCurve.prototype.divideByArcLength=function(e,r){return this.nurbsEngine.eval("rational_curve_divide_curve_by_arc_length",[this.get("degree"),this.get("knots"),this.homogenize(),e],r)},verb.NurbsCurve.prototype.tessellate=function(e,r){var e=e||{};return e.tolerance=e.tolerance||verb.EPSILON,this.nurbsEngine.eval("rational_curve_adaptive_sample",[this.get("degree"),this.get("knots"),this.homogenize(),e.tolerance],r)},verb.NurbsCurve.prototype.split=function(e,r){function t(e){var r=verb.eval.dehomogenize_1d(e[0].control_points),t=verb.eval.weight_1d(e[0].control_points),n=new verb.NurbsCurve(e[0].degree,r,t,e[0].knots),i=verb.eval.dehomogenize_1d(e[1].control_points),o=verb.eval.weight_1d(e[1].control_points),s=new verb.NurbsCurve(e[1].degree,i,o,e[1].knots);return[n,s]}var n=this.domain();if(n[0]>=e||e>=n[1])throw Error("Cannot split outside of the domain of the curve!");return r?this.nurbsEngine.eval("curve_split",[this.get("degree"),this.get("knots"),this.homogenize(),e],function(e){return r(t(e))}):t(this.nurbsEngine.eval("curve_split",[this.get("degree"),this.get("knots"),this.homogenize(),e]))},verb.NurbsCurve.prototype.domain=function(){var e=this.get("knots");return[e[0],e[e.length-1]]},verb.NurbsCurve.prototype.transform=function(e){for(var r=this.get("controlPoints"),t=0;r.length>t;t++){var n=r[1].push(1);r[t]=numeric.mul(e,n).slice(0,n.length-2)}return this.set("controlPoints",r),this},verb.NurbsCurve.prototype.clone=function(){for(var e=this.get("controlPoints"),r=[],t=0;e.length>t;t++)r.push(e[t].slice(0));return new verb.NurbsCurve(this.get("degree"),r,this.get("weights").slice(0),this.get("knots").slice)},verb.NurbsCurve.prototype.homogenize=function(){return verb.eval.homogenize_1d(this.get("controlPoints"),this.get("weights"))},verb.NurbsCurve.prototype.update=function(){if(this.nurbsRep){var e=this.nurbsRep();this.setAll({controlPoints:e.control_points,weights:e.weights,knots:e.knots,degree:e.degree})}},verb.NurbsSurface=function(e,r,t,n,i,o){verb.NurbsGeometry.call(this),this.setAll({controlPoints:i,weights:o,knotsU:r?r.slice(0):[],knotsV:n?n.slice(0):[],degreeU:e,degreeV:t})}.inherits(verb.NurbsGeometry),verb.NurbsSurface.prototype.point=function(e,r,t){return this.nurbsEngine.eval("rational_surface_point",[this.get("degreeU"),this.get("knotsU"),this.get("degreeV"),this.get("knotsV"),this.homogenize(),e,r],t)},verb.NurbsSurface.prototype.derivatives=function(e,r,t,n){return this.nurbsEngine.eval("rational_surface_derivs",[this.get("degreeU"),this.get("knotsU"),this.get("degreeV"),this.get("knotsV"),this.homogenize(),t||1,e,r],n)},verb.NurbsSurface.prototype.closestPoint=function(e,r){return this.nurbsEngine.eval("rational_surface_closest_point",[this.get("degreeU"),this.get("knotsU"),this.get("degreeV"),this.get("knotsV"),this.homogenize(),e],r)},verb.NurbsSurface.prototype.split=function(e,r,t){function n(e){var r=verb.eval.dehomogenize_2d(e[0].control_points),t=verb.eval.weight_2d(e[0].control_points),n=new verb.NurbsSurface(e[0].degree_u,e[0].knots_u,e[0].degree_v,e[0].knots_v,r,t),i=verb.eval.dehomogenize_2d(e[1].control_points),o=verb.eval.weight_2d(e[1].control_points),s=new verb.NurbsSurface(e[1].degree_u,e[1].knots_u,e[1].degree_v,e[1].knots_v,i,o);return[n,s]}var i=this.domain(),r=void 0===r?0:r,e=void 0===e?(i[r][1]-i[r][0])/2:e;if(i[r][0]>=e||e>=i[r][1])throw Error("Cannot split outside of the domain of the surface!");return t?this.nurbsEngine.eval("surface_split",[this.get("degreeU"),this.get("knotsU"),this.get("degreeV"),this.get("knotsV"),this.homogenize(),e,r],function(e){return t(n(e))}):n(this.nurbsEngine.eval("surface_split",[this.get("degreeU"),this.get("knotsU"),this.get("degreeV"),this.get("knotsV"),this.homogenize(),e,r]))},verb.NurbsSurface.prototype.tessellate=function(e,r){return this.nurbsEngine.eval("tessellate_rational_surface_adaptive",[this.get("degreeU"),this.get("knotsU"),this.get("degreeV"),this.get("knotsV"),this.homogenize(),e],r)},verb.NurbsSurface.prototype.domain=function(){var e=this.get("knotsU"),r=this.get("knotsV");return[[e[0],e[e.length-1]],[r[0],r[r.length-1]]]},verb.NurbsSurface.prototype.transform=function(e){for(var r=this.get("controlPoints"),t=0;r.length>t;t++)for(var n=0;r[t].length>n;n++){var i=r[1].push(1);r[t]=numeric.mul(e,i).slice(0,i.length-2)}return this.set("controlPoints",r),this},verb.NurbsSurface.prototype.clone=function(){for(var e=this.get("controlPoints"),r=[],t=0;e.length>t;t++){r.push([]);for(var n=0;e[t].length>n;n++)r[t].push(e[t][n].slice(0))}for(var i=this.get("weights"),o=[],t=0;i.length>t;t++)o.push(i[t].slice(0));return new verb.NurbsSurface(this.get("degreeU"),this.get("knotsU").slice(0),this.get("degreeV"),this.get("knotsV").slice(0),r,o)},verb.NurbsSurface.prototype.homogenize=function(){return verb.eval.homogenize_2d(this.get("controlPoints"),this.get("weights"))},verb.NurbsSurface.prototype.update=function(){if(this.nurbsRep){var e=this.nurbsRep();this.setAll({controlPoints:e.control_points,weights:e.weights,knotsU:e.knots_u,knotsV:e.knots_v,degreeU:e.degree_u,degreeV:e.degree_v})}},verb.Arc=function(e,r,t,n,i){verb.NurbsCurve.call(this),this.setAll({center:e,xaxis:r,yaxis:t,radius:n,interval:i}),this.update(),this.watchAll(["center","xaxis","yaxis","radius","interval"],this.update)}.inherits(verb.NurbsCurve),verb.Arc.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_arc",[this.get("center"),this.get("xaxis"),this.get("yaxis"),this.get("radius"),this.get("interval").get("min"),this.get("interval").get("max")])},verb.BezierCurve=function(e,r){verb.NurbsCurve.call(this),this.setAll({controlPoints:e?e.slice(0):[],weights:r?r.slice(0):void 0}),this.update()}.inherits(verb.NurbsCurve),verb.BezierCurve.prototype.nurbsRep=function(){for(var e=this.get("controlPoints"),r=this.get("weights"),t=e.length-1,n=[],i=0;t+1>i;i++)n.push(0);for(var i=0;t+1>i;i++)n.push(1);if(void 0===r){r=[];for(var i=0;e.length>i;i++)r.push(1)}return{degree:t,knots:n,control_points:e,weights:r}},verb.BoundingBox=function(e){this.initialized=!1,this.dim=3,this.min=null,this.max=null,e&&this.addRange(e)},verb.BoundingBox.fromPoint=function(e){var r=new verb.BoundingBox;return r.add(e),r},verb.BoundingBox.prototype.add=function(e){if(!this.initialized)return this.dim=e.length,this.min=e.slice(0),this.max=e.slice(0),this.initialized=!0,this;var r=0,t=this.dim;for(r=0;t>r;r++)e[r]>this.max[r]&&(this.max[r]=e[r]);for(r=0;t>r;r++)e[r]<this.min[r]&&(this.min[r]=e[r]);return this},verb.BoundingBox.prototype.addRange=function(e,r){var t=e.length;if(r)setTimeout(function(){for(var n=0;t>n;n++)this.add(e[n]);r(this)}.bind(this),0);else for(var n=0;t>n;n++)this.add(e[n]);return this},verb.BoundingBox.prototype.contains=function(e,r){return this.initialized?this.intersects(new verb.BoundingBox([e]),r):!1},verb.BoundingBox.prototype.TOLERANCE=1e-4,verb.BoundingBox.prototype.intervalsOverlap=function(e,r,t,n,i){var i=i||verb.BoundingBox.prototype.TOLERANCE,o=Math.min(e,r)-i,s=Math.max(e,r)+i,a=Math.min(t,n)-i,u=Math.max(t,n)+i;return o>=a&&u>=o||s>=a&&u>=s||a>=o&&s>=a||u>=o&&s>=u?!0:!1},verb.BoundingBox.prototype.intersects=function(e,r){if(!this.initialized||!e.initialized)return!1;var t=this.min,n=this.max,i=e.min,o=e.max;return this.intervalsOverlap(t[0],n[0],i[0],o[0],r)&&this.intervalsOverlap(t[1],n[1],i[1],o[1],r)&&this.intervalsOverlap(t[2],n[2],i[2],o[2],r)?!0:!1},verb.BoundingBox.prototype.clear=function(){return this.initialized=!1,this},verb.BoundingBox.prototype.getLongestAxis=function(){for(var e=[],r=0;this.dim>r;r++)e.push(this.getAxisLength(r));return e.indexOf(Math.max.apply(Math,e))},verb.BoundingBox.prototype.getAxisLength=function(e){return 0>e||e>this.dim-1?0:Math.abs(this.min[e]-this.max[e])},verb.BoundingBox.prototype.intersect=function(e,r){if(!this.initialized)return null;var t=this.min,n=this.max,i=e.min,o=e.max;if(!this.intersects(e,r))return null;for(var s=[],a=[],u=0;this.dim>u;u++)s.push(Math.min(n[u],o[u])),a.push(Math.max(t[u],i[u]));return new verb.BoundingBox([a,s])},verb.Circle=function(e,r,t,n){verb.NurbsCurve.call(this),this.setAll({center:e,xaxis:r,yaxis:t,radius:n}),this.update(),this.watchAll(["center","xaxis","yaxis","radius"],this.update)}.inherits(verb.NurbsCurve),verb.Circle.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_arc",[this.get("center"),this.get("xaxis"),this.get("yaxis"),this.get("radius"),0,2*Math.PI])},verb.Cone=function(e,r,t,n,i){verb.NurbsSurface.call(this),this.setAll({axis:e,xaxis:r,base:t,height:n,radius:i});var o=this.nurbsRep();verb.NurbsSurface.call(this,o.degree_u,o.knots_u,o.degree_v,o.knots_v,o.control_points,o.weights),this.watchAll(["axis","xaxis","base","height","radius"],this.update)}.inherits(verb.NurbsSurface),verb.Cone.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_cone_surface",[this.get("axis"),this.get("xaxis"),this.get("base"),this.get("height"),this.get("radius")])},verb.Cylinder=function(e,r,t,n,i){this.setAll({axis:e,xaxis:r,base:t,height:n,radius:i});var o=this.nurbsRep();verb.NurbsSurface.call(this,o.degree_u,o.knots_u,o.degree_v,o.knots_v,o.control_points,o.weights),this.watchAll(["axis","xaxis","base","height","radius"],this.update)}.inherits(verb.NurbsSurface),verb.Cylinder.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_cylinder_surface",[this.get("axis"),this.get("xaxis"),this.get("base"),this.get("height"),this.get("radius")])},verb.Ellipse=function(e,r,t,n,i){verb.NurbsCurve.call(this),this.setAll({center:e,xaxis:r,yaxis:t,xradius:n,yradius:i}),this.update(),this.watchAll(["center","xaxis","yaxis","xradius","yradius"],this.update)}.inherits(verb.NurbsCurve),verb.Ellipse.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_ellipse_arc",[this.get("center"),this.get("xaxis"),this.get("yaxis"),this.get("xradius"),this.get("yradius"),0,2*Math.PI])},verb.EllipseArc=function(e,r,t,n,i,o){verb.NurbsCurve.call(this),this.setAll({center:e,xaxis:r,yaxis:t,xradius:n,yradius:i,interval:o}),this.update(),this.watchAll(["center","xaxis","yaxis","xradius","yradius","interval"],this.update)}.inherits(verb.NurbsCurve),verb.EllipseArc.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_ellipse_arc",[this.get("center"),this.get("xaxis"),this.get("yaxis"),this.get("xradius"),this.get("yradius"),this.get("interval").get("min"),this.get("interval").get("max")])},verb.Extrusion=function(e,r,t){verb.NurbsSurface.call(this),this.setAll({profile:e,axis:r,length:t}),this.update(),this.watchAll(["axis","length"],this.update),e.watchAll(["knots","degree","controlPoints","weights"],this.update)}.inherits(verb.NurbsSurface),verb.Extrusion.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_extruded_surface",[this.get("axis"),this.get("length"),this.get("profile").get("knots"),this.get("profile").get("degree"),this.get("profile").get("controlPoints"),this.get("profile").get("weights")])},verb.FourPointSurface=function(e,r,t,n){verb.NurbsSurface.call(this),this.setAll({p1:e,p2:r,p3:t,p4:n}),this.update(),this.watchAll(["p1","p2","p3","p4"],this.update)}.inherits(verb.NurbsSurface),verb.FourPointSurface.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_4pt_surface",[this.get("p1"),this.get("p2"),this.get("p3"),this.get("p4")])},verb.InterpCurve=function(e,r,t,n){verb.NurbsCurve.call(this);var i={pts:e?e.slice(0):[],degree:r?r:3};t&&n&&(i.startTangent=t,i.endTangent=n),this.setAll(i),this.update();var o=["pts","degree"];t&&n&&(o.push("startTangent"),o.push("endTangent")),this.watchAll(o,this.update)}.inherits(verb.NurbsCurve),verb.InterpCurve.prototype.nurbsRep=function(){return this.nurbsEngine.eval("rational_interp_curve",[this.get("pts"),this.get("degree"),this.get("startTangent"),this.get("endTangent")])},verb.Interval=function(e,r){verb.core.WatchObject.call(this),this.setAll({min:e,max:r})}.inherits(verb.core.WatchObject),verb.Interval2=function(e,r,t,n){verb.core.WatchObject.call(this),this.setAll({uinterval:new verb.Interval(e,r),vinterval:new verb.Interval(t,n)})}.inherits(verb.core.WatchObject),verb.Line=function(e,r){verb.NurbsCurve.call(this),this.setAll({start:e,end:r}),this.update(),this.watchAll(["start","end"],this.update)}.inherits(verb.NurbsCurve),verb.Line.prototype.nurbsRep=function(){return{knots:[0,0,1,1],control_points:[this.get("start"),this.get("end")],weights:[1,1],degree:1}},verb.PlanarSurface=function(e,r,t,n,i){verb.NurbsSurface.call(this),this.setAll({base:e,uaxis:r,vaxis:t,ulength:n,vlength:i}),this.update(),this.watchAll(["base","uaxis","vaxis","ulength","vlength"],this.update)}.inherits(verb.NurbsSurface),verb.PlanarSurface.prototype.nurbsRep=function(){var e=this.get("base"),r=numeric.mul(this.get("uaxis"),this.get("ulength")),t=numeric.mul(this.get("vaxis"),this.get("vlength")),n=numeric.add(e,r),i=numeric.add(e,t,r),o=numeric.add(e,t);return this.nurbsEngine.eval("get_4pt_surface",[e,n,i,o])},verb.PolyLine=function(e){verb.NurbsCurve.call(this),this.setAll({control_points:e?e.slice(0):[]}),this.update()}.inherits(verb.NurbsCurve),verb.PolyLine.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_polyline_curve",[this.get("control_points")])},verb.RevolvedSurface=function(e,r,t,n){verb.NurbsSurface.call(this),this.setAll({center:e,axis:r,angle:t,profile:n}),this.update(),this.watchAll(["center","axis","angle","profile"],this.update)}.inherits(verb.NurbsSurface),verb.RevolvedSurface.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_revolved_surface",[this.get("center"),this.get("axis"),this.get("angle"),this.get("profile").get("knots"),this.get("profile").get("degree"),this.get("profile").get("controlPoints"),this.get("profile").get("weights")])},verb.Sphere=function(e,r){verb.NurbsSurface.call(this),this.setAll({center:e,radius:r}),this.update(),this.watchAll(["center","radius"],this.update)}.inherits(verb.NurbsSurface),verb.Sphere.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_sphere_surface",[this.get("center"),[0,0,1],[1,0,0],this.get("radius")])},verb.SweepOneRail=function(e,r){verb.NurbsSurface.call(this),this.setAll({rail:e,profile:r}),this.update(),this.watchAll(["rail","profile"],this.update)}.inherits(verb.NurbsSurface),verb.SweepOneRail.prototype.nurbsRep=function(){return this.nurbsEngine.eval("get_sweep1_surface",[this.get("profile").get("knots"),this.get("profile").get("degree"),this.get("profile").get("controlPoints"),this.get("profile").get("weights"),this.get("rail").get("knots"),this.get("rail").get("degree"),this.get("rail").get("controlPoints"),this.get("rail").get("weights")])},verb.intersectCurves=function(e,r,t){return verb.nurbsEngine.eval("intersect_rational_curves_by_aabb_refine",[e.get("degree"),e.get("knots"),e.homogenize(),r.get("degree"),r.get("knots"),r.homogenize(),verb.TOLERANCE,verb.TOLERANCE],t)},verb.intersectCurveSurface=function(e,r,t,n){return t=t||{tolerance:verb.TOLERANCE,sampleTolerance:verb.TOLERANCE,uDivs:20,vDivs:20},verb.nurbsEngine.eval("intersect_rational_curve_surface_by_aabb_refine",[r.get("degreeU"),r.get("knotsU"),r.get("degreeV"),r.get("knotsV"),r.homogenize(),e.get("degree"),e.get("knots"),e.homogenize(),t.sampleTolerance,t.tolerance,t.uDivs,t.vDivs],n)},verb.eval.intersect_rational_curve_surface_by_aabb_refine=function(e,r,t,n,i,o,s,a,u,v,l,c){var h=verb.eval.intersect_rational_curve_surface_by_aabb(e,r,t,n,i,o,s,a,u,v,l,c);return h.map(function(u){var v=[u.p,u.uv[0],u.uv[1]],l=verb.eval.refine_rational_curve_surface_intersection(e,r,t,n,i,o,s,a,v);return u.p=l[0],u.uv[0]=l[1],u.uv[1]=l[2],u.distance=l[3],delete u.face,u})},verb.eval.refine_rational_curve_surface_intersection=function(e,r,t,n,i,o,s,a,u){var v=function(u){var v=verb.eval.rational_curve_point(o,s,a,u[0]),l=verb.eval.rational_surface_point(e,r,t,n,i,u[1],u[2]),c=numeric.sub(v,l);return numeric.dot(c,c)},l=numeric.uncmin(v,u);return l.solution.concat(l.f)},verb.eval.intersect_rational_curve_surface_by_aabb=function(e,r,t,n,i,o,s,a,u,v,l,c){var h=verb.eval.rational_curve_adaptive_sample(o,s,a,u,!0),b=verb.eval.tessellate_rational_surface_naive(e,r,t,n,i,l,c),_=h.map(function(e){return e[0]}),m=h.map(function(e){return e.slice(1)}),d=verb.eval.intersect_parametric_polyline_mesh_by_aabb(m,_,b,verb.range(b.faces.length),v);return verb.unique(d,function(e,r){return v>numeric.norm2(numeric.sub(e.point,r.point))&&v>Math.abs(e.p-r.p)&&v>numeric.norm2(numeric.sub(e.uv,r.uv))})},verb.eval.intersect_parametric_polyline_mesh_by_aabb=function(e,r,t,n,i){var o=new verb.BoundingBox(e),s=verb.eval.make_mesh_aabb(t.points,t.faces,n),a=verb.eval.intersect_parametric_polyline_mesh_by_aabb;if(!o.intersects(s,i))return[];if(2!==e.length||1!==n.length){if(1===n.length){var u=verb.left(e),v=verb.rightWithPivot(e),l=verb.left(r),c=verb.rightWithPivot(r);return a(u,l,t,n,i).concat(a(v,c,t,n,i))}if(2===e.length){var h=verb.eval.sort_tris_on_longest_axis(s,t.points,t.faces,n),b=verb.left(h),_=verb.right(h);return a(e,r,t,b,i).concat(a(e,r,t,_,i))}var h=verb.eval.sort_tris_on_longest_axis(s,t.points,t.faces,n),b=verb.left(h),_=verb.right(h),u=verb.left(e),v=verb.rightWithPivot(e),l=verb.left(r),c=verb.rightWithPivot(r);return a(u,l,t,b,i).concat(a(u,l,t,_,i)).concat(a(v,c,t,b,i)).concat(a(v,c,t,_,i))}var m=verb.eval.intersect_segment_with_tri(e[0],e[1],t.points,t.faces[n[0]]);if(null!=m){var d=m.p*(r[1]-r[0])+r[0],g=t.faces[n][0],f=t.faces[n][1],p=t.faces[n][2],y=t.uvs[g],k=t.uvs[f],x=t.uvs[p],N=numeric.sub(k,y),E=numeric.sub(x,y),w=numeric.add(y,numeric.mul(m.s,N),numeric.mul(m.t,E));return[{point:m.point,p:d,uv:w,face:n[0]}]}return[]},verb.eval.intersect_segment_with_tri=function(e,r,t,n){var i=t[n[0]],o=t[n[1]],s=t[n[2]],a=numeric.sub(o,i),u=numeric.sub(s,i),v=numeric.cross(a,u),l=numeric.sub(r,e),c=numeric.sub(e,i),h=-numeric.dot(v,c),b=numeric.dot(v,l);if(Math.abs(b)<verb.EPSILON)return null;var _=h/b;if(0>_||_>1)return null;var m=numeric.add(e,numeric.mul(_,l)),d=numeric.dot(a,u),g=numeric.dot(a,a),f=numeric.dot(u,u),p=numeric.sub(m,i),y=numeric.dot(p,a),k=numeric.dot(p,u),x=d*d-g*f,N=(d*k-f*y)/x,E=(d*y-g*k)/x;return N>1+verb.EPSILON||E>1+verb.EPSILON||-verb.EPSILON>E||-verb.EPSILON>N||N+E>1+verb.EPSILON?null:{point:m,s:N,t:E,p:_}},verb.eval.intersect_segment_with_plane=function(e,r,t,n){var i=numeric.dot(n,numeric.sub(e,r));if(EPSILON>abs(i))return null;var o=numeric.dot(n,numeric.sub(t,e));return{p:o/i}},verb.eval.intersect_aabb_trees=function(e,r,t,n,i,o){var s=i.bounding_box.intersects(o.bounding_box),a=verb.eval.intersect_aabb_trees;return s?0===i.children.length&&0===o.children.length?[[i.triangle,o.triangle]]:0===i.children.length&&0!=o.children.length?a(e,r,t,n,i,o.children[0]).concat(a(e,r,t,n,i,o.children[1])):0!=i.children.length&&0===o.children.length?a(e,r,t,n,i.children[0],o).concat(a(e,r,t,n,i.children[1],o)):0!=i.children.length&&0!=o.children.length?a(e,r,t,n,i.children[0],o.children[0]).concat(a(e,r,t,n,i.children[0],o.children[1])).concat(a(e,r,t,n,i.children[1],o.children[0])).concat(a(e,r,t,n,i.children[1],o.children[1])):void 0:[]},verb.eval.make_mesh_aabb_tree=function(e,r,t){var n={bounding_box:verb.eval.make_mesh_aabb(e,r,t),children:[]};if(1===t.length)return n.triangle=t[0],n;var i=verb.eval.sort_tris_on_longest_axis(n.bounding_box,e,r,t),o=i.slice(0,Math.floor(i.length/2)),s=i.slice(Math.floor(i.length/2),i.length);return n.children=[verb.eval.make_mesh_aabb_tree(e,r,o),verb.eval.make_mesh_aabb_tree(e,r,s)],n},verb.eval.make_mesh_aabb=function(e,r,t){var n=new verb.BoundingBox;return t.forEach(function(t){n.add(e[r[t][0]]),n.add(e[r[t][1]]),n.add(e[r[t][2]])}),n},verb.eval.sort_tris_on_longest_axis=function(e,r,t,n){for(var i=e.getLongestAxis(),o=[],s=n.length-1;s>=0;s--){var a=n[s],u=verb.eval.get_min_coordinate_on_axis(r,t[a],i);o.push([u,a])}o.sort(function(e,r){return e[0]>r[0]});for(var v=[],s=0,l=o.length;l>s;s++)v.push(o[s][1]);return v},verb.eval.get_min_coordinate_on_axis=function(e,r,t){for(var n=[],i=0;3>i;i++)n.push(e[r[i]][t]);return Math.min.apply(Math,n)},verb.eval.get_tri_centroid=function(e,r){for(var t=[0,0,0],n=0;3>n;n++)for(var i=0;3>i;i++)t[i]+=e[r[n]][i];for(var n=0;3>n;n++)t[n]/=3;return t},verb.eval.get_tri_norm=function(e,r){var t=e[r[0]],n=e[r[1]],i=e[r[2]],o=numeric.sub(n,t),s=numeric.sub(i,t),a=numeric.cross(o,s);return numeric.mul(1/numeric.norm2(a),a)},verb.eval.intersect_rational_curves_by_aabb_refine=function(e,r,t,n,i,o,s,a){var u=verb.eval.intersect_rational_curves_by_aabb(e,r,t,n,i,o,s,a);return u.map(function(s){return verb.eval.refine_rational_curve_intersection(e,r,t,n,i,o,s)})},verb.eval.refine_rational_curve_intersection=function(e,r,t,n,i,o,s){var a=function(s){var a=verb.eval.rational_curve_point(e,r,t,s[0]),u=verb.eval.rational_curve_point(n,i,o,s[1]),v=numeric.sub(a,u);return numeric.dot(v,v)},u=numeric.uncmin(a,s);return u.solution.concat(u.f)},verb.eval.intersect_rational_curves_by_aabb=function(e,r,t,n,i,o,s,a){var u=verb.eval.rational_curve_adaptive_sample(e,r,t,s,!0),v=verb.eval.rational_curve_adaptive_sample(n,i,o,s,!0),l=u.map(function(e){return e[0]}),c=v.map(function(e){return e[0]}),h=u.map(function(e){return e.slice(1)}),b=v.map(function(e){return e.slice(1)});return verb.eval.intersect_parametric_polylines_by_aabb(h,b,l,c,a)},verb.eval.intersect_parametric_polylines_by_aabb=function(e,r,t,n,i){var o=new verb.BoundingBox(e),s=new verb.BoundingBox(r);if(!o.intersects(s,i))return[];if(2!==e.length||2!==r.length){if(2===e.length){var a=Math.ceil(r.length/2),u=r.slice(0,a),v=r.slice(a-1),l=n.slice(0,a),c=n.slice(a-1);return verb.eval.intersect_parametric_polylines_by_aabb(e,u,t,l,i).concat(verb.eval.intersect_parametric_polylines_by_aabb(e,v,t,c,i))}if(2===r.length){var h=Math.ceil(e.length/2),b=e.slice(0,h),_=e.slice(h-1),m=t.slice(0,h),d=t.slice(h-1);return verb.eval.intersect_parametric_polylines_by_aabb(b,r,m,n,i).concat(verb.eval.intersect_parametric_polylines_by_aabb(_,r,d,n,i))}var h=Math.ceil(e.length/2),b=e.slice(0,h),_=e.slice(h-1),m=t.slice(0,h),d=t.slice(h-1),a=Math.ceil(r.length/2),u=r.slice(0,a),v=r.slice(a-1),l=n.slice(0,a),c=n.slice(a-1);return verb.eval.intersect_parametric_polylines_by_aabb(b,u,m,l,i).concat(verb.eval.intersect_parametric_polylines_by_aabb(b,v,m,c,i)).concat(verb.eval.intersect_parametric_polylines_by_aabb(_,u,d,l,i)).concat(verb.eval.intersect_parametric_polylines_by_aabb(_,v,d,c,i))}var g=verb.eval.intersect_segments(e[0],e[1],r[0],r[1],i);return null!=g?(g[0][0]=g[0][0]*(t[1]-t[0])+t[0],g[1][0]=g[1][0]*(n[1]-n[0])+n[0],[[g[0][0],g[1][0]]]):[]},verb.eval.intersect_segments=function(e,r,t,n,i){var o=numeric.sub(r,e),s=Math.sqrt(numeric.dot(o,o)),a=numeric.mul(1/s,o),u=numeric.sub(n,t),v=Math.sqrt(numeric.dot(u,u)),l=numeric.mul(1/v,u),c=verb.eval.intersect_rays(e,a,t,l);if(null!=c){var h=Math.min(Math.max(0,c[0]/s),1),b=Math.min(Math.max(0,c[1]/v),1),_=numeric.add(numeric.mul(h,o),e),m=numeric.add(numeric.mul(b,u),t),d=numeric.norm2Squared(numeric.sub(_,m));if(i*i>d)return[[h].concat(_),[b].concat(m)]}return null},verb.eval.closest_point_on_segment=function(e,r,t,n,i){var o=numeric.sub(t,r),s=numeric.norm2(o);
if(verb.EPSILON>s)return{u:n,pt:r};var a=r,u=numeric.mul(1/s,o),v=numeric.sub(e,a),l=numeric.dot(v,u);return 0>l?{u:n,pt:r}:l>s?{u:i,pt:t}:{u:n+(i-n)*l/s,pt:numeric.add(a,numeric.mul(l,u))}},verb.eval.closest_point_on_ray=function(e,r,t){var n=numeric.sub(e,r),i=numeric.dot(n,t),o=numeric.add(r,numeric.mul(i,t));return o},verb.eval.dist_to_ray=function(e,r,t){var n=verb.eval.closest_point_on_ray(e,r,t),i=numeric.sub(n,e);return numeric.norm2(i)},verb.eval.intersect_rays=function(e,r,t,n){var i=numeric.dot(r,n),o=numeric.dot(r,t),s=numeric.dot(r,e),a=numeric.dot(n,t),u=numeric.dot(n,e),v=numeric.dot(r,r),l=numeric.dot(n,n),c=v*l-i*i;if(Math.abs(c)<verb.EPSILON)return null;var h=i*(o-s)-v*(a-u),b=h/c,_=(o-s+b*i)/v;return[_,b]},verb.eval.intersect_3_planes=function(e,r,t,n,i,o){var s=numeric.cross(t,i),a=numeric.dot(e,s);if(Math.abs(a)<verb.EPSILON)return null;var u=numeric.add(numeric.mul(r,s),numeric.cross(e,numeric.sub(numeric.mul(o,t),numeric.mul(n,i))));return numeric.mul(1/a,u)},verb.eval.refine_rational_surface_intersect_point=function(e,r,t,n,i,o,s,a,u,v,l,c,h){var b,_,m,d,g,f,p,y,k,x,N,E,w,z=1,S=0,P=function(e,r){return verb.eval.rational_surface_derivs(t,n,i,o,s,1,e,r)},A=function(e,r){return verb.eval.rational_surface_derivs(a,u,v,l,c,1,e,r)};do{if(b=P(e[0],e[1]),_=b[0][0],d=b[1][0],g=b[0][1],m=numeric.normalized(numeric.cross(d,g)),f=numeric.dot(m,_),p=A(r[0],r[1]),y=p[0][0],x=p[1][0],N=p[0][1],k=numeric.normalized(numeric.cross(x,N)),E=numeric.dot(k,y),w=numeric.norm2(numeric.sub(_,y)),h>w)break;var M=numeric.normalized(numeric.cross(m,k)),C=numeric.dot(M,_),L=verb.eval.intersect_3_planes(m,f,k,E,M,C);if(null===L)throw Error("panic!");var I=numeric.sub(L,_),O=numeric.sub(L,y),R=numeric.cross(d,m),B=numeric.cross(g,m),T=numeric.cross(x,k),j=numeric.cross(N,k),U=numeric.dot(B,I)/numeric.dot(B,d),V=numeric.dot(R,I)/numeric.dot(R,g),q=numeric.dot(j,O)/numeric.dot(j,x),D=numeric.dot(T,O)/numeric.dot(T,N);e=numeric.add([U,V],e),r=numeric.add([q,D],r),S++}while(z>S);return{uv1:e,uv2:r,pt:_,d:w}},verb.eval.intersect_rational_surface_surface_by_aabb_refine=function(e,r,t,n,i,o,s,a,u,v,l){var c={degree_u:e,degree_v:t,knots_u:r,knots_v:n,homo_control_points:i},h=verb.eval.tessellate_rational_surface_adaptive(c.degree_u,c.knots_u,c.degree_v,c.knots_v,c.homo_control_points),b={degree_u:o,degree_v:a,knots_u:s,knots_v:u,homo_control_points:v},_=verb.eval.tessellate_rational_surface_adaptive(b.degree_u,b.knots_u,b.degree_v,b.knots_v,b.homo_control_points),m=verb.eval.intersect_meshes_by_aabb(h.points,h.faces,h.uvs,_.points,_.faces,_.uvs),d=m.map(function(c){return c.map(function(c){return verb.eval.refine_rational_surface_intersect_point(c.uvtri1,c.uvtri2,e,r,t,n,i,o,s,a,u,v,l)})});return d.map(function(e){return verb.eval.rational_interp_curve(e.map(function(e){return e.pt}),3)})},verb.eval.intersect_meshes_by_aabb=function(e,r,t,n,i,o){var s=verb.range(r.length),a=verb.range(i.length),u=verb.eval.make_mesh_aabb_tree(e,r,s),v=verb.eval.make_mesh_aabb_tree(n,i,a),l=verb.eval.intersect_aabb_trees(e,r,n,i,u,v),c=l.map(function(s){var a=verb.eval.intersect_tris(e,r[s[0]],t,n,i[s[1]],o);return a?(a[0].tri1id=s[0],a[1].tri1id=s[0],a[0].tri2id=s[1],a[1].tri2id=s[1],a):a}).filter(function(e){return e}).filter(function(e){var r=numeric.sub(e[0].pt,e[1].pt);return numeric.dot(r,r)>verb.EPSILON});return c=verb.unique(c,function(e,r){var t=numeric.sub(e[0].uvtri1,r[0].uvtri1),n=numeric.dot(t,t),i=numeric.sub(e[1].uvtri1,r[1].uvtri1),o=numeric.dot(i,i),s=numeric.sub(e[0].uvtri1,r[1].uvtri1),a=numeric.dot(s,s),u=numeric.sub(e[1].uvtri1,r[0].uvtri1),v=numeric.dot(u,u);return verb.EPSILON>n&&verb.EPSILON>o||verb.EPSILON>a&&verb.EPSILON>v}),0===c.length?[]:verb.eval.make_intersect_polylines(c)},verb.eval.make_intersect_polylines=function(e){e.forEach(function(e){e[1].opp=e[0],e[0].opp=e[1]});var r=verb.eval.kdtree_from_segs(e),t=e.flatten();t.forEach(function(t){if(!t.adj){var n=verb.eval.lookup_adj_segment(t,r,e.length);n&&!n.adj&&(t.adj=n,n.adj=t)}});var n=t.filter(function(e){return!e.adj});0===n.length&&(n=t);var i=[];return n.forEach(function(e){if(!e.v){for(var r=[],t=e;t;){if(t.v)throw Error("Segment end encountered twice!");if(t.v=!0,t.opp.v=!0,r.push(t),t=t.opp.adj,t===e)break}r.length>0&&(r.push(r[r.length-1].opp),i.push(r))}}),i},verb.eval.pt_dist=function(e,r){return Math.pow(e.x-r.x,2)+Math.pow(e.y-r.y,2)+Math.pow(e.z-r.z,2)},verb.eval.kdtree_from_segs=function(e){var r=[];return e.forEach(function(e){r.push({x:e[0].pt[0],y:e[0].pt[1],z:e[0].pt[2],ele:e[0]}),r.push({x:e[1].pt[0],y:e[1].pt[1],z:e[1].pt[2],ele:e[1]})}),new KdTree(r,verb.eval.pt_dist,["x","y","z"])},verb.eval.lookup_adj_segment=function(e,r,t){var n=t?Math.min(t,3):3,i=r.nearest({x:e.pt[0],y:e.pt[1],z:e.pt[2]},n).filter(function(r){return e!=r[0].ele&&r[1]<verb.EPSILON}).map(function(e){return e[0].ele});return 1===i.length?i[0]:null},verb.eval.intersect_tris=function(e,r,t,n,i,o){var s=verb.eval.get_tri_norm(e,r),a=verb.eval.get_tri_norm(n,i),u=e[r[0]],v=n[i[0]],l=verb.eval.intersect_planes(u,s,v,a);if(!l.intersects)return null;var c=verb.eval.clip_ray_in_coplanar_tri(l.origin,l.dir,e,r,t);if(null===c)return null;var h=verb.eval.clip_ray_in_coplanar_tri(l.origin,l.dir,n,i,o);if(null===h)return null;var b=verb.eval.merge_tri_clip_intervals(c,h,e,r,t,n,i,o);return null===b?null:[{uvtri1:b.uv1tri1,uvtri2:b.uv1tri2,pt:b.pt1},{uvtri1:b.uv2tri1,uvtri2:b.uv2tri2,pt:b.pt2}]},verb.eval.clip_ray_in_coplanar_tri=function(e,r,t,n,i){for(var o=[t[n[0]],t[n[1]],t[n[2]]],i=[i[n[0]],i[n[1]],i[n[2]]],s=[numeric.sub(i[1],i[0]),numeric.sub(i[2],i[1]),numeric.sub(i[0],i[2])],a=[numeric.sub(o[1],o[0]),numeric.sub(o[2],o[1]),numeric.sub(o[0],o[2])],u=a.map(numeric.normalized),v=a.map(numeric.norm2),l=null,c=null,h=0;3>h;h++){var b=o[h],_=u[h],m=verb.eval.intersect_rays(b,_,e,r);if(null!==m){var d=m[0],g=m[1];-verb.EPSILON>d||d>v[h]+verb.EPSILON||((null===l||l.u>g)&&(l={u:g,pt:verb.eval.point_on_ray(e,r,g),uv:numeric.add(i[h],numeric.mul(d/v[h],s[h]))}),(null===c||g>c.u)&&(c={u:g,pt:verb.eval.point_on_ray(e,r,g),uv:numeric.add(i[h],numeric.mul(d/v[h],s[h]))}))}}return null===c||null===l?null:{min:l,max:c}},verb.eval.point_on_ray=function(e,r,t){return numeric.add(e,numeric.mul(t,r))},verb.eval.merge_tri_clip_intervals=function(e,r,t,n,i,o,s,a){if(r.min.u>e.max.u+verb.EPSILON||e.min.u>r.max.u+verb.EPSILON)return null;e.min.tri=0,e.max.tri=0,r.min.tri=1,r.max.tri=1;var u=e.min.u>r.min.u?e.min:r.min,v=e.max.u<r.max.u?e.max:r.max,l={};return 0===u.tri?(l.uv1tri1=u.uv,l.uv1tri2=verb.eval.tri_uv_from_point(o,s,a,u.pt)):(l.uv1tri1=verb.eval.tri_uv_from_point(t,n,i,u.pt),l.uv1tri2=u.uv),l.pt1=u.pt,0===v.tri?(l.uv2tri1=v.uv,l.uv2tri2=verb.eval.tri_uv_from_point(o,s,a,v.pt)):(l.uv2tri1=verb.eval.tri_uv_from_point(t,n,i,v.pt),l.uv2tri2=v.uv),l.pt2=v.pt,l},verb.eval.intersect_planes=function(e,r,t,n){var i=numeric.cross(r,n);if(numeric.dot(i,i)<verb.EPSILON)return{intersects:!1};var o=0,s=Math.abs(i[0]),a=Math.abs(i[1]),u=Math.abs(i[2]);a>s&&(o=1,s=a),u>s&&(o=2,s=u);var v,l,c,h;0===o?(v=r[1],l=r[2],c=n[1],h=n[2]):1===o?(v=r[0],l=r[2],c=n[0],h=n[2]):(v=r[0],l=r[1],c=n[0],h=n[1]);var b,_=-numeric.dot(e,r),m=-numeric.dot(t,n),d=v*h-l*c,g=(l*m-_*h)/d,f=(_*c-v*m)/d;return b=0===o?[0,g,f]:1===o?[g,0,f]:[g,f,0],{intersects:!0,origin:b,dir:numeric.normalized(i)}},verb.eval.tri_uv_from_point=function(e,r,t,n){var i=e[r[0]],o=e[r[1]],s=e[r[2]],a=t[r[0]],u=t[r[1]],v=t[r[2]],l=numeric.sub(i,n),c=numeric.sub(o,n),h=numeric.sub(s,n),b=numeric.norm2(numeric.cross(numeric.sub(i,o),numeric.sub(i,s))),_=numeric.norm2(numeric.cross(c,h))/b,m=numeric.norm2(numeric.cross(h,l))/b,d=numeric.norm2(numeric.cross(l,c))/b;return numeric.add(numeric.mul(_,a),numeric.mul(m,u),numeric.mul(d,v))},verb.eval.tessellate_rational_surface_naive=function(e,r,t,n,i,o,s){1>o&&(o=1),1>s&&(s=1);for(var a=r[r.length-1]-r[0],u=n[n.length-1]-n[0],v=a/o,l=u/s,c=[],h=[],b=[],_=0;o+1>_;_++)for(var m=0;s+1>m;m++){var d=_*v,g=m*l;h.push([d,g]);var f=verb.eval.rational_surface_derivs(e,r,t,n,i,1,d,g),p=f[0][0];c.push(p);var y=numeric.normalized(numeric.cross(f[0][1],f[1][0]));b.push(y)}for(var k=[],_=0;o>_;_++)for(var m=0;s>m;m++){var x=_*(s+1)+m,N=(_+1)*(s+1)+m,E=N+1,w=x+1,z=[x,N,E],S=[x,E,w];k.push(z),k.push(S)}return{points:c,faces:k,uvs:h,normals:b}},verb.eval.rational_curve_regular_sample=function(e,r,t,n,i){return verb.eval.rational_curve_regular_sample_range(e,r,t,r[0],verb.last(r),n,i)},verb.eval.rational_curve_regular_sample_range=function(e,r,t,n,i,o,s){1>o&&(o=2);for(var a=[],u=(i-n)/(o-1),v=0,l=0;o>l;l++)v=n+u*l,s?a.push([v].concat(verb.eval.rational_curve_point(e,r,t,v))):a.push(verb.eval.rational_curve_point(e,r,t,v));return a},verb.eval.rational_curve_adaptive_sample=function(e,r,t,n,i){return 1===e?i?t.map(function(e,t){return[r[t+1]].concat(verb.eval.dehomogenize(e))}):t.map(verb.eval.dehomogenize):verb.eval.rational_curve_adaptive_sample_range(e,r,t,r[0],r[r.length-1],n,i)},verb.eval.rational_curve_adaptive_sample_range=function(e,r,t,n,i,o,s){var a=verb.eval.rational_curve_point(e,r,t,n),u=verb.eval.rational_curve_point(e,r,t,i),v=.5+.2*Math.random(),l=n+(i-n)*v,c=verb.eval.rational_curve_point(e,r,t,l),h=numeric.sub(a,u),b=numeric.sub(a,c);if(o>numeric.dot(h,h)&&numeric.dot(b,b)>o||!verb.eval.three_points_are_flat(a,c,u,o)){var _=n+.5*(i-n),m=verb.eval.rational_curve_adaptive_sample_range(e,r,t,n,_,o,s),d=verb.eval.rational_curve_adaptive_sample_range(e,r,t,_,i,o,s);return m.slice(0,-1).concat(d)}return s?[[n].concat(a),[i].concat(u)]:[a,u]},verb.eval.three_points_are_flat=function(e,r,t,n){var i=numeric.sub(r,e),o=numeric.sub(t,e),s=crossprod(i,o),a=numeric.dot(s,s);return n>a},verb.eval.divide_rational_surface_adaptive=function(e,r,t,n,i,o){var s,a,u,v,l={degree_u:e,knots_u:r,degree_v:t,knots_v:n,homo_control_points:i};o=o||{},o.minDivsU=o.minDivsU||1,o.minDivsV=o.minDivsV||1,o.refine=void 0!=o.refine?o.refine:!0;var c=o.minDivsU=Math.max(o.minDivsU,3*(i.length-1)),h=o.minDivsV=Math.max(o.minDivsV,3*(i.length-1)),b=verb.last(r),_=r[0],m=verb.last(n),d=n[0],g=(b-_)/c,f=(m-d)/h,p=[],y=[];for(s=0,u=h+1;u>s;s++){var k=[];for(a=0,v=c+1;v>a;a++){var x=_+g*a,N=d+f*s,E=verb.eval.rational_surface_derivs(e,r,t,n,i,1,x,N),w=numeric.normalized(numeric.cross(E[0][1],E[1][0]));k.push(new verb.SurfacePoint(E[0][0],w,[x,N],null,verb.isZero(w)))}y.push(k)}for(s=0;h>s;s++)for(a=0;c>a;a++){var z=[y[h-s-1][a],y[h-s-1][a+1],y[h-s][a+1],y[h-s][a]];p.push(new verb.eval.AdaptiveRefinementNode(l,z))}if(!o.refine)return p;for(s=0;h>s;s++)for(a=0;c>a;a++){var S=s*c+a,P=verb.north(S,s,a,c,h,p),A=verb.east(S,s,a,c,h,p),M=verb.south(S,s,a,c,h,p),C=verb.west(S,s,a,c,h,p);p[S].neighbors=[M,A,P,C],p[S].divide(o)}return p},verb.north=function(e,r,t,n,i,o){return 0===r?null:o[e-n]},verb.south=function(e,r,t,n,i,o){return r===i-1?null:o[e+n]},verb.east=function(e,r,t,n,i,o){return t===n-1?null:o[e+1]},verb.west=function(e,r,t,n,i,o){return 0===t?null:o[e-1]},verb.eval.triangulate_adaptive_refinement_node_tree=function(e){var r=verb.TriMesh.empty();return e.forEach(function(e){e.triangulate(r)}),r},verb.eval.tessellate_rational_surface_adaptive=function(e,r,t,n,i,o){var s=verb.eval.divide_rational_surface_adaptive(e,r,t,n,i,o);return verb.eval.triangulate_adaptive_refinement_node_tree(s)},verb.eval.dist_to_seg=function(e,r,t){var n=numeric.sub(t,e),i=numeric.norm2(n),o=numeric.sub(r,e);if(verb.TOLERANCE>i)return numeric.norm2(o);var s=numeric.mul(1/i,n),a=numeric.dot(o,s),u=numeric.add(e,numeric.mul(a,s));return numeric.norm2(numeric.sub(u,r))},verb.SurfacePoint=function(e,r,t,n,i){this.uv=t,this.point=e,this.normal=r,this.id=n,this.degen=i},verb.SurfacePoint.fromUv=function(e,r){return new verb.SurfacePoint(null,null,[e,r],null,null)},verb.TriMesh=function(e,r,t,n){this.faces=e,this.points=r,this.uvs=t,this.normals=n},verb.TriMesh.empty=function(){return new verb.TriMesh([],[],[],[])},verb.eval.AdaptiveRefinementNode=function(e,r,t,n){if(this.srf=e,this.parentNode=t,this.neighbors=n||[null,null,null,null],!r){var i=e?e.knots_u[0]:null,o=e?verb.last(e.knots_u):null,s=e?e.knots_v[0]:null,a=e?verb.last(e.knots_v):null;r=[verb.SurfacePoint.fromUv(i,s),verb.SurfacePoint.fromUv(o,s),verb.SurfacePoint.fromUv(o,a),verb.SurfacePoint.fromUv(i,a)]}this.corners=r},verb.eval.AdaptiveRefinementNode.prototype.isLeaf=function(){return void 0===this.children},verb.eval.AdaptiveRefinementNode.prototype.center=function(){return this.centerPoint||this.evalSrf(this.u05,this.v05)},verb.eval.AdaptiveRefinementNode.prototype.evalCorners=function(){this.u05=this.u05||(this.corners[0].uv[0]+this.corners[2].uv[0])/2,this.v05=this.v05||(this.corners[0].uv[1]+this.corners[2].uv[1])/2;for(var e=0;4>e;e++)if(!this.corners[e].point){var r=this.corners[e];this.evalSrf(r.uv[0],r.uv[1],r)}},verb.eval.AdaptiveRefinementNode.prototype.evalSrf=function(e,r,t){var n=verb.eval.rational_surface_derivs(this.srf.degree_u,this.srf.knots_u,this.srf.degree_v,this.srf.knots_v,this.srf.homo_control_points,1,e,r),i=n[0][0],o=numeric.cross(n[0][1],n[1][0]),s=verb.isZero(o);return s||(o=numeric.normalized(o)),t?(t.degen=s,t.point=i,t.normal=o,t):new verb.SurfacePoint(i,o,[e,r],null,s)},verb.eval.AdaptiveRefinementNode.prototype.getEdgeCorners=function(e){if(this.isLeaf())return[this.corners[e]];if(this.horizontal)switch(e){case 0:return this.children[0].getEdgeCorners(0);case 1:return this.children[0].getEdgeCorners(1).concat(this.children[1].getEdgeCorners(1));case 2:return this.children[1].getEdgeCorners(2);case 3:return this.children[1].getEdgeCorners(3).concat(this.children[0].getEdgeCorners(3))}switch(e){case 0:return this.children[0].getEdgeCorners(0).concat(this.children[1].getEdgeCorners(0));case 1:return this.children[1].getEdgeCorners(1);case 2:return this.children[1].getEdgeCorners(2).concat(this.children[0].getEdgeCorners(2));case 3:return this.children[0].getEdgeCorners(3)}},verb.eval.AdaptiveRefinementNode.prototype.getAllCorners=function(e){var r=[this.corners[e]];if(!this.neighbors[e])return r;var t=this.neighbors[e].getEdgeCorners((e+2)%4),n=e%2,i=verb.EPSILON,o=this,s=[function(e){return e.uv[0]>o.corners[0].uv[0]+i&&e.uv[0]<o.corners[2].uv[0]-i},function(e){return e.uv[1]>o.corners[0].uv[1]+i&&e.uv[1]<o.corners[2].uv[1]-i}];return r.concat(t.filter(s[n]).reverse())},verb.eval.AdaptiveRefinementNode.prototype.midpoint=function(e){if(this.midPoints||(this.midpoints=[null,null,null,null]),this.midpoints[e])return this.midpoints[e];switch(e){case 0:this.midpoints[0]=this.evalSrf(this.u05,this.corners[0].uv[1]);break;case 1:this.midpoints[1]=this.evalSrf(this.corners[1].uv[0],this.v05);break;case 2:this.midpoints[2]=this.evalSrf(this.u05,this.corners[2].uv[1]);break;case 3:this.midpoints[3]=this.evalSrf(this.corners[0].uv[0],this.v05)}return this.midpoints[e]},verb.eval.AdaptiveRefinementNode.prototype.hasBadNormals=function(){return this.corners[0].degen||this.corners[1].degen||this.corners[2].degen||this.corners[3].degen},verb.eval.AdaptiveRefinementNode.prototype.fixNormals=function(){for(var e=0,r=this.corners.length;r>e;e++)if(this.corners[e],this.corners[e].degen){var t=this.corners[(e+1)%r],n=this.corners[(e+3)%r];this.corners[e].normal=t.degen?n.normal:t.normal}},verb.eval.AdaptiveRefinementNode.prototype.shouldDivide=function(e,r){if(e.minDepth>r)return!0;if(r>=e.maxDepth)return!1;if(this.hasBadNormals())return this.fixNormals(),!1;if(this.splitVert=numeric.norm2Squared(numeric.sub(this.corners[0].normal,this.corners[1].normal))>e.normTol||numeric.norm2Squared(numeric.sub(this.corners[2].normal,this.corners[3].normal))>e.normTol,this.splitHoriz=numeric.norm2Squared(numeric.sub(this.corners[1].normal,this.corners[2].normal))>e.normTol||numeric.norm2Squared(numeric.sub(this.corners[3].normal,this.corners[0].normal))>e.normTol,this.splitVert||this.splitHoriz)return!0;var t=this.center();return numeric.norm2Squared(numeric.sub(t.normal,this.corners[0].normal))>e.normTol||numeric.norm2Squared(numeric.sub(t.normal,this.corners[1].normal))>e.normTol||numeric.norm2Squared(numeric.sub(t.normal,this.corners[2].normal))>e.normTol||numeric.norm2Squared(numeric.sub(t.normal,this.corners[3].normal))>e.normTol},verb.eval.AdaptiveRefinementNode.prototype.divide=function(e){e=e||{},e.normTol=e.normTol||.085,e.minDepth=void 0!=e.minDepth?e.minDepth:0,e.maxDepth=void 0!=e.maxDepth?e.maxDepth:10,this._divide(e,0,!0)},verb.eval.AdaptiveRefinementNode.prototype._divide=function(e,r,t){if(this.evalCorners(),this.shouldDivide(e,r)){if(r++,this.splitVert&&!this.splitHoriz?t=!1:!this.splitVert&&this.splitHoriz&&(t=!0),this.horizontal=t,this.horizontal){var n=[this.corners[0],this.corners[1],this.midpoint(1),this.midpoint(3)],i=[this.midpoint(3),this.midpoint(1),this.corners[2],this.corners[3]];this.children=[new verb.eval.AdaptiveRefinementNode(this.srf,n,this),new verb.eval.AdaptiveRefinementNode(this.srf,i,this)],this.children[0].neighbors=[this.neighbors[0],this.neighbors[1],this.children[1],this.neighbors[3]],this.children[1].neighbors=[this.children[0],this.neighbors[1],this.neighbors[2],this.neighbors[3]]}else{var o=[this.corners[0],this.midpoint(0),this.midpoint(2),this.corners[3]],s=[this.midpoint(0),this.corners[1],this.corners[2],this.midpoint(2)];this.children=[new verb.eval.AdaptiveRefinementNode(this.srf,o,this),new verb.eval.AdaptiveRefinementNode(this.srf,s,this)],this.children[0].neighbors=[this.neighbors[0],this.children[1],this.neighbors[2],this.neighbors[3]],this.children[1].neighbors=[this.neighbors[0],this.neighbors[1],this.neighbors[2],this.children[0]]}this.children.forEach(function(n){n._divide(e,r,!t)})}},verb.eval.AdaptiveRefinementNode.prototype.triangulate=function(e){return e=e||verb.TriMesh.empty(),this.isLeaf()?this.triangulateLeaf(e):(this.children.forEach(function(r){r&&r.triangulate(e)}),e)},verb.eval.AdaptiveRefinementNode.prototype.triangulateLeaf=function(e){var r,t,n,i,o=e.points.length,s=[],a=[],u=0;for(u=0;4>u;u++){var v=this.getAllCorners(u);for(2===v.length&&(i=u+1),n=0;v.length>n;n++)s.push(v[n])}for(u=0,t=s.length;t>u;u++)r=s[u],void 0==r.id?(e.uvs.push(r.uv),e.points.push(r.point),e.normals.push(r.normal),r.id=o,a.push(o),o++):a.push(r.id);if(4===s.length)return e.faces.push([a[0],a[3],a[1]]),e.faces.push([a[3],a[2],a[1]]),e;if(5===s.length){var l=a.length;return e.faces.push([a[i],a[(i+1)%l],a[(i+2)%l]]),e.faces.push([a[(i+4)%l],a[(i+3)%l],a[i]]),e.faces.push([a[i],a[(i+2)%l],a[(i+3)%l]]),e}var c=this.center();e.uvs.push(c.uv),e.points.push(c.point),e.normals.push(c.normal);var h=e.points.length-1;for(u=0,n=s.length-1;s.length>u;n=u++)e.faces.push([h,a[n],a[u]]);return e},verb.eval.rational_surface_closest_point=function(e,r,t,n,i,o){function s(o){var s=verb.eval.rational_surface_derivs(e,r,t,n,i,2,o[0],o[1]);return s}function a(e,r,t){var n=r[1][0],i=r[0][1],o=r[2][0],s=r[0][2],a=r[1][1],u=r[1][1],v=numeric.dot(n,t),l=numeric.dot(i,t),c=[-v,-l],h=numeric.dot(n,n)+numeric.dot(o,t),b=numeric.dot(n,i)+numeric.dot(a,t),_=numeric.dot(n,i)+numeric.dot(u,t),m=numeric.dot(i,i)+numeric.dot(s,t),d=[[h,b],[_,m]],g=numeric.solve(d,c);return numeric.add(g,e)}var u,v,l,c=5,h=0,b=1e-4,_=5e-4,m=r[0],d=verb.last(r),g=n[0],f=verb.last(n),p=i[0].reduce(function(e,r,t){return e&&numeric.norm2Squared(numeric.sub(r,verb.last(i)[t]))<verb.EPSILON}),y=numeric.transpose(i),k=y[0].reduce(function(e,r,t){return e&&numeric.norm2Squared(numeric.sub(r,verb.last(y)[t]))<verb.EPSILON}),x=verb.eval.tessellate_rational_surface_adaptive(e,r,t,n,i,{normTol:.05}),N=Number.MAX_VALUE;for(x.points.forEach(function(e,r){var t=numeric.norm2Squared(numeric.sub(o,e));N>t&&(N=t,l=x.uvs[r])});c>h;){u=s(l),v=numeric.sub(u[0][0],o);var E=numeric.norm2(v),w=numeric.norm2(numeric.dot(u[1][0],v)),z=numeric.norm2(u[1][0])*C,S=numeric.norm2(numeric.dot(u[0][1],v)),P=numeric.norm2(u[0][1])*C,A=w/z,M=S/P,C=b>E,L=_>A,I=_>M;if(C&&L&&I)return l;var O=a(l,u,v);m>O[0]?O=p?[d-(O[0]-m),O[1]]:[m+verb.EPSILON,O[1]]:O[0]>d&&(O=p?[m+(O[0]-d),O[1]]:[d-verb.EPSILON,O[1]]),g>O[1]?O=k?[O[0],f-(O[1]-g)]:[O[0],g+verb.EPSILON]:O[1]>f&&(O=k?[O[0],g+(O[0]-f)]:[O[0],f-verb.EPSILON]);var R=numeric.norm2(numeric.mul(O[0]-l[0],u[1][0])),B=numeric.norm2(numeric.mul(O[1]-l[1],u[0][1]));if(b>R+B)return l;l=O,h++}return l},verb.eval.rational_curve_closest_point=function(e,r,t,n){function i(n){return verb.eval.rational_curve_derivs(e,r,t,n,2)}function o(e,r,t){var n=numeric.dot(r[1],t),i=numeric.dot(r[2],t),o=numeric.dot(r[1],r[1]),s=i+o;return e-n/s}for(var s=.001,a=Number.MAX_VALUE,u=0,v=verb.eval.rational_curve_adaptive_sample(e,r,t,s,!0),l=0;v.length-1>l;l++){var c=v[l][0],h=v[l+1][0],b=v[l].slice(1),_=v[l+1].slice(1),m=verb.eval.closest_point_on_segment(n,b,_,c,h),d=numeric.norm2(numeric.sub(n,m.pt));a>d&&(a=d,u=m.u)}for(var g,f,p=5,l=0,y=1e-4,k=5e-4,x=r[0],N=verb.last(r),E=numeric.norm2Squared(numeric.sub(t[0],verb.last(t)))<verb.EPSILON,w=u;p>l;){g=i(w),f=numeric.sub(g[0],n);var z=numeric.norm2(f),S=numeric.dot(g[1],f),P=numeric.norm2(g[1])*z,A=S/P,M=y>z,C=k>Math.abs(A);if(M&&C)return w;var L=o(w,g,f);x>L?L=E?N-(L-x):x:L>N&&(L=E?x+(L-N):N);var I=numeric.norm2(numeric.mul(L-w,g[1]));if(y>I)return w;w=L,l++}return w},verb.eval.rational_curve_divide_curve_equally_by_arc_length=function(e,r,t,n){var i=verb.eval.rational_curve_arc_length(e,r,t),o=i/n;return verb.eval.rational_curve_divide_curve_by_arc_length(e,r,t,o)},verb.eval.rational_curve_divide_curve_by_arc_length=function(e,r,t,n){var i=verb.eval.curve_bezier_decompose(e,r,t),o=i.map(function(e){return verb.eval.rational_bezier_curve_arc_length(e.degree,e.knots,e.control_points)}),s=o.reduce(function(e,r){return e+r},0),a=[new CurvePoint(r[0],0)];if(n>s)return a;for(var u,v=n,l=0,c=v,h=0,b=0;i.length>l;){for(h+=o[l];h+verb.EPSILON>c;)u=verb.eval.rational_bezier_curve_param_at_arc_length(i[l].degree,i[l].knots,i[l].control_points,c-b,verb.TOLERANCE,o[l]),a.push(new CurvePoint(u,c)),c+=v;b+=o[l],l++}return a},verb.eval.rational_curve_param_at_arc_length=function(e,r,t,n,i,o,s){if(verb.EPSILON>n)return r[0];for(var a=o||verb.eval.curve_bezier_decompose(e,r,t),u=0,v=(a[u],-verb.EPSILON),s=s||[],u=0;n>v&&a.length>u;u++)if(s[u]=void 0!=s[u]?s[u]:verb.eval.rational_bezier_curve_arc_length(e,r,t),v+=s[u],v+verb.EPSILON>n)return verb.eval.rational_bezier_curve_param_at_arc_length(e,r,t,n,i,s[u]);return-1},verb.eval.rational_bezier_curve_param_at_arc_length=function(e,r,t,n,i,o){if(0>n)return r[0];var s=o||verb.eval.rational_bezier_curve_arc_length(e,r,t);if(n>s)return verb.last(r);for(var a={p:r[0],l:0},u={p:verb.last(r),l:s},v={p:0,l:0},i=i||2*verb.TOLERANCE;u.l-a.l>i;)v.p=(a.p+u.p)/2,v.l=verb.eval.rational_bezier_curve_arc_length(e,r,t,v.p),v.l>n?(u.p=v.p,u.l=v.l):(a.p=v.p,a.l=v.l);return(a.p+u.p)/2},verb.eval.rational_curve_arc_length=function(e,r,t,n){void 0===n&&(n=verb.last(r));for(var i=verb.eval.curve_bezier_decompose(e,r,t),o=0,s=i[o],a=0;s&&n>s.knots[0]+verb.EPSILON;)a+=verb.eval.rational_bezier_curve_arc_length(s.degree,s.knots,s.control_points,Math.min(verb.last(s.knots),n)),s=i[++o];return a},verb.eval.rational_bezier_curve_arc_length=function(e,r,t,n,i){for(var o,s,n=void 0===n?verb.last(r):n,a=(n-r[0])/2,u=0,v=e+(void 0!=i?i:16),l=0;v>l;l++)o=a*verb.eval.Tvalues[v][l]+a+r[0],s=verb.eval.rational_curve_derivs(e,r,t,o,1),u+=verb.eval.Cvalues[v][l]*numeric.norm2(s[1]);return a*u},verb.eval.Tvalues=[[],[],[-.5773502691896257,.5773502691896257],[0,-.7745966692414834,.7745966692414834],[-.33998104358485626,.33998104358485626,-.8611363115940526,.8611363115940526],[0,-.5384693101056831,.5384693101056831,-.906179845938664,.906179845938664],[.6612093864662645,-.6612093864662645,-.2386191860831969,.2386191860831969,-.932469514203152,.932469514203152],[0,.4058451513773972,-.4058451513773972,-.7415311855993945,.7415311855993945,-.9491079123427585,.9491079123427585],[-.1834346424956498,.1834346424956498,-.525532409916329,.525532409916329,-.7966664774136267,.7966664774136267,-.9602898564975363,.9602898564975363],[0,-.8360311073266358,.8360311073266358,-.9681602395076261,.9681602395076261,-.3242534234038089,.3242534234038089,-.6133714327005904,.6133714327005904],[-.14887433898163122,.14887433898163122,-.4333953941292472,.4333953941292472,-.6794095682990244,.6794095682990244,-.8650633666889845,.8650633666889845,-.9739065285171717,.9739065285171717],[0,-.26954315595234496,.26954315595234496,-.5190961292068118,.5190961292068118,-.7301520055740494,.7301520055740494,-.8870625997680953,.8870625997680953,-.978228658146057,.978228658146057],[-.1252334085114689,.1252334085114689,-.3678314989981802,.3678314989981802,-.5873179542866175,.5873179542866175,-.7699026741943047,.7699026741943047,-.9041172563704749,.9041172563704749,-.9815606342467192,.9815606342467192],[0,-.2304583159551348,.2304583159551348,-.44849275103644687,.44849275103644687,-.6423493394403402,.6423493394403402,-.8015780907333099,.8015780907333099,-.9175983992229779,.9175983992229779,-.9841830547185881,.9841830547185881],[-.10805494870734367,.10805494870734367,-.31911236892788974,.31911236892788974,-.5152486363581541,.5152486363581541,-.6872929048116855,.6872929048116855,-.827201315069765,.827201315069765,-.9284348836635735,.9284348836635735,-.9862838086968123,.9862838086968123],[0,-.20119409399743451,.20119409399743451,-.3941513470775634,.3941513470775634,-.5709721726085388,.5709721726085388,-.7244177313601701,.7244177313601701,-.8482065834104272,.8482065834104272,-.937273392400706,.937273392400706,-.9879925180204854,.9879925180204854],[-.09501250983763744,.09501250983763744,-.2816035507792589,.2816035507792589,-.45801677765722737,.45801677765722737,-.6178762444026438,.6178762444026438,-.755404408355003,.755404408355003,-.8656312023878318,.8656312023878318,-.9445750230732326,.9445750230732326,-.9894009349916499,.9894009349916499],[0,-.17848418149584785,.17848418149584785,-.3512317634538763,.3512317634538763,-.5126905370864769,.5126905370864769,-.6576711592166907,.6576711592166907,-.7815140038968014,.7815140038968014,-.8802391537269859,.8802391537269859,-.9506755217687678,.9506755217687678,-.9905754753144174,.9905754753144174],[-.0847750130417353,.0847750130417353,-.2518862256915055,.2518862256915055,-.41175116146284263,.41175116146284263,-.5597708310739475,.5597708310739475,-.6916870430603532,.6916870430603532,-.8037049589725231,.8037049589725231,-.8926024664975557,.8926024664975557,-.9558239495713977,.9558239495713977,-.9915651684209309,.9915651684209309],[0,-.16035864564022537,.16035864564022537,-.31656409996362983,.31656409996362983,-.46457074137596094,.46457074137596094,-.600545304661681,.600545304661681,-.7209661773352294,.7209661773352294,-.8227146565371428,.8227146565371428,-.9031559036148179,.9031559036148179,-.96020815213483,.96020815213483,-.9924068438435844,.9924068438435844],[-.07652652113349734,.07652652113349734,-.22778585114164507,.22778585114164507,-.37370608871541955,.37370608871541955,-.5108670019508271,.5108670019508271,-.636053680726515,.636053680726515,-.7463319064601508,.7463319064601508,-.8391169718222188,.8391169718222188,-.912234428251326,.912234428251326,-.9639719272779138,.9639719272779138,-.9931285991850949,.9931285991850949],[0,-.1455618541608951,.1455618541608951,-.2880213168024011,.2880213168024011,-.4243421202074388,.4243421202074388,-.5516188358872198,.5516188358872198,-.6671388041974123,.6671388041974123,-.7684399634756779,.7684399634756779,-.8533633645833173,.8533633645833173,-.9200993341504008,.9200993341504008,-.9672268385663063,.9672268385663063,-.9937521706203895,.9937521706203895],[-.06973927331972223,.06973927331972223,-.20786042668822127,.20786042668822127,-.34193582089208424,.34193582089208424,-.469355837986757,.469355837986757,-.5876404035069116,.5876404035069116,-.6944872631866827,.6944872631866827,-.7878168059792081,.7878168059792081,-.8658125777203002,.8658125777203002,-.926956772187174,.926956772187174,-.9700604978354287,.9700604978354287,-.9942945854823992,.9942945854823992],[0,-.1332568242984661,.1332568242984661,-.26413568097034495,.26413568097034495,-.3903010380302908,.3903010380302908,-.5095014778460075,.5095014778460075,-.6196098757636461,.6196098757636461,-.7186613631319502,.7186613631319502,-.8048884016188399,.8048884016188399,-.8767523582704416,.8767523582704416,-.9329710868260161,.9329710868260161,-.9725424712181152,.9725424712181152,-.9947693349975522,.9947693349975522],[-.06405689286260563,.06405689286260563,-.1911188674736163,.1911188674736163,-.3150426796961634,.3150426796961634,-.4337935076260451,.4337935076260451,-.5454214713888396,.5454214713888396,-.6480936519369755,.6480936519369755,-.7401241915785544,.7401241915785544,-.820001985973903,.820001985973903,-.8864155270044011,.8864155270044011,-.9382745520027328,.9382745520027328,-.9747285559713095,.9747285559713095,-.9951872199970213,.9951872199970213]],verb.eval.Cvalues=[[],[],[1,1],[.8888888888888888,.5555555555555556,.5555555555555556],[.6521451548625461,.6521451548625461,.34785484513745385,.34785484513745385],[.5688888888888889,.47862867049936647,.47862867049936647,.23692688505618908,.23692688505618908],[.3607615730481386,.3607615730481386,.46791393457269104,.46791393457269104,.17132449237917036,.17132449237917036],[.4179591836734694,.3818300505051189,.3818300505051189,.27970539148927664,.27970539148927664,.1294849661688697,.1294849661688697],[.362683783378362,.362683783378362,.31370664587788727,.31370664587788727,.22238103445337448,.22238103445337448,.10122853629037626,.10122853629037626],[.3302393550012598,.1806481606948574,.1806481606948574,.08127438836157441,.08127438836157441,.31234707704000286,.31234707704000286,.26061069640293544,.26061069640293544],[.29552422471475287,.29552422471475287,.26926671930999635,.26926671930999635,.21908636251598204,.21908636251598204,.1494513491505806,.1494513491505806,.06667134430868814,.06667134430868814],[.2729250867779006,.26280454451024665,.26280454451024665,.23319376459199048,.23319376459199048,.18629021092773426,.18629021092773426,.1255803694649046,.1255803694649046,.05566856711617366,.05566856711617366],[.24914704581340277,.24914704581340277,.2334925365383548,.2334925365383548,.20316742672306592,.20316742672306592,.16007832854334622,.16007832854334622,.10693932599531843,.10693932599531843,.04717533638651183,.04717533638651183],[.2325515532308739,.22628318026289723,.22628318026289723,.2078160475368885,.2078160475368885,.17814598076194574,.17814598076194574,.13887351021978725,.13887351021978725,.09212149983772845,.09212149983772845,.04048400476531588,.04048400476531588],[.2152638534631578,.2152638534631578,.2051984637212956,.2051984637212956,.18553839747793782,.18553839747793782,.15720316715819355,.15720316715819355,.12151857068790319,.12151857068790319,.08015808715976021,.08015808715976021,.03511946033175186,.03511946033175186],[.2025782419255613,.19843148532711158,.19843148532711158,.1861610000155622,.1861610000155622,.16626920581699392,.16626920581699392,.13957067792615432,.13957067792615432,.10715922046717194,.10715922046717194,.07036604748810812,.07036604748810812,.03075324199611727,.03075324199611727],[.1894506104550685,.1894506104550685,.18260341504492358,.18260341504492358,.16915651939500254,.16915651939500254,.14959598881657674,.14959598881657674,.12462897125553388,.12462897125553388,.09515851168249279,.09515851168249279,.062253523938647894,.062253523938647894,.027152459411754096,.027152459411754096],[.17944647035620653,.17656270536699264,.17656270536699264,.16800410215645004,.16800410215645004,.15404576107681028,.15404576107681028,.13513636846852548,.13513636846852548,.11188384719340397,.11188384719340397,.08503614831717918,.08503614831717918,.0554595293739872,.0554595293739872,.02414830286854793,.02414830286854793],[.1691423829631436,.1691423829631436,.16427648374583273,.16427648374583273,.15468467512626524,.15468467512626524,.14064291467065065,.14064291467065065,.12255520671147846,.12255520671147846,.10094204410628717,.10094204410628717,.07642573025488905,.07642573025488905,.0497145488949698,.0497145488949698,.02161601352648331,.02161601352648331],[.1610544498487837,.15896884339395434,.15896884339395434,.15276604206585967,.15276604206585967,.1426067021736066,.1426067021736066,.12875396253933621,.12875396253933621,.11156664554733399,.11156664554733399,.09149002162245,.09149002162245,.06904454273764123,.06904454273764123,.0448142267656996,.0448142267656996,.019461788229726478,.019461788229726478],[.15275338713072584,.15275338713072584,.14917298647260374,.14917298647260374,.14209610931838204,.14209610931838204,.13168863844917664,.13168863844917664,.11819453196151841,.11819453196151841,.10193011981724044,.10193011981724044,.08327674157670475,.08327674157670475,.06267204833410907,.06267204833410907,.04060142980038694,.04060142980038694,.017614007139152118,.017614007139152118],[.14608113364969041,.14452440398997005,.14452440398997005,.13988739479107315,.13988739479107315,.13226893863333747,.13226893863333747,.12183141605372853,.12183141605372853,.10879729916714838,.10879729916714838,.09344442345603386,.09344442345603386,.0761001136283793,.0761001136283793,.057134425426857205,.057134425426857205,.036953789770852494,.036953789770852494,.016017228257774335,.016017228257774335],[.13925187285563198,.13925187285563198,.13654149834601517,.13654149834601517,.13117350478706238,.13117350478706238,.12325237681051242,.12325237681051242,.11293229608053922,.11293229608053922,.10041414444288096,.10041414444288096,.08594160621706773,.08594160621706773,.06979646842452049,.06979646842452049,.052293335152683286,.052293335152683286,.03377490158481415,.03377490158481415,.0146279952982722,.0146279952982722],[.13365457218610619,.1324620394046966,.1324620394046966,.12890572218808216,.12890572218808216,.12304908430672953,.12304908430672953,.11499664022241136,.11499664022241136,.10489209146454141,.10489209146454141,.09291576606003515,.09291576606003515,.07928141177671895,.07928141177671895,.06423242140852585,.06423242140852585,.04803767173108467,.04803767173108467,.030988005856979445,.030988005856979445,.013411859487141771,.013411859487141771],[.12793819534675216,.12793819534675216,.1258374563468283,.1258374563468283,.12167047292780339,.12167047292780339,.1155056680537256,.1155056680537256,.10744427011596563,.10744427011596563,.09761865210411388,.09761865210411388,.08619016153195327,.08619016153195327,.0733464814110803,.0733464814110803,.05929858491543678,.05929858491543678,.04427743881741981,.04427743881741981,.028531388628933663,.028531388628933663,.0123412297999872,.0123412297999872]],verb.eval.rational_interp_curve=function(e,r,t,n){if(r=r||3,r+1>e.length)throw Error("You need to supply at least degree + 1 points!");
for(var i=[0],o=1;e.length>o;o++){var s=numeric.norm2(numeric.sub(e[o],e[o-1])),a=i[i.length-1];i.push(a+s)}for(var u=i[i.length-1],o=0;i.length>o;o++)i[o]=i[o]/u;for(var v=numeric.rep([r+1],0),l=void 0!=t&&void 0!=n,c=l?0:1,h=l?i.length-r+1:i.length-r,o=c,b=h;b>o;o++){for(var _=0,m=0;r>m;m++)_+=i[o+m];v.push(1/r*_)}for(var d=v.concat(numeric.rep([r+1],1)),g=[],f=l?e.length+1:e.length-1,p=l?e.length-(r-1):e.length-(r+1),o=0;i.length>o;o++){var y=i[o],k=verb.eval.knot_span_given_n(f,r,y,d),x=verb.eval.basis_functions_given_knot_span_index(k,y,r,d),N=k-r,E=verb.eval.zeros_1d(N),w=verb.eval.zeros_1d(p-N);g.push(E.concat(x).concat(w))}if(l){var z=g[0].length-2,S=[-1,1].concat(verb.eval.zeros_1d(z)),P=verb.eval.zeros_1d(z).concat([-1,1]);g.splice(1,0,S),g.splice(g.length-1,0,P)}for(var A=e[0].length,M=[],C=(1-d[d.length-r-2])/r,L=d[r+1]/r,o=0;A>o;o++){if(l){var I=[e[0][o]];I.push(L*t[o]);for(var m=1;e.length-1>m;m++)I.push(e[m][o]);I.push(C*n[o]),I.push(verb.last(e)[o])}else var I=e.map(function(e){return e[o]});var O=numeric.solve(g,I);M.push(O)}var R=numeric.transpose(M),B=numeric.rep([R.length],1);return{control_points:R,knots:d,degree:r,weights:B}},verb.eval.get_sweep1_surface=function(e,r,t,n,i,o,s,a){for(var u=verb.eval.homogenize_1d(s,a),v=verb.eval.rational_curve_point(o,i,u,0),l=1/s.length,c=[],h=[],b=0;s.length>b;b++){for(var _=verb.eval.rational_curve_point(o,i,u,b*l),m=numeric.sub(_,v),d=[],g=[],f=0;t.length>f;f++)d.push(numeric.add(m,t[f])),g.push(n[f]*a[b]);c.push(d),h.push(g)}return{knots_u:i,knots_v:e,control_points:c,degree_u:o,degree_v:r,weights:h}},verb.eval.get_ellipse_arc=function(e,r,t,n,i,o,s){o>s&&(s=2*Math.PI+o);var a=s-o,u=0;u=Math.PI/2>=a?1:Math.PI>=a?2:3*Math.PI/2>=a?3:4;var v=a/u,l=Math.cos(v/2),c=numeric.add(e,numeric.mul(n,Math.cos(o),r),numeric.mul(i,Math.sin(o),t)),h=numeric.sub(numeric.mul(Math.cos(o),t),numeric.mul(Math.sin(o),r)),b=verb.eval.zeros_1d(2*u),_=verb.eval.zeros_1d(2*u+3),m=0,d=o,g=verb.eval.zeros_1d(2*u);b[0]=c,g[0]=1;for(var f=1;u>=f;f++){d+=v;var p=numeric.add(e,numeric.mul(n,Math.cos(d),r),numeric.mul(i,Math.sin(d),t));g[m+2]=1,b[m+2]=p;var y=numeric.sub(numeric.mul(Math.cos(d),t),numeric.mul(Math.sin(d),r)),k=verb.eval.intersect_rays(c,numeric.mul(1/numeric.norm2(h),h),p,numeric.mul(1/numeric.norm2(y),y)),x=numeric.add(c,numeric.mul(h,k[0]));g[m+1]=l,b[m+1]=x,m+=2,u>f&&(c=p,h=y)}for(var N=2*u+1,f=0;3>f;f++)_[f]=0,_[f+N]=1;switch(u){case 1:break;case 2:_[3]=_[4]=.5;break;case 3:_[3]=_[4]=1/3,_[5]=_[6]=2/3;break;case 4:_[3]=_[4]=.25,_[5]=_[6]=.5,_[7]=_[8]=.75}return{knots:_,control_points:b,degree:2,weights:g}},verb.eval.get_sphere_surface=function(e,r,t,n){var i=verb.eval.get_arc(e,numeric.mul(r,-1),t,n,0,Math.PI);return verb.eval.get_revolved_surface(e,r,2*Math.PI,i.knots,i.degree,i.control_points,i.weights)},verb.eval.get_polyline_curve=function(e){for(var r=e.length-1,t=1/r,n=[0,0],i=1;r>i;i++)n.push(i*t);n.push(1),n.push(1);for(var o=[],i=0;e.length>i;i++)o.push(1);return{knots:n,control_points:e.slice(0),degree:1,weights:o}},verb.eval.get_4pt_surface=function(e,r,t,n){var i=numeric.mul(.5,numeric.add(e,n)),o=numeric.mul(.5,numeric.add(r,t)),s=numeric.mul(.5,numeric.add(t,n)),a=numeric.mul(.5,numeric.add(e,r)),u=numeric.mul(.5,numeric.add(i,o));return{knots_u:[0,0,0,1,1,1],knots_v:[0,0,0,1,1,1],control_points:[[e,i,n],[a,u,s],[r,o,t]],degree_u:2,degree_v:2,weights:[[1,1,1],[1,1,1],[1,1,1]]}},verb.eval.get_cylinder_surface=function(e,r,t,n,i){var o=crossprod(e,r),s=(2*Math.PI,verb.eval.get_arc(t,r,o,i,0,2*Math.PI));return verb.eval.get_extruded_surface(e,n,s.knots,s.degree,s.control_points,s.weights)},verb.eval.get_cone_surface=function(e,r,t,n,i){var o=2*Math.PI,s=1,a=[numeric.add(t,numeric.mul(n,e)),numeric.add(t,numeric.mul(i,r))],u=[0,0,1,1],v=[1,1];return verb.eval.get_revolved_surface(t,e,o,u,s,a,v)},verb.eval.get_extruded_surface=function(e,r,t,n,i,o){for(var s=verb.eval.zeros_2d(3,i.length),a=verb.eval.zeros_2d(3,i.length),u=numeric.mul(e,r),v=numeric.mul(e,.5*r),l=0;i.length>l;l++)s[2][l]=i[l],s[1][l]=numeric.add(v,i[l]),s[0][l]=numeric.add(u,i[l]),a[0][l]=o[l],a[1][l]=o[l],a[2][l]=o[l];return{knots_u:[0,0,0,1,1,1],knots_v:t,control_points:s,degree_u:2,degree_v:n,weights:a}},verb.eval.get_revolved_surface=function(e,r,t,n,i,o,s){var a,u,v,l;Math.PI/2>=t?(a=1,u=verb.eval.zeros_1d(6+2*(a-1))):Math.PI>=t?(a=2,u=verb.eval.zeros_1d(6+2*(a-1)),u[3]=u[4]=.5):3*Math.PI/2>=t?(a=3,u=verb.eval.zeros_1d(6+2*(a-1)),u[3]=u[4]=1/3,u[5]=u[6]=2/3):(a=4,u=verb.eval.zeros_1d(6+2*(a-1)),u[3]=u[4]=.25,u[5]=u[6]=.5,u[7]=u[8]=.75);for(var c=t/a,h=3+2*(a-1),b=0;3>b;h++,b++)u[b]=0,u[h]=1;for(var _=Math.cos(c/2),m=0,d=verb.eval.zeros_1d(a+1),g=verb.eval.zeros_1d(a+1),v=verb.eval.zeros_2d(2*a+1,o.length),l=verb.eval.zeros_2d(2*a+1,o.length),b=1;a>=b;b++)m+=c,g[b]=Math.cos(m),d[b]=Math.sin(m);for(h=0;o.length>h;h++){var f=verb.eval.closest_point_on_ray(o[h],e,r),p=numeric.sub(o[h],f),y=numeric.norm2(p),k=crossprod(r,p);y>verb.EPSILON&&(p=numeric.mul(1/y,p),k=numeric.mul(1/y,k)),v[0][h]=o[h];var x=o[h];l[0][h]=s[h];for(var N=k,E=0,m=0,b=1;a>=b;b++){var w=0==y?f:numeric.add(f,numeric.mul(y,g[b],p),numeric.mul(y,d[b],k));v[E+2][h]=w,l[E+2][h]=s[h];var z=numeric.sub(numeric.mul(g[b],k),numeric.mul(d[b],p));if(0==y)v[E+1][h]=f;else{var S=verb.eval.intersect_rays(x,numeric.mul(1/numeric.norm2(N),N),w,numeric.mul(1/numeric.norm2(z),z)),P=numeric.add(x,numeric.mul(N,S[0]));v[E+1][h]=P}l[E+1][h]=_*s[h],E+=2,a>b&&(x=w,N=z)}}return{knots_u:u,knots_v:n,control_points:v,degree_u:2,degree_v:i,weights:l}},verb.eval.get_arc=function(e,r,t,n,i,o){return verb.eval.get_ellipse_arc(e,r,t,n,n,i,o)},verb.eval.surface_split=function(e,r,t,n,i,o,s){var a,u,v;0===s?(i=numeric.transpose(i),a=r,u=e):(i=i,a=n,u=t);var l=[];for(v=0;u+1>v;v++)l.push(o);var c,h=[],b=[],_=verb.eval.knot_span(u,o,a);for(v=0;i.length>v;v++){c=verb.eval.curve_knot_refine(u,a,i[v],l);var m=c.control_points.slice(0,_+1),d=c.control_points.slice(_+1);h.push(m),b.push(d)}var g=c.knots.slice(0,_+u+2),f=c.knots.slice(_+1);return 0===s?(h=numeric.transpose(h),b=numeric.transpose(b),[{degree_u:u,knots_u:g,degree_v:t,knots_v:n,control_points:h},{degree_u:u,knots_u:f,degree_v:t,knots_v:n,control_points:b}]):[{degree_u:e,knots_u:r,degree_v:u,knots_v:g,control_points:h},{degree_u:e,knots_u:r,degree_v:u,knots_v:f,control_points:b}]},verb.eval.surface_knot_refine=function(e,r,t,n,i,o,s){var a,u,v,l,c,h=[];0===s?(l=numeric.transpose(i),u=r,v=e):(l=i,u=n,v=t);for(var b=0;l.length>b;b++)a=verb.eval.curve_knot_refine(v,u,l[b],o),h.push(a.control_points);return c=a.knots,0===s?(h=numeric.transpose(h),{knots_u:c,degree_u:v,knots_v:n,degree_v:t,control_points:h}):{knots_u:r,degree_u:e,knots_v:c,degree_v:v,control_points:h}},verb.eval.curve_bezier_decompose=function(e,r,t){for(var n=verb.eval.knot_multiplicities(r),i=e+1,o=verb.eval.curve_knot_refine,s=0;n.length>s;s++)if(i>n[s][1]){var a=numeric.rep([i-n[s][1]],n[s][0]),u=o(e,r,t,a);r=u.knots,t=u.control_points}r.length/i-1;for(var v=2*i,l=[],s=0;t.length>s;s+=i){var c=r.slice(s,s+v),h=t.slice(s,s+i);l.push({degree:e,knots:c,control_points:h})}return l},verb.eval.knot_multiplicities=function(e){for(var r=[[e[0],0]],t=r[0],n=0;e.length>n;n++)Math.abs(e[n]-t[0])>verb.EPSILON&&(t=[e[n],0],r.push(t)),t[1]++;return r},verb.eval.curve_split=function(e,r,t,n){for(var i=[],o=0;e+1>o;o++)i.push(n);var s=verb.eval.curve_knot_refine(e,r,t,i),a=verb.eval.knot_span(e,n,r),u=s.knots.slice(0,a+e+2),v=s.knots.slice(a+1),l=s.control_points.slice(0,a+1),c=s.control_points.slice(a+1);return[{degree:e,knots:u,control_points:l},{degree:e,knots:v,control_points:c}]},verb.eval.curve_knot_refine=function(e,r,t,n){var i=t.length-1,o=i+e+1,s=n.length-1,a=verb.eval.knot_span(e,n[0],r),u=verb.eval.knot_span(e,n[s],r),v=Array(t.length+s+1),l=Array(r.length+s+1),c=0,h=0;for(c=0;a-e>=c;c++)v[c]=t[c];for(c=u-1;i>=c;c++)v[c+s+1]=t[c];for(c=0;a>=c;c++)l[c]=r[c];for(c=u+e;o>=c;c++)l[c+s+1]=r[c];c=u+e-1;var b=u+e+s;for(h=s;h>=0;h--){for(;n[h]<=r[c]&&c>a;)v[b-e-1]=t[c-e-1],l[b]=r[c],b-=1,c-=1;v[b-e-1]=v[b-e];for(var _=1;e>=_;_++){var m=b-e+_,d=l[b+_]-n[h];Math.abs(d)<verb.EPSILON?v[m-1]=v[m]:(d/=l[b+_]-r[c-e+_],v[m-1]=numeric.add(numeric.mul(d,v[m-1]),numeric.mul(1-d,v[m])))}l[b]=n[h],b-=1}return{knots:l,control_points:v}},verb.eval.curve_knot_insert=function(e,r,t,n,i){var o=0,s=t.length,a=verb.eval.knot_span(e,n,r),u=s+i,v=Array(e-o),l=Array(r.length+i),c=Array(u),h=0;for(h=0;a>=h;h++)l[h]=r[h];for(h=1;i>=h;h++)l[a+h]=n;for(h=a+1;r.length>h;h++)l[h+i]=r[h];for(h=0;a-e>=h;h++)c[h]=t[h];for(h=a-o;s>h;h++)c[h+i]=t[h];for(h=0;e-o>=h;h++)v[h]=t[a-e+h];for(var b=0,_=0,m=1;i>=m;m++){for(b=a-e+m,h=0;e-m-o>=h;h++)_=(n-r[b+h])/(r[h+a+1]-r[b+h]),v[h]=numeric.add(numeric.mul(_,v[h+1]),numeric.mul(1-_,v[h]));c[b]=v[0],c[a+i-m-o]=v[e-m-o]}for(h=b+1;a-o>h;h++)c[h]=v[h-b];return{knots:l,control_points:c}},verb.eval.rational_surface_curvature=function(e,r,t,n,i,o,s){var a=verb.eval.rational_surface_derivs(e,r,t,n,i,2,o,s),u=a[0][1],v=a[1][0],l=a[0][2],c=a[2][0],h=a[1][1],b=numeric.cross(u,v),_=numeric.dot(l,b),m=numeric.dot(h,b),d=numeric.dot(c,b),g=[[_,m],[m,d]],f=numeric.eig(g),p=f.lambda.x[0],y=f.lambda.x[1],k=.5*(p+y),x=p*y,N=numeric.add(numeric.mul(f.E.x[0][0],u),numeric.mul(f.E.x[0][1],v)),E=numeric.add(numeric.mul(f.E.x[1][0],u),numeric.mul(f.E.x[1][1],v));return{point:a[0][0],normal:b,mean:k,gaussian:x,shapeOperator:g,k1:p,k2:y,p1:N,p2:E,p1p:f.E.x[0],p2p:f.E.x[1]}},verb.eval.rational_surface_derivs=function(e,r,t,n,i,o,s,a){var u=verb.eval.surface_derivs(e,r,t,n,i,o,s,a),v=verb.eval.separate_homo_derivs_2d(u),l=v[0],c=v[1],h=0,b=0,_=0,m=0,d=[],g=l[0][0].length;for(h=0;o>=h;h++)for(d.push([]),m=0;o-h>=m;m++){var a=l[h][m];for(_=1;m>=_;_++)a=numeric.sub(a,numeric.mul(numeric.mul(binomial.get(m,_),c[0][_]),d[h][m-_]));for(b=1;h>=b;b++){a=numeric.sub(a,numeric.mul(numeric.mul(binomial.get(h,b),c[b][0]),d[h-b][m]));var f=verb.eval.zeros_1d(g);for(_=1;m>=_;_++)f=numeric.add(f,numeric.mul(numeric.mul(binomial.get(m,_),c[b][_]),d[h-b][m-_]));a=numeric.sub(a,numeric.mul(binomial.get(h,b),f))}d[h].push(numeric.mul(1/c[0][0],a))}return d},verb.eval.rational_surface_point=function(e,r,t,n,i,o,s){return verb.eval.dehomogenize(verb.eval.surface_point(e,r,t,n,i,o,s))},verb.eval.rational_curve_derivs=function(e,r,t,n,i){var o=verb.eval.separate_homo_derivs_1d(verb.eval.curve_derivs(e,r,t,n,i)),s=o[0],a=o[1],u=0,v=0,l=[];for(u=0;i>=u;u++){var c=s[u];for(v=1;u>=v;v++)c=numeric.sub(c,numeric.mul(numeric.mul(binomial.get(u,v),a[v]),l[u-v]));l.push(numeric.mul(1/a[0],c))}return l},verb.eval.separate_homo_derivs_1d=function(e){for(var r=e[0].length,t=r-1,n=[],i=[],o=0,s=e.length;s>o;o++)n.push(e[o].slice(0,t)),i.push(e[o][t]);return[n,i]},verb.eval.separate_homo_derivs_2d=function(e){for(var r=[],t=[],n=0,i=e.length;i>n;n++){var o=verb.eval.separate_homo_derivs_1d(e[n]);r.push(o[0]),t.push(o[1])}return[r,t]},verb.eval.rational_curve_point=function(e,r,t,n){return verb.eval.dehomogenize(verb.eval.curve_point(e,r,t,n))},verb.eval.dehomogenize=function(e){for(var r=e.length,t=[],n=e[r-1],i=0;e.length-1>i;i++)t.push(e[i]/n);return t},verb.eval.weight_1d=function(e){var r=e[0].length-1;return e.map(function(e){return e[r]})},verb.eval.weight_2d=function(e){return e.map(verb.eval.weight_1d)},verb.eval.dehomogenize_1d=function(e){return e.map(verb.eval.dehomogenize)},verb.eval.dehomogenize_2d=function(e){return e.map(verb.eval.dehomogenize_1d)},verb.eval.homogenize_1d=function(e,r){for(var t=e.length,n=e[0].length,i=0,o=[],s=0,a=[],u=0;t>u;u++){var v=[];for(a=e[u],s=r[u],i=0;n>i;i++)v.push(a[i]*s);v.push(s),o.push(v)}return o},verb.eval.homogenize_2d=function(e,r){for(var t=e.length,n=(e[0].length,e[0][0].length,[]),i=0;t>i;i++)n.push(verb.eval.homogenize_1d(e[i],r[i]));return n},verb.eval.surface_derivs=function(e,r,t,n,i,o,s,a){var u=r.length-e-2,v=n.length-t-2;return verb.eval.surface_derivs_given_n_m(u,e,r,v,t,n,i,o,s,a)},verb.eval.surface_derivs_given_n_m=function(e,r,t,n,i,o,s,a,u,v){if(verb.eval.are_valid_relations(r,s.length,t.length)===!1||verb.eval.are_valid_relations(i,s[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var l=s[0][0].length,c=Math.min(a,r),h=Math.min(a,i),b=verb.eval.zeros_3d(c+1,h+1,l),_=verb.eval.knot_span_given_n(e,r,u,t),m=verb.eval.knot_span_given_n(n,i,v,o),d=verb.eval.deriv_basis_functions_given_n_i(_,u,r,e,t),g=verb.eval.deriv_basis_functions_given_n_i(m,v,i,n,o),f=verb.eval.zeros_2d(i+1,l),p=0,y=0,k=0,x=0,N=0;for(p=0;c>=p;p++){for(y=0;i>=y;y++)for(f[y]=verb.eval.zeros_1d(l),k=0;r>=k;k++)f[y]=numeric.add(f[y],numeric.mul(d[p][k],s[_-r+k][m-i+y]));for(N=Math.min(a-p,h),x=0;N>=x;x++)for(b[p][x]=verb.eval.zeros_1d(l),y=0;i>=y;y++)b[p][x]=numeric.add(b[p][x],numeric.mul(g[x][y],f[y]))}return b},verb.eval.surface_point=function(e,r,t,n,i,o,s){var a=r.length-e-2,u=n.length-t-2;return verb.eval.surface_point_given_n_m(a,e,r,u,t,n,i,o,s)},verb.eval.volume_point=function(e,r,t,n,i,o,s,a,u,v){var l=r.length-e-2,c=n.length-t-2,h=o.length-i-2;return verb.eval.volume_point_given_n_m_l(l,e,r,c,t,n,h,i,o,s,a,u,v)},verb.eval.volume_point_given_n_m_l=function(e,r,t,n,i,o,s,a,u,v,l,c,h){if(!verb.eval.are_valid_relations(r,v.length,t.length)||!verb.eval.are_valid_relations(i,v[0].length,o.length)||!verb.eval.are_valid_relations(a,v[0][0].length,u.length))return console.error("Invalid relations between control points and knot vector"),null;for(var b=v[0][0][0].length,_=verb.eval.knot_span_given_n(e,r,l,t),m=verb.eval.knot_span_given_n(n,i,c,o),d=verb.eval.knot_span_given_n(s,a,h,u),g=verb.eval.basis_functions_given_knot_span_index(_,l,r,t),f=verb.eval.basis_functions_given_knot_span_index(m,c,i,o),p=verb.eval.basis_functions_given_knot_span_index(d,h,a,u),y=_-r,k=m,x=d,N=verb.eval.zeros_1d(b),E=verb.eval.zeros_1d(b),w=verb.eval.zeros_1d(b),z=0,S=0,P=0;a>=P;P++){for(w=verb.eval.zeros_1d(b),x=d-a+P,z=0;i>=z;z++){for(E=verb.eval.zeros_1d(b),k=m-i+z,S=0;r>=S;S++)E=numeric.add(E,numeric.mul(g[S],v[y+S][k][x]));w=numeric.add(w,numeric.mul(f[z],E))}N=numeric.add(N,numeric.mul(p[P],w))}return N},verb.eval.surface_point_given_n_m=function(e,r,t,n,i,o,s,a,u){if(verb.eval.are_valid_relations(r,s.length,t.length)===!1||verb.eval.are_valid_relations(i,s[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var v=s[0][0].length,l=verb.eval.knot_span_given_n(e,r,a,t),c=verb.eval.knot_span_given_n(n,i,u,o),h=verb.eval.basis_functions_given_knot_span_index(l,a,r,t),b=verb.eval.basis_functions_given_knot_span_index(c,u,i,o),_=l-r,m=c,d=verb.eval.zeros_1d(v),g=verb.eval.zeros_1d(v),f=0,p=0;for(f=0;i>=f;f++){for(g=verb.eval.zeros_1d(v),m=c-i+f,p=0;r>=p;p++)g=numeric.add(g,numeric.mul(h[p],s[_+p][m]));d=numeric.add(d,numeric.mul(b[f],g))}return d},verb.eval.curve_derivs=function(e,r,t,n,i){var o=r.length-e-2;return verb.eval.curve_derivs_given_n(o,e,r,t,n,i)},verb.eval.curve_derivs_given_n=function(e,r,t,n,i,o){if(verb.eval.are_valid_relations(r,n.length,t.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var s=n[0].length,a=Math.min(o,r),u=verb.eval.zeros_2d(a+1,s),v=verb.eval.knot_span_given_n(e,r,i,t),l=verb.eval.deriv_basis_functions_given_n_i(v,i,r,a,t),c=0,h=0;for(c=0;a>=c;c++)for(h=0;r>=h;h++)u[c]=numeric.add(u[c],numeric.mul(l[c][h],n[v-r+h]));return u},verb.eval.are_valid_relations=function(e,r,t){return 0===r+e+1-t?!0:!1},verb.eval.curve_point=function(e,r,t,n){var i=r.length-e-2;return verb.eval.curve_point_given_n(i,e,r,t,n)},verb.eval.curve_point_given_n=function(e,r,t,n,i){if(verb.eval.are_valid_relations(r,n.length,t.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;for(var o=verb.eval.knot_span_given_n(e,r,i,t),s=verb.eval.basis_functions_given_knot_span_index(o,i,r,t),a=verb.eval.zeros_1d(n[0].length),u=0;r>=u;u++)a=numeric.add(a,numeric.mul(s[u],n[o-r+u]));return a},verb.eval.zeros_1d=function(e){return numeric.rep([e],0)},verb.eval.zeros_2d=function(e,r){return r=r>0?r:0,e=e>0?e:0,numeric.rep([e,r],0)},verb.eval.zeros_3d=function(e,r,t){return r=r>0?r:0,e=e>0?e:0,numeric.rep([e,r,t],0)},verb.eval.deriv_basis_functions=function(e,r,t){var n=verb.eval.knot_span(r,e,t),i=t.length-1,o=i-r-1;return verb.eval.deriv_basis_functions_given_n_i(n,e,r,o,t)},verb.eval.deriv_basis_functions_given_n_i=function(e,r,t,n,i){var o=verb.eval.zeros_2d(t+1,t+1),s=Array(t+1),a=Array(t+1),u=0,v=0,l=1,c=0;for(o[0][0]=1,l=1;t>=l;l++){for(s[l]=r-i[e+1-l],a[l]=i[e+l]-r,u=0,c=0;l>c;c++)o[l][c]=a[c+1]+s[l-c],v=o[c][l-1]/o[l][c],o[c][l]=u+a[c+1]*v,u=s[l-c]*v;o[l][l]=u}var h=verb.eval.zeros_2d(n+1,t+1),b=verb.eval.zeros_2d(2,t+1),_=1,m=0,d=1,g=0,f=0,p=0,y=0,k=0;for(l=0;t>=l;l++)h[0][l]=o[l][t];for(c=0;t>=c;c++)for(m=0,d=1,b[0][0]=1,_=1;n>=_;_++){for(g=0,f=c-_,p=t-_,c>=_&&(b[d][0]=b[m][0]/o[p+1][f],g=b[d][0]*o[f][p]),y=f>=-1?1:-f,k=p>=c-1?_-1:t-c,l=y;k>=l;l++)b[d][l]=(b[m][l]-b[m][l-1])/o[p+1][f+l],g+=b[d][l]*o[f+l][p];p>=c&&(b[d][_]=-b[m][_-1]/o[p+1][c],g+=b[d][_]*o[c][p]),h[_][c]=g,l=m,m=d,d=l}for(c=t,_=1;n>=_;_++){for(l=0;t>=l;l++)h[_][l]*=c;c*=t-_}return h},verb.eval.basis_functions=function(e,r,t){var n=verb.eval.knot_span(e,r,t);return verb.eval.basis_functions_given_knot_span_index(n,e,r,t)},verb.eval.basis_functions_given_knot_span_index=function(e,r,t,n){var i=Array(t+1),o=Array(t+1),s=Array(t+1),a=0,u=0;i[0]=1;for(var v=1;t>=v;v++){o[v]=r-n[e+1-v],s[v]=n[e+v]-r,a=0;for(var l=0;v>l;l++)u=i[l]/(s[l+1]+o[v-l]),i[l]=a+s[l+1]*u,a=o[v-l]*u;i[v]=a}return i},verb.eval.knot_span=function(e,r,t){var n=t.length-1,i=n-e-1;return verb.eval.knot_span_given_n(i,e,r,t)},verb.eval.knot_span_given_n=function(e,r,t,n){if(t>=n[e+1])return e;if(n[r]>t)return r;for(var i=r,o=e+1,s=Math.floor((i+o)/2);n[s]>t||t>=n[s+1];)n[s]>t?o=s:i=s,s=Math.floor((i+o)/2);return s};