/*! verb 2013-06-08 */
if("object"!=typeof exports||void 0===exports)var verb={},numeric=window.numeric,binomial=window.binomial,labor=window.labor,_=window.underscore;else var verb=module.exports={},numeric=require("numeric"),binomial=require("binomial"),labor=require("labor"),_=require("underscore");verb.geom={},verb.core={},verb.eval={},verb.eval.nurbs={},verb.init=function(){verb.nurbsEngine=new verb.core.Engine(verb.eval.nurbs),verb.geom.NURBSGeometry.prototype.nurbsEngine=verb.nurbsEngine},"function"!=typeof Object.create&&(Object.create=function(n){function t(){}return t.prototype=n,new t}),Function.prototype.method=function(n,t){return this.prototype[n]=t,this},Function.method("inherits",function(n){return this.prototype=new n,this.prototype,this.prototype.constructor=n,this}),verb.core.Engine=function(n){var t="function"==typeof Worker&&(n.use_pool||void 0===n.use_pool),e=n.num_workers||2,r=n.tolerance||1e-4,i=n.url||"verb_nurbs_eval.js";n.library||verb.eval.nurbs;var o=n.error_handler||function(n){console.warn(n)},u=void 0,s=function(){try{u=new labor.Pool(i,e),u.start()}catch(n){return o("Failed to initialize labor.Pool."),!1}return!0};this.start=function(){t&&s()},this.eval=function(n,e,r){if(t&&(u||void 0===u&&s()))u.addWork(n,e,r);else{var i=this;_.defer(function(){r(i.eval_sync(n,e))})}},this.eval_sync=function(n,t){return _library[n].apply(null,t)},this.set_tolerance=function(n){r=n},this.set_use_pool=function(n){return n&&void 0===u&&s()?(t=n,!0):n?!1:(u=null,delete u,!0)},this.set_error_handler=function(n){o=n},this.set_num_threads=function(n){e=n}},verb.core.uid=function(){var n=0;return function(){return n++}}(),verb.geom.BoundingBox=function(){this.initialized=!1,this.min=[0,0,0],this.max=[0,0,0];var n=Array.prototype.slice.call(arguments,0);this.add_points_sync(n)},verb.geom.BoundingBox.prototype.add_points=function(n,t){var e=this;_.defer(function(){_.each(n,function(n){e.add(n)}),t(e)})},verb.geom.BoundingBox.prototype.add_points_sync=function(n){var t=this;return _.each(n,function(n){t.add(n)}),this},verb.geom.BoundingBox.prototype.add=function(n){return this.initialized?(n[0]>this.max[0]&&(this.max[0]=n[0]),n[1]>this.max[1]&&(this.max[1]=n[1]),n[2]>this.max[2]&&(this.max[2]=n[2]),n[0]<this.min[0]&&(this.min[0]=n[0]),n[1]<this.min[1]&&(this.min[1]=n[1]),n[2]<this.min[2]&&(this.min[2]=n[2]),this):(this.min=n.slice(0),this.max=n.slice(0),this.initialized=!0,this)},verb.geom.BoundingBox.prototype.contains=function(n){return this.initialized?this.intersects(new verb.geom.BoundingBox(n)):!1},verb.geom.BoundingBox.prototype.TOLERANCE=1e-4,verb.geom.BoundingBox.prototype.intervals_overlap=function(n,t,e,r){var i=verb.geom.BoundingBox.prototype.TOLERANCE,o=Math.min(n,t)-i,u=Math.max(n,t)+i,s=Math.min(e,r)-i,a=Math.max(e,r)+i;return o>=s&&a>=o||u>=s&&a>=u||s>=o&&u>=s||a>=o&&u>=a?!0:!1},verb.geom.BoundingBox.prototype.intersects=function(n){if(!this.initialized||!n.initialized)return!1;var t=this.min,e=this.max,r=n.min,i=n.max;return this.intervals_overlap(t[0],e[0],r[0],i[0])&&this.intervals_overlap(t[1],e[1],r[1],i[1])&&this.intervals_overlap(t[2],e[2],r[2],i[2])?!0:!1},verb.geom.BoundingBox.prototype.clear=function(){return this.initialized=!1,this},verb.geom.BoundingBox.prototype.intersect=function(n){if(!this.initialized)return null;var t=this.min,e=this.max,r=n.min,i=n.max;if(!this.intersects(n))return null;var o=Math.min(e[0],i[0]),u=Math.max(t[0],r[0]),s=Math.min(e[1],i[1]),a=Math.max(t[1],r[1]),l=Math.min(e[2],i[2]),c=Math.max(t[2],r[2]),h=[o,s,l],v=[u,a,c];return new verb.geom.BoundingBox(v,h)},verb.geom.Geometry=function(){var n=verb.core.uid();this.uid=function(){return n}},function(){function n(n,t,e){this.obj=n,this.left=null,this.right=null,this.parent=e,this.dimension=t}function t(t,r,i){function o(t,e,r){var u,s,a=e%i.length;return 0===t.length?null:1===t.length?new n(t[0],a,r):(t.sort(function(n,t){return n[i[a]]-t[i[a]]}),u=Math.floor(t.length/2),s=new n(t[u],a,r),s.left=o(t.slice(0,u),e+1,s),s.right=o(t.slice(u+1),e+1,s),s)}var u=this;this.root=o(t,0,null),this.insert=function(t){function e(n,r){if(null===n)return r;var o=i[n.dimension];return t[o]<n.obj[o]?e(n.left,n):e(n.right,n)}var r,o,u=e(this.root,null);return null===u?(this.root=new n(t,0,null),void 0):(r=new n(t,(u.dimension+1)%i.length,u),o=i[u.dimension],t[o]<u.obj[o]?u.left=r:u.right=r,void 0)},this.remove=function(n){function t(e){if(null===e)return null;if(e.obj===n)return e;var r=i[e.dimension];return n[r]<e.obj[r]?t(e.left,e):t(e.right,e)}function e(n){function t(n,e){var r,o,u,s,a;return null===n?null:(r=i[e],n.dimension===e?null!==n.right?t(n.right,e):n:(o=n.obj[r],u=t(n.left,e),s=t(n.right,e),a=n,null!==u&&u.obj[r]>o&&(a=u),null!==s&&s.obj[r]>a.obj[r]&&(a=s),a))}function r(n,t){var e,o,u,s,a;return null===n?null:(e=i[t],n.dimension===t?null!==n.left?r(n.left,t):n:(o=n.obj[e],u=r(n.left,t),s=r(n.right,t),a=n,null!==u&&o>u.obj[e]&&(a=u),null!==s&&s.obj[e]<a.obj[e]&&(a=s),a))}var o,s,a;return null===n.left&&null===n.right?null===n.parent?(u.root=null,void 0):(a=i[n.parent.dimension],n.obj[a]<n.parent.obj[a]?n.parent.left=null:n.parent.right=null,void 0):(o=null!==n.left?t(n.left,n.dimension):r(n.right,n.dimension),s=o.obj,e(o),n.obj=s,void 0)}var r;r=t(u.root),null!==r&&e(r)},this.nearest=function(n,t,o){function s(e){function o(n,e){c.push([n,e]),c.size()>t&&c.pop()}var u,a,l,h,v=i[e.dimension],_=r(n,e.obj),f={};for(h=0;i.length>h;h+=1)f[i[h]]=h===e.dimension?n[i[h]]:e.obj[i[h]];return a=r(f,e.obj),null===e.right&&null===e.left?((t>c.size()||c.peek()[1]>_)&&o(e,_),void 0):(u=null===e.right?e.left:null===e.left?e.right:n[v]<e.obj[v]?e.left:e.right,s(u),(t>c.size()||c.peek()[1]>_)&&o(e,_),(t>c.size()||Math.abs(a)<c.peek()[1])&&(l=u===e.left?e.right:e.left,null!==l&&s(l)),void 0)}var a,l,c;if(c=new e(function(n){return-n[1]}),o)for(a=0;t>a;a+=1)c.push([null,o]);for(s(u.root),l=[],a=0;t>a;a+=1)c.content[a][0]&&l.push([c.content[a][0].obj,c.content[a][1]]);return l},this.balanceFactor=function(){function n(t){return null===t?0:Math.max(n(t.left),n(t.right))+1}function t(n){return null===n?0:t(n.left)+t(n.right)+1}return n(u.root)/(Math.log(t(u.root))/Math.log(2))}}function e(n){this.content=[],this.scoreFunction=n}e.prototype={push:function(n){this.content.push(n),this.bubbleUp(this.content.length-1)},pop:function(){var n=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.sinkDown(0)),n},peek:function(){return this.content[0]},remove:function(n){for(var t=this.content.length,e=0;t>e;e++)if(this.content[e]==n){var r=this.content.pop();return e!=t-1&&(this.content[e]=r,this.scoreFunction(r)<this.scoreFunction(n)?this.bubbleUp(e):this.sinkDown(e)),void 0}throw Error("Node not found.")},size:function(){return this.content.length},bubbleUp:function(n){for(var t=this.content[n];n>0;){var e=Math.floor((n+1)/2)-1,r=this.content[e];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[e]=t,this.content[n]=r,n=e}},sinkDown:function(n){for(var t=this.content.length,e=this.content[n],r=this.scoreFunction(e);;){var i=2*(n+1),o=i-1,u=null;if(t>o){var s=this.content[o],a=this.scoreFunction(s);r>a&&(u=o)}if(t>i){var l=this.content[i],c=this.scoreFunction(l);(null==u?r:a)>c&&(u=i)}if(null==u)break;this.content[n]=this.content[u],this.content[u]=e,n=u}}},verb.geom.KDTree=t}(verb),verb.geom.NurbsCurve=function(n,t,e,r){if(verb.geom.NURBSGeometry.call(this),verb.eval.nurbs.are_valid_relations(n,t.length,r.length))var i=t.slice(0),o=verb.eval.nurbs.homogenize_1d(t,e),u=r.slice(0),s=e.slice(0),a=n;else{console.warn("Invalid relations were used to instantiate a NurbsCurve - using defaults.");var i=[],o=[],u=[],s=[],a=2}this.set_control_point=function(n,t){return i[n]=t,o[n]=t*s[n],this},this.set_weight=function(n,t){return s[n]=t,set_control_point(n,i[n]),this},this.set_knot=function(n,t){return u[n]=t,this},this.point_sync=function(n){return this.nurbsEngine.eval_sync("rational_curve_point",[a,_knot_vector,o,n])},this.derivs_sync=function(n,t){return this.nurbsEngine.eval_sync("rational_curve_derivs",[a,_knot_vector,o,n,t])},this.point=function(n,t){nurbsEngine.eval("rational_curve_point",[a,_knot_vector,o,n],t)},this.derivs=function(n,t,e){this.nurbsEngine.eval("rational_curve_derivs",[a,_knot_vector,o,n,t],e)}},verb.geom.NURBSGeometry=function(){verb.geom.Geometry.call(this)}.inherits(verb.geom.Geometry),verb.geom.NurbsSurface=function(n,t,e,r){verb.geom.NURBSGeometry.call(this),t.slice(0),r.slice(0),e.slice(0),this.set_control_point=function(){},this.set_weight=function(){},this.set_control_point=function(){},this.point=function(){},this.derivs=function(){}}.inherits(verb.geom.NURBSGeometry),verb.geom.Vector=function(n,t,e){3==arguments.length?(this.x=n,this.y=t,this.z=e):"x"in n?(this.x=n.x,this.y=n.y,this.z=n.z):(this.x=n[0],this.y=n[1],this.z=n[2])},verb.geom.Vector.prototype={clone:function(){return new CSG.Vector(this.x,this.y,this.z)},negated:function(){return new CSG.Vector(-this.x,-this.y,-this.z)},plus:function(n){return new CSG.Vector(this.x+n.x,this.y+n.y,this.z+n.z)},minus:function(n){return new CSG.Vector(this.x-n.x,this.y-n.y,this.z-n.z)},times:function(n){return new CSG.Vector(this.x*n,this.y*n,this.z*n)},dividedBy:function(n){return new CSG.Vector(this.x/n,this.y/n,this.z/n)},dot:function(n){return this.x*n.x+this.y*n.y+this.z*n.z},lerp:function(n,t){return this.plus(n.minus(this).times(t))},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.dividedBy(this.length())},cross:function(n){return new CSG.Vector(this.y*n.z-this.z*n.y,this.z*n.x-this.x*n.z,this.x*n.y-this.y*n.x)}},verb.eval.nurbs.rational_surface_surface_intersect=function(){},verb.eval.nurbs.rational_curve_curve_bb_intersect=function(){},verb.eval.nurbs.rational_curve_adaptive_sample=function(n,t,e,r){var i={};return verb.eval.nurbs.rational_curve_adaptive_sample_range(n,t,e,0,1,r,i),i},verb.eval.nurbs.rational_curve_adaptive_sample_range=function(n,t,e,r,i,o,u){var s=verb.eval.nurbs.rational_curve_point(r),a=verb.eval.nurbs.rational_curve_point(i),l=.45+.1*Math.random();mid_u=r+(i-r)*l,p2=verb.eval.nurbs.rational_curve_point(mid_u),verb.eval.nurbs.three_points_are_flat(s,p2,a,o)?(u[r]=s,u[i]=a):(verb.eval.nurbs.rational_curve_adaptive_sample_range(n,t,e,r,mid_u,o,u),verb.eval.nurbs.rational_curve_adaptive_sample_range(n,t,e,mid_u,i,o,u))},verb.eval.nurbs.three_points_are_flat=function(n,t,e,r){var i=new verb.geom.Vector(n),o=new verb.geom.Vector(t),u=verb.geom.Vector(e),s=o.minus(i).cross(u.minus(i)),a=s.dot(s);return r>a},verb.eval.nurbs.curve_knot_insert=function(n,t,e,r,i,o){var u=(e[0].length,t.length-n-2),s=e.length,a=verb.eval.nurbs.knot_span(n,r,t),l=u+n+1,c=s+o,h=Array(n+1),v=Array(t.length+o),_=Array(c),f=0;for(f=0;a>=f;f++)v[f]=t[f];for(f=1;o>=f;f++)v[a+f]=r;for(f=a+1;l>=f;f++)v[f+o]=t[f];for(f=0;a-n>=f;f++)_[f]=e[f];for(f=a-i;u>=f;f++)_[f+o]=e[f];for(f=0;n-i>=f;f++)h[f]=e[a-n+1];for(var d=0,m=0,b=1;o>=b;b++){for(d=a-n+b,f=0;n-b-i>=f;f++)m=(r-t[d+f])/(t[f+a+1]-t[d+f]),h[f]=numeric.add(numeric.mul(m,h[f+1]),numeric.mul(1-m,h[f]));_[d]=h[0],_[a+o-b-i]=h[n-b-i]}for(f=d+1;a-i>f;f++)_[f]=h[f-d];return[v,_]},verb.eval.nurbs.rational_surface_derivs=function(n,t,e,r,i,o,u,s){var a=verb.eval.nurbs.surface_derivs(n,t,e,r,i,o,u,s),l=verb.eval.nurbs.separate_homo_derivs_2d(a),c=l[0],h=l[1],v=0,_=0,f=0,d=0,m=[],b=c[0][0].length;for(v=0;o>=v;v++)for(m.push([]),d=0;o-v>=d;d++){var s=c[v][d];for(f=1;d>=f;f++)s=numeric.sub(s,numeric.mul(numeric.mul(binomial.get(d,f),h[0][f]),m[v][d-f]));for(_=1;v>=_;_++){s=numeric.sub(s,numeric.mul(numeric.mul(binomial.get(v,_),h[_][0]),m[v-_][d]));var g=verb.eval.nurbs.zeros_1d(b);for(f=1;d>=f;f++)g=numeric.add(g,numeric.mul(numeric.mul(binomial.get(d,f),h[_][f]),m[v-_][d-f]));s=numeric.sub(s,numeric.mul(binomial.get(v,_),g))}m[v].push(numeric.mul(1/h[0][0],s))}return m},verb.eval.nurbs.rational_surface_point=function(n,t,e,r,i,o,u){return verb.eval.nurbs.dehomogenize(verb.eval.nurbs.surface_point(n,t,e,r,i,o,u))},verb.eval.nurbs.rational_curve_derivs=function(n,t,e,r,i){var o=verb.eval.nurbs.separate_homo_derivs_1d(verb.eval.nurbs.curve_derivs(n,t,e,r,i)),u=o[0],s=o[1],a=0,l=0,c=[];for(a=0;i>=a;a++){var h=u[a];for(l=1;a>=l;l++)h=numeric.sub(h,numeric.mul(numeric.mul(binomial.get(a,l),s[l]),c[a-l]));c.push(numeric.mul(1/s[0],h))}return c},verb.eval.nurbs.separate_homo_derivs_1d=function(n){for(var t=n[0].length,e=t-1,r=[],i=[],o=0,u=n.length;u>o;o++)r.push(n[o].slice(0,e)),i.push(n[o][e]);return[r,i]},verb.eval.nurbs.separate_homo_derivs_2d=function(n){for(var t=[],e=[],r=0,i=n.length;i>r;r++){var o=verb.eval.nurbs.separate_homo_derivs_1d(n[r]);t.push(o[0]),e.push(o[1])}return[t,e]},verb.eval.nurbs.rational_curve_point=function(n,t,e,r){return verb.eval.nurbs.dehomogenize(verb.eval.nurbs.curve_point(n,t,e,r))},verb.eval.nurbs.dehomogenize=function(n){for(var t=n.length,e=[],r=n[t-1],i=0;n.length-1>i;i++)e.push(n[i]/r);return e},verb.eval.nurbs.homogenize_1d=function(n,t){for(var e=n.length,r=n[0].length,i=0,o=[],u=0,s=[],a=0;e>a;a++){var l=[];for(s=n[a],u=t[a],i=0;r>i;i++)l.push(s[i]*u);l.push(u),o.push(l)}return o},verb.eval.nurbs.homogenize_2d=function(n,t){for(var e=n.length,r=(n[0].length,n[0][0].length,[]),i=0;e>i;i++)r.push(verb.eval.nurbs.homogenize_1d(n[i],t[i]));return r},verb.eval.nurbs.surface_derivs=function(n,t,e,r,i,o,u,s){var a=t.length-n-2,l=r.length-e-2;return verb.eval.nurbs.surface_derivs_given_n_m(a,n,t,l,e,r,i,o,u,s)},verb.eval.nurbs.surface_derivs_given_n_m=function(n,t,e,r,i,o,u,s,a,l){if(verb.eval.nurbs.are_valid_relations(t,u.length,e.length)===!1||verb.eval.nurbs.are_valid_relations(i,u[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var c=u[0][0].length,h=Math.min(s,t),v=Math.min(s,i),_=verb.eval.nurbs.zeros_3d(h+1,v+1,c),f=verb.eval.nurbs.knot_span_given_n(n,t,a,e),d=verb.eval.nurbs.knot_span_given_n(r,i,l,o),m=verb.eval.nurbs.deriv_basis_functions_given_n_i(f,a,t,n,e),b=verb.eval.nurbs.deriv_basis_functions_given_n_i(d,l,i,r,o),g=verb.eval.nurbs.zeros_2d(i+1,c),B=0,p=0,V=0,E=0,R=0;for(B=0;h>=B;B++){for(p=0;i>=p;p++)for(g[p]=verb.eval.nurbs.zeros_1d(c),V=0;t>=V;V++)g[p]=numeric.add(g[p],numeric.mul(m[B][V],u[f-t+V][d-i+p]));for(R=Math.min(s-B,v),E=0;R>=E;E++)for(_[B][E]=verb.eval.nurbs.zeros_1d(c),p=0;i>=p;p++)_[B][E]=numeric.add(_[B][E],numeric.mul(b[E][p],g[p]))}return _},verb.eval.nurbs.surface_point=function(n,t,e,r,i,o,u){var s=t.length-n-2,a=r.length-e-2;return verb.eval.nurbs.surface_point_given_n_m(s,n,t,a,e,r,i,o,u)},verb.eval.nurbs.surface_point_given_n_m=function(n,t,e,r,i,o,u,s,a){if(verb.eval.nurbs.are_valid_relations(t,u.length,e.length)===!1||verb.eval.nurbs.are_valid_relations(i,u[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var l=(u[0][0].length,verb.eval.nurbs.knot_span_given_n(n,t,s,e)),c=verb.eval.nurbs.knot_span_given_n(r,i,a,o),h=verb.eval.nurbs.basis_functions_given_knot_span_index(l,s,t,e),v=verb.eval.nurbs.basis_functions_given_knot_span_index(c,a,i,o),_=l-t,f=c,d=verb.eval.nurbs.zeros_1d(u[0][0].length),m=verb.eval.nurbs.zeros_1d(u[0][0].length),b=0,g=0;for(b=0;i>=b;b++){for(m=verb.eval.nurbs.zeros_1d(u[0][0].length),f=c-i+b,g=0;t>=g;g++)m=numeric.add(m,numeric.mul(h[g],u[_+g][f]));d=numeric.add(d,numeric.mul(v[b],m))}return d},verb.eval.nurbs.curve_derivs=function(n,t,e,r,i){var o=t.length-n-2;return verb.eval.nurbs.curve_derivs_given_n(o,n,t,e,r,i)},verb.eval.nurbs.curve_derivs_given_n=function(n,t,e,r,i,o){if(verb.eval.nurbs.are_valid_relations(t,r.length,e.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var u=r[0].length,s=Math.min(o,t),a=verb.eval.nurbs.zeros_2d(s+1,u),l=verb.eval.nurbs.knot_span_given_n(n,t,i,e),c=verb.eval.nurbs.deriv_basis_functions_given_n_i(l,i,t,s,e),h=0,v=0;for(h=0;s>=h;h++)for(v=0;t>=v;v++)a[h]=numeric.add(a[h],numeric.mul(c[h][v],r[l-t+v]));return a},verb.eval.nurbs.are_valid_relations=function(n,t,e){return 0===t+n+1-e?!0:!1},verb.eval.nurbs.curve_point=function(n,t,e,r){var i=t.length-n-2;return verb.eval.nurbs.curve_point_given_n(i,n,t,e,r)},verb.eval.nurbs.curve_point_given_n=function(n,t,e,r,i){if(verb.eval.nurbs.are_valid_relations(t,r.length,e.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;for(var o=verb.eval.nurbs.knot_span_given_n(n,t,i,e),u=verb.eval.nurbs.basis_functions_given_knot_span_index(o,i,t,e),s=verb.eval.nurbs.zeros_1d(r[0].length),a=0;t>=a;a++)s=numeric.add(s,numeric.mul(u[a],r[o-t+a]));return s},verb.eval.nurbs.zeros_1d=function(n){n=n>0?n:0;for(var t=[];n--;)t.push(0);return t},verb.eval.nurbs.zeros_2d=function(n,t){t=t>0?t:0,n=n>0?n:0;for(var e=[],r=t,i=n;n--;){for(e.push([]);r--;)e[i-n-1].push(0);r=t}return e},verb.eval.nurbs.zeros_3d=function(n,t,e){t=t>0?t:0,n=n>0?n:0;for(var r=[],i=t,o=n;n--;){for(r.push([]);i--;)r[o-n-1].push(verb.eval.nurbs.zeros_1d(e));i=t}return r},verb.eval.nurbs.deriv_basis_functions=function(n,t,e){var r=verb.eval.nurbs.knot_span(t,n,e),i=e.length-1,o=i-t-1;return verb.eval.nurbs.deriv_basis_functions_given_n_i(r,n,t,o,e)},verb.eval.nurbs.deriv_basis_functions_given_n_i=function(n,t,e,r,i){var o=verb.eval.nurbs.zeros_2d(e+1,e+1),u=Array(e+1),s=Array(e+1),a=0,l=0,c=1,h=0;for(o[0][0]=1,c=1;e>=c;c++){for(u[c]=t-i[n+1-c],s[c]=i[n+c]-t,a=0,h=0;c>h;h++)o[c][h]=s[h+1]+u[c-h],l=o[h][c-1]/o[c][h],o[h][c]=a+s[h+1]*l,a=u[c-h]*l;o[c][c]=a}var v=verb.eval.nurbs.zeros_2d(r+1,e+1),_=verb.eval.nurbs.zeros_2d(2,e+1),f=1,d=0,m=1,b=0,g=0,B=0,p=0,V=0;for(c=0;e>=c;c++)v[0][c]=o[c][e];for(h=0;e>=h;h++)for(d=0,m=1,_[0][0]=1,f=1;r>=f;f++){for(b=0,g=h-f,B=e-f,h>=f&&(_[m][0]=_[d][0]/o[B+1][g],b=_[m][0]*o[g][B]),p=g>=-1?1:-g,V=B>=h-1?f-1:e-h,c=p;V>=c;c++)_[m][c]=(_[d][c]-_[d][c-1])/o[B+1][g+c],b+=_[m][c]*o[g+c][B];B>=h&&(_[m][f]=-_[d][f-1]/o[B+1][h],b+=_[m][f]*o[h][B]),v[f][h]=b,c=d,d=m,m=c}for(h=e,f=1;r>=f;f++){for(c=0;e>=c;c++)v[f][c]*=h;h*=e-f}return v},verb.eval.nurbs.basis_functions=function(n,t,e){var r=verb.eval.nurbs.knot_span(n,t,e);return verb.eval.nurbs.basis_functions_given_knot_span_index(r,n,t,e)},verb.eval.nurbs.basis_functions_given_knot_span_index=function(n,t,e,r){var i=Array(e+1),o=Array(e+1),u=Array(e+1),s=0,a=0;i[0]=1;for(var l=1;e>=l;l++){o[l]=t-r[n+1-l],u[l]=r[n+l]-t,s=0;for(var c=0;l>c;c++)a=i[c]/(u[c+1]+o[l-c]),i[c]=s+u[c+1]*a,s=o[l-c]*a;i[l]=s}return i},verb.eval.nurbs.knot_span=function(n,t,e){var r=e.length-1,i=r-n-1;return verb.eval.nurbs.knot_span_given_n(i,n,t,e)},verb.eval.nurbs.knot_span_given_n=function(n,t,e,r){if(e>=r[n+1])return n;if(r[t]>e)return t;for(var i=t,o=n+1,u=Math.floor((i+o)/2);r[u]>e||e>=r[u+1];)r[u]>e?o=u:i=u,u=Math.floor((i+o)/2);return u};