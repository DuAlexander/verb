/*! verb 2013-02-20 */
if("object"!=typeof exports||void 0===exports)importScripts("labor.js");else var labor=require("labor");var VERB=VERB||{};VERB.eval=VERB.eval||{},VERB.eval.nurbs=VERB.eval.nurbs||{};var router=new labor.Router(VERB.eval.nurbs);VERB.eval.nurbs.curve_knot_insert=function(n,r,e,i,t,o){var u=(e[0].length,r.length-n-2),s=e.length,a=VERB.eval.nurbs.knot_span(n,i,r),l=u+n+1,v=s+o,_=Array(n+1),c=Array(r.length+o),f=Array(v),h=0;for(h=0;a>=h;h++)c[h]=r[h];for(h=1;o>=h;h++)c[a+h]=i;for(h=a+1;l>=h;h++)c[h+o]=r[h];for(h=0;a-n>=h;h++)f[h]=e[h];for(h=a-t;u>=h;h++)f[h+o]=e[h];for(h=0;n-t>=h;h++)console.log(e[a-n+1]),_[h]=e[a-n+1];for(var b=0,d=0,B=1;o>=B;B++){for(b=a-n+B,h=0;n-B-t>=h;h++)d=(i-r[b+h])/(r[h+a+1]-r[b+h]),_[h]=numeric.add(numeric.mul(d,_[h+1]),numeric.mul(1-d,_[h]));f[b]=_[0],f[a+o-B-t]=_[n-B-t]}for(console.log(_),console.log(b),h=b+1;a-t>h;h++)f[h]=_[h-b];return[c,f]},VERB.eval.nurbs.rational_surface_derivs=function(n,r,e,i,t,o,u,s){var a=VERB.eval.nurbs.surface_derivs(n,r,e,i,t,o,u,s),l=VERB.eval.nurbs.separate_homo_derivs_2d(a),v=l[0],_=l[1],c=0,f=0,h=0,b=0,d=[],B=v[0][0].length;for(c=0;o>=c;c++)for(d.push([]),b=0;o-c>=b;b++){var s=v[c][b];for(h=1;b>=h;h++)s=numeric.sub(s,numeric.mul(numeric.mul(binomial.get(b,h),_[0][h]),d[c][b-h]));for(f=1;c>=f;f++){s=numeric.sub(s,numeric.mul(numeric.mul(binomial.get(c,f),_[f][0]),d[c-f][b]));var m=VERB.eval.nurbs.zeros_1d(B);for(h=1;b>=h;h++)m=numeric.add(m,numeric.mul(numeric.mul(binomial.get(b,h),_[f][h]),d[c-f][b-h]));s=numeric.sub(s,numeric.mul(binomial.get(c,f),m))}d[c].push(numeric.mul(1/_[0][0],s))}return d},VERB.eval.nurbs.rational_surface_point=function(n,r,e,i,t,o,u){return VERB.eval.nurbs.dehomogenize(VERB.eval.nurbs.surface_point(n,r,e,i,t,o,u))},VERB.eval.nurbs.rational_curve_derivs=function(n,r,e,i,t){var o=VERB.eval.nurbs.separate_homo_derivs_1d(VERB.eval.nurbs.curve_derivs(n,r,e,i,t)),u=o[0],s=o[1],a=0,l=0,v=[];for(a=0;t>=a;a++){var _=u[a];for(l=1;a>=l;l++)_=numeric.sub(_,numeric.mul(numeric.mul(binomial.get(a,l),s[l]),v[a-l]));v.push(numeric.mul(1/s[0],_))}return v},VERB.eval.nurbs.separate_homo_derivs_1d=function(n){for(var r=n[0].length,e=r-1,i=[],t=[],o=0,u=n.length;u>o;o++)i.push(n[o].slice(0,e)),t.push(n[o][e]);return[i,t]},VERB.eval.nurbs.separate_homo_derivs_2d=function(n){for(var r=[],e=[],i=0,t=n.length;t>i;i++){var o=VERB.eval.nurbs.separate_homo_derivs_1d(n[i]);r.push(o[0]),e.push(o[1])}return[r,e]},VERB.eval.nurbs.rational_curve_point=function(n,r,e,i){return VERB.eval.nurbs.dehomogenize(VERB.eval.nurbs.curve_point(n,r,e,i))},VERB.eval.nurbs.dehomogenize=function(n){for(var r=n.length,e=[],i=n[r-1],t=0;n.length-1>t;t++)e.push(n[t]/i);return e},VERB.eval.nurbs.homogenize_1d=function(n,r){for(var e=n.length,i=n[0].length,t=0,o=[],u=0,s=[],a=0;e>a;a++){var l=[];for(s=n[a],u=r[a],t=0;i>t;t++)l.push(s[t]*u);l.push(u),o.push(l)}return o},VERB.eval.nurbs.homogenize_2d=function(n,r){for(var e=n.length,i=(n[0].length,n[0][0].length,[]),t=0;e>t;t++)i.push(VERB.eval.nurbs.homogenize_1d(n[t],r[t]));return i},VERB.eval.nurbs.surface_derivs=function(n,r,e,i,t,o,u,s){var a=r.length-n-2,l=i.length-e-2;return VERB.eval.nurbs.surface_derivs_given_n_m(a,n,r,l,e,i,t,o,u,s)},VERB.eval.nurbs.surface_derivs_given_n_m=function(n,r,e,i,t,o,u,s,a,l){if(VERB.eval.nurbs.are_valid_relations(r,u.length,e.length)===!1||VERB.eval.nurbs.are_valid_relations(t,u[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var v=u[0][0].length,_=Math.min(s,r),c=Math.min(s,t),f=VERB.eval.nurbs.zeros_3d(_+1,c+1,v),h=VERB.eval.nurbs.knot_span_given_n(n,r,a,e),b=VERB.eval.nurbs.knot_span_given_n(i,t,l,o),d=VERB.eval.nurbs.deriv_basis_functions_given_n_i(h,a,r,n,e),B=VERB.eval.nurbs.deriv_basis_functions_given_n_i(b,l,t,i,o),m=VERB.eval.nurbs.zeros_2d(t+1,v),g=0,R=0,E=0,V=0,p=0;for(g=0;_>=g;g++){for(R=0;t>=R;R++)for(m[R]=VERB.eval.nurbs.zeros_1d(v),E=0;r>=E;E++)m[R]=numeric.add(m[R],numeric.mul(d[g][E],u[h-r+E][b-t+R]));for(p=Math.min(s-g,c),V=0;p>=V;V++)for(f[g][V]=VERB.eval.nurbs.zeros_1d(v),R=0;t>=R;R++)f[g][V]=numeric.add(f[g][V],numeric.mul(B[V][R],m[R]))}return f},VERB.eval.nurbs.surface_point=function(n,r,e,i,t,o,u){var s=r.length-n-2,a=i.length-e-2;return VERB.eval.nurbs.surface_point_given_n_m(s,n,r,a,e,i,t,o,u)},VERB.eval.nurbs.surface_point_given_n_m=function(n,r,e,i,t,o,u,s,a){if(VERB.eval.nurbs.are_valid_relations(r,u.length,e.length)===!1||VERB.eval.nurbs.are_valid_relations(t,u[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var l=(u[0][0].length,VERB.eval.nurbs.knot_span_given_n(n,r,s,e)),v=VERB.eval.nurbs.knot_span_given_n(i,t,a,o),_=VERB.eval.nurbs.basis_functions_given_knot_span_index(l,s,r,e),c=VERB.eval.nurbs.basis_functions_given_knot_span_index(v,a,t,o),f=l-r,h=v,b=VERB.eval.nurbs.zeros_1d(u[0][0].length),d=VERB.eval.nurbs.zeros_1d(u[0][0].length),B=0,m=0;for(B=0;t>=B;B++){for(d=VERB.eval.nurbs.zeros_1d(u[0][0].length),h=v-t+B,m=0;r>=m;m++)d=numeric.add(d,numeric.mul(_[m],u[f+m][h]));b=numeric.add(b,numeric.mul(c[B],d))}return b},VERB.eval.nurbs.curve_derivs=function(n,r,e,i,t){var o=r.length-n-2;return VERB.eval.nurbs.curve_derivs_given_n(o,n,r,e,i,t)},VERB.eval.nurbs.curve_derivs_given_n=function(n,r,e,i,t,o){if(VERB.eval.nurbs.are_valid_relations(r,i.length,e.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var u=i[0].length,s=Math.min(o,r),a=VERB.eval.nurbs.zeros_2d(s+1,u),l=VERB.eval.nurbs.knot_span_given_n(n,r,t,e),v=VERB.eval.nurbs.deriv_basis_functions_given_n_i(l,t,r,s,e),_=0,c=0;for(_=0;s>=_;_++)for(c=0;r>=c;c++)a[_]=numeric.add(a[_],numeric.mul(v[_][c],i[l-r+c]));return a},VERB.eval.nurbs.are_valid_relations=function(n,r,e){return 0===r+n+1-e?!0:!1},VERB.eval.nurbs.curve_point=function(n,r,e,i){var t=r.length-n-2;return VERB.eval.nurbs.curve_point_given_n(t,n,r,e,i)},VERB.eval.nurbs.curve_point_given_n=function(n,r,e,i,t){if(VERB.eval.nurbs.are_valid_relations(r,i.length,e.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;for(var o=VERB.eval.nurbs.knot_span_given_n(n,r,t,e),u=VERB.eval.nurbs.basis_functions_given_knot_span_index(o,t,r,e),s=VERB.eval.nurbs.zeros_1d(i[0].length),a=0;r>=a;a++)s=numeric.add(s,numeric.mul(u[a],i[o-r+a]));return s},VERB.eval.nurbs.zeros_1d=function(n){n=n>0?n:0;for(var r=[];n--;)r.push(0);return r},VERB.eval.nurbs.zeros_2d=function(n,r){r=r>0?r:0,n=n>0?n:0;for(var e=[],i=r,t=n;n--;){for(e.push([]);i--;)e[t-n-1].push(0);i=r}return e},VERB.eval.nurbs.zeros_3d=function(n,r,e){r=r>0?r:0,n=n>0?n:0;for(var i=[],t=r,o=n;n--;){for(i.push([]);t--;)i[o-n-1].push(VERB.eval.nurbs.zeros_1d(e));t=r}return i},VERB.eval.nurbs.deriv_basis_functions=function(n,r,e){var i=VERB.eval.nurbs.knot_span(r,n,e),t=e.length-1,o=t-r-1;return VERB.eval.nurbs.deriv_basis_functions_given_n_i(i,n,r,o,e)},VERB.eval.nurbs.deriv_basis_functions_given_n_i=function(n,r,e,i,t){var o=VERB.eval.nurbs.zeros_2d(e+1,e+1),u=Array(e+1),s=Array(e+1),a=0,l=0,v=1,_=0;for(o[0][0]=1,v=1;e>=v;v++){for(u[v]=r-t[n+1-v],s[v]=t[n+v]-r,a=0,_=0;v>_;_++)o[v][_]=s[_+1]+u[v-_],l=o[_][v-1]/o[v][_],o[_][v]=a+s[_+1]*l,a=u[v-_]*l;o[v][v]=a}var c=VERB.eval.nurbs.zeros_2d(i+1,e+1),f=VERB.eval.nurbs.zeros_2d(2,e+1),h=1,b=0,d=1,B=0,m=0,g=0,R=0,E=0;for(v=0;e>=v;v++)c[0][v]=o[v][e];for(_=0;e>=_;_++)for(b=0,d=1,f[0][0]=1,h=1;i>=h;h++){for(B=0,m=_-h,g=e-h,_>=h&&(f[d][0]=f[b][0]/o[g+1][m],B=f[d][0]*o[m][g]),R=m>=-1?1:-m,E=g>=_-1?h-1:e-_,v=R;E>=v;v++)f[d][v]=(f[b][v]-f[b][v-1])/o[g+1][m+v],B+=f[d][v]*o[m+v][g];g>=_&&(f[d][h]=-f[b][h-1]/o[g+1][_],B+=f[d][h]*o[_][g]),c[h][_]=B,v=b,b=d,d=v}for(_=e,h=1;i>=h;h++){for(v=0;e>=v;v++)c[h][v]*=_;_*=e-h}return c},VERB.eval.nurbs.basis_functions=function(n,r,e){var i=VERB.eval.nurbs.knot_span(n,r,e);return VERB.eval.nurbs.basis_functions_given_knot_span_index(i,n,r,e)},VERB.eval.nurbs.basis_functions_given_knot_span_index=function(n,r,e,i){var t=Array(e+1),o=Array(e+1),u=Array(e+1),s=0,a=0;t[0]=1;for(var l=1;e>=l;l++){o[l]=r-i[n+1-l],u[l]=i[n+l]-r,s=0;for(var v=0;l>v;v++)a=t[v]/(u[v+1]+o[l-v]),t[v]=s+u[v+1]*a,s=o[l-v]*a;t[l]=s}return t},VERB.eval.nurbs.knot_span=function(n,r,e){var i=e.length-1,t=i-n-1;return VERB.eval.nurbs.knot_span_given_n(t,n,r,e)},VERB.eval.nurbs.knot_span_given_n=function(n,r,e,i){if(e>=i[n+1])return n;if(i[r]>e)return r;for(var t=r,o=n+1,u=Math.floor((t+o)/2);i[u]>e||e>=i[u+1];)i[u]>e?o=u:t=u,u=Math.floor((t+o)/2);return u};