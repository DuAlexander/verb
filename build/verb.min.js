/*! verb 2013-02-20 */
if("object"!=typeof exports||void 0===exports)var VERB={},numeric=window.numeric,binomial=window.binomial,labor=window.labor,_=window.underscore;else var VERB=module.exports={},numeric=require("numeric"),binomial=require("binomial"),labor=require("labor"),_=require("underscore");VERB.geom={},VERB.core={},VERB.eval={},VERB.eval.nurbs={},VERB.init=function(){VERB.nurbs_engine=new VERB.core.Engine(VERB.eval.nurbs),VERB.geom.NURBSGeometry.prototype.nurbs_engine=VERB.nurbs_engine},"function"!=typeof Object.create&&(Object.create=function(n){function e(){}return e.prototype=n,new e}),Function.prototype.method=function(n,e){return this.prototype[n]=e,this},Function.method("inherits",function(n){return this.prototype=new n,this.prototype,this.prototype.constructor=n,this}),VERB.core.Engine=function(n){var e="function"==typeof Worker&&(n.use_pool||void 0===n.use_pool),r=n.num_workers||2,t=n.tolerance||1e-4,i=n.url||"verb_nurbs_eval.js";n.library||VERB.eval.nurbs;var o=n.error_handler||function(n){console.warn(n)},s=void 0,u=function(){try{s=new labor.Pool(i,r),s.start()}catch(n){return o("Failed to initialize labor.Pool."),!1}return!0};this.start=function(){e&&u()},this.eval=function(n,r,t){if(e&&(s||void 0===s&&u()))s.addWork(n,r,t);else{var i=this;_.defer(function(){t(i.eval_sync(n,r))})}},this.eval_sync=function(n,e){return _library[n].apply(null,e)},this.set_tolerance=function(n){t=n},this.set_use_pool=function(n){return n&&void 0===s&&u()?(e=n,!0):n?!1:(s=null,delete s,!0)},this.set_error_handler=function(n){o=n},this.set_num_threads=function(n){r=n}},VERB.core.uid=function(){var n=0;return function(){return n++}}(),VERB.geom.BoundingBox=function(){this.initialized=!1,this.min=[0,0,0],this.max=[0,0,0];var n=Array.prototype.slice.call(arguments,0);this.add_points_sync(n)},VERB.geom.BoundingBox.prototype.add_points=function(n,e){var r=this;_.defer(function(){_.each(n,function(n){r.add(n)}),e(r)})},VERB.geom.BoundingBox.prototype.add_points_sync=function(n){var e=this;return _.each(n,function(n){e.add(n)}),this},VERB.geom.BoundingBox.prototype.add=function(n){return this.initialized?(n[0]>this.max[0]&&(this.max[0]=n[0]),n[1]>this.max[1]&&(this.max[1]=n[1]),n[2]>this.max[2]&&(this.max[2]=n[2]),n[0]<this.min[0]&&(this.min[0]=n[0]),n[1]<this.min[1]&&(this.min[1]=n[1]),n[2]<this.min[2]&&(this.min[2]=n[2]),this):(this.min=n.slice(0),this.max=n.slice(0),this.initialized=!0,this)},VERB.geom.BoundingBox.prototype.contains=function(n){return this.initialized?this.intersects(new VERB.geom.BoundingBox(n)):!1},VERB.geom.BoundingBox.prototype.TOLERANCE=1e-4,VERB.geom.BoundingBox.prototype.intervals_overlap=function(n,e,r,t){var i=VERB.geom.BoundingBox.prototype.TOLERANCE,o=Math.min(n,e)-i,s=Math.max(n,e)+i,u=Math.min(r,t)-i,a=Math.max(r,t)+i;return o>=u&&a>=o||s>=u&&a>=s||u>=o&&s>=u||a>=o&&s>=a?!0:!1},VERB.geom.BoundingBox.prototype.intersects=function(n){if(!this.initialized||!n.initialized)return!1;var e=this.min,r=this.max,t=n.min,i=n.max;return this.intervals_overlap(e[0],r[0],t[0],i[0])&&this.intervals_overlap(e[1],r[1],t[1],i[1])&&this.intervals_overlap(e[2],r[2],t[2],i[2])?!0:!1},VERB.geom.BoundingBox.prototype.clear=function(){return this.initialized=!1,this},VERB.geom.BoundingBox.prototype.intersect=function(n){if(!this.initialized)return null;var e=this.min,r=this.max,t=n.min,i=n.max;if(!this.intersects(n))return null;var o=Math.min(r[0],i[0]),s=Math.max(e[0],t[0]),u=Math.min(r[1],i[1]),a=Math.max(e[1],t[1]),l=Math.min(r[2],i[2]),v=Math.max(e[2],t[2]),_=[o,u,l],c=[s,a,v];return new VERB.geom.BoundingBox(c,_)},VERB.geom.Geometry=function(){var n=VERB.core.uid();this.uid=function(){return n}},VERB.geom.NurbsCurve=function(n,e,r,t){if(VERB.geom.NURBSGeometry.call(this),VERB.eval.nurbs.are_valid_relations(n,e.length,t.length))var i=e.slice(0),o=VERB.eval.nurbs.homogenize_1d(e,r),s=t.slice(0),u=r.slice(0),a=n;else{console.warn("Invalid relations were used to instantiate a NurbsCurve - using defaults.");var i=[],o=[],s=[],u=[],a=2}this.set_control_point=function(n,e){return i[n]=e,o[n]=e*u[n],this},this.set_weight=function(n,e){return u[n]=e,set_control_point(n,i[n]),this},this.set_knot=function(n,e){return s[n]=e,this},this.point_sync=function(n){return this.nurbs_engine.eval_sync("rational_curve_point",[a,_knot_vector,o,n])},this.derivs_sync=function(n,e){return this.nurbs_engine.eval_sync("rational_curve_derivs",[a,_knot_vector,o,n,e])},this.point=function(n,e){nurbs_engine.eval("rational_curve_point",[a,_knot_vector,o,n],e)},this.derivs=function(n,e,r){this.nurbs_engine.eval("rational_curve_derivs",[a,_knot_vector,o,n,e],r)}},VERB.geom.NURBSGeometry=function(){VERB.geom.Geometry.call(this)}.inherits(VERB.geom.Geometry),VERB.geom.NurbsSurface=function(n,e,r,t){VERB.geom.NURBSGeometry.call(this),e.slice(0),t.slice(0),r.slice(0),this.set_control_point=function(){},this.set_weight=function(){},this.set_control_point=function(){},this.point=function(){},this.derivs=function(){}}.inherits(VERB.geom.NURBSGeometry),VERB.eval.nurbs.curve_knot_insert=function(n,e,r,t,i,o){var s=(r[0].length,e.length-n-2),u=r.length,a=VERB.eval.nurbs.knot_span(n,t,e),l=s+n+1,v=u+o,_=Array(n+1),c=Array(e.length+o),h=Array(v),f=0;for(f=0;a>=f;f++)c[f]=e[f];for(f=1;o>=f;f++)c[a+f]=t;for(f=a+1;l>=f;f++)c[f+o]=e[f];for(f=0;a-n>=f;f++)h[f]=r[f];for(f=a-i;s>=f;f++)h[f+o]=r[f];for(f=0;n-i>=f;f++)console.log(r[a-n+1]),_[f]=r[a-n+1];for(var m=0,d=0,B=1;o>=B;B++){for(m=a-n+B,f=0;n-B-i>=f;f++)d=(t-e[m+f])/(e[f+a+1]-e[m+f]),_[f]=numeric.add(numeric.mul(d,_[f+1]),numeric.mul(1-d,_[f]));h[m]=_[0],h[a+o-B-i]=_[n-B-i]}for(console.log(_),console.log(m),f=m+1;a-i>f;f++)h[f]=_[f-m];return[c,h]},VERB.eval.nurbs.rational_surface_derivs=function(n,e,r,t,i,o,s,u){var a=VERB.eval.nurbs.surface_derivs(n,e,r,t,i,o,s,u),l=VERB.eval.nurbs.separate_homo_derivs_2d(a),v=l[0],_=l[1],c=0,h=0,f=0,m=0,d=[],B=v[0][0].length;for(c=0;o>=c;c++)for(d.push([]),m=0;o-c>=m;m++){var u=v[c][m];for(f=1;m>=f;f++)u=numeric.sub(u,numeric.mul(numeric.mul(binomial.get(m,f),_[0][f]),d[c][m-f]));for(h=1;c>=h;h++){u=numeric.sub(u,numeric.mul(numeric.mul(binomial.get(c,h),_[h][0]),d[c-h][m]));var b=VERB.eval.nurbs.zeros_1d(B);for(f=1;m>=f;f++)b=numeric.add(b,numeric.mul(numeric.mul(binomial.get(m,f),_[h][f]),d[c-h][m-f]));u=numeric.sub(u,numeric.mul(binomial.get(c,h),b))}d[c].push(numeric.mul(1/_[0][0],u))}return d},VERB.eval.nurbs.rational_surface_point=function(n,e,r,t,i,o,s){return VERB.eval.nurbs.dehomogenize(VERB.eval.nurbs.surface_point(n,e,r,t,i,o,s))},VERB.eval.nurbs.rational_curve_derivs=function(n,e,r,t,i){var o=VERB.eval.nurbs.separate_homo_derivs_1d(VERB.eval.nurbs.curve_derivs(n,e,r,t,i)),s=o[0],u=o[1],a=0,l=0,v=[];for(a=0;i>=a;a++){var _=s[a];for(l=1;a>=l;l++)_=numeric.sub(_,numeric.mul(numeric.mul(binomial.get(a,l),u[l]),v[a-l]));v.push(numeric.mul(1/u[0],_))}return v},VERB.eval.nurbs.separate_homo_derivs_1d=function(n){for(var e=n[0].length,r=e-1,t=[],i=[],o=0,s=n.length;s>o;o++)t.push(n[o].slice(0,r)),i.push(n[o][r]);return[t,i]},VERB.eval.nurbs.separate_homo_derivs_2d=function(n){for(var e=[],r=[],t=0,i=n.length;i>t;t++){var o=VERB.eval.nurbs.separate_homo_derivs_1d(n[t]);e.push(o[0]),r.push(o[1])}return[e,r]},VERB.eval.nurbs.rational_curve_point=function(n,e,r,t){return VERB.eval.nurbs.dehomogenize(VERB.eval.nurbs.curve_point(n,e,r,t))},VERB.eval.nurbs.dehomogenize=function(n){for(var e=n.length,r=[],t=n[e-1],i=0;n.length-1>i;i++)r.push(n[i]/t);return r},VERB.eval.nurbs.homogenize_1d=function(n,e){for(var r=n.length,t=n[0].length,i=0,o=[],s=0,u=[],a=0;r>a;a++){var l=[];for(u=n[a],s=e[a],i=0;t>i;i++)l.push(u[i]*s);l.push(s),o.push(l)}return o},VERB.eval.nurbs.homogenize_2d=function(n,e){for(var r=n.length,t=(n[0].length,n[0][0].length,[]),i=0;r>i;i++)t.push(VERB.eval.nurbs.homogenize_1d(n[i],e[i]));return t},VERB.eval.nurbs.surface_derivs=function(n,e,r,t,i,o,s,u){var a=e.length-n-2,l=t.length-r-2;return VERB.eval.nurbs.surface_derivs_given_n_m(a,n,e,l,r,t,i,o,s,u)},VERB.eval.nurbs.surface_derivs_given_n_m=function(n,e,r,t,i,o,s,u,a,l){if(VERB.eval.nurbs.are_valid_relations(e,s.length,r.length)===!1||VERB.eval.nurbs.are_valid_relations(i,s[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var v=s[0][0].length,_=Math.min(u,e),c=Math.min(u,i),h=VERB.eval.nurbs.zeros_3d(_+1,c+1,v),f=VERB.eval.nurbs.knot_span_given_n(n,e,a,r),m=VERB.eval.nurbs.knot_span_given_n(t,i,l,o),d=VERB.eval.nurbs.deriv_basis_functions_given_n_i(f,a,e,n,r),B=VERB.eval.nurbs.deriv_basis_functions_given_n_i(m,l,i,t,o),b=VERB.eval.nurbs.zeros_2d(i+1,v),g=0,R=0,E=0,V=0,p=0;for(g=0;_>=g;g++){for(R=0;i>=R;R++)for(b[R]=VERB.eval.nurbs.zeros_1d(v),E=0;e>=E;E++)b[R]=numeric.add(b[R],numeric.mul(d[g][E],s[f-e+E][m-i+R]));for(p=Math.min(u-g,c),V=0;p>=V;V++)for(h[g][V]=VERB.eval.nurbs.zeros_1d(v),R=0;i>=R;R++)h[g][V]=numeric.add(h[g][V],numeric.mul(B[V][R],b[R]))}return h},VERB.eval.nurbs.surface_point=function(n,e,r,t,i,o,s){var u=e.length-n-2,a=t.length-r-2;return VERB.eval.nurbs.surface_point_given_n_m(u,n,e,a,r,t,i,o,s)},VERB.eval.nurbs.surface_point_given_n_m=function(n,e,r,t,i,o,s,u,a){if(VERB.eval.nurbs.are_valid_relations(e,s.length,r.length)===!1||VERB.eval.nurbs.are_valid_relations(i,s[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var l=(s[0][0].length,VERB.eval.nurbs.knot_span_given_n(n,e,u,r)),v=VERB.eval.nurbs.knot_span_given_n(t,i,a,o),_=VERB.eval.nurbs.basis_functions_given_knot_span_index(l,u,e,r),c=VERB.eval.nurbs.basis_functions_given_knot_span_index(v,a,i,o),h=l-e,f=v,m=VERB.eval.nurbs.zeros_1d(s[0][0].length),d=VERB.eval.nurbs.zeros_1d(s[0][0].length),B=0,b=0;for(B=0;i>=B;B++){for(d=VERB.eval.nurbs.zeros_1d(s[0][0].length),f=v-i+B,b=0;e>=b;b++)d=numeric.add(d,numeric.mul(_[b],s[h+b][f]));m=numeric.add(m,numeric.mul(c[B],d))}return m},VERB.eval.nurbs.curve_derivs=function(n,e,r,t,i){var o=e.length-n-2;return VERB.eval.nurbs.curve_derivs_given_n(o,n,e,r,t,i)},VERB.eval.nurbs.curve_derivs_given_n=function(n,e,r,t,i,o){if(VERB.eval.nurbs.are_valid_relations(e,t.length,r.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var s=t[0].length,u=Math.min(o,e),a=VERB.eval.nurbs.zeros_2d(u+1,s),l=VERB.eval.nurbs.knot_span_given_n(n,e,i,r),v=VERB.eval.nurbs.deriv_basis_functions_given_n_i(l,i,e,u,r),_=0,c=0;for(_=0;u>=_;_++)for(c=0;e>=c;c++)a[_]=numeric.add(a[_],numeric.mul(v[_][c],t[l-e+c]));return a},VERB.eval.nurbs.are_valid_relations=function(n,e,r){return 0===e+n+1-r?!0:!1},VERB.eval.nurbs.curve_point=function(n,e,r,t){var i=e.length-n-2;return VERB.eval.nurbs.curve_point_given_n(i,n,e,r,t)},VERB.eval.nurbs.curve_point_given_n=function(n,e,r,t,i){if(VERB.eval.nurbs.are_valid_relations(e,t.length,r.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;for(var o=VERB.eval.nurbs.knot_span_given_n(n,e,i,r),s=VERB.eval.nurbs.basis_functions_given_knot_span_index(o,i,e,r),u=VERB.eval.nurbs.zeros_1d(t[0].length),a=0;e>=a;a++)u=numeric.add(u,numeric.mul(s[a],t[o-e+a]));return u},VERB.eval.nurbs.zeros_1d=function(n){n=n>0?n:0;for(var e=[];n--;)e.push(0);return e},VERB.eval.nurbs.zeros_2d=function(n,e){e=e>0?e:0,n=n>0?n:0;for(var r=[],t=e,i=n;n--;){for(r.push([]);t--;)r[i-n-1].push(0);t=e}return r},VERB.eval.nurbs.zeros_3d=function(n,e,r){e=e>0?e:0,n=n>0?n:0;for(var t=[],i=e,o=n;n--;){for(t.push([]);i--;)t[o-n-1].push(VERB.eval.nurbs.zeros_1d(r));i=e}return t},VERB.eval.nurbs.deriv_basis_functions=function(n,e,r){var t=VERB.eval.nurbs.knot_span(e,n,r),i=r.length-1,o=i-e-1;return VERB.eval.nurbs.deriv_basis_functions_given_n_i(t,n,e,o,r)},VERB.eval.nurbs.deriv_basis_functions_given_n_i=function(n,e,r,t,i){var o=VERB.eval.nurbs.zeros_2d(r+1,r+1),s=Array(r+1),u=Array(r+1),a=0,l=0,v=1,_=0;for(o[0][0]=1,v=1;r>=v;v++){for(s[v]=e-i[n+1-v],u[v]=i[n+v]-e,a=0,_=0;v>_;_++)o[v][_]=u[_+1]+s[v-_],l=o[_][v-1]/o[v][_],o[_][v]=a+u[_+1]*l,a=s[v-_]*l;o[v][v]=a}var c=VERB.eval.nurbs.zeros_2d(t+1,r+1),h=VERB.eval.nurbs.zeros_2d(2,r+1),f=1,m=0,d=1,B=0,b=0,g=0,R=0,E=0;for(v=0;r>=v;v++)c[0][v]=o[v][r];for(_=0;r>=_;_++)for(m=0,d=1,h[0][0]=1,f=1;t>=f;f++){for(B=0,b=_-f,g=r-f,_>=f&&(h[d][0]=h[m][0]/o[g+1][b],B=h[d][0]*o[b][g]),R=b>=-1?1:-b,E=g>=_-1?f-1:r-_,v=R;E>=v;v++)h[d][v]=(h[m][v]-h[m][v-1])/o[g+1][b+v],B+=h[d][v]*o[b+v][g];g>=_&&(h[d][f]=-h[m][f-1]/o[g+1][_],B+=h[d][f]*o[_][g]),c[f][_]=B,v=m,m=d,d=v}for(_=r,f=1;t>=f;f++){for(v=0;r>=v;v++)c[f][v]*=_;_*=r-f}return c},VERB.eval.nurbs.basis_functions=function(n,e,r){var t=VERB.eval.nurbs.knot_span(n,e,r);return VERB.eval.nurbs.basis_functions_given_knot_span_index(t,n,e,r)},VERB.eval.nurbs.basis_functions_given_knot_span_index=function(n,e,r,t){var i=Array(r+1),o=Array(r+1),s=Array(r+1),u=0,a=0;i[0]=1;for(var l=1;r>=l;l++){o[l]=e-t[n+1-l],s[l]=t[n+l]-e,u=0;for(var v=0;l>v;v++)a=i[v]/(s[v+1]+o[l-v]),i[v]=u+s[v+1]*a,u=o[l-v]*a;i[l]=u}return i},VERB.eval.nurbs.knot_span=function(n,e,r){var t=r.length-1,i=t-n-1;return VERB.eval.nurbs.knot_span_given_n(i,n,e,r)},VERB.eval.nurbs.knot_span_given_n=function(n,e,r,t){if(r>=t[n+1])return n;if(t[e]>r)return e;for(var i=e,o=n+1,s=Math.floor((i+o)/2);t[s]>r||r>=t[s+1];)t[s]>r?o=s:i=s,s=Math.floor((i+o)/2);return s};