/*! verb 2013-06-08 */
if("object"!=typeof exports||void 0===exports)importScripts("labor.js");else var labor=require("labor");var VERB=VERB||{};VERB.eval=VERB.eval||{},VERB.eval.nurbs=VERB.eval.nurbs||{};var router=new labor.Router(VERB.eval.nurbs);VERB.eval.nurbs.rational_surface_surface_intersect=function(){},VERB.eval.nurbs.rational_curve_curve_bb_intersect=function(){},VERB.eval.nurbs.rational_curve_adaptive_sample=function(n,e,r,t){var i={};return VERB.eval.nurbs.rational_curve_adaptive_sample_range(n,e,r,0,1,t,i),i},VERB.eval.nurbs.rational_curve_adaptive_sample_range=function(n,e,r,t,i,o,u){var s=VERB.eval.nurbs.rational_curve_point(t),a=VERB.eval.nurbs.rational_curve_point(i),l=.45+.1*Math.random();mid_u=t+(i-t)*l,p2=VERB.eval.nurbs.rational_curve_point(mid_u),VERB.eval.nurbs.three_points_are_flat(s,p2,a,o)?(u[t]=s,u[i]=a):(VERB.eval.nurbs.rational_curve_adaptive_sample_range(n,e,r,t,mid_u,o,u),VERB.eval.nurbs.rational_curve_adaptive_sample_range(n,e,r,mid_u,i,o,u))},VERB.eval.nurbs.three_points_are_flat=function(n,e,r,t){var i=new VERB.geom.Vector(n),o=new VERB.geom.Vector(e),u=VERB.geom.Vector(r),s=o.minus(i).cross(u.minus(i)),a=s.dot(s);return t>a},VERB.eval.nurbs.curve_knot_insert=function(n,e,r,t,i,o){var u=(r[0].length,e.length-n-2),s=r.length,a=VERB.eval.nurbs.knot_span(n,t,e),l=u+n+1,v=s+o,_=Array(n+1),c=Array(e.length+o),h=Array(v),f=0;for(f=0;a>=f;f++)c[f]=e[f];for(f=1;o>=f;f++)c[a+f]=t;for(f=a+1;l>=f;f++)c[f+o]=e[f];for(f=0;a-n>=f;f++)h[f]=r[f];for(f=a-i;u>=f;f++)h[f+o]=r[f];for(f=0;n-i>=f;f++)_[f]=r[a-n+1];for(var b=0,d=0,m=1;o>=m;m++){for(b=a-n+m,f=0;n-m-i>=f;f++)d=(t-e[b+f])/(e[f+a+1]-e[b+f]),_[f]=numeric.add(numeric.mul(d,_[f+1]),numeric.mul(1-d,_[f]));h[b]=_[0],h[a+o-m-i]=_[n-m-i]}for(f=b+1;a-i>f;f++)h[f]=_[f-b];return[c,h]},VERB.eval.nurbs.rational_surface_derivs=function(n,e,r,t,i,o,u,s){var a=VERB.eval.nurbs.surface_derivs(n,e,r,t,i,o,u,s),l=VERB.eval.nurbs.separate_homo_derivs_2d(a),v=l[0],_=l[1],c=0,h=0,f=0,b=0,d=[],m=v[0][0].length;for(c=0;o>=c;c++)for(d.push([]),b=0;o-c>=b;b++){var s=v[c][b];for(f=1;b>=f;f++)s=numeric.sub(s,numeric.mul(numeric.mul(binomial.get(b,f),_[0][f]),d[c][b-f]));for(h=1;c>=h;h++){s=numeric.sub(s,numeric.mul(numeric.mul(binomial.get(c,h),_[h][0]),d[c-h][b]));var B=VERB.eval.nurbs.zeros_1d(m);for(f=1;b>=f;f++)B=numeric.add(B,numeric.mul(numeric.mul(binomial.get(b,f),_[h][f]),d[c-h][b-f]));s=numeric.sub(s,numeric.mul(binomial.get(c,h),B))}d[c].push(numeric.mul(1/_[0][0],s))}return d},VERB.eval.nurbs.rational_surface_point=function(n,e,r,t,i,o,u){return VERB.eval.nurbs.dehomogenize(VERB.eval.nurbs.surface_point(n,e,r,t,i,o,u))},VERB.eval.nurbs.rational_curve_derivs=function(n,e,r,t,i){var o=VERB.eval.nurbs.separate_homo_derivs_1d(VERB.eval.nurbs.curve_derivs(n,e,r,t,i)),u=o[0],s=o[1],a=0,l=0,v=[];for(a=0;i>=a;a++){var _=u[a];for(l=1;a>=l;l++)_=numeric.sub(_,numeric.mul(numeric.mul(binomial.get(a,l),s[l]),v[a-l]));v.push(numeric.mul(1/s[0],_))}return v},VERB.eval.nurbs.separate_homo_derivs_1d=function(n){for(var e=n[0].length,r=e-1,t=[],i=[],o=0,u=n.length;u>o;o++)t.push(n[o].slice(0,r)),i.push(n[o][r]);return[t,i]},VERB.eval.nurbs.separate_homo_derivs_2d=function(n){for(var e=[],r=[],t=0,i=n.length;i>t;t++){var o=VERB.eval.nurbs.separate_homo_derivs_1d(n[t]);e.push(o[0]),r.push(o[1])}return[e,r]},VERB.eval.nurbs.rational_curve_point=function(n,e,r,t){return VERB.eval.nurbs.dehomogenize(VERB.eval.nurbs.curve_point(n,e,r,t))},VERB.eval.nurbs.dehomogenize=function(n){for(var e=n.length,r=[],t=n[e-1],i=0;n.length-1>i;i++)r.push(n[i]/t);return r},VERB.eval.nurbs.homogenize_1d=function(n,e){for(var r=n.length,t=n[0].length,i=0,o=[],u=0,s=[],a=0;r>a;a++){var l=[];for(s=n[a],u=e[a],i=0;t>i;i++)l.push(s[i]*u);l.push(u),o.push(l)}return o},VERB.eval.nurbs.homogenize_2d=function(n,e){for(var r=n.length,t=(n[0].length,n[0][0].length,[]),i=0;r>i;i++)t.push(VERB.eval.nurbs.homogenize_1d(n[i],e[i]));return t},VERB.eval.nurbs.surface_derivs=function(n,e,r,t,i,o,u,s){var a=e.length-n-2,l=t.length-r-2;return VERB.eval.nurbs.surface_derivs_given_n_m(a,n,e,l,r,t,i,o,u,s)},VERB.eval.nurbs.surface_derivs_given_n_m=function(n,e,r,t,i,o,u,s,a,l){if(VERB.eval.nurbs.are_valid_relations(e,u.length,r.length)===!1||VERB.eval.nurbs.are_valid_relations(i,u[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var v=u[0][0].length,_=Math.min(s,e),c=Math.min(s,i),h=VERB.eval.nurbs.zeros_3d(_+1,c+1,v),f=VERB.eval.nurbs.knot_span_given_n(n,e,a,r),b=VERB.eval.nurbs.knot_span_given_n(t,i,l,o),d=VERB.eval.nurbs.deriv_basis_functions_given_n_i(f,a,e,n,r),m=VERB.eval.nurbs.deriv_basis_functions_given_n_i(b,l,i,t,o),B=VERB.eval.nurbs.zeros_2d(i+1,v),g=0,V=0,R=0,E=0,p=0;for(g=0;_>=g;g++){for(V=0;i>=V;V++)for(B[V]=VERB.eval.nurbs.zeros_1d(v),R=0;e>=R;R++)B[V]=numeric.add(B[V],numeric.mul(d[g][R],u[f-e+R][b-i+V]));for(p=Math.min(s-g,c),E=0;p>=E;E++)for(h[g][E]=VERB.eval.nurbs.zeros_1d(v),V=0;i>=V;V++)h[g][E]=numeric.add(h[g][E],numeric.mul(m[E][V],B[V]))}return h},VERB.eval.nurbs.surface_point=function(n,e,r,t,i,o,u){var s=e.length-n-2,a=t.length-r-2;return VERB.eval.nurbs.surface_point_given_n_m(s,n,e,a,r,t,i,o,u)},VERB.eval.nurbs.surface_point_given_n_m=function(n,e,r,t,i,o,u,s,a){if(VERB.eval.nurbs.are_valid_relations(e,u.length,r.length)===!1||VERB.eval.nurbs.are_valid_relations(i,u[0].length,o.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var l=(u[0][0].length,VERB.eval.nurbs.knot_span_given_n(n,e,s,r)),v=VERB.eval.nurbs.knot_span_given_n(t,i,a,o),_=VERB.eval.nurbs.basis_functions_given_knot_span_index(l,s,e,r),c=VERB.eval.nurbs.basis_functions_given_knot_span_index(v,a,i,o),h=l-e,f=v,b=VERB.eval.nurbs.zeros_1d(u[0][0].length),d=VERB.eval.nurbs.zeros_1d(u[0][0].length),m=0,B=0;for(m=0;i>=m;m++){for(d=VERB.eval.nurbs.zeros_1d(u[0][0].length),f=v-i+m,B=0;e>=B;B++)d=numeric.add(d,numeric.mul(_[B],u[h+B][f]));b=numeric.add(b,numeric.mul(c[m],d))}return b},VERB.eval.nurbs.curve_derivs=function(n,e,r,t,i){var o=e.length-n-2;return VERB.eval.nurbs.curve_derivs_given_n(o,n,e,r,t,i)},VERB.eval.nurbs.curve_derivs_given_n=function(n,e,r,t,i,o){if(VERB.eval.nurbs.are_valid_relations(e,t.length,r.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;var u=t[0].length,s=Math.min(o,e),a=VERB.eval.nurbs.zeros_2d(s+1,u),l=VERB.eval.nurbs.knot_span_given_n(n,e,i,r),v=VERB.eval.nurbs.deriv_basis_functions_given_n_i(l,i,e,s,r),_=0,c=0;for(_=0;s>=_;_++)for(c=0;e>=c;c++)a[_]=numeric.add(a[_],numeric.mul(v[_][c],t[l-e+c]));return a},VERB.eval.nurbs.are_valid_relations=function(n,e,r){return 0===e+n+1-r?!0:!1},VERB.eval.nurbs.curve_point=function(n,e,r,t){var i=e.length-n-2;return VERB.eval.nurbs.curve_point_given_n(i,n,e,r,t)},VERB.eval.nurbs.curve_point_given_n=function(n,e,r,t,i){if(VERB.eval.nurbs.are_valid_relations(e,t.length,r.length)===!1)return console.error("Invalid relations between control points, knot vector, and n"),null;for(var o=VERB.eval.nurbs.knot_span_given_n(n,e,i,r),u=VERB.eval.nurbs.basis_functions_given_knot_span_index(o,i,e,r),s=VERB.eval.nurbs.zeros_1d(t[0].length),a=0;e>=a;a++)s=numeric.add(s,numeric.mul(u[a],t[o-e+a]));return s},VERB.eval.nurbs.zeros_1d=function(n){n=n>0?n:0;for(var e=[];n--;)e.push(0);return e},VERB.eval.nurbs.zeros_2d=function(n,e){e=e>0?e:0,n=n>0?n:0;for(var r=[],t=e,i=n;n--;){for(r.push([]);t--;)r[i-n-1].push(0);t=e}return r},VERB.eval.nurbs.zeros_3d=function(n,e,r){e=e>0?e:0,n=n>0?n:0;for(var t=[],i=e,o=n;n--;){for(t.push([]);i--;)t[o-n-1].push(VERB.eval.nurbs.zeros_1d(r));i=e}return t},VERB.eval.nurbs.deriv_basis_functions=function(n,e,r){var t=VERB.eval.nurbs.knot_span(e,n,r),i=r.length-1,o=i-e-1;return VERB.eval.nurbs.deriv_basis_functions_given_n_i(t,n,e,o,r)},VERB.eval.nurbs.deriv_basis_functions_given_n_i=function(n,e,r,t,i){var o=VERB.eval.nurbs.zeros_2d(r+1,r+1),u=Array(r+1),s=Array(r+1),a=0,l=0,v=1,_=0;for(o[0][0]=1,v=1;r>=v;v++){for(u[v]=e-i[n+1-v],s[v]=i[n+v]-e,a=0,_=0;v>_;_++)o[v][_]=s[_+1]+u[v-_],l=o[_][v-1]/o[v][_],o[_][v]=a+s[_+1]*l,a=u[v-_]*l;o[v][v]=a}var c=VERB.eval.nurbs.zeros_2d(t+1,r+1),h=VERB.eval.nurbs.zeros_2d(2,r+1),f=1,b=0,d=1,m=0,B=0,g=0,V=0,R=0;for(v=0;r>=v;v++)c[0][v]=o[v][r];for(_=0;r>=_;_++)for(b=0,d=1,h[0][0]=1,f=1;t>=f;f++){for(m=0,B=_-f,g=r-f,_>=f&&(h[d][0]=h[b][0]/o[g+1][B],m=h[d][0]*o[B][g]),V=B>=-1?1:-B,R=g>=_-1?f-1:r-_,v=V;R>=v;v++)h[d][v]=(h[b][v]-h[b][v-1])/o[g+1][B+v],m+=h[d][v]*o[B+v][g];g>=_&&(h[d][f]=-h[b][f-1]/o[g+1][_],m+=h[d][f]*o[_][g]),c[f][_]=m,v=b,b=d,d=v}for(_=r,f=1;t>=f;f++){for(v=0;r>=v;v++)c[f][v]*=_;_*=r-f}return c},VERB.eval.nurbs.basis_functions=function(n,e,r){var t=VERB.eval.nurbs.knot_span(n,e,r);return VERB.eval.nurbs.basis_functions_given_knot_span_index(t,n,e,r)},VERB.eval.nurbs.basis_functions_given_knot_span_index=function(n,e,r,t){var i=Array(r+1),o=Array(r+1),u=Array(r+1),s=0,a=0;i[0]=1;for(var l=1;r>=l;l++){o[l]=e-t[n+1-l],u[l]=t[n+l]-e,s=0;for(var v=0;l>v;v++)a=i[v]/(u[v+1]+o[l-v]),i[v]=s+u[v+1]*a,s=o[l-v]*a;i[l]=s}return i},VERB.eval.nurbs.knot_span=function(n,e,r){var t=r.length-1,i=t-n-1;return VERB.eval.nurbs.knot_span_given_n(i,n,e,r)},VERB.eval.nurbs.knot_span_given_n=function(n,e,r,t){if(r>=t[n+1])return n;if(t[e]>r)return e;for(var i=e,o=n+1,u=Math.floor((i+o)/2);t[u]>r||r>=t[u+1];)t[u]>r?o=u:i=u,u=Math.floor((i+o)/2);return u};